<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ video.title }} - Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav id="mainNav" class="bg-gray-800 p-4 sticky top-0 z-10 transition-all duration-300">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-400">Video Library</a>
            <div class="flex items-center gap-4">
                <form action="/search" method="GET" class="flex">
                    <input type="text" name="q" placeholder="Search videos..."
                        class="px-4 py-2 rounded-l-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-r-lg">
                        Search
                    </button>
                </form>
                {% if is_admin %}
                <a href="/admin" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg">Admin</a>
                {% endif %}
                <button onclick="toggleNav()" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm" title="Hide navbar (H)">
                    ▲ Hide
                </button>
            </div>
        </div>
    </nav>
    <!-- Show navbar button (visible when nav is hidden) -->
    <button id="showNavBtn" onclick="toggleNav()" class="fixed top-2 right-2 z-20 bg-gray-800 hover:bg-gray-700 px-3 py-1 rounded-lg text-sm hidden transition-all duration-300" title="Show navbar (H)">
        ▼ Show Nav
    </button>

    <div class="container mx-auto px-4 py-8">
        <!-- Competition Context Banner (when opened from competition) -->
        {% if competition_context %}
        <div class="bg-blue-900/50 border border-blue-700 rounded-lg p-4 mb-6 flex items-center justify-between">
            <div>
                <span class="text-blue-400 font-medium">Judging:</span>
                <span class="text-white ml-2">{{ competition_context.team_name }} - Round {{ competition_context.round_num }}</span>
                <span class="text-gray-400 ml-2">({{ competition_context.competition_name }})</span>
            </div>
            <div class="flex items-center gap-3">
                {% if is_admin %}
                <button onclick="showQuickScoreModal()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg text-sm font-medium">
                    Enter Score
                </button>
                {% endif %}
                <a href="/competition/{{ competition_context.competition_id }}" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg text-sm">
                    ← Back to Competition
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Breadcrumb -->
        <div class="mb-6">
            <a href="/" class="text-blue-400 hover:underline">Home</a>
            <span class="text-gray-500 mx-2">/</span>
            {% if competition_context %}
            <a href="/competitions" class="text-blue-400 hover:underline">Competitions</a>
            <span class="text-gray-500 mx-2">/</span>
            <a href="/competition/{{ competition_context.competition_id }}" class="text-blue-400 hover:underline">{{ competition_context.competition_name }}</a>
            {% else %}
            <a href="/category/{{ video.category }}" class="text-blue-400 hover:underline">{{ category.name }}</a>
            {% endif %}
            <span class="text-gray-500 mx-2">/</span>
            <span class="text-gray-300 truncate">{{ video.title }}</span>
        </div>

        <div>
            <!-- Main Video Area -->
            <div>
                <!-- Video Player -->
                <div class="aspect-video bg-black rounded-lg overflow-hidden mb-4 relative" id="videoContainer">
                    <!-- Freeze Frame Overlay (for all videos) -->
                    <div id="freezeOverlay" class="absolute inset-0 bg-black/80 flex items-center justify-center z-10 hidden">
                        <!-- Initial TIME display -->
                        <div id="freezeTimeDisplay" class="text-center">
                            <span class="text-6xl font-bold text-yellow-400 drop-shadow-lg">TIME</span>
                            <p class="text-white text-xl mt-2">Working Time Complete</p>
                            <button onclick="showScoreConfirmation()" class="mt-4 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg text-white font-bold text-lg">
                                Confirm Scores
                            </button>
                        </div>
                        <!-- Score Summary Table (shown after confirmation) -->
                        <div id="scoreSummaryTable" class="hidden w-full max-w-5xl mx-4 bg-gray-900 rounded-lg shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
                            <div class="bg-gray-800 px-4 py-3 border-b border-gray-700 flex-shrink-0">
                                <h3 class="text-xl font-bold text-white text-center">Score Summary</h3>
                            </div>
                            <div class="p-4 overflow-auto flex-grow">
                                <table class="w-full text-sm border-collapse" id="scoreSummaryContent">
                                    <!-- Generated by JavaScript -->
                                </table>
                            </div>
                            <div class="bg-gray-800 px-4 py-3 border-t border-gray-700 flex justify-between items-center flex-shrink-0">
                                <span id="summaryTotal" class="text-2xl font-bold text-yellow-400">Total: 0</span>
                                <div class="flex gap-2">
                                    <button onclick="hideScoreSummary()" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white">
                                        Edit Scores
                                    </button>
                                    <button onclick="saveAndCloseSummary()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded text-white font-bold">
                                        Save & Close
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% if video.is_local or video.is_direct_url %}
                    <video controls class="w-full h-full" poster="{{ video.thumbnail }}" id="videoPlayer" playsinline preload="metadata" tabindex="-1">
                        {% if '.webm' in video.video_src|lower %}
                        <source src="{{ video.video_src }}" type="video/webm">
                        {% elif '.ogg' in video.video_src|lower or '.ogv' in video.video_src|lower %}
                        <source src="{{ video.video_src }}" type="video/ogg">
                        {% elif '.mov' in video.video_src|lower or '.m4v' in video.video_src|lower %}
                        <source src="{{ video.video_src }}" type="video/mp4">
                        {% else %}
                        <source src="{{ video.video_src }}" type="video/mp4">
                        {% endif %}
                        Your browser does not support the video tag.
                    </video>
                    {% else %}
                    <iframe id="vimeoPlayer" src="{{ video.embed_url }}"
                        class="w-full h-full"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                    {% endif %}
                </div>

                <!-- Scoring & Judging Panel -->
                <div class="bg-gray-800 rounded-lg p-4 mb-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400 text-sm">Speed:</span>
                            <button onclick="setSpeed(0.25)" class="speed-btn px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" data-speed="0.25">25%</button>
                            <button onclick="setSpeed(0.5)" class="speed-btn px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" data-speed="0.5">50%</button>
                            <button onclick="setSpeed(0.75)" class="speed-btn px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" data-speed="0.75">75%</button>
                            <button onclick="setSpeed(1)" class="speed-btn px-3 py-1 rounded bg-blue-600 text-sm" data-speed="1">100%</button>
                            <span class="text-gray-600 mx-2">|</span>
                            <span class="text-gray-400 text-sm">Frame:</span>
                            <button onclick="stepFrame(-1)" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" title="Previous frame (,)">&lt;</button>
                            <button onclick="stepFrame(1)" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" title="Next frame (.)">></button>
                            <span class="text-gray-600 mx-2">|</span>
                            <button onclick="startTimer()" id="timerBtn"
                                class="px-4 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                Start (X)
                            </button>
                            <button onclick="replayVideo()"
                                class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-sm" title="Restart video without clearing scores">
                                Replay
                            </button>
                            <button onclick="confirmReset()"
                                class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm" title="Clear all scores and reset">
                                Reset
                            </button>
                            <span class="text-gray-600 mx-2">|</span>
                            <span class="text-gray-400 text-sm">Video Start:</span>
                            <span id="startTimeDisplay" class="font-mono text-cyan-400">{{ video.start_time|default(0, true) }}s</span>
                            <button onclick="goToStartTime()" class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs">
                                Go to Start
                            </button>
                            <button onclick="setCurrentAsStart()" class="px-2 py-1 rounded bg-blue-600 hover:bg-blue-700 text-xs">
                                Set Current
                            </button>
                            <button onclick="clearStartTime()" class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs">
                                Clear
                            </button>
                            <span id="startTimeSaveStatus" class="text-xs text-gray-500"></span>
                            <span id="timerDisplay" class="text-xl font-mono font-bold text-gray-400 ml-2">--:--</span>
                            <span id="timerStatus" class="text-sm text-gray-500"></span>
                            <span id="flysightTimeCompare" class="text-sm text-gray-500 hidden ml-2">
                                / FlySight: <span id="flysightTimeDisplay" class="text-cyan-400 font-mono">--.-s</span>
                            </span>
                        </div>
                    </div>
                    <!-- Scoring Timeline -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400 text-sm">Scoring:</span>
                                <span class="text-xs text-gray-500">X = point (+1) | C = bust (0 pts) | Q = omission (-1)</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Panel Mode Toggle -->
                                <select id="panelSize" onchange="updatePanelMode()" class="px-2 py-1 rounded bg-gray-700 text-white text-sm">
                                    <option value="1">Solo</option>
                                    <option value="3">3 Panel</option>
                                    <option value="5">5 Panel</option>
                                </select>
                                <span id="currentJudgeLabel" class="text-xs text-cyan-400 hidden">J1</span>
                                <button onclick="toggleNV()" id="nvBtn" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                                    NV
                                </button>
                                <button onclick="clearScoring()" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                                    Clear
                                </button>
                            </div>
                        </div>
                        <!-- Judge Names Dropdown (panel mode only) -->
                        <div id="judgeNamesRow" class="hidden mb-3 flex items-center gap-2 flex-wrap">
                            <span class="text-gray-400 text-sm">Judges:</span>
                            <select id="judgeName1" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm" onchange="updateJudgeSelection(1)">
                                <option value="">Select Judge 1</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="judgeName2" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm" onchange="updateJudgeSelection(2)">
                                <option value="">Select Judge 2</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="judgeName3" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm" onchange="updateJudgeSelection(3)">
                                <option value="">Select Judge 3</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="judgeName4" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm hidden" onchange="updateJudgeSelection(4)">
                                <option value="">Select Judge 4</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                            <select id="judgeName5" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm hidden" onchange="updateJudgeSelection(5)">
                                <option value="">Select Judge 5</option>
                                {% for user in users %}
                                <option value="{{ user.name }}">{{ user.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <!-- Sync Panel Session (panel mode only) -->
                        <div id="syncPanelRow" class="hidden mb-3 p-3 bg-blue-900/30 border border-blue-700 rounded-lg">
                            <div class="flex items-center justify-between flex-wrap gap-2">
                                <div class="flex items-center gap-2">
                                    <span class="text-blue-400 text-sm font-medium">Sync Session:</span>
                                    <span id="syncSessionId" class="text-xs text-gray-400 font-mono">Not connected</span>
                                    <button id="copySessionIdBtn" onclick="copySessionId()" class="hidden px-2 py-1 rounded bg-gray-600 hover:bg-gray-500 text-xs">
                                        Copy ID
                                    </button>
                                </div>
                                <div id="syncNotConnected" class="flex items-center gap-2 flex-wrap">
                                    <!-- Role Selection -->
                                    <div class="flex items-center gap-2">
                                        <select id="syncRoleSelect" onchange="updateSyncRoleUI()" class="px-2 py-1 rounded bg-gray-700 text-white text-sm">
                                            <option value="event">I am the Event Judge</option>
                                            <option value="panel">I am a Panel Judge</option>
                                        </select>
                                    </div>
                                    <!-- Event Judge: Create session -->
                                    <div id="eventJudgeControls" class="flex items-center gap-2">
                                        <button onclick="createSyncSession()" class="px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                            Create Session
                                        </button>
                                    </div>
                                    <!-- Panel Judges: Join session -->
                                    <div id="panelJudgeControls" class="hidden flex items-center gap-2">
                                        <select id="myJudgeNum" class="px-2 py-1 rounded bg-gray-700 text-white text-sm">
                                            <option value="1">Judge 1</option>
                                            <option value="2">Judge 2</option>
                                            <option value="3">Judge 3</option>
                                        </select>
                                        <input type="text" id="joinSessionId" placeholder="Session ID" class="w-32 px-2 py-1 rounded bg-gray-700 text-white text-sm">
                                        <button onclick="joinSyncSession()" class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-sm">
                                            Join
                                        </button>
                                    </div>
                                </div>
                                <div id="syncConnected" class="hidden flex items-center gap-2 flex-wrap">
                                    <div id="syncJudgesList" class="flex items-center gap-1">
                                        <!-- Judge connection indicators -->
                                    </div>
                                    <span class="text-gray-500">|</span>
                                    <span id="syncStateDisplay" class="text-yellow-400 text-xs">Waiting...</span>
                                    <button id="syncReadyBtn" onclick="markJudgeReady()" class="hidden px-3 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                        Ready
                                    </button>
                                    <button id="syncStartVideoBtn" onclick="eventJudgeStartVideo()" class="hidden px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-sm font-medium">
                                        Start Video
                                    </button>
                                    <button id="syncResetBtn" onclick="eventJudgeReset()" class="hidden px-3 py-1 rounded bg-orange-600 hover:bg-orange-700 text-sm font-medium">
                                        Reset
                                    </button>
                                    <button onclick="leaveSyncSession()" class="px-3 py-1 rounded bg-red-600 hover:bg-red-700 text-sm">
                                        Leave
                                    </button>
                                </div>
                            </div>
                            <div id="syncStatus" class="text-xs text-green-400 mt-2 hidden"></div>
                        </div>
                        <div class="bg-gray-900 rounded-lg p-3 mb-3 min-h-[40px] font-mono text-xl tracking-widest" id="scoringTimeline">
                            <span class="text-gray-500">Press X, C, or Q to score...</span>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <div class="flex items-center gap-4">
                                <span class="text-gray-400">Points (X): <span id="xCount" class="text-green-400 font-bold">0</span></span>
                                <span class="text-gray-400">Busts (C): <span id="cCount" class="text-red-400 font-bold">0</span></span>
                                <span class="text-gray-400">Omissions (Q): <span id="qCount" class="text-orange-400 font-bold">0</span></span>
                            </div>
                            <div class="text-lg flex items-center gap-3">
                                <span id="nvIndicator" class="text-red-500 font-bold hidden">NV PENALTY</span>
                                <span class="text-gray-400">Total:</span>
                                <span id="totalScore" class="text-yellow-400 font-bold ml-2">0</span>
                                <span id="scoreComparison" class="text-cyan-400 text-sm hidden"></span>
                            </div>
                        </div>
                        <!-- Save Score Button -->
                        <div id="saveScoreSection" class="hidden mt-3 pt-3 border-t border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    {% if competition_context %}
                                    <span class="text-gray-400 text-sm">Round {{ competition_context.round_num }}</span>
                                    <input type="hidden" id="scoreRoundLabel" value="Round {{ competition_context.round_num }}">
                                    {% else %}
                                    <input type="text" id="scoreRoundLabel" placeholder="Round #"
                                        class="w-24 px-3 py-1 rounded bg-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    {% endif %}
                                    <button onclick="saveCurrentScore()" class="px-4 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                        Save Score
                                    </button>
                                </div>
                                <span id="saveScoreStatus" class="text-sm text-gray-500"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Scores Display -->
                    <div class="mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm font-medium">Saved Scores (Practice)</span>
                            <button onclick="clearSavedScores()" class="px-2 py-1 rounded bg-gray-700 hover:bg-gray-600 text-xs">
                                Clear All
                            </button>
                        </div>
                        <div id="savedScoresList" class="space-y-2 max-h-48 overflow-y-auto">
                            <div class="text-gray-500 text-sm text-center py-2">No saved scores yet</div>
                        </div>
                    </div>

                    <!-- Timer Controls -->
                    <div class="flex items-center justify-between flex-wrap gap-4 mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 text-sm">Event:</span>
                            <select id="eventType" onchange="updateEventType()"
                                class="px-3 py-1 rounded bg-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <optgroup label="Formation Skydiving">
                                    <option value="2way-mfs" data-duration="35">2-Way MFS (35s)</option>
                                    <option value="4way-vfs" data-duration="35">4-Way VFS (35s)</option>
                                    <option value="4way-fs" data-duration="35" selected>4-Way FS (35s)</option>
                                    <option value="8way" data-duration="50">8-Way (50s)</option>
                                    <option value="10way" data-duration="0">10-Way Speed</option>
                                    <option value="16way" data-duration="50">16-Way (50s)</option>
                                </optgroup>
                                <optgroup label="Canopy Formation">
                                    <option value="2way-cf-seq" data-duration="60">2-Way CF Sequential (60s)</option>
                                    <option value="4way-cf-seq" data-duration="120">4-Way CF Sequential (120s)</option>
                                    <option value="4way-cf-rot" data-duration="90">4-Way CF Rotation (90s)</option>
                                </optgroup>
                                <optgroup label="Artistic Events">
                                    <option value="freestyle" data-duration="45">Freestyle (45s)</option>
                                    <option value="freefly" data-duration="43">Freeflying (43s)</option>
                                </optgroup>
                                <optgroup label="Wingsuit Acrobatic">
                                    <option value="ws-compulsory" data-duration="0">WS Compulsory Round</option>
                                    <option value="ws-free" data-duration="0">WS Free Round</option>
                                </optgroup>
                            </select>
                            <select id="eventClass" onchange="updateFormations()"
                                class="px-3 py-1 rounded bg-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="open">Open</option>
                                <option value="advanced">Advanced</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="beginner">Beginner</option>
                            </select>
                            <span id="durationLabel" class="text-gray-400 text-sm">35s working time</span>
                        </div>
                    </div>

                    <!-- Formations/Draw Input -->
                    <div id="formationsSection" class="mt-3 pt-3 border-t border-gray-700">
                        <div class="flex items-center gap-3 flex-wrap">
                            <span class="text-gray-400 text-sm">Draw:</span>
                            <input type="text" id="formationsInput" placeholder="e.g., A2BC1D"
                                oninput="updateFormations()"
                                class="w-48 px-3 py-1 rounded bg-gray-700 text-white text-sm font-mono uppercase focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div id="formationsDisplay" class="flex items-center gap-1 text-lg font-mono"></div>
                        </div>
                        <div class="flex items-center gap-3 flex-wrap mt-2">
                            <span class="text-gray-400 text-sm">Max: <span id="maxPoints" class="text-cyan-400 font-bold">0</span> pts</span>
                            <span class="text-gray-500">|</span>
                            <span id="drawInfo" class="text-xs text-gray-500"></span>
                            <span id="drawValidation" class="text-xs"></span>
                        </div>
                    </div>

                    <div id="speedInfo" class="text-xs text-gray-500 hidden mt-2">
                        10-Way Speed: X to start, X again to stop. Max score: 35.00s. Freeze 6s after completion.
                    </div>

                    <!-- Multi-Judge Scoring Panel -->
                    <div id="multiJudgePanel" class="mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm font-medium">Judge Panel</span>
                            <div class="flex items-center gap-2">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="checkbox" id="multiJudgeMode" onchange="toggleMultiJudgeMode()"
                                        class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-600">
                                    <span class="text-gray-400 text-sm">Multi-Judge Mode</span>
                                </label>
                                <select id="judgeCount" onchange="updateJudgeCount()" class="px-2 py-1 rounded bg-gray-700 text-white text-sm hidden">
                                    <option value="3">3 Judges</option>
                                    <option value="5" selected>5 Judges</option>
                                </select>
                            </div>
                        </div>

                        <!-- FS/VFS Multi-Judge Panel -->
                        <div id="fsMultiJudgePanel" class="hidden">
                            <p class="text-xs text-gray-500 mb-3">Enter each judge's point count. Average will be calculated automatically.</p>
                            <div class="grid grid-cols-5 gap-2 mb-3" id="fsJudgeInputs">
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J1</label>
                                    <input type="number" id="fsJ1" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateFsAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J2</label>
                                    <input type="number" id="fsJ2" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateFsAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J3</label>
                                    <input type="number" id="fsJ3" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateFsAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J4</label>
                                    <input type="number" id="fsJ4" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateFsAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J5</label>
                                    <input type="number" id="fsJ5" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateFsAverage()">
                                </div>
                            </div>
                            <div class="flex items-center justify-between bg-gray-900 rounded p-3">
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-400 text-sm">Average:</span>
                                    <span id="fsJudgeAverage" class="text-2xl font-mono font-bold text-yellow-400">0.0</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-400 text-sm">Spread:</span>
                                    <span id="fsJudgeSpread" class="font-mono text-gray-300">0</span>
                                    <span id="fsSpreadWarning" class="text-red-400 text-sm hidden">⚠️ Large spread</span>
                                </div>
                            </div>
                        </div>

                        <!-- CF Multi-Judge Panel -->
                        <div id="cfMultiJudgePanel" class="hidden">
                            <p class="text-xs text-gray-500 mb-3">Enter each judge's formation count for CF events.</p>
                            <div class="grid grid-cols-5 gap-2 mb-3" id="cfJudgeInputs">
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J1</label>
                                    <input type="number" id="cfJ1" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateCfAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J2</label>
                                    <input type="number" id="cfJ2" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateCfAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J3</label>
                                    <input type="number" id="cfJ3" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateCfAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J4</label>
                                    <input type="number" id="cfJ4" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateCfAverage()">
                                </div>
                                <div class="text-center">
                                    <label class="text-xs text-gray-500">J5</label>
                                    <input type="number" id="cfJ5" min="0" max="99" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateCfAverage()">
                                </div>
                            </div>
                            <div class="flex items-center justify-between bg-gray-900 rounded p-3">
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-400 text-sm">Average:</span>
                                    <span id="cfJudgeAverage" class="text-2xl font-mono font-bold text-yellow-400">0.0</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <span class="text-gray-400 text-sm">Spread:</span>
                                    <span id="cfJudgeSpread" class="font-mono text-gray-300">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Artistic Events Multi-Judge Panel -->
                        <div id="artisticMultiJudgePanel" class="hidden">
                            <p class="text-xs text-gray-500 mb-3">Score Presentation (0-10), Technical (0-10), and Difficulty (0-2.5).</p>

                            <!-- Presentation Scores -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm font-medium">Presentation</span>
                                    <span class="text-xs text-gray-500">Execution, form, control</span>
                                </div>
                                <div class="grid grid-cols-5 gap-2 mb-2" id="artPresInputs">
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J1</label>
                                        <input type="number" id="artPresJ1" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J2</label>
                                        <input type="number" id="artPresJ2" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J3</label>
                                        <input type="number" id="artPresJ3" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J4</label>
                                        <input type="number" id="artPresJ4" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J5</label>
                                        <input type="number" id="artPresJ5" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                </div>
                                <div class="text-right text-sm">
                                    Avg: <span id="artPresAvg" class="text-cyan-400 font-mono font-bold">0.00</span>
                                </div>
                            </div>

                            <!-- Technical Scores -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm font-medium">Technical</span>
                                    <span class="text-xs text-gray-500">Variety, creativity, choreography</span>
                                </div>
                                <div class="grid grid-cols-5 gap-2 mb-2" id="artTechInputs">
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J1</label>
                                        <input type="number" id="artTechJ1" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J2</label>
                                        <input type="number" id="artTechJ2" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J3</label>
                                        <input type="number" id="artTechJ3" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J4</label>
                                        <input type="number" id="artTechJ4" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                    <div class="text-center">
                                        <label class="text-xs text-gray-500">J5</label>
                                        <input type="number" id="artTechJ5" min="0" max="10" step="0.1" class="w-full px-2 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    </div>
                                </div>
                                <div class="text-right text-sm">
                                    Avg: <span id="artTechAvg" class="text-cyan-400 font-mono font-bold">0.00</span>
                                </div>
                            </div>

                            <!-- Difficulty -->
                            <div class="mb-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-gray-300 text-sm font-medium">Difficulty</span>
                                    <span class="text-xs text-gray-500">0.0 - 2.5 (from difficulty sheet)</span>
                                </div>
                                <div class="flex items-center gap-4">
                                    <input type="number" id="artDifficulty" min="0" max="2.5" step="0.1" placeholder="0.0"
                                        class="w-24 px-3 py-2 rounded bg-gray-700 text-white text-center font-mono" onchange="calculateArtisticScores()">
                                    <span class="text-gray-500 text-sm">Based on declared difficulty</span>
                                </div>
                            </div>

                            <!-- Total Score -->
                            <div class="bg-gray-900 rounded p-4 mt-4">
                                <div class="grid grid-cols-4 gap-4 text-center">
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Presentation</div>
                                        <div id="artPresFinal" class="text-lg font-mono font-bold text-cyan-400">0.00</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Technical</div>
                                        <div id="artTechFinal" class="text-lg font-mono font-bold text-cyan-400">0.00</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">Difficulty</div>
                                        <div id="artDiffFinal" class="text-lg font-mono font-bold text-cyan-400">0.00</div>
                                    </div>
                                    <div>
                                        <div class="text-xs text-gray-500 mb-1">TOTAL</div>
                                        <div id="artTotalScore" class="text-2xl font-mono font-bold text-yellow-400">0.00</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Multi-Judge Score -->
                        <div id="multiJudgeSaveSection" class="hidden mt-4 pt-4 border-t border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <input type="text" id="multiJudgeRoundLabel" placeholder="Round #"
                                        class="w-24 px-3 py-1 rounded bg-gray-700 text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button onclick="saveMultiJudgeScore()" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                        Save Judge Panel Score
                                    </button>
                                </div>
                                <span id="multiJudgeSaveStatus" class="text-sm text-gray-500"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Wingsuit FlySight Upload (hidden by default) -->
                    <div id="wingsuitSection" class="hidden mt-4 pt-4 border-t border-gray-700">
                        <!-- Competition/Library Mode Toggle -->
                        <div class="flex items-center justify-between mb-3 pb-3 border-b border-gray-700">
                            <span class="text-gray-400 text-sm font-medium">Judging Mode</span>
                            <div class="flex items-center gap-4">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="wsMode" value="library" checked
                                        class="w-4 h-4 text-blue-600" onchange="updateWsMode()">
                                    <span class="text-gray-300 text-sm">Library (Practice)</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="wsMode" value="competition"
                                        class="w-4 h-4 text-green-600" onchange="updateWsMode()">
                                    <span class="text-gray-300 text-sm">Competition</span>
                                </label>
                            </div>
                        </div>
                        <div id="wsCompetitionWarning" class="hidden mb-3 p-2 bg-red-900/50 border border-red-700 rounded text-sm text-red-300">
                            ⚠️ Competition mode requires FlySight data. Please upload CSV file.
                        </div>
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm font-medium">FlySight Data</span>
                            <div class="flex items-center gap-2">
                                <label class="text-gray-500 text-xs">Ground Elev:</label>
                                <input type="number" id="groundElevation" placeholder="0"
                                    class="w-20 px-2 py-1 rounded bg-gray-700 text-white text-xs text-right"
                                    onchange="recalculateFlySight()">
                                <span class="text-gray-500 text-xs">m MSL</span>
                                <input type="file" id="flysightFile" accept=".csv" class="hidden" onchange="parseFlySight(event)">
                                <button onclick="document.getElementById('flysightFile').click()"
                                    class="px-3 py-1 rounded bg-blue-600 hover:bg-blue-700 text-sm">
                                    Upload CSV
                                </button>
                                <span id="flysightStatus" class="text-xs text-gray-500">No file loaded</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div class="bg-gray-900 rounded p-3">
                                <div class="text-gray-500 text-xs mb-1">Upper Boundary</div>
                                <div id="upperBoundary" class="font-mono text-white">-- ft</div>
                            </div>
                            <div class="bg-gray-900 rounded p-3">
                                <div class="text-gray-500 text-xs mb-1">Lower Boundary</div>
                                <div id="lowerBoundary" class="font-mono text-white">-- ft</div>
                            </div>
                            <div class="bg-gray-900 rounded p-3">
                                <div class="text-gray-500 text-xs mb-1">Working Time</div>
                                <div id="flysightWorkingTime" class="font-mono text-yellow-400 text-lg">--.- s</div>
                            </div>
                            <div class="bg-gray-900 rounded p-3">
                                <div class="text-gray-500 text-xs mb-1">Altitude Window</div>
                                <div id="altitudeWindow" class="font-mono text-white">7500 ft</div>
                            </div>
                        </div>

                        <!-- Lower Exit Rule Toggle -->
                        <div class="mt-3 flex items-center gap-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="lowerExitRule" checked
                                    class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500"
                                    onchange="recalculateFlySight()">
                                <span class="text-gray-400 text-sm">Lower exit rule (5000 ft window if exit ≤ 11,500 ft)</span>
                            </label>
                        </div>

                        <!-- FlySight Graph Button -->
                        <div id="flysightGraphSection" class="hidden mt-4">
                            <button onclick="openFlySightModal()"
                                class="w-full px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-sm font-medium">
                                📊 View Altitude Profile & Confirm Working Time
                            </button>
                        </div>
                    </div>

                    <!-- Wingsuit Compulsory Scoring (hidden by default) -->
                    <div id="wsCompulsorySection" class="hidden mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm font-medium">Compulsory Round Scoring</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-xs">Judges:</span>
                                <select id="wsCompJudgeCount" onchange="toggleWsCompJudgeMode()" class="px-2 py-1 rounded bg-gray-700 text-white text-xs">
                                    <option value="1" selected>Single</option>
                                    <option value="3">3 Panel</option>
                                </select>
                            </div>
                        </div>

                        <!-- Style Score -->
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">Style Score</span>
                            </div>
                            <div id="wsStyleSingleJudge" class="flex items-center gap-2">
                                <input type="number" id="wsStyleSingle" min="0" max="10" step="0.1" placeholder="Score"
                                    class="w-24 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsCompulsory()">
                                <span class="text-gray-400">=</span>
                                <span id="wsStyleAvgSingle" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                            <div id="wsStylePanelJudge" class="hidden flex items-center gap-2 flex-wrap">
                                <input type="number" id="wsStyleJ1" min="0" max="10" step="0.1" placeholder="J1"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsCompulsory()">
                                <input type="number" id="wsStyleJ2" min="0" max="10" step="0.1" placeholder="J2"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsCompulsory()">
                                <input type="number" id="wsStyleJ3" min="0" max="10" step="0.1" placeholder="J3"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsCompulsory()">
                                <span class="text-gray-400">=</span>
                                <span id="wsStyleAvg" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                            <div class="mt-2 flex items-center gap-2">
                                <span class="text-gray-500 text-xs">Maneuver Omissions (each -1.5 from style):</span>
                                <input type="number" id="wsManeuverOmissions" min="0" max="20" value="0"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsCompulsory()">
                            </div>
                        </div>

                        <!-- Grips -->
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">Grips</span>
                            </div>
                            <div class="grid grid-cols-3 gap-3 text-sm">
                                <div>
                                    <label class="text-gray-500 text-xs">Scoring Grips</label>
                                    <input type="number" id="wsGrips" min="0" max="50" value="0"
                                        class="w-full px-2 py-1 rounded bg-gray-700 text-white text-center" onchange="calculateWsCompulsory()">
                                </div>
                                <div>
                                    <label class="text-gray-500 text-xs">Grip Omissions (-1 each)</label>
                                    <input type="number" id="wsGripOmissions" min="0" max="50" value="0"
                                        class="w-full px-2 py-1 rounded bg-gray-700 text-white text-center" onchange="calculateWsCompulsory()">
                                </div>
                                <div>
                                    <label class="text-gray-500 text-xs">Infringements (0 pts)</label>
                                    <input type="number" id="wsInfringements" min="0" max="50" value="0"
                                        class="w-full px-2 py-1 rounded bg-gray-700 text-white text-center" onchange="calculateWsCompulsory()">
                                </div>
                            </div>
                            <div class="mt-2 text-right">
                                <span class="text-gray-400 text-sm">Grip Score: </span>
                                <span id="wsGripScore" class="text-yellow-400 font-bold">0</span>
                            </div>
                        </div>

                        <!-- NV Toggle -->
                        <div class="flex items-center justify-between">
                            <button onclick="toggleWsNV()" id="wsNvBtn" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                                NV Penalty
                            </button>
                            <div class="text-right">
                                <span class="text-gray-400">Final Style: </span>
                                <span id="wsFinalStyle" class="text-green-400 font-bold">0.0</span>
                                <span class="text-gray-500 mx-2">|</span>
                                <span class="text-gray-400">Final Grips: </span>
                                <span id="wsFinalGrips" class="text-green-400 font-bold">0</span>
                            </div>
                        </div>
                        <!-- Save Compulsory Score -->
                        <div class="mt-3 pt-3 border-t border-gray-700 flex items-center justify-between">
                            <input type="text" id="wsCompRoundLabel" placeholder="Round #"
                                class="w-24 px-3 py-1 rounded bg-gray-700 text-white text-sm">
                            <button onclick="saveWsCompulsoryScore()" class="px-4 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                Save Score
                            </button>
                        </div>
                    </div>

                    <!-- Wingsuit Free Round Scoring (hidden by default) -->
                    <div id="wsFreeSection" class="hidden mt-4 pt-4 border-t border-gray-700">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-gray-400 text-sm font-medium">Free Round Scoring</span>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-500 text-xs">Judges:</span>
                                <select id="wsFreeJudgeCount" onchange="toggleWsFreeJudgeMode()" class="px-2 py-1 rounded bg-gray-700 text-white text-xs">
                                    <option value="1" selected>Single</option>
                                    <option value="3">3 Panel</option>
                                </select>
                            </div>
                        </div>

                        <!-- Style Score -->
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">Style</span>
                            </div>
                            <div id="wsFreeStyleSingle" class="flex items-center gap-2">
                                <input type="number" id="wsFreeStyleSingleInput" min="0" max="10" step="0.1" placeholder="Score"
                                    class="w-24 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeStyleAvgSingle" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                            <div id="wsFreeStylePanel" class="hidden flex items-center gap-2 flex-wrap">
                                <input type="number" id="wsFreeStyleJ1" min="0" max="10" step="0.1" placeholder="J1"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeStyleJ2" min="0" max="10" step="0.1" placeholder="J2"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeStyleJ3" min="0" max="10" step="0.1" placeholder="J3"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeStyleAvg" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                        </div>

                        <!-- Dive Plan Score -->
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">Dive Plan</span>
                            </div>
                            <div id="wsFreeDiveSingle" class="flex items-center gap-2">
                                <input type="number" id="wsFreeDiveSingleInput" min="0" max="10" step="0.1" placeholder="Score"
                                    class="w-24 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeDiveAvgSingle" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                            <div id="wsFreeDivePanel" class="hidden flex items-center gap-2 flex-wrap">
                                <input type="number" id="wsFreeDiveJ1" min="0" max="10" step="0.1" placeholder="J1"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeDiveJ2" min="0" max="10" step="0.1" placeholder="J2"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeDiveJ3" min="0" max="10" step="0.1" placeholder="J3"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeDiveAvg" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                        </div>

                        <!-- Camerawork Score -->
                        <div class="bg-gray-900 rounded-lg p-3 mb-3">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-gray-400 text-sm">Camerawork</span>
                            </div>
                            <div id="wsFreeCamSingle" class="flex items-center gap-2">
                                <input type="number" id="wsFreeCamSingleInput" min="0" max="10" step="0.1" placeholder="Score"
                                    class="w-24 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeCamAvgSingle" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                            <div id="wsFreeCamPanel" class="hidden flex items-center gap-2 flex-wrap">
                                <input type="number" id="wsFreeCamJ1" min="0" max="10" step="0.1" placeholder="J1"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeCamJ2" min="0" max="10" step="0.1" placeholder="J2"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <input type="number" id="wsFreeCamJ3" min="0" max="10" step="0.1" placeholder="J3"
                                    class="w-16 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center" onchange="calculateWsFree()">
                                <span class="text-gray-400">=</span>
                                <span id="wsFreeCamAvg" class="text-yellow-400 font-bold">0.0</span>
                            </div>
                        </div>

                        <!-- NV Toggle and Totals -->
                        <div class="flex items-center justify-between">
                            <button onclick="toggleWsFreeNV()" id="wsFreeNvBtn" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                                NV Penalty
                            </button>
                            <div class="text-sm">
                                <span class="text-gray-400">Style: </span><span id="wsFreeStyleFinal" class="text-green-400 font-bold">0.0</span>
                                <span class="text-gray-500 mx-1">|</span>
                                <span class="text-gray-400">Dive: </span><span id="wsFreeDiveFinal" class="text-green-400 font-bold">0.0</span>
                                <span class="text-gray-500 mx-1">|</span>
                                <span class="text-gray-400">Cam: </span><span id="wsFreeCamFinal" class="text-green-400 font-bold">0.0</span>
                            </div>
                        </div>
                        <!-- Save Free Round Score -->
                        <div class="mt-3 pt-3 border-t border-gray-700 flex items-center justify-between">
                            <input type="text" id="wsFreeRoundLabel" placeholder="Round #"
                                class="w-24 px-3 py-1 rounded bg-gray-700 text-white text-sm">
                            <button onclick="saveWsFreeScore()" class="px-4 py-1 rounded bg-green-600 hover:bg-green-700 text-sm font-medium">
                                Save Score
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Video Info -->
                <div class="flex items-center gap-3 mb-4">
                    <h1 id="videoTitle" class="text-2xl font-bold">{{ video.title }}</h1>
                    {% if is_admin %}
                    <button onclick="showEditTitleModal()" class="text-gray-400 hover:text-blue-400" title="Rename video">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
                        </svg>
                    </button>
                    {% endif %}
                    {% if is_event_judge %}
                    <button onclick="startSyncViewing()" class="bg-purple-600 hover:bg-purple-700 px-3 py-1 rounded text-sm flex items-center gap-1" title="Start synchronized viewing with judges">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                        Sync View
                    </button>
                    {% endif %}
                </div>

                <div class="flex flex-wrap items-center gap-4 mb-6 text-gray-400">
                    <span class="bg-blue-600 text-white px-3 py-1 rounded">{{ category.abbrev }}</span>
                    {% if video.subcategory %}
                    <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded">{{ video.subcategory }}</span>
                    {% endif %}
                    {% if video.duration %}
                    <span>{{ video.duration }}</span>
                    {% endif %}
                    <span>{{ video.views }} views</span>
                    <span>{{ video.created_at[:10] }}</span>
                </div>

                {% if video.description %}
                <div class="bg-gray-800 rounded-lg p-6 mb-6">
                    <h2 class="font-semibold mb-3">Description</h2>
                    <p class="text-gray-300 whitespace-pre-line">{{ video.description }}</p>
                </div>
                {% endif %}

                {% if video.tags %}
                <div class="flex flex-wrap gap-2">
                    {% for tag in video.tags.split(',') %}
                    <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded-full text-sm">{{ tag.strip() }}</span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

        </div>
    </div>

    <footer class="bg-gray-800 mt-12 py-8">
        <div class="container mx-auto px-4 text-center text-gray-400">
            <p>Video Library - Competition footage for judges and competitors</p>
            <p class="text-sm mt-2 text-gray-500">Keyboard: Space = Play/Pause | ,/. = Frame step | ←/→ = 0.1s step | 1-4 = Speed (25%-100%) | H = Hide/Show Nav</p>
            <p class="text-sm mt-1 text-gray-500">Scoring: X = Start/Point (+1) | C = Bust (0 pts) | Q = Omission (-1) | P = →Point | B = →Bust | N = NV</p>
        </div>
    </footer>

    <!-- Vimeo Player SDK for embedded video control -->
    <script src="https://player.vimeo.com/api/player.js"></script>

    <script>
        const video = document.getElementById('videoPlayer');
        const isEmbeddedVideo = !video;
        const frameTime = 1/30; // ~0.033s for 30fps video (frame-by-frame)
        const smallStep = 0.1;  // 0.1s for arrow keys (more noticeable)

        // Initialize Vimeo player if embedded
        let vimeoPlayer = null;
        if (isEmbeddedVideo) {
            const iframe = document.getElementById('vimeoPlayer');
            if (iframe && iframe.src.includes('vimeo')) {
                vimeoPlayer = new Vimeo.Player(iframe);
            }
        }

        // Toggle navbar visibility
        let navHidden = false;
        function toggleNav() {
            const nav = document.getElementById('mainNav');
            const showBtn = document.getElementById('showNavBtn');
            navHidden = !navHidden;
            if (navHidden) {
                nav.style.marginTop = '-' + nav.offsetHeight + 'px';
                nav.style.opacity = '0';
                showBtn.classList.remove('hidden');
            } else {
                nav.style.marginTop = '0';
                nav.style.opacity = '1';
                showBtn.classList.add('hidden');
            }
        }

        // Frame stepping function
        function stepFrame(direction) {
            const step = frameTime * 2; // ~0.067s - two frames for better visibility
            if (video) {
                video.pause();
                const newTime = video.currentTime + (step * direction);
                video.currentTime = Math.max(0, Math.min(video.duration, newTime));
            } else if (vimeoPlayer) {
                vimeoPlayer.pause();
                vimeoPlayer.getCurrentTime().then(currentTime => {
                    vimeoPlayer.getDuration().then(duration => {
                        const newTime = Math.max(0, Math.min(duration, currentTime + (step * direction)));
                        vimeoPlayer.setCurrentTime(newTime);
                    });
                });
            }
        }

        // Make body focusable and focus it on load to receive keyboard events
        document.body.tabIndex = -1;
        document.body.focus();

        // For embedded videos, detect when iframe takes focus and help user regain it
        if (isEmbeddedVideo) {
            // Add pulse animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulse-hint {
                    0%, 100% { transform: scale(1); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
                    50% { transform: scale(1.05); box-shadow: 0 6px 12px rgba(59,130,246,0.5); }
                }
            `;
            document.head.appendChild(style);

            // Show keyboard hint message
            const keyboardHint = document.createElement('div');
            keyboardHint.id = 'keyboardHint';
            keyboardHint.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-4 py-2 rounded-lg shadow-lg text-sm z-50 transition-opacity duration-300';
            keyboardHint.innerHTML = 'Click here to enable keyboard shortcuts (X, C, Q)';
            keyboardHint.style.cursor = 'pointer';
            keyboardHint.onclick = () => {
                document.body.focus();
                keyboardHint.classList.add('opacity-50');
                keyboardHint.innerHTML = 'Keyboard shortcuts enabled!';
                setTimeout(() => {
                    keyboardHint.classList.remove('opacity-50');
                    keyboardHint.innerHTML = 'Click here to enable keyboard shortcuts (X, C, Q)';
                }, 2000);
            };
            document.body.appendChild(keyboardHint);

            // Detect when focus leaves the window (goes to iframe)
            window.addEventListener('blur', () => {
                keyboardHint.classList.remove('opacity-50');
                keyboardHint.style.animation = 'pulse-hint 1s ease-in-out infinite';
            });
            window.addEventListener('focus', () => {
                keyboardHint.style.animation = '';
            });
        }

        // Ensure keyboard shortcuts work - click anywhere outside inputs to enable
        document.body.addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
                // Blur any focused input to enable keyboard shortcuts
                if (document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'SELECT')) {
                    document.activeElement.blur();
                }
                // Also blur the video element if it has focus
                if (video) video.blur();
                // Focus body to receive keyboard events
                document.body.focus();
            }
        });

        // Intercept keyboard events directly on video element (for when video has focus)
        if (video) {
            video.addEventListener('keydown', (e) => {
                // Handle our custom shortcuts even when video is focused
                const handled = handleKeyboardShortcut(e);
                if (handled) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                // Also prevent default video behavior for arrow keys and space
                if (['Space', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown'].includes(e.code)) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            });

            // Prevent video from handling click to play/pause (we control via keyboard)
            video.addEventListener('click', (e) => {
                // Toggle play/pause on click
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });
        }

        // Video start time (set by videographer)
        let videoStartTime = {{ video.start_time|default(0, true) }};
        let workingTimeVideoStart = null; // Captured when judge first starts timer
        const videoId = '{{ video.id }}';

        // Apply start time when video loads (only for local videos)
        if (video) {
            video.addEventListener('loadedmetadata', () => {
                if (videoStartTime > 0 && video.currentTime < videoStartTime) {
                    video.currentTime = videoStartTime;
                }
            });
            // Check for replay auto-start when video time updates
            video.addEventListener('timeupdate', () => {
                if (typeof checkReplayAutoStart === 'function') {
                    checkReplayAutoStart(video.currentTime);
                }
            });
        }

        // Check for replay auto-start on Vimeo videos
        if (vimeoPlayer) {
            vimeoPlayer.on('timeupdate', (data) => {
                if (typeof checkReplayAutoStart === 'function') {
                    checkReplayAutoStart(data.seconds);
                }
            });
        }

        function goToStartTime() {
            if (video) {
                video.currentTime = videoStartTime;
            } else if (vimeoPlayer) {
                vimeoPlayer.setCurrentTime(videoStartTime);
            }
        }

        function setCurrentAsStart() {
            if (video) {
                const currentTime = parseFloat(video.currentTime.toFixed(2));
                videoStartTime = currentTime;
                document.getElementById('startTimeDisplay').textContent = currentTime + 's';
                saveStartTime(currentTime);
            } else if (vimeoPlayer) {
                vimeoPlayer.getCurrentTime().then(currentTime => {
                    const time = parseFloat(currentTime.toFixed(2));
                    videoStartTime = time;
                    document.getElementById('startTimeDisplay').textContent = time + 's';
                    saveStartTime(time);
                });
            }
        }

        function clearStartTime() {
            videoStartTime = 0;
            document.getElementById('startTimeDisplay').textContent = '0s';
            saveStartTime(0);
        }

        function saveStartTime(time) {
            const statusEl = document.getElementById('startTimeSaveStatus');
            statusEl.textContent = 'Saving...';
            statusEl.classList.remove('text-green-400', 'text-red-400');
            statusEl.classList.add('text-gray-500');

            fetch(`/api/video/${videoId}/set-start-time`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start_time: time })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusEl.textContent = 'Saved!';
                    statusEl.classList.remove('text-gray-500');
                    statusEl.classList.add('text-green-400');
                    setTimeout(() => { statusEl.textContent = ''; }, 2000);
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Failed to save');
                    statusEl.classList.remove('text-gray-500');
                    statusEl.classList.add('text-red-400');
                }
            })
            .catch(err => {
                statusEl.textContent = 'Error saving';
                statusEl.classList.remove('text-gray-500');
                statusEl.classList.add('text-red-400');
            });
        }

        // Playback speed control
        function setSpeed(speed) {
            // Track current speed for timer sync
            currentPlaybackSpeed = speed;

            // Set speed on local video element
            if (video) {
                video.playbackRate = speed;
            }
            // Set speed on Vimeo player
            if (vimeoPlayer) {
                vimeoPlayer.setPlaybackRate(speed).catch(err => {
                    console.log('Vimeo speed change not supported for this video');
                });
            }


            // Update button styles
            document.querySelectorAll('.speed-btn').forEach(btn => {
                if (parseFloat(btn.dataset.speed) === speed) {
                    btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                    btn.classList.add('bg-blue-600');
                } else {
                    btn.classList.remove('bg-blue-600');
                    btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                }
            });
        }

        // Click outside inputs to unfocus them for keyboard shortcuts
        document.getElementById('videoContainer').addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT') {
                document.activeElement.blur();
            }
        });

        // Keyboard controls - use capture phase to intercept before video element handles them
        window.addEventListener('keydown', (e) => {
            // Ignore if typing in an input or select
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                return;
            }

            // Handle our custom shortcuts
            const handled = handleKeyboardShortcut(e);
            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true); // true = capture phase

        function handleKeyboardShortcut(e) {
            // Video playback controls for local video
            if (video) {
                switch(e.code) {
                    case 'Space':
                        if (video.paused) {
                            video.play();
                        } else {
                            video.pause();
                        }
                        return true;
                    case 'ArrowLeft':
                        // Step back 0.1 seconds (more noticeable than single frame)
                        video.pause();
                        video.currentTime = Math.max(0, video.currentTime - smallStep);
                        return true;
                    case 'ArrowRight':
                        // Step forward 0.1 seconds
                        video.pause();
                        video.currentTime = Math.min(video.duration, video.currentTime + smallStep);
                        return true;
                    case 'Comma':
                        // Fine frame step backward (,)
                        stepFrame(-1);
                        return true;
                    case 'Period':
                        // Fine frame step forward (.)
                        stepFrame(1);
                        return true;
                }
            }

            // Vimeo player controls
            if (vimeoPlayer) {
                switch(e.code) {
                    case 'Space':
                        vimeoPlayer.getPaused().then(paused => {
                            if (paused) {
                                vimeoPlayer.play();
                            } else {
                                vimeoPlayer.pause();
                            }
                        });
                        return true;
                    case 'ArrowLeft':
                        vimeoPlayer.pause();
                        vimeoPlayer.getCurrentTime().then(t => {
                            vimeoPlayer.setCurrentTime(Math.max(0, t - smallStep));
                        });
                        return true;
                    case 'ArrowRight':
                        vimeoPlayer.pause();
                        vimeoPlayer.getCurrentTime().then(t => {
                            vimeoPlayer.getDuration().then(d => {
                                vimeoPlayer.setCurrentTime(Math.min(d, t + smallStep));
                            });
                        });
                        return true;
                    case 'Comma':
                        stepFrame(-1);
                        return true;
                    case 'Period':
                        stepFrame(1);
                        return true;
                }
            }

            // Speed controls work for both local and Vimeo
            switch(e.code) {
                case 'Digit1':
                    setSpeed(0.25);
                    return true;
                case 'Digit2':
                    setSpeed(0.5);
                    return true;
                case 'Digit3':
                    setSpeed(0.75);
                    return true;
                case 'Digit4':
                    setSpeed(1);
                    return true;
            }

            // Scoring controls - work for all videos (including embedded)
            switch(e.code) {
                case 'KeyX':
                    // Check if in sync mode
                    if (isSyncMode && currentSyncState === 'playing') {
                        // In sync mode, X marks working time start - send to server for validation
                        sendXPress();
                        return true;
                    }

                    if (isCountUpEvent) {
                        // Wingsuit: First X starts timer, subsequent X adds points
                        if (!timerRunning) {
                            startTimer();
                        } else {
                            addScore('x');
                        }
                    } else if (timerRunning) {
                        // Score a point while timer is running
                        addScore('x');
                    } else {
                        // Start timer when not running
                        startTimer();
                    }
                    return true;
                case 'KeyC':
                    addScore('c');
                    return true;
                case 'KeyQ':
                    addScore('q');
                    return true;
                case 'KeyP':
                    bustToPoint();
                    return true;
                case 'KeyB':
                    pointToBust();
                    return true;
                case 'KeyN':
                    toggleNV();
                    return true;
                case 'KeyH':
                    toggleNav();
                    return true;
                default:
                    return false;
            }
        }

        // Scoring functionality
        let scoringTimeline = [];
        let scoringTypes = []; // Track actual types for corrections
        let scoringTimes = []; // Track timestamps relative to timer start
        let timerStartTime = 0; // When timer was started
        let xCount = 0;
        let cCount = 0;
        let qCount = 0;
        let nvPenalty = false;

        // Panel mode variables
        let panelSize = 1; // 1 = solo, 3 = 3-judge panel, 5 = 5-judge panel
        let currentJudge = 1; // Which judge is currently scoring (1-based)
        let panelVotes = []; // Array of arrays: panelVotes[position][judgeIndex] = 'x'|'c'|'q'|null
        let judgeNames = ['Judge 1', 'Judge 2', 'Judge 3', 'Judge 4', 'Judge 5']; // Custom judge names

        function updatePanelMode() {
            panelSize = parseInt(document.getElementById('panelSize').value);
            const judgeLabel = document.getElementById('currentJudgeLabel');
            const judgeNamesRow = document.getElementById('judgeNamesRow');
            const syncPanelRow = document.getElementById('syncPanelRow');
            const myJudgeNumSelect = document.getElementById('myJudgeNum');

            if (panelSize > 1) {
                currentJudge = 1;
                judgeLabel.textContent = getJudgeName(0);
                judgeLabel.classList.remove('hidden');
                judgeNamesRow.classList.remove('hidden');
                syncPanelRow.classList.remove('hidden');

                // Update "I am Judge X" options based on panel size
                myJudgeNumSelect.innerHTML = '';
                for (let i = 1; i <= panelSize; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = `I am Judge ${i}`;
                    myJudgeNumSelect.appendChild(opt);
                }

                // Show/hide judge name dropdowns based on panel size
                for (let i = 1; i <= 5; i++) {
                    const select = document.getElementById('judgeName' + i);
                    if (i <= panelSize) {
                        select.classList.remove('hidden');
                    } else {
                        select.classList.add('hidden');
                        select.value = ''; // Clear hidden selections
                    }
                }

                // Reset judge selections when changing panel mode
                resetJudgeSelections();
            } else {
                judgeLabel.classList.add('hidden');
                judgeNamesRow.classList.add('hidden');
                syncPanelRow.classList.add('hidden');
                // Leave sync session if connected
                if (syncSocket && syncSessionId) {
                    leaveSyncSession();
                }
            }

            // Reset scoring when changing panel mode
            clearScoring();
        }

        function updateJudgeNames() {
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById('judgeName' + i);
                const name = select.value.trim();
                judgeNames[i - 1] = name || ('Judge ' + i);
            }
            // Update current judge label
            if (panelSize > 1) {
                document.getElementById('currentJudgeLabel').textContent = getJudgeName(currentJudge - 1);
            }
            updateScoringDisplay();
        }

        function updateJudgeSelection(changedIndex) {
            // Get all currently selected values
            const selectedValues = [];
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById('judgeName' + i);
                if (select.value && i !== changedIndex) {
                    selectedValues.push(select.value);
                }
            }

            // Update all dropdowns to disable already-selected options
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById('judgeName' + i);
                const currentValue = select.value;

                // Enable/disable options based on what's selected in other dropdowns
                for (let option of select.options) {
                    if (option.value === '') continue; // Skip placeholder
                    if (option.value === currentValue) {
                        option.disabled = false; // Keep current selection enabled
                    } else {
                        option.disabled = selectedValues.includes(option.value);
                    }
                }
            }

            // Update judge names array
            updateJudgeNames();
        }

        function resetJudgeSelections() {
            // Reset all dropdowns and enable all options
            for (let i = 1; i <= 5; i++) {
                const select = document.getElementById('judgeName' + i);
                select.value = '';
                for (let option of select.options) {
                    option.disabled = false;
                }
            }
            judgeNames = ['Judge 1', 'Judge 2', 'Judge 3', 'Judge 4', 'Judge 5'];
        }

        function getJudgeName(index) {
            return judgeNames[index] || ('Judge ' + (index + 1));
        }

        // ============================================
        // SYNC PANEL SESSION FUNCTIONS
        // ============================================
        let syncSocket = null;
        let syncSessionId = null;
        let myJudgeNumber = 1;
        let isSyncMode = false;
        let isEventJudgeSession = false; // True if current user is the event judge who created the session

        function initSyncSocket() {
            if (syncSocket) return;

            // Connect to the same origin (works for both localhost and production)
            const socketUrl = window.location.origin;
            syncSocket = io(socketUrl, {
                transports: ['websocket', 'polling'],
                reconnection: true,
                reconnectionAttempts: 5,
                reconnectionDelay: 1000
            });

            syncSocket.on('connect', () => {
                console.log('Connected to sync server at', socketUrl);
                showSyncStatus('Connected to server');
            });

            syncSocket.on('connect_error', (error) => {
                console.error('Connection error:', error);
                showSyncStatus('Connection error - retrying...');
            });

            syncSocket.on('disconnect', (reason) => {
                console.log('Disconnected:', reason);
                showSyncStatus('Disconnected from server');
            });

            syncSocket.on('panel_session_created', (data) => {
                syncSessionId = data.session_id;
                document.getElementById('syncSessionId').textContent = data.session_id;
                document.getElementById('copySessionIdBtn').classList.remove('hidden');
                document.getElementById('syncNotConnected').classList.add('hidden');
                document.getElementById('syncConnected').classList.remove('hidden');
                isSyncMode = true;
                isEventJudgeSession = true;
                updateSyncState(data.state);
                showSyncStatus(`Session created! Share ID with panel judges.`);

                // Show prominent session ID dialog
                showSessionIdDialog(data.session_id);
            });

            syncSocket.on('panel_joined', (data) => {
                syncSessionId = data.session_id;
                document.getElementById('syncSessionId').textContent = data.session_id;
                document.getElementById('syncNotConnected').classList.add('hidden');
                document.getElementById('syncConnected').classList.remove('hidden');
                isSyncMode = true;
                updateSyncJudgesList(data.judges);
                updateSyncState(data.state);
                showSyncStatus(`Joined as Judge ${myJudgeNumber}. Click Ready when prepared.`);
            });

            syncSocket.on('panel_update', (data) => {
                updateSyncJudgesList(data.judges);
                if (data.state) updateSyncState(data.state);
                if (data.message) showSyncStatus(data.message);
            });

            syncSocket.on('panel_state_change', (data) => {
                updateSyncState(data.state);
                showSyncStatus(data.message);
            });

            syncSocket.on('panel_video_start', (data) => {
                // Event judge started video - start playback for all
                showSyncStatus(data.message);
                updateSyncState('playing');

                // Start video playback
                if (video) {
                    video.currentTime = data.video_time || videoStartTime || 0;
                    video.play();
                }
                if (vimeoPlayer) {
                    vimeoPlayer.setCurrentTime(data.video_time || videoStartTime || 0).then(() => {
                        vimeoPlayer.play();
                    });
                }
            });

            syncSocket.on('panel_x_received', (data) => {
                showSyncStatus(`Judge ${data.judge_num} pressed X (${data.x_presses.length}/${panelSize})`);
            });

            syncSocket.on('panel_working_time_accepted', (data) => {
                // All judges pressed X within tolerance - start timer!
                showSyncStatus(data.message);
                updateSyncState('scoring');
                if (!timerRunning) {
                    // Don't call startTimer() directly - it would broadcast again
                    // Instead, start the timer locally
                    timerRunning = true;
                    elapsedTime = 0;
                    timerStartTime = Date.now();
                    startCountdownTimer();
                }
            });

            syncSocket.on('panel_working_time_rejected', (data) => {
                // X press spread too large - reset!
                alert(`Working time sync failed!\n\nSpread: ${data.spread.toFixed(2)}s\nTolerance: ${data.tolerance}s\n\nVideo will reset. All judges must be ready again.`);
                showSyncStatus(data.message);

                // Pause and reset video
                if (video) {
                    video.pause();
                    video.currentTime = videoStartTime || 0;
                }
                if (vimeoPlayer) {
                    vimeoPlayer.pause();
                    vimeoPlayer.setCurrentTime(videoStartTime || 0);
                }

                updateSyncState('reset_required');
            });

            syncSocket.on('panel_session_reset', (data) => {
                showSyncStatus(data.message);
                updateSyncState(data.state);

                // Reset video
                if (video) {
                    video.pause();
                    video.currentTime = videoStartTime || 0;
                }
                if (vimeoPlayer) {
                    vimeoPlayer.pause();
                    vimeoPlayer.setCurrentTime(videoStartTime || 0);
                }

                // Clear scores
                clearScoring();
            });

            syncSocket.on('panel_score_update', (data) => {
                const { position, judge_num, score_type, votes } = data;

                // Update panel votes
                while (panelVotes.length <= position) {
                    panelVotes.push(new Array(panelSize).fill(null));
                    scoringTypes.push(null);
                    scoringTimes.push(data.timestamp || '--');
                }
                panelVotes[position][judge_num - 1] = score_type;

                // Recalculate majority
                const majority = getMajorityVote(panelVotes[position]);
                scoringTypes[position] = majority;

                recalculatePanelCounts();
                updateScoringDisplay();
            });

            syncSocket.on('panel_timer_stopped', (data) => {
                if (timerRunning) {
                    stopTimer();
                }
                updateSyncState('review');
                showSyncStatus('Working time ended - review scores');
            });

            syncSocket.on('panel_error', (data) => {
                alert(data.error);
            });
        }

        let currentSyncState = 'waiting_for_judges';

        function updateSyncState(state) {
            currentSyncState = state;
            const stateDisplay = document.getElementById('syncStateDisplay');
            const readyBtn = document.getElementById('syncReadyBtn');
            const startVideoBtn = document.getElementById('syncStartVideoBtn');
            const resetBtn = document.getElementById('syncResetBtn');

            if (!stateDisplay) return;

            // Update state display
            const stateLabels = {
                'waiting_for_judges': 'Waiting for judges to join...',
                'waiting_for_ready': 'Waiting for judges to confirm ready',
                'all_ready': 'All judges ready - start video',
                'playing': 'Video playing - press X at working time',
                'scoring': 'Scoring in progress',
                'review': 'Review scores',
                'reset_required': 'Reset required - sync failed'
            };
            stateDisplay.textContent = stateLabels[state] || state;

            // Show/hide buttons based on state and role
            if (readyBtn) {
                readyBtn.classList.toggle('hidden', state !== 'waiting_for_ready' || isEventJudgeSession);
            }
            if (startVideoBtn) {
                startVideoBtn.classList.toggle('hidden', state !== 'all_ready' || !isEventJudgeSession);
            }
            if (resetBtn) {
                resetBtn.classList.toggle('hidden', state !== 'reset_required' || !isEventJudgeSession);
            }
        }

        function markJudgeReady() {
            if (syncSocket && syncSessionId) {
                syncSocket.emit('panel_judge_ready', {
                    session_id: syncSessionId,
                    judge_num: myJudgeNumber
                });
                showSyncStatus('Marked as ready!');
            }
        }

        function eventJudgeStartVideo() {
            if (syncSocket && syncSessionId && isEventJudgeSession) {
                const startTime = videoStartTime || 0;
                syncSocket.emit('panel_start_video', {
                    session_id: syncSessionId,
                    video_time: Math.max(0, startTime - 3) // Start 3 seconds before working time
                });
            }
        }

        function eventJudgeReset() {
            if (syncSocket && syncSessionId && isEventJudgeSession) {
                syncSocket.emit('panel_reset', {
                    session_id: syncSessionId
                });
            }
        }

        function sendXPress() {
            if (syncSocket && syncSessionId && currentSyncState === 'playing') {
                syncSocket.emit('panel_x_press', {
                    session_id: syncSessionId,
                    judge_num: myJudgeNumber,
                    press_time: Date.now() / 1000  // Send as seconds
                });
            }
        }

        function updateSyncRoleUI() {
            const role = document.getElementById('syncRoleSelect').value;
            const eventControls = document.getElementById('eventJudgeControls');
            const panelControls = document.getElementById('panelJudgeControls');

            if (role === 'event') {
                eventControls.classList.remove('hidden');
                panelControls.classList.add('hidden');
            } else {
                eventControls.classList.add('hidden');
                panelControls.classList.remove('hidden');
            }
        }

        function createSyncSession() {
            initSyncSocket();
            // Event judge is not a scoring judge, they just run the session
            myJudgeNumber = 0; // 0 = event judge (not scoring)

            syncSocket.emit('create_panel_session', {
                video_id: videoId,
                panel_size: panelSize,
                judge_name: 'Event Judge',
                judge_num: 0
            });
        }

        function showSessionIdDialog(sessionId) {
            // Create modal dialog to show session ID prominently
            const modal = document.createElement('div');
            modal.id = 'sessionIdModal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-lg mx-4 shadow-2xl">
                    <div class="text-center mb-4">
                        <span class="text-4xl">🔗</span>
                    </div>
                    <h3 class="text-xl font-bold text-white text-center mb-2">Session Created!</h3>
                    <p class="text-gray-300 text-center mb-4">Share this Session ID with your panel judges:</p>
                    <div class="bg-gray-900 rounded-lg p-4 mb-4">
                        <div class="text-center">
                            <span id="modalSessionId" class="text-2xl font-mono text-yellow-400 select-all">${sessionId}</span>
                        </div>
                    </div>
                    <div class="flex gap-3 justify-center">
                        <button onclick="copySessionIdFromModal('${sessionId}')" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium">
                            Copy ID
                        </button>
                        <button onclick="document.getElementById('sessionIdModal').remove()" class="px-6 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg font-medium">
                            Close
                        </button>
                    </div>
                    <p class="text-gray-500 text-xs text-center mt-4">Panel judges enter this ID to join the scoring session</p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function copySessionIdFromModal(sessionId) {
            navigator.clipboard.writeText(sessionId).then(() => {
                const btn = event.target;
                btn.textContent = 'Copied!';
                btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                btn.classList.add('bg-green-600');
                setTimeout(() => {
                    btn.textContent = 'Copy ID';
                    btn.classList.remove('bg-green-600');
                    btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            }).catch(() => {
                // Fallback
                const input = document.createElement('input');
                input.value = sessionId;
                document.body.appendChild(input);
                input.select();
                document.execCommand('copy');
                document.body.removeChild(input);
                alert('Session ID copied: ' + sessionId);
            });
        }

        function copySessionId() {
            const sessionId = syncSessionId;
            if (sessionId) {
                navigator.clipboard.writeText(sessionId).then(() => {
                    showSyncStatus('Session ID copied! Share with panel judges.');
                }).catch(() => {
                    // Fallback for older browsers
                    const input = document.createElement('input');
                    input.value = sessionId;
                    document.body.appendChild(input);
                    input.select();
                    document.execCommand('copy');
                    document.body.removeChild(input);
                    showSyncStatus('Session ID copied! Share with panel judges.');
                });
            }
        }

        function joinSyncSession() {
            const sessionId = document.getElementById('joinSessionId').value.trim();
            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            initSyncSocket();
            myJudgeNumber = parseInt(document.getElementById('myJudgeNum').value);
            const judgeName = judgeNames[myJudgeNumber - 1] || `Judge ${myJudgeNumber}`;

            syncSocket.emit('join_panel_session', {
                session_id: sessionId,
                judge_name: judgeName,
                judge_num: myJudgeNumber
            });
        }

        function leaveSyncSession() {
            if (syncSocket && syncSessionId) {
                syncSocket.emit('leave_panel_session', {
                    session_id: syncSessionId,
                    judge_num: myJudgeNumber
                });
            }

            syncSessionId = null;
            isSyncMode = false;
            document.getElementById('syncSessionId').textContent = 'Not connected';
            document.getElementById('syncNotConnected').classList.remove('hidden');
            document.getElementById('syncConnected').classList.add('hidden');
            document.getElementById('syncStatus').classList.add('hidden');
        }

        function updateSyncJudgesList(judges) {
            const container = document.getElementById('syncJudgesList');
            let html = '';
            for (let i = 1; i <= panelSize; i++) {
                const judge = judges[i];
                const connected = judge && judge.connected;
                const name = judge ? judge.name : `J${i}`;
                const isMe = i === myJudgeNumber;
                html += `<span class="px-2 py-1 rounded text-xs ${connected ? 'bg-green-600' : 'bg-gray-600'} ${isMe ? 'ring-2 ring-yellow-400' : ''}">${name}</span>`;
            }
            container.innerHTML = html;
        }

        function showSyncStatus(message) {
            const statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
            setTimeout(() => {
                statusEl.classList.add('hidden');
            }, 3000);
        }

        // Override addScore to sync with other judges
        const originalAddScore = addScore;
        addScore = function(type) {
            // Call original function
            originalAddScore(type);

            // If in sync mode, broadcast to other judges
            if (isSyncMode && syncSocket && syncSessionId) {
                const position = scoringTypes.length - 1;
                const timestamp = scoringTimes[position];

                syncSocket.emit('panel_score', {
                    session_id: syncSessionId,
                    judge_num: myJudgeNumber,
                    score_type: type,
                    position: position,
                    timestamp: timestamp
                });
            }
        };

        // Override startTimer to sync with other judges
        const originalStartTimer = startTimer;
        startTimer = function() {
            originalStartTimer();

            // If in sync mode, broadcast to other judges
            if (isSyncMode && syncSocket && syncSessionId) {
                syncSocket.emit('panel_start_timer', {
                    session_id: syncSessionId
                });
            }
        };

        function nextJudge() {
            if (panelSize > 1) {
                currentJudge = (currentJudge % panelSize) + 1;
                document.getElementById('currentJudgeLabel').textContent = getJudgeName(currentJudge - 1);
            }
        }

        function getMajorityVote(votes) {
            // Count votes for each type
            const counts = { x: 0, c: 0, q: 0 };
            votes.forEach(v => {
                if (v && counts.hasOwnProperty(v)) counts[v]++;
            });

            // Find majority (more than half)
            const threshold = Math.floor(votes.filter(v => v).length / 2) + 1;
            if (counts.x >= threshold) return 'x';
            if (counts.c >= threshold) return 'c';
            if (counts.q >= threshold) return 'q';

            // No clear majority - return the highest count (tie goes to x > c > q)
            if (counts.x >= counts.c && counts.x >= counts.q) return 'x';
            if (counts.c >= counts.q) return 'c';
            return 'q';
        }

        function addScore(type) {
            // Record timestamp relative to working time (uses elapsedTime which is scaled by playback speed)
            let timestamp = '--';
            if (timerRunning && elapsedTime > 0) {
                timestamp = (elapsedTime / 1000).toFixed(1);
            }

            if (panelSize === 1) {
                // Solo mode - simple scoring
                scoringTypes.push(type);
                scoringTimes.push(timestamp);

                if (type === 'x') xCount++;
                else if (type === 'c') cCount++;
                else if (type === 'q') qCount++;
            } else {
                // Panel mode - track votes per judge
                const posIndex = scoringTypes.length;

                // Check if this is a new position or adding to existing
                if (currentJudge === 1) {
                    // New position
                    scoringTypes.push(type); // Will be updated with majority
                    scoringTimes.push(timestamp);
                    panelVotes.push(new Array(panelSize).fill(null));
                    panelVotes[posIndex][0] = type;
                } else {
                    // Adding vote to current position
                    const currentPos = panelVotes.length - 1;
                    if (currentPos >= 0) {
                        panelVotes[currentPos][currentJudge - 1] = type;

                        // Calculate majority and update scoringTypes
                        const majority = getMajorityVote(panelVotes[currentPos]);
                        scoringTypes[currentPos] = majority;
                    }
                }

                // Move to next judge
                nextJudge();

                // Recalculate counts based on majority votes
                recalculatePanelCounts();
            }

            updateScoringDisplay();
        }

        function recalculatePanelCounts() {
            xCount = 0;
            cCount = 0;
            qCount = 0;

            scoringTypes.forEach(type => {
                if (type === 'x') xCount++;
                else if (type === 'c') cCount++;
                else if (type === 'q') qCount++;
            });
        }

        function changeScoreType(index, newType) {
            const oldType = scoringTypes[index];
            if (oldType === newType) return;

            // Update counts
            if (oldType === 'x') xCount--;
            else if (oldType === 'c') cCount--;
            else if (oldType === 'q') qCount--;

            if (newType === 'x') xCount++;
            else if (newType === 'c') cCount++;
            else if (newType === 'q') qCount++;

            scoringTypes[index] = newType;
            updateScoringDisplay();
        }

        function showScoreEditMenu(index, event) {
            event.stopPropagation();
            // Remove any existing menus
            const existingMenu = document.getElementById('scoreEditMenu');
            if (existingMenu) existingMenu.remove();

            const currentType = scoringTypes[index];
            const timestamp = scoringTimes[index];
            const menu = document.createElement('div');
            menu.id = 'scoreEditMenu';
            menu.className = 'absolute bg-gray-800 rounded-lg shadow-xl p-3 z-50 min-w-[200px]';
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';

            // Get score type label
            const typeLabels = { x: 'Point', c: 'Bust', q: 'Omission' };
            const typeColors = { x: 'text-green-400', c: 'text-red-400', q: 'text-orange-400' };

            const options = [
                { type: 'x', label: 'Point (X)', color: 'text-green-400' },
                { type: 'c', label: 'Bust (C)', color: 'text-red-400' },
                { type: 'q', label: 'Omission (Q)', color: 'text-orange-400' }
            ];

            menu.innerHTML = `
                <div class="mb-2 pb-2 border-b border-gray-600">
                    <div class="text-xs text-gray-400 mb-1">Position ${index + 1}</div>
                    <div class="flex justify-between items-center">
                        <span class="font-bold ${typeColors[currentType]}">${typeLabels[currentType]}</span>
                        <span class="text-cyan-400 font-mono">${timestamp}s</span>
                    </div>
                </div>
                <button onclick="watchFromScore(${index}); document.getElementById('scoreEditMenu').remove();"
                    class="block w-full text-left px-3 py-2 rounded bg-blue-600 hover:bg-blue-700 text-sm text-white mb-2">
                    ▶ Watch (from ${Math.max(0, parseFloat(timestamp) - 2).toFixed(1)}s)
                </button>
                <div class="text-xs text-gray-400 mb-1">Change to:</div>
                ${options.map(opt => `
                    <button onclick="changeScoreType(${index}, '${opt.type}'); document.getElementById('scoreEditMenu').remove();"
                        class="block w-full text-left px-3 py-1 rounded hover:bg-gray-600 text-sm ${opt.type === currentType ? 'bg-gray-600' : ''} ${opt.color}">
                        ${opt.label}
                    </button>
                `).join('')}
                <button onclick="deleteScore(${index}); document.getElementById('scoreEditMenu').remove();"
                    class="block w-full text-left px-3 py-2 rounded bg-red-600 hover:bg-red-700 text-sm text-white mt-2">
                    Remove Point
                </button>
            `;

            document.body.appendChild(menu);

            // Adjust position if menu goes off screen
            const rect = menu.getBoundingClientRect();
            if (rect.right > window.innerWidth) {
                menu.style.left = (window.innerWidth - rect.width - 10) + 'px';
            }
            if (rect.bottom > window.innerHeight) {
                menu.style.top = (window.innerHeight - rect.height - 10) + 'px';
            }

            // Close menu when clicking elsewhere
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    const m = document.getElementById('scoreEditMenu');
                    if (m) m.remove();
                    document.removeEventListener('click', closeMenu);
                });
            }, 10);
        }

        function watchFromScore(index) {
            const timestamp = parseFloat(scoringTimes[index]);
            if (isNaN(timestamp)) return;

            // Calculate start time (2 seconds before the score, plus video start time offset)
            const watchTime = Math.max(0, (videoStartTime || 0) + timestamp - 2);

            // Hide freeze overlay if visible
            const overlay = document.getElementById('freezeOverlay');
            if (overlay) overlay.classList.add('hidden');

            // Jump to position and play
            if (video) {
                video.currentTime = watchTime;
                video.play();
            } else if (vimeoPlayer) {
                vimeoPlayer.setCurrentTime(watchTime).then(() => {
                    vimeoPlayer.play();
                });
            }
        }

        function deleteScore(index) {
            const type = scoringTypes[index];
            if (type === 'x') xCount--;
            else if (type === 'c') cCount--;
            else if (type === 'q') qCount--;

            scoringTypes.splice(index, 1);
            scoringTimes.splice(index, 1);
            updateScoringDisplay();
        }

        function bustToPoint() {
            // Find last bust (c or q) and convert to point
            for (let i = scoringTypes.length - 1; i >= 0; i--) {
                if (scoringTypes[i] === 'q' || scoringTypes[i] === 'c') {
                    if (scoringTypes[i] === 'q') {
                        qCount--;
                    } else {
                        cCount--;
                    }
                    scoringTypes[i] = 'x';
                    scoringTimeline[i] = '<span class="text-purple-400">-</span>'; // Purple to show correction
                    xCount++;
                    updateScoringDisplay();
                    return;
                }
            }
        }

        function pointToBust() {
            // Find last point (x) and convert to bust
            for (let i = scoringTypes.length - 1; i >= 0; i--) {
                if (scoringTypes[i] === 'x') {
                    xCount--;
                    scoringTypes[i] = 'c';
                    scoringTimeline[i] = '<span class="text-yellow-400">0</span>'; // Yellow to show correction
                    cCount++;
                    updateScoringDisplay();
                    return;
                }
            }
        }

        function toggleNV() {
            nvPenalty = !nvPenalty;
            const nvBtn = document.getElementById('nvBtn');
            const nvIndicator = document.getElementById('nvIndicator');

            if (nvPenalty) {
                nvBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                nvBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                nvIndicator.classList.remove('hidden');
            } else {
                nvBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                nvBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                nvIndicator.classList.add('hidden');
            }
            updateScoringDisplay();
        }

        function updateScoringDisplay() {
            const timeline = document.getElementById('scoringTimeline');
            if (scoringTypes.length === 0) {
                const modeText = panelSize > 1 ? `Panel mode (${panelSize} judges) - J${currentJudge} scoring...` : 'Press X, C, or Q to score...';
                timeline.innerHTML = `<span class="text-gray-500">${modeText}</span>`;
            } else {
                // Generate clickable timeline with count numbers on top
                const timelineHtml = scoringTypes.map((type, idx) => {
                    let display, color, bgColor;
                    if (type === 'x') {
                        display = '-';
                        color = 'text-green-400';
                        bgColor = 'hover:bg-green-900';
                    } else if (type === 'c') {
                        display = '0';
                        color = 'text-red-400';
                        bgColor = 'hover:bg-red-900';
                    } else {
                        display = 'x';
                        color = 'text-orange-400';
                        bgColor = 'hover:bg-orange-900';
                    }
                    const time = scoringTimes[idx];
                    const count = idx + 1; // 1-based count

                    // Panel mode - show individual judge votes
                    let panelInfo = '';
                    if (panelSize > 1 && panelVotes[idx]) {
                        const votes = panelVotes[idx].map((v, j) => {
                            if (!v) return `<span class="text-gray-600">·</span>`;
                            const vColor = v === 'x' ? 'text-green-400' : (v === 'c' ? 'text-red-400' : 'text-orange-400');
                            const vDisplay = v === 'x' ? '-' : (v === 'c' ? '0' : 'x');
                            return `<span class="${vColor}">${vDisplay}</span>`;
                        }).join('');
                        panelInfo = `<span class="text-[9px] leading-none flex gap-px">${votes}</span>`;
                    }

                    return `<span class="cursor-pointer px-1 rounded ${color} ${bgColor} relative inline-flex flex-col items-center" onclick="showScoreEditMenu(${idx}, event)" title="Click to edit (${time}s)">
                        <span class="text-[10px] text-gray-400 leading-none">${count}</span>
                        <span class="leading-none text-xl">${display}</span>
                        ${panelInfo}
                    </span>`;
                }).join(' ');
                timeline.innerHTML = timelineHtml;
            }

            document.getElementById('xCount').textContent = xCount;
            document.getElementById('cCount').textContent = cCount;
            document.getElementById('qCount').textContent = qCount;

            const calculatedTotal = xCount - qCount;
            const total = nvPenalty ? 0 : calculatedTotal;
            document.getElementById('totalScore').textContent = total;

            // Color the total based on value
            const totalEl = document.getElementById('totalScore');
            totalEl.classList.remove('text-yellow-400', 'text-green-400', 'text-red-400');
            if (nvPenalty) {
                totalEl.classList.add('text-red-400');
            } else if (total > 0) {
                totalEl.classList.add('text-green-400');
            } else if (total < 0) {
                totalEl.classList.add('text-red-400');
            } else {
                totalEl.classList.add('text-yellow-400');
            }

            // Update score comparison with max points
            updateScoreComparison();
        }

        function clearScoring() {
            scoringTimeline = [];
            scoringTypes = [];
            scoringTimes = [];
            timerStartTime = 0;
            xCount = 0;
            cCount = 0;
            qCount = 0;
            nvPenalty = false;
            // Reset panel mode
            panelVotes = [];
            currentJudge = 1;
            if (panelSize > 1) {
                document.getElementById('currentJudgeLabel').textContent = 'J1';
            }
            document.getElementById('nvBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
            document.getElementById('nvBtn').classList.add('bg-gray-700', 'hover:bg-gray-600');
            document.getElementById('nvIndicator').classList.add('hidden');
            document.getElementById('saveScoreSection').classList.add('hidden');
            // Reset summary display
            document.getElementById('freezeTimeDisplay').classList.remove('hidden');
            document.getElementById('scoreSummaryTable').classList.add('hidden');
            updateScoringDisplay();
        }

        // Score confirmation and summary functions
        function showScoreConfirmation() {
            document.getElementById('freezeTimeDisplay').classList.add('hidden');
            document.getElementById('scoreSummaryTable').classList.remove('hidden');
            generateScoreSummaryTable();
        }

        function hideScoreSummary() {
            document.getElementById('freezeTimeDisplay').classList.remove('hidden');
            document.getElementById('scoreSummaryTable').classList.add('hidden');
            const overlayEl = document.getElementById('freezeOverlay');
            if (overlayEl) overlayEl.classList.add('hidden');
        }

        function saveAndCloseSummary() {
            // Save the score
            showSaveScoreSection();
            // Hide the overlay
            const overlayEl = document.getElementById('freezeOverlay');
            if (overlayEl) overlayEl.classList.add('hidden');
            document.getElementById('freezeTimeDisplay').classList.remove('hidden');
            document.getElementById('scoreSummaryTable').classList.add('hidden');
        }

        function generateScoreSummaryTable() {
            const table = document.getElementById('scoreSummaryContent');
            const numPositions = scoringTypes.length;

            if (numPositions === 0) {
                table.innerHTML = '<tr><td class="text-gray-400 text-center py-4">No scores recorded</td></tr>';
                document.getElementById('summaryTotal').textContent = 'Total: 0';
                return;
            }

            let html = '';

            // Summary stats at top
            html += '<tr class="bg-gray-800/50">';
            html += '<td colspan="100%" class="py-3 px-4">';
            html += '<div class="flex justify-center gap-8 text-lg">';
            html += `<span class="text-green-400"><strong>${xCount}</strong> Points</span>`;
            html += `<span class="text-red-400"><strong>${cCount}</strong> Busts</span>`;
            html += `<span class="text-orange-400"><strong>${qCount}</strong> Omissions</span>`;
            html += '</div>';
            html += '</td></tr>';

            // Header row with position numbers
            html += '<tr class="border-b border-gray-700">';
            html += '<th class="py-2 px-2 text-left text-gray-400 font-normal sticky left-0 bg-gray-900">Judge</th>';
            for (let i = 1; i <= numPositions; i++) {
                html += `<th class="py-2 px-1 text-center text-gray-400 font-normal min-w-[32px]">${i}</th>`;
            }
            html += '<th class="py-2 px-2 text-center text-gray-400 font-normal sticky right-0 bg-gray-900">Pts</th>';
            html += '</tr>';

            if (panelSize > 1 && panelVotes.length > 0) {
                // Panel mode - show each judge's row
                for (let j = 0; j < panelSize; j++) {
                    html += `<tr class="border-b border-gray-700/50">`;
                    html += `<td class="py-2 px-2 text-cyan-400 font-medium sticky left-0 bg-gray-900">${getJudgeName(j)}</td>`;
                    let judgeX = 0, judgeC = 0, judgeQ = 0;
                    for (let p = 0; p < numPositions; p++) {
                        const vote = panelVotes[p] ? panelVotes[p][j] : null;
                        let display = '', color = 'text-gray-600';
                        if (vote === 'x') {
                            display = '-';
                            color = 'text-green-400';
                            judgeX++;
                        } else if (vote === 'c') {
                            display = '0';
                            color = 'text-red-400';
                            judgeC++;
                        } else if (vote === 'q') {
                            display = 'x';
                            color = 'text-orange-400';
                            judgeQ++;
                        } else {
                            display = '·';
                        }
                        html += `<td class="py-2 px-1 text-center font-mono text-lg ${color}">${display}</td>`;
                    }
                    const judgeTotal = judgeX - judgeQ;
                    html += `<td class="py-2 px-2 text-center font-bold sticky right-0 bg-gray-900 ${judgeTotal >= 0 ? 'text-green-400' : 'text-red-400'}">${judgeTotal}</td>`;
                    html += '</tr>';
                }

                // Majority/Final row
                html += '<tr class="bg-yellow-900/30 border-t-2 border-yellow-500">';
                html += '<td class="py-3 px-2 text-yellow-400 font-bold sticky left-0 bg-yellow-900/30">MAJORITY</td>';
            } else {
                // Solo mode - single row
                html += '<tr class="bg-yellow-900/30 border-t-2 border-yellow-500">';
                html += '<td class="py-3 px-2 text-yellow-400 font-bold sticky left-0 bg-yellow-900/30">Score</td>';
            }

            // Final scores row
            for (let p = 0; p < numPositions; p++) {
                const type = scoringTypes[p];
                let display = '', color = 'text-gray-600';
                if (type === 'x') {
                    display = '-';
                    color = 'text-green-400';
                } else if (type === 'c') {
                    display = '0';
                    color = 'text-red-400';
                } else if (type === 'q') {
                    display = 'x';
                    color = 'text-orange-400';
                }
                html += `<td class="py-3 px-1 text-center font-mono text-xl font-bold ${color}">${display}</td>`;
            }

            const total = nvPenalty ? 0 : (xCount - qCount);
            html += `<td class="py-3 px-2 text-center font-bold text-2xl ${total >= 0 ? 'text-green-400' : 'text-red-400'}">${total}</td>`;
            html += '</tr>';

            // NV penalty row if applicable
            if (nvPenalty) {
                html += '<tr class="bg-red-900/30">';
                html += `<td colspan="${numPositions + 2}" class="py-2 px-2 text-center text-red-400 font-bold">⚠️ NV PENALTY - SCORE: 0</td>`;
                html += '</tr>';
            }

            table.innerHTML = html;
            document.getElementById('summaryTotal').textContent = `Total: ${total}${nvPenalty ? ' (NV)' : ''}`;
        }

        // Score saving functionality
        // videoId already defined above
        let savedScores = [];

        function loadSavedScores() {
            const stored = localStorage.getItem('practiceScores_' + videoId);
            if (stored) {
                savedScores = JSON.parse(stored);
            }
            displaySavedScores();
        }

        function saveCurrentScore() {
            const roundLabel = document.getElementById('scoreRoundLabel').value || 'Round ' + (savedScores.length + 1);
            const eventType = document.getElementById('eventType').value;
            const workingTime = document.getElementById('timerDisplay').textContent;

            const scoreData = {
                id: Date.now(),
                round: roundLabel,
                event: eventType,
                points: xCount,
                busts: cCount,
                omissions: qCount,
                nv: nvPenalty,
                total: nvPenalty ? 0 : (xCount - qCount),
                workingTime: workingTime,
                timeline: scoringTypes.join(''),
                timestamp: new Date().toLocaleString()
            };

            savedScores.push(scoreData);
            localStorage.setItem('practiceScores_' + videoId, JSON.stringify(savedScores));

            document.getElementById('saveScoreStatus').textContent = 'Saved!';
            document.getElementById('saveScoreStatus').classList.remove('text-gray-500');
            document.getElementById('saveScoreStatus').classList.add('text-green-400');
            setTimeout(() => {
                document.getElementById('saveScoreStatus').textContent = '';
                document.getElementById('saveScoreStatus').classList.remove('text-green-400');
            }, 2000);

            document.getElementById('scoreRoundLabel').value = '';
            displaySavedScores();
        }

        function displaySavedScores() {
            const container = document.getElementById('savedScoresList');

            if (savedScores.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-2">No saved scores yet</div>';
                return;
            }

            container.innerHTML = savedScores.map((score, idx) => {
                // Different display for different score types
                if (score.type === 'wingsuit') {
                    // Wingsuit Compulsory
                    return `
                        <div class="bg-gray-800 rounded p-3 flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <span class="font-medium text-white">${score.round}</span>
                                    <span class="text-xs text-gray-500">WS Compulsory</span>
                                    <span class="text-xs text-gray-500">${score.workingTime}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    Style: <span class="text-yellow-400">${score.style}</span> |
                                    Grips: <span class="text-yellow-400">${score.grips}</span>
                                    ${score.nv ? '<span class="text-red-500 ml-2">NV</span>' : ''}
                                </div>
                            </div>
                            <button onclick="deleteSavedScore(${score.id})" class="text-red-400 hover:text-red-300 text-xs">×</button>
                        </div>
                    `;
                } else if (score.type === 'wingsuit-free') {
                    // Wingsuit Free Round
                    return `
                        <div class="bg-gray-800 rounded p-3 flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-3">
                                    <span class="font-medium text-white">${score.round}</span>
                                    <span class="text-xs text-gray-500">WS Free</span>
                                    <span class="text-xs text-gray-500">${score.workingTime}</span>
                                </div>
                                <div class="text-xs text-gray-400 mt-1">
                                    Style: <span class="text-yellow-400">${score.style}</span> |
                                    Dive: <span class="text-yellow-400">${score.dive}</span> |
                                    Cam: <span class="text-yellow-400">${score.camerawork}</span>
                                    ${score.nv ? '<span class="text-red-500 ml-2">NV</span>' : ''}
                                </div>
                            </div>
                            <button onclick="deleteSavedScore(${score.id})" class="text-red-400 hover:text-red-300 text-xs">×</button>
                        </div>
                    `;
                } else {
                    // Formation Skydiving (X/C/Q scoring)
                    return `
                        <div class="bg-gray-800 rounded p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-3">
                                    <span class="font-medium text-white">${score.round}</span>
                                    <span class="text-xs text-gray-500">${score.event}</span>
                                    <span class="text-xs text-gray-500">${score.workingTime}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="text-2xl font-bold ${score.nv ? 'text-red-400' : (score.total > 0 ? 'text-green-400' : 'text-yellow-400')}">${score.total}</span>
                                    <button onclick="deleteSavedScore(${score.id})" class="text-red-400 hover:text-red-300 text-lg">×</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-4 text-sm">
                                <span class="text-green-400 font-medium">Points: ${score.points}</span>
                                <span class="text-red-400 font-medium">Busts: ${score.busts}</span>
                                <span class="text-orange-400 font-medium">Omissions: ${score.omissions}</span>
                                ${score.nv ? '<span class="text-red-500 font-bold">NV PENALTY</span>' : ''}
                            </div>
                            ${score.timeline ? `<div class="mt-2 font-mono text-xs tracking-wider text-gray-400">${score.timeline.split('').map(t => t === 'x' ? '<span class="text-green-400">-</span>' : (t === 'c' ? '<span class="text-red-400">0</span>' : '<span class="text-orange-400">x</span>')).join(' ')}</div>` : ''}
                        </div>
                    `;
                }
            }).join('');
        }

        function deleteSavedScore(scoreId) {
            savedScores = savedScores.filter(s => s.id !== scoreId);
            localStorage.setItem('practiceScores_' + videoId, JSON.stringify(savedScores));
            displaySavedScores();
        }

        function clearSavedScores() {
            if (!confirm('Clear all saved scores for this video?')) return;
            savedScores = [];
            localStorage.removeItem('practiceScores_' + videoId);
            displaySavedScores();
        }

        function showSaveScoreSection() {
            document.getElementById('saveScoreSection').classList.remove('hidden');
        }

        function saveWsCompulsoryScore() {
            const roundLabel = document.getElementById('wsCompRoundLabel').value || 'Compulsory ' + (savedScores.length + 1);
            const workingTime = document.getElementById('timerDisplay').textContent;
            const finalStyle = document.getElementById('wsFinalStyle').textContent;
            const finalGrips = document.getElementById('wsFinalGrips').textContent;

            const scoreData = {
                id: Date.now(),
                round: roundLabel,
                event: 'ws-compulsory',
                type: 'wingsuit',
                style: parseFloat(finalStyle),
                grips: parseInt(finalGrips),
                nv: wsCompulsoryNV,
                workingTime: workingTime,
                timestamp: new Date().toLocaleString()
            };

            savedScores.push(scoreData);
            localStorage.setItem('practiceScores_' + videoId, JSON.stringify(savedScores));
            document.getElementById('wsCompRoundLabel').value = '';
            displaySavedScores();
        }

        function saveWsFreeScore() {
            const roundLabel = document.getElementById('wsFreeRoundLabel').value || 'Free Round ' + (savedScores.length + 1);
            const workingTime = document.getElementById('timerDisplay').textContent;
            const styleScore = document.getElementById('wsFreeStyleFinal').textContent;
            const diveScore = document.getElementById('wsFreeDiveFinal').textContent;
            const camScore = document.getElementById('wsFreeCamFinal').textContent;

            const scoreData = {
                id: Date.now(),
                round: roundLabel,
                event: 'ws-free',
                type: 'wingsuit-free',
                style: parseFloat(styleScore),
                dive: parseFloat(diveScore),
                camerawork: parseFloat(camScore),
                nv: wsFreeNV,
                workingTime: workingTime,
                timestamp: new Date().toLocaleString()
            };

            savedScores.push(scoreData);
            localStorage.setItem('practiceScores_' + videoId, JSON.stringify(savedScores));
            document.getElementById('wsFreeRoundLabel').value = '';
            displaySavedScores();
        }

        // Load saved scores on page load
        loadSavedScores();

        // Prevent video from capturing keyboard events by removing focus
        if (video) {
            video.addEventListener('focus', () => {
                video.blur();
            });
        }

        // Timer functionality
        let timerInterval = null;
        let timerRunning = false;
        let timeRemaining = 0;
        let elapsedTime = 0;
        let isSpeedEvent = false;
        let isCountUpEvent = false; // For Wingsuit - counts up like a stopwatch
        let speedCompleted = false;
        let freezeTimeout = null;
        let currentPlaybackSpeed = 1.0; // Track playback speed for timer sync

        // Auto-select event type based on video category and subcategory
        function autoSelectEventType() {
            const category = '{{ video.category }}';
            const subcategory = '{{ video.subcategory|default("", true) }}';
            const select = document.getElementById('eventType');

            // Mapping from category/subcategory to event type
            const categoryMapping = {
                // Formation Skydiving
                'fs': {
                    '4way_fs': '4way-fs',
                    '4way_vfs': '4way-vfs',
                    '2way_mfs': '2way-mfs',
                    '8way': '8way',
                    '16way': '16way',
                    '10way': '10way',
                    '_default': '4way-fs'
                },
                // Canopy Formation
                'cf': {
                    '4way_rot': '4way-cf-rot',
                    '4way_seq': '4way-cf-seq',
                    '2way_open': '2way-cf-seq',
                    '2way_proam': '2way-cf-seq',
                    '_default': '4way-cf-seq'
                },
                // Artistic Events
                'ae': {
                    'freestyle': 'freestyle',
                    'freefly': 'freefly',
                    '_default': 'freestyle'
                },
                // Wingsuit
                'ws': {
                    'acrobatic': 'ws-compulsory',
                    '_default': 'ws-compulsory'
                },
                // Indoor (uses same as FS)
                'indoor': {
                    '4way_fs': '4way-fs',
                    '4way_vfs': '4way-vfs',
                    '2way_fs': '4way-fs',
                    '2way_vfs': '4way-vfs',
                    '8way': '8way',
                    '_default': '4way-fs'
                }
            };

            if (categoryMapping[category]) {
                const mapping = categoryMapping[category];
                const eventType = mapping[subcategory] || mapping['_default'];
                if (eventType) {
                    select.value = eventType;
                }
            }
        }

        // Formations/Draw tracking (must be declared before updateEventType is called)
        let formations = [];
        let maxPossiblePoints = 0;

        // Initialize event type on page load (after timer variables are declared)
        autoSelectEventType();
        updateEventType();

        // USPA Dive Pool Rules per Event/Class (from SCM Chapter 9)
        const divePoolRules = {
            // 4-Way FS
            '4way-fs': {
                open: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '4-Way FS Open' },
                advanced: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '4-Way FS Advanced' },
                intermediate: { blocks: [1,2,4,6,7,8,9,11,13,14,15,18,19,20,21,22], randoms: 'all', drawLength: [4, 5], name: '4-Way FS Intermediate' },
                beginner: { blocks: [2,4,6,7,8,9,19,21], randoms: 'all', drawLength: [3, 4], name: '4-Way FS Beginner' }
            },
            // 8-Way FS
            '8way': {
                open: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '8-Way FS Open' },
                advanced: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '8-Way FS Advanced' },
                intermediate: { blocks: [1,3,4,5,6,7,8,10,13,14,16,17,18,19,21], randoms: 'all', drawLength: [4, 5], name: '8-Way FS Intermediate' }
            },
            // 4-Way VFS
            '4way-vfs': {
                open: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '4-Way VFS Open' },
                advanced: { blocks: [1,2,3,4,7,8,9,11,12,13,14,16,17,18,20,21,22], randoms: ['A','B','C','E','J','K','L','Q'], drawLength: [4, 5], name: '4-Way VFS Advanced' },
                intermediate: { blocks: [1,2,3,7,8,12,13,14,21,22], randoms: ['A','B','E','J','L'], drawLength: [3, 4], name: '4-Way VFS Intermediate' }
            },
            // 2-Way MFS
            '2way-mfs': {
                open: { blocks: 'all', randoms: 'all', drawLength: [5, 6], name: '2-Way MFS Open' },
                advanced: { blocks: 'allExcept', blocksExclude: [4,12,13,16], randoms: 'allExcept', randomsExclude: ['A','F','P'], drawLength: [4, 5], name: '2-Way MFS Advanced' },
                intermediate: { blocks: [5,6,7,8,10,17,20,22], randoms: ['D','G','H','J','K','L','M','Q'], drawLength: [3, 4], name: '2-Way MFS Intermediate' }
            },
            // 16-Way FS
            '16way': {
                open: { blocks: 'all', randoms: 'all', drawLength: [3, 4], name: '16-Way FS' }
            },
            // 10-Way Speed (different scoring - time based)
            '10way': {
                open: { blocks: [], randoms: 'all', drawLength: [1], name: '10-Way Speed', isSpeed: true }
            }
        };

        // All possible randoms (A-Q for most events)
        const allRandoms = ['A','B','C','D','E','F','G','H','J','K','L','M','N','O','P','Q'];
        // All possible blocks (1-22 for 4-way)
        const allBlocks = Array.from({length: 22}, (_, i) => i + 1);

        function getEventDivePool() {
            const eventType = document.getElementById('eventType').value;
            // Map event types to dive pool keys
            const eventMap = {
                '4way-fs': '4way-fs', '4way': '4way-fs', '4way-inter': '4way-fs',
                '8way': '8way', '8way-inter': '8way',
                '4way-vfs': '4way-vfs', 'vfs': '4way-vfs',
                '2way-mfs': '2way-mfs',
                '16way': '16way',
                '10way': '10way'
            };
            return divePoolRules[eventMap[eventType]] || divePoolRules['4way-fs'];
        }

        function getCurrentClass() {
            const classSelect = document.getElementById('eventClass');
            return classSelect ? classSelect.value : 'open';
        }

        function updateFormations() {
            const input = document.getElementById('formationsInput').value.toUpperCase();
            const display = document.getElementById('formationsDisplay');
            const maxPointsEl = document.getElementById('maxPoints');
            const drawInfoEl = document.getElementById('drawInfo');
            const validationEl = document.getElementById('drawValidation');

            formations = [];
            maxPossiblePoints = 0;
            let displayHtml = '';
            let warnings = [];

            const divePool = getEventDivePool();
            const classRules = divePool[getCurrentClass()] || divePool.open;

            // Parse formations - handle multi-digit block numbers
            let i = 0;
            while (i < input.length) {
                const char = input[i];

                if (/[A-Q]/.test(char)) {
                    // Random formation (letter) = 1 point
                    const isValid = classRules.randoms === 'all' ||
                                   (classRules.randoms === 'allExcept' && !classRules.randomsExclude.includes(char)) ||
                                   (Array.isArray(classRules.randoms) && classRules.randoms.includes(char));

                    formations.push({ type: 'random', value: char, points: 1, valid: isValid });
                    maxPossiblePoints += 1;

                    const bgColor = isValid ? 'bg-blue-600' : 'bg-red-600';
                    displayHtml += `<span class="px-1.5 py-0.5 rounded ${bgColor} text-white" title="Random ${char}: 1 point${!isValid ? ' (NOT IN POOL)' : ''}">${char}</span>`;

                    if (!isValid) warnings.push(`Random ${char} not in dive pool`);
                    i++;
                } else if (/[0-9]/.test(char)) {
                    // Block sequence (number) = 2 points
                    // Check for two-digit numbers (10-22)
                    let blockNum = char;
                    if (i + 1 < input.length && /[0-9]/.test(input[i + 1])) {
                        blockNum = char + input[i + 1];
                        i++;
                    }
                    const num = parseInt(blockNum);

                    const isValid = classRules.blocks === 'all' ||
                                   (classRules.blocks === 'allExcept' && !classRules.blocksExclude.includes(num)) ||
                                   (Array.isArray(classRules.blocks) && classRules.blocks.includes(num));

                    formations.push({ type: 'block', value: blockNum, points: 2, valid: isValid });
                    maxPossiblePoints += 2;

                    const bgColor = isValid ? 'bg-purple-600' : 'bg-red-600';
                    displayHtml += `<span class="px-1.5 py-0.5 rounded ${bgColor} text-white" title="Block ${blockNum}: 2 points${!isValid ? ' (NOT IN POOL)' : ''}">${blockNum}</span>`;

                    if (!isValid) warnings.push(`Block ${blockNum} not in dive pool`);
                    i++;
                } else {
                    i++;
                }
            }

            display.innerHTML = displayHtml;
            maxPointsEl.textContent = maxPossiblePoints;

            // Show draw info
            const drawLen = classRules.drawLength;
            drawInfoEl.textContent = `${classRules.name}: ${drawLen[0]}${drawLen.length > 1 ? '-' + drawLen[1] : ''} formations per round | Randoms=1pt, Blocks=2pts`;

            // Validation
            if (warnings.length > 0) {
                validationEl.textContent = warnings.join(', ');
                validationEl.className = 'text-xs text-red-400';
            } else if (formations.length > 0) {
                validationEl.textContent = `${formations.length} formations entered`;
                validationEl.className = 'text-xs text-green-400';
            } else {
                validationEl.textContent = '';
            }

            // Update score comparison if scoring is active
            updateScoreComparison();
        }

        function updateScoreComparison() {
            // If we have formations, show comparison with max points
            const comparisonEl = document.getElementById('scoreComparison');
            if (!comparisonEl) return;

            if (maxPossiblePoints > 0) {
                const currentScore = (typeof xCount !== 'undefined' ? xCount : 0) - (typeof qCount !== 'undefined' ? qCount : 0);
                const percentage = Math.round((currentScore / maxPossiblePoints) * 100);
                comparisonEl.textContent = `of ${maxPossiblePoints} max (${percentage}%)`;
                comparisonEl.classList.remove('hidden');
            } else {
                comparisonEl.classList.add('hidden');
            }
        }

        function updateEventType() {
            const select = document.getElementById('eventType');
            const option = select.options[select.selectedIndex];
            const duration = parseInt(option.dataset.duration);
            const eventType = select.value;

            isSpeedEvent = (eventType === '10way');
            const isWingsuit = (eventType === 'ws-compulsory' || eventType === 'ws-free');
            isCountUpEvent = isWingsuit; // Wingsuit uses count-up timer like speed events

            // Hide all special sections first
            document.getElementById('speedInfo').classList.add('hidden');
            document.getElementById('wingsuitSection').classList.add('hidden');
            document.getElementById('wsCompulsorySection').classList.add('hidden');
            document.getElementById('wsFreeSection').classList.add('hidden');

            if (isSpeedEvent) {
                document.getElementById('durationLabel').textContent = 'Speed competition';
                document.getElementById('speedInfo').textContent = '10-Way Speed: X to start, X again to stop. Max score: 35.00s. Freeze 6s after completion.';
                document.getElementById('speedInfo').classList.remove('hidden');
                document.getElementById('timerBtn').textContent = 'Start (X)';
            } else if (isWingsuit) {
                document.getElementById('durationLabel').textContent = 'X to start/stop working time';
                document.getElementById('speedInfo').textContent = 'Wingsuit: Press X to start timing when working time begins, X again to stop.';
                document.getElementById('speedInfo').classList.remove('hidden');
                document.getElementById('timerBtn').textContent = 'Start (X)';
                document.getElementById('wingsuitSection').classList.remove('hidden');
                if (eventType === 'ws-compulsory') {
                    document.getElementById('wsCompulsorySection').classList.remove('hidden');
                } else {
                    document.getElementById('wsFreeSection').classList.remove('hidden');
                }
                // Set up mode-specific defaults
                updateWsMode();
            } else {
                document.getElementById('durationLabel').textContent = duration + 's working time';
            }

            // Update formations display for new event type
            updateFormations();

            resetTimer();
        }

        function getEventDuration() {
            const select = document.getElementById('eventType');
            const option = select.options[select.selectedIndex];
            return parseInt(option.dataset.duration) || 35;
        }

        function startTimer() {
            if (isSpeedEvent) {
                startSpeedTimer();
            } else if (isCountUpEvent) {
                startCountUpTimer();
            } else {
                startCountdownTimer();
            }
        }

        function startCountUpTimer() {
            // Count-up stopwatch for Wingsuit events - X only starts, never stops manually
            if (timerRunning) {
                // Already running, do nothing (X now adds points instead)
                return;
            }

            // Competition mode: require FlySight data
            if (wsCompetitionMode && (!flysightData || flysightData.length === 0)) {
                document.getElementById('wsCompetitionWarning').classList.remove('hidden');
                document.getElementById('timerStatus').textContent = 'FlySight required';
                document.getElementById('timerStatus').classList.remove('text-gray-500', 'text-green-400');
                document.getElementById('timerStatus').classList.add('text-red-400');
                return;
            }

            // Capture video time when working time starts (for replay)
            if (workingTimeVideoStart === null) {
                if (video) {
                    workingTimeVideoStart = video.currentTime;
                } else if (vimeoPlayer) {
                    vimeoPlayer.getCurrentTime().then(t => { workingTimeVideoStart = t; });
                }
            }

            // Start the timer
            elapsedTime = 0;
            timerRunning = true;
            timerStartTime = Date.now(); // Record start time for scoring timestamps

            document.getElementById('timerBtn').textContent = 'Running...';
            document.getElementById('timerBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('timerBtn').classList.add('bg-yellow-600', 'cursor-not-allowed');
            document.getElementById('timerStatus').textContent = 'Timing...';
            document.getElementById('timerStatus').classList.remove('text-gray-500', 'text-yellow-400');
            document.getElementById('timerStatus').classList.add('text-green-400');

            const overlay = document.getElementById('freezeOverlay'); if (overlay) overlay.classList.add('hidden');
            if (video) video.play();

            timerInterval = setInterval(() => {
                elapsedTime += 10 * currentPlaybackSpeed; // Scale by playback speed
                updateCountUpDisplay();

                // Auto-stop when working time is reached (if FlySight data loaded)
                if (wsWorkingTime > 0) {
                    const currentSeconds = elapsedTime / 1000;
                    if (currentSeconds >= wsWorkingTime) {
                        stopCountUpTimer();
                    }
                }
            }, 10);
        }

        function stopCountUpTimer() {
            if (!timerRunning) return;

            clearInterval(timerInterval);
            timerInterval = null;
            timerRunning = false;

            const finalTime = (elapsedTime / 1000).toFixed(2);
            document.getElementById('timerBtn').textContent = 'Start (X)';
            document.getElementById('timerBtn').classList.remove('bg-yellow-600', 'cursor-not-allowed');
            document.getElementById('timerBtn').classList.add('bg-green-600', 'hover:bg-green-700');

            // Show comparison between judge time and FlySight time
            let statusText = `Judge: ${finalTime}s`;
            if (wsWorkingTime > 0) {
                const diff = (parseFloat(finalTime) - wsWorkingTime).toFixed(2);
                const diffSign = diff >= 0 ? '+' : '';
                statusText += ` (${diffSign}${diff}s vs FlySight)`;
            }
            document.getElementById('timerStatus').textContent = statusText;
            document.getElementById('timerStatus').classList.remove('text-green-400');
            document.getElementById('timerStatus').classList.add('text-yellow-400');
            const overlayEl = document.getElementById('freezeOverlay'); if (overlayEl) overlayEl.classList.remove('hidden');
            if (video) video.pause();
            // Show save score section
            showSaveScoreSection();
        }

        function updateCountUpDisplay() {
            const seconds = Math.floor(elapsedTime / 1000);
            const centiseconds = Math.floor((elapsedTime % 1000) / 10);
            const display = `${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            document.getElementById('timerDisplay').classList.remove('text-gray-400');
            document.getElementById('timerDisplay').classList.add('text-white');
        }

        function startCountdownTimer() {
            if (timerRunning) {
                stopTimer();
                return;
            }

            // Capture video time when working time starts (for replay)
            if (workingTimeVideoStart === null) {
                if (video) {
                    workingTimeVideoStart = video.currentTime;
                } else if (vimeoPlayer) {
                    vimeoPlayer.getCurrentTime().then(t => { workingTimeVideoStart = t; });
                }
            }

            const duration = getEventDuration();
            timeRemaining = duration;
            elapsedTime = 0;
            timerRunning = true;
            timerStartTime = Date.now(); // Record start time for scoring timestamps

            document.getElementById('timerBtn').textContent = 'Stop (X)';
            document.getElementById('timerBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
            document.getElementById('timerBtn').classList.add('bg-red-600', 'hover:bg-red-700');
            document.getElementById('timerStatus').textContent = 'Running';
            document.getElementById('timerStatus').classList.remove('text-gray-500');
            document.getElementById('timerStatus').classList.add('text-green-400');

            const overlay = document.getElementById('freezeOverlay'); if (overlay) overlay.classList.add('hidden');
            if (video) video.play();
            // Also play Vimeo if available
            if (vimeoPlayer) vimeoPlayer.play();

            // Show initial time immediately
            document.getElementById('timerDisplay').textContent = '0.0s';
            document.getElementById('timerDisplay').style.color = '#ffffff';

            timerInterval = setInterval(() => {
                elapsedTime += 100 * currentPlaybackSpeed; // Scale by playback speed
                timeRemaining = Math.max(0, duration - Math.floor(elapsedTime / 1000));
                updateRunningTimeDisplay();

                if (timeRemaining <= 0) {
                    if (video) video.pause();
                    if (vimeoPlayer) vimeoPlayer.pause();
                    stopTimer();
                    document.getElementById('timerStatus').textContent = 'Time!';
                    document.getElementById('timerStatus').classList.remove('text-green-400');
                    document.getElementById('timerStatus').classList.add('text-yellow-400');
                    document.getElementById('timerDisplay').classList.add('text-yellow-400');
                    const overlayEl = document.getElementById('freezeOverlay'); if (overlayEl) overlayEl.classList.remove('hidden');
                    // Show save score section
                    showSaveScoreSection();
                }
            }, 100);
        }

        function updateRunningTimeDisplay() {
            // Show elapsed time in seconds with one decimal
            const seconds = (elapsedTime / 1000).toFixed(1);
            const timerEl = document.getElementById('timerDisplay');
            if (timerEl) {
                timerEl.textContent = seconds + 's';
                timerEl.style.color = '#ffffff';
            }
        }

        function startSpeedTimer() {
            if (speedCompleted) {
                // Already completed, do nothing until reset
                return;
            }

            if (!timerRunning) {
                // Capture video time when working time starts (for replay)
                if (workingTimeVideoStart === null) {
                    if (video) {
                        workingTimeVideoStart = video.currentTime;
                    } else if (vimeoPlayer) {
                        vimeoPlayer.getCurrentTime().then(t => { workingTimeVideoStart = t; });
                    }
                }

                // First X press - start the timer
                elapsedTime = 0;
                timerRunning = true;

                document.getElementById('timerBtn').textContent = 'Stop (X)';
                document.getElementById('timerBtn').classList.remove('bg-green-600', 'hover:bg-green-700');
                document.getElementById('timerBtn').classList.add('bg-red-600', 'hover:bg-red-700');
                document.getElementById('timerStatus').textContent = 'Timing...';
                document.getElementById('timerStatus').classList.remove('text-gray-500');
                document.getElementById('timerStatus').classList.add('text-green-400');

                const overlay = document.getElementById('freezeOverlay'); if (overlay) overlay.classList.add('hidden');
                if (video) video.play();

                timerInterval = setInterval(() => {
                    elapsedTime += 10 * currentPlaybackSpeed; // Scale by playback speed
                    updateSpeedDisplay();
                }, 10);
            } else {
                // Second X press - stop the timer, record time
                speedCompleted = true;
                clearInterval(timerInterval);
                timerInterval = null;
                timerRunning = false;

                const finalTime = (elapsedTime / 1000).toFixed(2);
                const maxScore = 35.00;

                document.getElementById('timerBtn').textContent = 'Completed';
                document.getElementById('timerBtn').classList.remove('bg-red-600', 'hover:bg-red-700');
                document.getElementById('timerBtn').classList.add('bg-blue-600', 'hover:bg-blue-700');

                if (parseFloat(finalTime) <= maxScore) {
                    document.getElementById('timerStatus').textContent = `Score: ${finalTime}s`;
                    document.getElementById('timerStatus').classList.remove('text-green-400');
                    document.getElementById('timerStatus').classList.add('text-yellow-400');
                } else {
                    document.getElementById('timerStatus').textContent = `DNF (>${maxScore}s)`;
                    document.getElementById('timerStatus').classList.remove('text-green-400');
                    document.getElementById('timerStatus').classList.add('text-red-400');
                }

                // Continue playing video, freeze after 6 seconds
                freezeTimeout = setTimeout(() => {
                    if (video) video.pause();
                    const overlayEl = document.getElementById('freezeOverlay'); if (overlayEl) overlayEl.classList.remove('hidden');
                    document.getElementById('timerStatus').textContent += ' - Frozen';
                }, 6000);
            }
        }

        function updateSpeedDisplay() {
            const seconds = Math.floor(elapsedTime / 1000);
            const centiseconds = Math.floor((elapsedTime % 1000) / 10);
            const display = `${seconds.toString().padStart(2, '0')}.${centiseconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            document.getElementById('timerDisplay').classList.remove('text-gray-400');
            document.getElementById('timerDisplay').classList.add('text-white');
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            if (freezeTimeout) {
                clearTimeout(freezeTimeout);
                freezeTimeout = null;
            }
            timerRunning = false;

            document.getElementById('timerBtn').textContent = 'Start (X)';
            document.getElementById('timerBtn').classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('timerBtn').classList.add('bg-green-600', 'hover:bg-green-700');

            if (!isSpeedEvent && timeRemaining > 0) {
                document.getElementById('timerStatus').textContent = 'Stopped';
                document.getElementById('timerStatus').classList.remove('text-green-400');
                document.getElementById('timerStatus').classList.add('text-gray-500');
            }
        }

        function confirmReset() {
            // Check if there are any scores to warn about
            if (scoringTypes.length > 0 || timerRunning || elapsedTime > 0) {
                showResetConfirmation();
            } else {
                // No scores, just reset
                resetTimer();
            }
        }

        function showResetConfirmation() {
            // Create confirmation modal
            const modal = document.createElement('div');
            modal.id = 'resetConfirmModal';
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-4 shadow-2xl">
                    <div class="text-center mb-4">
                        <span class="text-5xl">⚠️</span>
                    </div>
                    <h3 class="text-xl font-bold text-white text-center mb-2">Reset All Scores?</h3>
                    <p class="text-gray-300 text-center mb-4">This will clear all recorded scores and reset the timer. This action cannot be undone.</p>
                    <div class="bg-red-900/30 border border-red-500 rounded p-3 mb-4">
                        <p class="text-red-400 text-sm text-center">
                            <strong>${scoringTypes.length}</strong> scores will be permanently deleted
                        </p>
                    </div>
                    <div class="flex gap-3 justify-center">
                        <button onclick="document.getElementById('resetConfirmModal').remove()"
                            class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-white">
                            Cancel
                        </button>
                        <button onclick="document.getElementById('resetConfirmModal').remove(); resetTimer(); clearScoring();"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded text-white font-bold">
                            Yes, Reset All
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        let replayAutoStartPending = false; // Flag to auto-start timer on replay

        function replayVideo() {
            // Stop timer but keep scores
            stopTimer();
            timerRunning = false;

            // Reset timer display but keep elapsed time for reference
            document.getElementById('timerDisplay').textContent = '--:--';
            document.getElementById('timerDisplay').style.color = '';
            document.getElementById('timerDisplay').classList.remove('text-yellow-400', 'text-white');
            document.getElementById('timerDisplay').classList.add('text-gray-400');
            document.getElementById('timerStatus').textContent = 'Auto-starting at working time...';
            document.getElementById('timerStatus').classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
            document.getElementById('timerStatus').classList.add('text-gray-500');

            // Hide freeze overlay
            const overlay = document.getElementById('freezeOverlay');
            if (overlay) overlay.classList.add('hidden');

            // Reset button state
            document.getElementById('timerBtn').textContent = 'Start (X)';
            document.getElementById('timerBtn').classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-blue-600', 'hover:bg-blue-700', 'bg-yellow-600', 'cursor-not-allowed');
            document.getElementById('timerBtn').classList.add('bg-green-600', 'hover:bg-green-700');

            // Reset timer variables but NOT scores
            timeRemaining = 0;
            elapsedTime = 0;
            speedCompleted = false;
            timerStartTime = 0;

            // Set flag to auto-start timer when video reaches working time
            replayAutoStartPending = true;

            // Reset video to a few seconds BEFORE working time starts (gives judges time to prepare)
            // Use captured working time start from first view, or fall back to preset videoStartTime
            const workingStart = workingTimeVideoStart !== null ? workingTimeVideoStart : (videoStartTime || 0);
            const replayStartTime = Math.max(0, workingStart - 3);
            if (video) {
                video.currentTime = replayStartTime;
                video.play(); // Auto-start video playback
            }
            if (vimeoPlayer) {
                vimeoPlayer.setCurrentTime(replayStartTime).then(() => {
                    vimeoPlayer.play(); // Auto-start video playback
                });
            }
        }

        // Check if video reached working time during replay (for auto-start)
        function checkReplayAutoStart(currentTime) {
            const workingStart = workingTimeVideoStart !== null ? workingTimeVideoStart : videoStartTime;
            if (replayAutoStartPending && workingStart > 0 && currentTime >= workingStart) {
                replayAutoStartPending = false;
                // Auto-start the timer (same as pressing X)
                startTimer();
            }
        }

        function resetTimer() {
            stopTimer();
            timeRemaining = 0;
            elapsedTime = 0;
            speedCompleted = false;
            timerRunning = false;
            timerStartTime = 0;
            document.getElementById('timerDisplay').textContent = '--:--';
            document.getElementById('timerDisplay').classList.remove('text-yellow-400', 'text-white');
            document.getElementById('timerDisplay').classList.add('text-gray-400');
            document.getElementById('timerStatus').textContent = '';
            document.getElementById('timerStatus').classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
            document.getElementById('timerStatus').classList.add('text-gray-500');
            const overlay = document.getElementById('freezeOverlay'); if (overlay) overlay.classList.add('hidden');
            document.getElementById('timerBtn').textContent = 'Start (X)';
            document.getElementById('timerBtn').classList.remove('bg-red-600', 'hover:bg-red-700', 'bg-blue-600', 'hover:bg-blue-700');
            document.getElementById('timerBtn').classList.add('bg-green-600', 'hover:bg-green-700');

            // Reset video to start position and pause
            if (video) {
                video.pause();
                video.currentTime = videoStartTime || 0;
            }
            // Reset Vimeo player
            if (vimeoPlayer) {
                vimeoPlayer.pause();
                vimeoPlayer.setCurrentTime(0);
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timerDisplay').textContent = display;
            document.getElementById('timerDisplay').classList.remove('text-gray-400');
            document.getElementById('timerDisplay').classList.add('text-white');
        }

        // FlySight CSV Parsing
        let flysightDataRaw = null; // Raw MSL data
        let flysightData = null;    // Adjusted for ground elevation (AGL)
        let wsWorkingTime = 0;
        let wsCompetitionMode = false; // false = library/practice, true = competition

        function updateWsMode() {
            const selectedMode = document.querySelector('input[name="wsMode"]:checked').value;
            wsCompetitionMode = (selectedMode === 'competition');

            const warningEl = document.getElementById('wsCompetitionWarning');

            if (wsCompetitionMode) {
                // Competition mode: require FlySight data
                if (!flysightData || flysightData.length === 0) {
                    warningEl.classList.remove('hidden');
                    // Clear any default working time
                    document.getElementById('flysightWorkingTime').textContent = '--.- s';
                    document.getElementById('upperBoundary').textContent = '-- ft';
                    document.getElementById('lowerBoundary').textContent = '-- ft';
                    wsWorkingTime = 0;
                } else {
                    warningEl.classList.add('hidden');
                }
            } else {
                // Library mode: FlySight optional, use default if not provided
                warningEl.classList.add('hidden');
                if (!flysightData || flysightData.length === 0) {
                    setDefaultWorkingTime();
                }
            }
        }

        function setDefaultWorkingTime() {
            // Library mode default: 12,000 ft AGL upper boundary, 90s working time
            const defaultUpperBoundary = 12000; // ft AGL
            // Check lower exit rule toggle (though 12,000 ft > 11,500 ft so normally 7500 ft)
            const lowerExitRuleEnabled = document.getElementById('lowerExitRule').checked;
            const altWindow = (lowerExitRuleEnabled && defaultUpperBoundary <= 11500) ? 5000 : 7500;
            const defaultLowerBoundary = defaultUpperBoundary - altWindow;
            const defaultWorkingTime = 90; // 90 seconds for library/practice mode

            document.getElementById('upperBoundary').textContent = defaultUpperBoundary.toLocaleString() + ' ft';
            document.getElementById('upperBoundary').classList.remove('text-red-400', 'text-yellow-400');
            document.getElementById('upperBoundary').classList.add('text-green-400');
            document.getElementById('lowerBoundary').textContent = defaultLowerBoundary.toLocaleString() + ' ft';
            document.getElementById('altitudeWindow').textContent = altWindow.toLocaleString() + ' ft';
            document.getElementById('flysightWorkingTime').textContent = defaultWorkingTime + ' s (default)';
            document.getElementById('flysightTimeDisplay').textContent = defaultWorkingTime + 's';
            document.getElementById('flysightTimeCompare').classList.remove('hidden');
            wsWorkingTime = defaultWorkingTime; // Auto-stop at 90 seconds in library mode
        }

        function recalculateFlySight() {
            if (!flysightDataRaw || flysightDataRaw.length === 0) return;

            // Ground elevation is in meters, convert to feet (altitudes are stored in feet)
            const groundElevMeters = parseFloat(document.getElementById('groundElevation').value) || 0;
            const groundElevFeet = groundElevMeters * 3.28084;
            flysightData = flysightDataRaw.map(d => ({
                time: d.time,
                alt: d.alt - groundElevFeet,
                velD: d.velD || 0
            }));
            calculateWorkingTime();
        }

        function parseFlySight(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                const lines = csv.split('\n');

                // Find header row and data
                // FlySight v1 uses: time,lat,lon,hMSL,velN,velE,velD,...
                // FlySight v2 may use different column names
                let headerIndex = -1;
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].toLowerCase();
                    if (line.includes('time') && (line.includes('alt') || line.includes('hmsl') || line.includes('msl') || line.includes('elev'))) {
                        headerIndex = i;
                        break;
                    }
                }

                if (headerIndex === -1) {
                    document.getElementById('flysightStatus').textContent = 'Invalid CSV format - needs time and altitude columns';
                    document.getElementById('flysightStatus').classList.add('text-red-400');
                    return;
                }

                const headers = lines[headerIndex].split(',').map(h => h.trim().toLowerCase());
                const timeCol = headers.findIndex(h => h === 'time' || h === 'time(s)' || h.includes('time'));
                const altCol = headers.findIndex(h => h === 'hmsl' || h === 'alt' || h === 'altitude' || h.includes('alt') || h.includes('msl') || h.includes('elev'));
                const velDCol = headers.findIndex(h => h === 'veld' || h === 'veldown' || h === 'vel_d');

                if (timeCol === -1 || altCol === -1) {
                    document.getElementById('flysightStatus').textContent = 'Missing time/altitude columns';
                    document.getElementById('flysightStatus').classList.add('text-red-400');
                    return;
                }

                // Parse data rows
                const data = [];
                let baseTime = null;

                for (let i = headerIndex + 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    // Skip empty lines and units row (starts with comma or contains only units like (deg))
                    if (!line || line.startsWith(',') || line.includes('(deg)') || line.includes('(m)') || line.includes('(m/s)')) {
                        continue;
                    }

                    const cols = line.split(',');
                    if (cols.length > Math.max(timeCol, altCol)) {
                        let time;
                        const timeStr = cols[timeCol];

                        // Check if time is ISO format (contains T or Z) or numeric
                        if (timeStr.includes('T') || timeStr.includes('Z')) {
                            // ISO timestamp - convert to seconds from first timestamp
                            const timestamp = new Date(timeStr).getTime();
                            if (isNaN(timestamp)) continue;
                            if (baseTime === null) baseTime = timestamp;
                            time = (timestamp - baseTime) / 1000;
                        } else {
                            // Numeric time in seconds
                            time = parseFloat(timeStr);
                            if (isNaN(time)) continue;
                        }

                        const alt = parseFloat(cols[altCol]);
                        const velD = velDCol !== -1 ? parseFloat(cols[velDCol]) : 0;

                        if (!isNaN(alt)) {
                            // Convert meters to feet if needed (FlySight usually reports in meters)
                            const altFt = alt < 5000 ? alt * 3.28084 : alt; // Assume meters if < 5000
                            data.push({ time, alt: altFt, velD: velD });
                        }
                    }
                }

                if (data.length === 0) {
                    document.getElementById('flysightStatus').textContent = 'No valid data found';
                    document.getElementById('flysightStatus').classList.add('text-red-400');
                    return;
                }

                flysightDataRaw = data; // Store raw MSL data
                recalculateFlySight();  // Apply ground elevation and calculate

                // Show working time in status
                let statusText = `${data.length} pts`;
                if (wsWorkingTime > 0) {
                    statusText += ` | WT: ${wsWorkingTime}s`;
                }
                document.getElementById('flysightStatus').textContent = statusText;
                document.getElementById('flysightStatus').classList.remove('text-red-400');
                document.getElementById('flysightStatus').classList.add('text-green-400');

                // Make sure wingsuitSection is visible to show the detailed data
                document.getElementById('wingsuitSection').classList.remove('hidden');

                // Hide competition warning since FlySight data is now loaded
                document.getElementById('wsCompetitionWarning').classList.add('hidden');
                document.getElementById('timerStatus').textContent = '';
                document.getElementById('timerStatus').classList.remove('text-red-400');
            };
            reader.readAsText(file);
        }

        function calculateWorkingTime() {
            if (!flysightData || flysightData.length === 0) return;

            // Find upper boundary: altitude when vertical velocity first reaches 10 m/s after exit
            let upperBoundaryAlt = null;
            let upperCrossTime = null;
            for (let i = 0; i < flysightData.length; i++) {
                if (flysightData[i].velD >= 10) { // velD >= 10 m/s
                    upperBoundaryAlt = flysightData[i].alt;
                    upperCrossTime = flysightData[i].time;
                    break;
                }
            }

            // If no velD data or never reaches 10 m/s, fall back to max altitude
            if (upperBoundaryAlt === null) {
                upperBoundaryAlt = Math.max(...flysightData.map(d => d.alt));
                // Find when altitude drops 100ft below max as fallback
                for (let i = 1; i < flysightData.length; i++) {
                    if (flysightData[i].alt < upperBoundaryAlt - 100) {
                        upperCrossTime = flysightData[i].time;
                        break;
                    }
                }
            }

            // WS Acrobatic altitude window rules:
            // Normal: 7500 ft below upper boundary
            // If lower exit rule enabled and exit altitude <= 11,500 ft AGL (3505m): 5000 ft below upper boundary
            const lowerExitRuleEnabled = document.getElementById('lowerExitRule').checked;
            const altWindow = (lowerExitRuleEnabled && upperBoundaryAlt <= 11500) ? 5000 : 7500;
            const lowerBoundary = upperBoundaryAlt - altWindow;

            // Find first crossing of lower boundary
            let lowerCrossTime = null;
            for (let i = 1; i < flysightData.length; i++) {
                if (flysightData[i-1].alt > lowerBoundary && flysightData[i].alt <= lowerBoundary) {
                    lowerCrossTime = flysightData[i].time;
                    break;
                }
            }

            // Update display
            // WS Acrobatic altitude limits (FAI/IPC rules):
            // Min exit: 3658m = 12,000ft, Max exit: 3810m = 12,500ft
            const upperLimitMin = 12000; // Minimum exit altitude
            const upperLimitMax = 12500; // Maximum exit altitude
            const upperEl = document.getElementById('upperBoundary');
            upperEl.textContent = Math.round(upperBoundaryAlt).toLocaleString() + ' ft';
            upperEl.classList.remove('text-white', 'text-green-400', 'text-red-400', 'text-yellow-400');
            if (upperBoundaryAlt >= upperLimitMin && upperBoundaryAlt <= upperLimitMax) {
                upperEl.classList.add('text-green-400'); // Within limits
            } else if (upperBoundaryAlt < upperLimitMin) {
                upperEl.classList.add('text-yellow-400'); // Below minimum (too low)
            } else {
                upperEl.classList.add('text-red-400'); // Above maximum (too high)
            }

            document.getElementById('lowerBoundary').textContent = Math.round(lowerBoundary).toLocaleString() + ' ft';
            document.getElementById('altitudeWindow').textContent = altWindow.toLocaleString() + ' ft';

            if (upperCrossTime !== null && lowerCrossTime !== null) {
                wsWorkingTime = parseFloat((lowerCrossTime - upperCrossTime).toFixed(1));
                document.getElementById('flysightWorkingTime').textContent = wsWorkingTime + ' s';

                // Show FlySight time next to judge timer for comparison
                document.getElementById('flysightTimeDisplay').textContent = wsWorkingTime + 's';
                document.getElementById('flysightTimeCompare').classList.remove('hidden');

                // Set timer duration for freeze frame
                const eventType = document.getElementById('eventType').value;
                if (eventType.startsWith('ws-')) {
                    timeRemaining = Math.ceil(parseFloat(wsWorkingTime));
                }
            } else {
                document.getElementById('flysightWorkingTime').textContent = 'N/A';
                document.getElementById('flysightTimeCompare').classList.add('hidden');
                wsWorkingTime = 0;
            }

            // Draw the altitude graph
            drawFlySightGraph(upperBoundaryAlt, lowerBoundary, upperCrossTime, lowerCrossTime);
        }

        // FlySight Graph Modal
        let flysightModalChart = null;
        let detectedUpperCrossTime = null;
        let confirmedWorkingTime = null;
        let cropStart = 0;
        let cropEnd = 0;
        let croppedFlysightData = null;

        function drawFlySightGraph(upperBoundaryAlt, lowerBoundary, upperCrossTime, lowerCrossTime) {
            if (!flysightData || flysightData.length === 0) {
                document.getElementById('flysightGraphSection').classList.add('hidden');
                return;
            }
            document.getElementById('flysightGraphSection').classList.remove('hidden');
            detectedUpperCrossTime = upperCrossTime;
        }

        function openFlySightModal() {
            if (!flysightData || flysightData.length === 0) return;

            const modal = document.getElementById('flysightModal');
            modal.classList.remove('hidden');

            // Reset crop values
            cropStart = 0;
            cropEnd = 0;
            const maxTime = flysightData[flysightData.length - 1].time;

            // Set up crop sliders
            document.getElementById('cropStartSlider').max = maxTime / 2;
            document.getElementById('cropStartSlider').value = 0;
            document.getElementById('cropStartInput').value = 0;
            document.getElementById('cropEndSlider').max = maxTime / 2;
            document.getElementById('cropEndSlider').value = 0;
            document.getElementById('cropEndInput').value = 0;

            // Apply initial crop and draw
            updateCropPreview();
        }

        function closeFlySightModal() {
            document.getElementById('flysightModal').classList.add('hidden');
            if (flysightModalChart) {
                flysightModalChart.destroy();
                flysightModalChart = null;
            }
        }

        function updateCropFromInput(type) {
            if (type === 'start') {
                const val = parseFloat(document.getElementById('cropStartInput').value) || 0;
                document.getElementById('cropStartSlider').value = val;
            } else {
                const val = parseFloat(document.getElementById('cropEndInput').value) || 0;
                document.getElementById('cropEndSlider').value = val;
            }
            updateCropPreview();
        }

        function updateCropPreview() {
            cropStart = parseFloat(document.getElementById('cropStartSlider').value) || 0;
            cropEnd = parseFloat(document.getElementById('cropEndSlider').value) || 0;

            document.getElementById('cropStartInput').value = cropStart.toFixed(1);
            document.getElementById('cropEndInput').value = cropEnd.toFixed(1);

            // Apply crop to data
            const maxTime = flysightData[flysightData.length - 1].time;
            const endTime = maxTime - cropEnd;

            croppedFlysightData = flysightData.filter(d => d.time >= cropStart && d.time <= endTime);

            if (croppedFlysightData.length === 0) {
                document.getElementById('modalWorkingTime').textContent = 'No data';
                return;
            }

            // Recalculate working time for cropped data
            recalculateCroppedWorkingTime();
        }

        function recalculateCroppedWorkingTime() {
            if (!croppedFlysightData || croppedFlysightData.length === 0) return;

            // Find upper boundary (velD >= 10)
            let upperBoundaryAlt = null;
            let upperCrossTime = null;
            for (let i = 0; i < croppedFlysightData.length; i++) {
                if (croppedFlysightData[i].velD >= 10) {
                    upperBoundaryAlt = croppedFlysightData[i].alt;
                    upperCrossTime = croppedFlysightData[i].time;
                    break;
                }
            }

            // Fallback to max altitude
            if (upperBoundaryAlt === null) {
                upperBoundaryAlt = Math.max(...croppedFlysightData.map(d => d.alt));
                for (let i = 1; i < croppedFlysightData.length; i++) {
                    if (croppedFlysightData[i].alt < upperBoundaryAlt - 100) {
                        upperCrossTime = croppedFlysightData[i].time;
                        break;
                    }
                }
            }

            // WS Acrobatic altitude window rules:
            // Normal: 7500 ft below upper boundary
            // If lower exit rule enabled and exit altitude <= 11,500 ft AGL: 5000 ft below upper boundary
            const lowerExitRuleEnabled = document.getElementById('lowerExitRule').checked;
            const altWindow = (lowerExitRuleEnabled && upperBoundaryAlt <= 11500) ? 5000 : 7500;
            const lowerBoundary = upperBoundaryAlt - altWindow;

            // Find lower boundary crossing
            let lowerCrossTime = null;
            for (let i = 1; i < croppedFlysightData.length; i++) {
                if (croppedFlysightData[i-1].alt > lowerBoundary && croppedFlysightData[i].alt <= lowerBoundary) {
                    lowerCrossTime = croppedFlysightData[i].time;
                    break;
                }
            }

            // Update modal displays
            document.getElementById('modalUpperBoundary').textContent = Math.round(upperBoundaryAlt).toLocaleString() + ' ft';
            document.getElementById('modalLowerBoundary').textContent = Math.round(lowerBoundary).toLocaleString() + ' ft';

            const startTime = croppedFlysightData[0].time;
            const endTime = croppedFlysightData[croppedFlysightData.length - 1].time;
            document.getElementById('modalDataRange').textContent = startTime.toFixed(1) + 's - ' + endTime.toFixed(1) + 's';

            // Set up working time slider
            const slider = document.getElementById('workingTimeStartSlider');
            slider.min = startTime;
            slider.max = endTime;
            slider.value = upperCrossTime || startTime;
            slider.step = 0.1;
            document.getElementById('workingTimeStartDisplay').textContent = (upperCrossTime || startTime).toFixed(1) + 's';

            if (upperCrossTime !== null && lowerCrossTime !== null) {
                const wt = parseFloat((lowerCrossTime - upperCrossTime).toFixed(1));
                document.getElementById('modalWorkingTime').textContent = wt + ' s';
            } else {
                document.getElementById('modalWorkingTime').textContent = 'N/A';
            }

            // Color upper boundary
            const upperEl = document.getElementById('modalUpperBoundary');
            upperEl.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
            if (upperBoundaryAlt >= 12000 && upperBoundaryAlt <= 12500) {
                upperEl.classList.add('text-green-400');
            } else if (upperBoundaryAlt < 12000) {
                upperEl.classList.add('text-yellow-400');
            } else {
                upperEl.classList.add('text-red-400');
            }

            // Draw chart
            drawModalChart(upperBoundaryAlt, lowerBoundary, upperCrossTime);
        }

        function adjustWorkingTimeStart(value) {
            const newStartTime = parseFloat(value);
            document.getElementById('workingTimeStartDisplay').textContent = newStartTime.toFixed(1) + 's';

            // Find altitude at new start time
            let startAlt = null;
            for (let i = 0; i < croppedFlysightData.length; i++) {
                if (croppedFlysightData[i].time >= newStartTime) {
                    startAlt = croppedFlysightData[i].alt;
                    break;
                }
            }
            if (startAlt === null) return;

            // WS Acrobatic altitude window: 5000 ft if lower exit rule enabled and exit <= 11,500 ft, else 7500 ft
            const lowerExitRuleEnabled = document.getElementById('lowerExitRule').checked;
            const altWindow = (lowerExitRuleEnabled && startAlt <= 11500) ? 5000 : 7500;
            const newLowerBoundary = startAlt - altWindow;

            // Find lower boundary crossing
            let lowerCrossTime = null;
            for (let i = 1; i < croppedFlysightData.length; i++) {
                if (croppedFlysightData[i-1].alt > newLowerBoundary && croppedFlysightData[i].alt <= newLowerBoundary) {
                    lowerCrossTime = croppedFlysightData[i].time;
                    break;
                }
            }

            // Update displays
            document.getElementById('modalUpperBoundary').textContent = Math.round(startAlt).toLocaleString() + ' ft';
            document.getElementById('modalLowerBoundary').textContent = Math.round(newLowerBoundary).toLocaleString() + ' ft';

            if (lowerCrossTime !== null && lowerCrossTime > newStartTime) {
                const wt = parseFloat((lowerCrossTime - newStartTime).toFixed(1));
                document.getElementById('modalWorkingTime').textContent = wt + ' s';
            } else {
                document.getElementById('modalWorkingTime').textContent = 'N/A';
            }

            // Color upper boundary
            const upperEl = document.getElementById('modalUpperBoundary');
            upperEl.classList.remove('text-green-400', 'text-red-400', 'text-yellow-400');
            if (startAlt >= 12000 && startAlt <= 12500) {
                upperEl.classList.add('text-green-400');
            } else if (startAlt < 12000) {
                upperEl.classList.add('text-yellow-400');
            } else {
                upperEl.classList.add('text-red-400');
            }

            // Update chart
            drawModalChart(startAlt, newLowerBoundary, newStartTime);
        }

        function drawModalChart(upperBoundaryAlt, lowerBoundary, upperCrossTime) {
            if (!croppedFlysightData || croppedFlysightData.length === 0) return;

            const labels = croppedFlysightData.map(d => d.time.toFixed(1));
            const altitudes = croppedFlysightData.map(d => d.alt);
            const velocities = croppedFlysightData.map(d => d.velD);

            if (flysightModalChart) {
                flysightModalChart.destroy();
            }

            const ctx = document.getElementById('flysightModalChart').getContext('2d');
            flysightModalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Altitude (ft AGL)',
                        data: altitudes,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: 'y'
                    }, {
                        label: 'Vertical Vel (m/s)',
                        data: velocities,
                        borderColor: 'rgb(168, 85, 247)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        tension: 0.1,
                        pointRadius: 0,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { color: '#9ca3af', font: { size: 11 } } },
                        annotation: {
                            annotations: {
                                upperLine: {
                                    type: 'line', yMin: upperBoundaryAlt, yMax: upperBoundaryAlt, yScaleID: 'y',
                                    borderColor: 'rgb(34, 197, 94)', borderWidth: 2, borderDash: [5, 5],
                                    label: { display: true, content: 'Upper: ' + Math.round(upperBoundaryAlt) + ' ft', position: 'start', backgroundColor: 'rgba(34, 197, 94, 0.8)', color: 'white', font: { size: 10 } }
                                },
                                lowerLine: {
                                    type: 'line', yMin: lowerBoundary, yMax: lowerBoundary, yScaleID: 'y',
                                    borderColor: 'rgb(239, 68, 68)', borderWidth: 2, borderDash: [5, 5],
                                    label: { display: true, content: 'Lower: ' + Math.round(lowerBoundary) + ' ft', position: 'start', backgroundColor: 'rgba(239, 68, 68, 0.8)', color: 'white', font: { size: 10 } }
                                },
                                startLine: {
                                    type: 'line',
                                    xMin: upperCrossTime ? labels.indexOf(upperCrossTime.toFixed(1)) : 0,
                                    xMax: upperCrossTime ? labels.indexOf(upperCrossTime.toFixed(1)) : 0,
                                    borderColor: 'rgb(6, 182, 212)', borderWidth: 3,
                                    label: { display: true, content: 'Start', position: 'start', backgroundColor: 'rgba(6, 182, 212, 0.8)', color: 'white', font: { size: 10 } }
                                },
                                velThreshold: {
                                    type: 'line', yMin: 10, yMax: 10, yScaleID: 'y1',
                                    borderColor: 'rgba(168, 85, 247, 0.5)', borderWidth: 1, borderDash: [2, 2]
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Time (s)', color: '#9ca3af' }, ticks: { color: '#9ca3af', maxTicksLimit: 15 }, grid: { color: 'rgba(75, 85, 99, 0.3)' } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Altitude (ft AGL)', color: '#9ca3af' }, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(75, 85, 99, 0.3)' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Vel (m/s)', color: '#a855f7' }, ticks: { color: '#a855f7' }, grid: { display: false }, min: -10, max: 40 }
                    }
                }
            });
        }

        function confirmWorkingTime() {
            // Get the confirmed working time from modal
            const wtText = document.getElementById('modalWorkingTime').textContent;
            const wt = parseFloat(wtText);

            if (!isNaN(wt) && wt > 0) {
                wsWorkingTime = wt;
                confirmedWorkingTime = wt;

                // Update main display
                document.getElementById('flysightWorkingTime').textContent = wt + ' s';
                document.getElementById('flysightTimeDisplay').textContent = wt + 's';
                document.getElementById('flysightStatus').textContent = `Confirmed | WT: ${wt}s`;

                // Update upper/lower boundary from modal
                document.getElementById('upperBoundary').textContent = document.getElementById('modalUpperBoundary').textContent;
                document.getElementById('lowerBoundary').textContent = document.getElementById('modalLowerBoundary').textContent;
            }

            closeFlySightModal();
        }

        // Wingsuit Compulsory Scoring
        let wsCompulsoryNV = false;
        let wsCompSingleJudge = true;  // Default to single judge for practice
        let wsFreeSingleJudge = true;  // Default to single judge for practice

        function toggleWsCompJudgeMode() {
            const count = document.getElementById('wsCompJudgeCount').value;
            wsCompSingleJudge = (count === '1');

            if (wsCompSingleJudge) {
                document.getElementById('wsStyleSingleJudge').classList.remove('hidden');
                document.getElementById('wsStylePanelJudge').classList.add('hidden');
            } else {
                document.getElementById('wsStyleSingleJudge').classList.add('hidden');
                document.getElementById('wsStylePanelJudge').classList.remove('hidden');
            }
            calculateWsCompulsory();
        }

        function toggleWsFreeJudgeMode() {
            const count = document.getElementById('wsFreeJudgeCount').value;
            wsFreeSingleJudge = (count === '1');

            ['Style', 'Dive', 'Cam'].forEach(type => {
                if (wsFreeSingleJudge) {
                    document.getElementById(`wsFree${type}Single`).classList.remove('hidden');
                    document.getElementById(`wsFree${type}Panel`).classList.add('hidden');
                } else {
                    document.getElementById(`wsFree${type}Single`).classList.add('hidden');
                    document.getElementById(`wsFree${type}Panel`).classList.remove('hidden');
                }
            });
            calculateWsFree();
        }

        function calculateJudgeAverage(scores) {
            const validScores = scores.filter(s => !isNaN(s) && s !== null);
            if (validScores.length === 0) return 0;

            if (validScores.length === 5) {
                // Drop high and low
                validScores.sort((a, b) => a - b);
                const middle = validScores.slice(1, 4);
                return (middle.reduce((a, b) => a + b, 0) / 3).toFixed(1);
            } else if (validScores.length >= 3) {
                // Average all (for 3 judges)
                return (validScores.reduce((a, b) => a + b, 0) / validScores.length).toFixed(1);
            }
            return 0;
        }

        function calculateWsCompulsory() {
            // Get style scores
            let styleAvg;
            if (wsCompSingleJudge) {
                styleAvg = parseFloat(document.getElementById('wsStyleSingle').value) || 0;
                document.getElementById('wsStyleAvgSingle').textContent = styleAvg.toFixed(1);
            } else {
                const styleScores = [
                    parseFloat(document.getElementById('wsStyleJ1').value),
                    parseFloat(document.getElementById('wsStyleJ2').value),
                    parseFloat(document.getElementById('wsStyleJ3').value)
                ];
                styleAvg = calculateJudgeAverage(styleScores);
                document.getElementById('wsStyleAvg').textContent = styleAvg;
            }

            // Get maneuver omissions
            const maneuverOmissions = parseInt(document.getElementById('wsManeuverOmissions').value) || 0;
            const styleDeduction = maneuverOmissions * 1.5;
            const finalStyle = Math.max(0, parseFloat(styleAvg) - styleDeduction).toFixed(1);

            // Get grips
            const grips = parseInt(document.getElementById('wsGrips').value) || 0;
            const gripOmissions = parseInt(document.getElementById('wsGripOmissions').value) || 0;
            const infringements = parseInt(document.getElementById('wsInfringements').value) || 0;

            // Grip score = grips - omissions (infringements just mean 0 for those grips, already not counted)
            const gripScore = Math.max(0, grips - gripOmissions);
            document.getElementById('wsGripScore').textContent = gripScore;

            // Final scores
            if (wsCompulsoryNV) {
                document.getElementById('wsFinalStyle').textContent = '0.0';
                document.getElementById('wsFinalGrips').textContent = '0';
                document.getElementById('wsFinalStyle').classList.remove('text-green-400');
                document.getElementById('wsFinalStyle').classList.add('text-red-400');
                document.getElementById('wsFinalGrips').classList.remove('text-green-400');
                document.getElementById('wsFinalGrips').classList.add('text-red-400');
            } else {
                document.getElementById('wsFinalStyle').textContent = finalStyle;
                document.getElementById('wsFinalGrips').textContent = gripScore;
                document.getElementById('wsFinalStyle').classList.remove('text-red-400');
                document.getElementById('wsFinalStyle').classList.add('text-green-400');
                document.getElementById('wsFinalGrips').classList.remove('text-red-400');
                document.getElementById('wsFinalGrips').classList.add('text-green-400');
            }
        }

        function toggleWsNV() {
            wsCompulsoryNV = !wsCompulsoryNV;
            const btn = document.getElementById('wsNvBtn');
            if (wsCompulsoryNV) {
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = 'NV ACTIVE';
            } else {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                btn.textContent = 'NV Penalty';
            }
            calculateWsCompulsory();
        }

        // Wingsuit Free Round Scoring
        let wsFreeNV = false;

        function calculateWsFree() {
            let styleAvg, diveAvg, camAvg;

            if (wsFreeSingleJudge) {
                // Single judge mode
                styleAvg = parseFloat(document.getElementById('wsFreeStyleSingleInput').value) || 0;
                diveAvg = parseFloat(document.getElementById('wsFreeDiveSingleInput').value) || 0;
                camAvg = parseFloat(document.getElementById('wsFreeCamSingleInput').value) || 0;

                document.getElementById('wsFreeStyleAvgSingle').textContent = styleAvg.toFixed(1);
                document.getElementById('wsFreeDiveAvgSingle').textContent = diveAvg.toFixed(1);
                document.getElementById('wsFreeCamAvgSingle').textContent = camAvg.toFixed(1);
            } else {
                // 3 judge panel mode
                const styleScores = [
                    parseFloat(document.getElementById('wsFreeStyleJ1').value),
                    parseFloat(document.getElementById('wsFreeStyleJ2').value),
                    parseFloat(document.getElementById('wsFreeStyleJ3').value)
                ];
                styleAvg = calculateJudgeAverage(styleScores);
                document.getElementById('wsFreeStyleAvg').textContent = styleAvg;

                const diveScores = [
                    parseFloat(document.getElementById('wsFreeDiveJ1').value),
                    parseFloat(document.getElementById('wsFreeDiveJ2').value),
                    parseFloat(document.getElementById('wsFreeDiveJ3').value)
                ];
                diveAvg = calculateJudgeAverage(diveScores);
                document.getElementById('wsFreeDiveAvg').textContent = diveAvg;

                const camScores = [
                    parseFloat(document.getElementById('wsFreeCamJ1').value),
                    parseFloat(document.getElementById('wsFreeCamJ2').value),
                    parseFloat(document.getElementById('wsFreeCamJ3').value)
                ];
                camAvg = calculateJudgeAverage(camScores);
                document.getElementById('wsFreeCamAvg').textContent = camAvg;
            }

            // Final scores
            if (wsFreeNV) {
                document.getElementById('wsFreeStyleFinal').textContent = '0.0';
                document.getElementById('wsFreeDiveFinal').textContent = '0.0';
                document.getElementById('wsFreeCamFinal').textContent = '0.0';
                ['wsFreeStyleFinal', 'wsFreeDiveFinal', 'wsFreeCamFinal'].forEach(id => {
                    document.getElementById(id).classList.remove('text-green-400');
                    document.getElementById(id).classList.add('text-red-400');
                });
            } else {
                document.getElementById('wsFreeStyleFinal').textContent = styleAvg;
                document.getElementById('wsFreeDiveFinal').textContent = diveAvg;
                document.getElementById('wsFreeCamFinal').textContent = camAvg;
                ['wsFreeStyleFinal', 'wsFreeDiveFinal', 'wsFreeCamFinal'].forEach(id => {
                    document.getElementById(id).classList.remove('text-red-400');
                    document.getElementById(id).classList.add('text-green-400');
                });
            }
        }

        function toggleWsFreeNV() {
            wsFreeNV = !wsFreeNV;
            const btn = document.getElementById('wsFreeNvBtn');
            if (wsFreeNV) {
                btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                btn.textContent = 'NV ACTIVE';
            } else {
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                btn.textContent = 'NV Penalty';
            }
            calculateWsFree();
        }

        // ============================================
        // MULTI-JUDGE SCORING FUNCTIONS
        // ============================================

        let multiJudgeModeEnabled = false;
        let currentJudgeCount = 5;

        function toggleMultiJudgeMode() {
            multiJudgeModeEnabled = document.getElementById('multiJudgeMode').checked;
            const judgeCountSelect = document.getElementById('judgeCount');
            const saveSection = document.getElementById('multiJudgeSaveSection');

            // Show/hide judge count selector and save section
            if (multiJudgeModeEnabled) {
                judgeCountSelect.classList.remove('hidden');
                saveSection.classList.remove('hidden');
            } else {
                judgeCountSelect.classList.add('hidden');
                saveSection.classList.add('hidden');
            }

            // Update which panel is visible based on event type
            updateMultiJudgePanelVisibility();
        }

        function updateMultiJudgePanelVisibility() {
            const eventType = document.getElementById('eventType').value;

            // Hide all panels first
            document.getElementById('fsMultiJudgePanel').classList.add('hidden');
            document.getElementById('cfMultiJudgePanel').classList.add('hidden');
            document.getElementById('artisticMultiJudgePanel').classList.add('hidden');

            if (!multiJudgeModeEnabled) return;

            // Determine which panel to show based on event type
            // FS/VFS events: 4way, 8way, 4way-vfs, vfs
            // CF events: 2way-cf, 4way-cf, 4way-cf-rotation, 8way-cf
            // Artistic events: freefly, freestyle, artistic-freefly, artistic-freestyle

            const fsEvents = ['4way', '8way', '4way-vfs', 'vfs', '4way-inter', '8way-inter', '10way'];
            const cfEvents = ['2way-cf', '4way-cf', '4way-cf-rotation', '8way-cf', 'cf-2way', 'cf-4way', 'cf-8way'];
            const artisticEvents = ['freefly', 'freestyle', 'artistic-freefly', 'artistic-freestyle',
                                    'fs-artistic', 'artistic', 'freefly-ae', 'freestyle-ae'];

            if (fsEvents.includes(eventType)) {
                document.getElementById('fsMultiJudgePanel').classList.remove('hidden');
            } else if (cfEvents.includes(eventType)) {
                document.getElementById('cfMultiJudgePanel').classList.remove('hidden');
            } else if (artisticEvents.includes(eventType)) {
                document.getElementById('artisticMultiJudgePanel').classList.remove('hidden');
            } else {
                // Default to FS panel for unlisted events
                document.getElementById('fsMultiJudgePanel').classList.remove('hidden');
            }
        }

        function updateJudgeCount() {
            currentJudgeCount = parseInt(document.getElementById('judgeCount').value);

            // Update FS panel visibility
            for (let i = 1; i <= 5; i++) {
                const input = document.getElementById('fsJ' + i);
                const cfInput = document.getElementById('cfJ' + i);
                const artPresInput = document.getElementById('artPresJ' + i);
                const artTechInput = document.getElementById('artTechJ' + i);

                if (input) {
                    const parent = input.closest('.text-center');
                    if (i <= currentJudgeCount) {
                        parent.classList.remove('hidden');
                    } else {
                        parent.classList.add('hidden');
                        input.value = '';
                    }
                }

                if (cfInput) {
                    const parent = cfInput.closest('.text-center');
                    if (i <= currentJudgeCount) {
                        parent.classList.remove('hidden');
                    } else {
                        parent.classList.add('hidden');
                        cfInput.value = '';
                    }
                }

                if (artPresInput) {
                    const parent = artPresInput.closest('.text-center');
                    if (i <= currentJudgeCount) {
                        parent.classList.remove('hidden');
                    } else {
                        parent.classList.add('hidden');
                        artPresInput.value = '';
                    }
                }

                if (artTechInput) {
                    const parent = artTechInput.closest('.text-center');
                    if (i <= currentJudgeCount) {
                        parent.classList.remove('hidden');
                    } else {
                        parent.classList.add('hidden');
                        artTechInput.value = '';
                    }
                }
            }

            // Recalculate averages
            calculateFsAverage();
            calculateCfAverage();
            calculateArtisticScores();
        }

        function calculateFsAverage() {
            const scores = [];
            for (let i = 1; i <= currentJudgeCount; i++) {
                const input = document.getElementById('fsJ' + i);
                if (input && input.value !== '') {
                    scores.push(parseInt(input.value) || 0);
                }
            }

            if (scores.length === 0) {
                document.getElementById('fsJudgeAverage').textContent = '0.0';
                document.getElementById('fsJudgeSpread').textContent = '0';
                document.getElementById('fsSpreadWarning').classList.add('hidden');
                return;
            }

            // Calculate average
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            document.getElementById('fsJudgeAverage').textContent = avg.toFixed(1);

            // Calculate spread (max - min)
            const spread = Math.max(...scores) - Math.min(...scores);
            document.getElementById('fsJudgeSpread').textContent = spread;

            // Show warning if spread is >= 3 (indicating disagreement)
            if (spread >= 3) {
                document.getElementById('fsSpreadWarning').classList.remove('hidden');
            } else {
                document.getElementById('fsSpreadWarning').classList.add('hidden');
            }
        }

        function calculateCfAverage() {
            const scores = [];
            for (let i = 1; i <= currentJudgeCount; i++) {
                const input = document.getElementById('cfJ' + i);
                if (input && input.value !== '') {
                    scores.push(parseInt(input.value) || 0);
                }
            }

            if (scores.length === 0) {
                document.getElementById('cfJudgeAverage').textContent = '0.0';
                document.getElementById('cfJudgeSpread').textContent = '0';
                return;
            }

            // Calculate average
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            document.getElementById('cfJudgeAverage').textContent = avg.toFixed(1);

            // Calculate spread (max - min)
            const spread = Math.max(...scores) - Math.min(...scores);
            document.getElementById('cfJudgeSpread').textContent = spread;
        }

        function calculateArtisticScores() {
            // Calculate Presentation average
            const presScores = [];
            for (let i = 1; i <= currentJudgeCount; i++) {
                const input = document.getElementById('artPresJ' + i);
                if (input && input.value !== '') {
                    presScores.push(parseFloat(input.value) || 0);
                }
            }

            const presAvg = presScores.length > 0 ?
                presScores.reduce((a, b) => a + b, 0) / presScores.length : 0;
            document.getElementById('artPresAvg').textContent = presAvg.toFixed(2);
            document.getElementById('artPresFinal').textContent = presAvg.toFixed(2);

            // Calculate Technical average
            const techScores = [];
            for (let i = 1; i <= currentJudgeCount; i++) {
                const input = document.getElementById('artTechJ' + i);
                if (input && input.value !== '') {
                    techScores.push(parseFloat(input.value) || 0);
                }
            }

            const techAvg = techScores.length > 0 ?
                techScores.reduce((a, b) => a + b, 0) / techScores.length : 0;
            document.getElementById('artTechAvg').textContent = techAvg.toFixed(2);
            document.getElementById('artTechFinal').textContent = techAvg.toFixed(2);

            // Get Difficulty score
            const difficulty = parseFloat(document.getElementById('artDifficulty').value) || 0;
            document.getElementById('artDiffFinal').textContent = difficulty.toFixed(2);

            // Calculate total (Presentation + Technical + Difficulty)
            const total = presAvg + techAvg + difficulty;
            document.getElementById('artTotalScore').textContent = total.toFixed(2);
        }

        function saveMultiJudgeScore() {
            const eventType = document.getElementById('eventType').value;
            let scoreData = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                eventType: eventType,
                multiJudge: true,
                judgeCount: currentJudgeCount
            };

            // Determine which type of score to save based on visible panel
            const fsPanel = document.getElementById('fsMultiJudgePanel');
            const cfPanel = document.getElementById('cfMultiJudgePanel');
            const artisticPanel = document.getElementById('artisticMultiJudgePanel');

            if (!fsPanel.classList.contains('hidden')) {
                // Save FS/VFS score
                const judges = [];
                for (let i = 1; i <= currentJudgeCount; i++) {
                    const input = document.getElementById('fsJ' + i);
                    if (input) judges.push(parseInt(input.value) || 0);
                }
                scoreData.type = 'fs-multijudge';
                scoreData.judges = judges;
                scoreData.average = parseFloat(document.getElementById('fsJudgeAverage').textContent);
                scoreData.spread = parseInt(document.getElementById('fsJudgeSpread').textContent);
                scoreData.round = 'FS Round ' + (savedScores.filter(s => s.type === 'fs-multijudge').length + 1);
            } else if (!cfPanel.classList.contains('hidden')) {
                // Save CF score
                const judges = [];
                for (let i = 1; i <= currentJudgeCount; i++) {
                    const input = document.getElementById('cfJ' + i);
                    if (input) judges.push(parseInt(input.value) || 0);
                }
                scoreData.type = 'cf-multijudge';
                scoreData.judges = judges;
                scoreData.average = parseFloat(document.getElementById('cfJudgeAverage').textContent);
                scoreData.spread = parseInt(document.getElementById('cfJudgeSpread').textContent);
                scoreData.round = 'CF Round ' + (savedScores.filter(s => s.type === 'cf-multijudge').length + 1);
            } else if (!artisticPanel.classList.contains('hidden')) {
                // Save Artistic score
                const presJudges = [];
                const techJudges = [];
                for (let i = 1; i <= currentJudgeCount; i++) {
                    const presInput = document.getElementById('artPresJ' + i);
                    const techInput = document.getElementById('artTechJ' + i);
                    if (presInput) presJudges.push(parseFloat(presInput.value) || 0);
                    if (techInput) techJudges.push(parseFloat(techInput.value) || 0);
                }
                scoreData.type = 'artistic-multijudge';
                scoreData.presentationJudges = presJudges;
                scoreData.technicalJudges = techJudges;
                scoreData.presentation = parseFloat(document.getElementById('artPresFinal').textContent);
                scoreData.technical = parseFloat(document.getElementById('artTechFinal').textContent);
                scoreData.difficulty = parseFloat(document.getElementById('artDiffFinal').textContent);
                scoreData.total = parseFloat(document.getElementById('artTotalScore').textContent);
                scoreData.round = 'Artistic Round ' + (savedScores.filter(s => s.type === 'artistic-multijudge').length + 1);
            }

            savedScores.push(scoreData);
            localStorage.setItem('practiceScores_' + videoId, JSON.stringify(savedScores));
            displaySavedScores();

            // Clear inputs after saving
            clearMultiJudgeInputs();

            alert('Score saved! ' + (scoreData.average || scoreData.total).toFixed(2));
        }

        function clearMultiJudgeInputs() {
            // Clear FS inputs
            for (let i = 1; i <= 5; i++) {
                const fsInput = document.getElementById('fsJ' + i);
                const cfInput = document.getElementById('cfJ' + i);
                const presInput = document.getElementById('artPresJ' + i);
                const techInput = document.getElementById('artTechJ' + i);

                if (fsInput) fsInput.value = '';
                if (cfInput) cfInput.value = '';
                if (presInput) presInput.value = '';
                if (techInput) techInput.value = '';
            }
            document.getElementById('artDifficulty').value = '';

            // Reset displays
            calculateFsAverage();
            calculateCfAverage();
            calculateArtisticScores();
        }

        // Update multi-judge panel when event type changes
        const originalUpdateEventType = updateEventType;
        updateEventType = function() {
            originalUpdateEventType();
            updateMultiJudgePanelVisibility();
        };
    </script>

    <!-- FlySight Modal -->
    <div id="flysightModal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-gray-800 rounded-xl w-full max-w-5xl max-h-[90vh] overflow-auto">
            <div class="p-4 border-b border-gray-700 flex items-center justify-between">
                <h3 class="text-lg font-bold text-white">FlySight Altitude Profile</h3>
                <button onclick="closeFlySightModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-4">
                <!-- Crop Controls -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-gray-400 text-sm block mb-1">Crop Start (seconds from beginning)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="cropStartSlider" min="0" max="100" value="0"
                                class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                oninput="updateCropPreview()">
                            <input type="number" id="cropStartInput" value="0" step="0.1" min="0"
                                class="w-20 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center"
                                onchange="updateCropFromInput('start')">
                            <span class="text-gray-500 text-sm">s</span>
                        </div>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm block mb-1">Crop End (seconds from end)</label>
                        <div class="flex items-center gap-2">
                            <input type="range" id="cropEndSlider" min="0" max="100" value="0"
                                class="flex-1 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                oninput="updateCropPreview()">
                            <input type="number" id="cropEndInput" value="0" step="0.1" min="0"
                                class="w-20 px-2 py-1 rounded bg-gray-700 text-white text-sm text-center"
                                onchange="updateCropFromInput('end')">
                            <span class="text-gray-500 text-sm">s</span>
                        </div>
                    </div>
                </div>

                <!-- Working Time Adjustment -->
                <div class="bg-gray-900 rounded-lg p-3 mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-400 text-sm">Working Time Start (velD ≥ 10 m/s)</span>
                        <div class="flex items-center gap-2">
                            <input type="range" id="workingTimeStartSlider" min="0" max="100" value="0"
                                class="w-48 h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                oninput="adjustWorkingTimeStart(this.value)">
                            <span id="workingTimeStartDisplay" class="text-cyan-400 font-mono text-sm w-20">0.0s</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-4 text-center">
                        <div>
                            <div class="text-gray-500 text-xs">Upper Boundary</div>
                            <div id="modalUpperBoundary" class="text-green-400 font-mono">-- ft</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Lower Boundary</div>
                            <div id="modalLowerBoundary" class="text-red-400 font-mono">-- ft</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Working Time</div>
                            <div id="modalWorkingTime" class="text-yellow-400 font-mono text-xl font-bold">--.- s</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs">Data Range</div>
                            <div id="modalDataRange" class="text-gray-400 font-mono text-sm">0s - 0s</div>
                        </div>
                    </div>
                </div>

                <!-- Graph -->
                <div class="bg-gray-900 rounded-lg p-2" style="height: 400px;">
                    <canvas id="flysightModalChart"></canvas>
                </div>

                <!-- Legend -->
                <div class="flex items-center justify-center gap-6 mt-3 text-xs">
                    <span class="text-blue-400">━ Altitude (ft AGL)</span>
                    <span class="text-purple-400">╌ Vertical Vel (m/s)</span>
                    <span class="text-green-400">┅ Upper Boundary</span>
                    <span class="text-red-400">┅ Lower Boundary</span>
                    <span class="text-cyan-400">│ Start Time</span>
                </div>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-700 flex items-center justify-between">
                <div class="text-gray-500 text-sm">
                    Review the altitude profile and adjust working time start if needed.
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="closeFlySightModal()" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-sm">
                        Cancel
                    </button>
                    <button onclick="confirmWorkingTime()" class="px-6 py-2 rounded bg-green-600 hover:bg-green-700 text-sm font-bold">
                        ✓ Agree & Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if is_admin %}
    <!-- Edit Title Modal -->
    <div id="editTitleModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Rename Video</h2>
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">Title</label>
                <input type="text" id="editTitleInput"
                    value="{{ video.title }}"
                    class="w-full px-4 py-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Video title">
            </div>
            <div class="flex justify-end gap-3">
                <button onclick="hideEditTitleModal()" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500">
                    Cancel
                </button>
                <button onclick="saveVideoTitle()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 font-medium">
                    Save
                </button>
            </div>
        </div>
    </div>

    <script>
        function showEditTitleModal() {
            document.getElementById('editTitleModal').classList.remove('hidden');
            document.getElementById('editTitleInput').focus();
            document.getElementById('editTitleInput').select();
        }

        function hideEditTitleModal() {
            document.getElementById('editTitleModal').classList.add('hidden');
        }

        async function saveVideoTitle() {
            const newTitle = document.getElementById('editTitleInput').value.trim();
            if (!newTitle) {
                alert('Please enter a title');
                return;
            }

            try {
                const response = await fetch('/admin/edit-video/{{ video.id }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('videoTitle').textContent = newTitle;
                    document.title = newTitle + ' - Video Library';
                    hideEditTitleModal();
                } else {
                    alert(result.error || 'Failed to rename video');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Allow Enter to save title
        document.getElementById('editTitleInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveVideoTitle();
            } else if (e.key === 'Escape') {
                hideEditTitleModal();
            }
        });
    </script>
    {% endif %}

    {% if competition_context and is_admin %}
    <!-- Quick Score Modal (for competition judging) -->
    <div id="quickScoreModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm mx-4">
            <h2 class="text-xl font-bold mb-2">Enter Score</h2>
            <p class="text-gray-400 text-sm mb-4">{{ competition_context.team_name }} - Round {{ competition_context.round_num }}</p>

            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">Score</label>
                <input type="number" id="quickScoreInput" step="1" min="0"
                    value="{{ competition_context.current_score if competition_context.current_score is not none else '' }}"
                    class="w-full px-4 py-3 rounded bg-gray-700 text-white text-3xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="--" autofocus>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="hideQuickScoreModal()" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-500">
                    Cancel
                </button>
                <button onclick="saveQuickScore()" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 font-medium">
                    Save Score
                </button>
            </div>
        </div>
    </div>

    <script>
        const competitionContext = {
            competitionId: '{{ competition_context.competition_id }}',
            teamId: '{{ competition_context.team_id }}',
            roundNum: {{ competition_context.round_num }}
        };

        function showQuickScoreModal() {
            document.getElementById('quickScoreModal').classList.remove('hidden');
            document.getElementById('quickScoreInput').focus();
        }

        function hideQuickScoreModal() {
            document.getElementById('quickScoreModal').classList.add('hidden');
        }

        async function saveQuickScore() {
            const scoreInput = document.getElementById('quickScoreInput').value;
            if (scoreInput === '' || scoreInput === null) {
                alert('Please enter a score');
                return;
            }

            const score = parseFloat(scoreInput);

            try {
                const response = await fetch('/videographer/team/' + competitionContext.teamId + '/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        round_num: competitionContext.roundNum,
                        score: score,
                        video_id: '{{ video.id }}'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Score saved!');
                    hideQuickScoreModal();
                    // Optionally redirect back to competition
                    // window.location.href = '/competition/' + competitionContext.competitionId;
                } else {
                    alert(result.error || 'Failed to save score');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Allow Enter to save score in modal
        document.getElementById('quickScoreInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                saveQuickScore();
            }
        });
    </script>
    {% endif %}

    {% if is_event_judge %}
    <script>
        async function startSyncViewing() {
            try {
                const response = await fetch('/sync-room/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_id: '{{ video.id }}' })
                });
                const result = await response.json();
                if (result.success) {
                    window.location.href = '/sync-room/' + result.room_id;
                } else {
                    alert(result.error || 'Failed to create sync room');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
    </script>
    {% endif %}
</body>
</html>
