<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    {% if dropbox_app_key %}
    <script src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="{{ dropbox_app_key }}"></script>
    {% endif %}
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-purple-800 p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/admin" class="text-2xl font-bold text-white">Admin</a>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-green-600 hover:bg-green-500 px-4 py-2 rounded-lg font-semibold">Videos</a>
                <a href="/competitions" class="bg-yellow-600 hover:bg-yellow-500 text-black px-4 py-2 rounded-lg font-semibold">Competitions</a>
                <a href="/draw-generator" class="bg-purple-600 hover:bg-purple-500 px-4 py-2 rounded-lg font-semibold">Draw Generator</a>
                <a href="/draw-generator/svnh" class="bg-orange-600 hover:bg-orange-500 px-4 py-2 rounded-lg font-semibold">SVNH Draw</a>
                <a href="/admin/users" class="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded-lg">Users</a>
                <a href="/logout" class="text-purple-200 hover:text-white">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-4xl font-bold text-blue-400">{{ total_videos }}</p>
                <p class="text-gray-400">Total Videos</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-2">Auto-categorize from filenames</p>
                <div class="flex items-center gap-2 mb-2">
                    <select id="autoCategorizeScope" class="bg-gray-700 text-white text-sm px-2 py-1 rounded">
                        <option value="uncategorized">Uncategorized Only</option>
                        <option value="all">All Files (PIN required)</option>
                    </select>
                </div>
                <button onclick="autoCategorize()" id="autoCategorizeBtn" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-sm">
                    Auto-Categorize
                </button>
                <p id="autoCategorizeMessage" class="text-sm mt-2 hidden"></p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-3">Migrate existing videos to AWS S3</p>
                <button onclick="migrateToS3()" id="migrateS3Btn" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm">
                    Migrate to S3
                </button>
                <p id="migrateS3Message" class="text-sm mt-2 hidden"></p>

                <p class="text-gray-400 text-sm mb-3 mt-4">Delete all Vimeo videos (cannot be migrated to S3)</p>
                <button onclick="deleteVimeoVideos()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm">
                    Delete Vimeo Videos
                </button>
                <p id="deleteVimeoMessage" class="text-sm mt-2 hidden"></p>

                <p class="text-gray-400 text-sm mb-3 mt-4">Remove duplicate videos (same URL or title+duration)</p>
                <button onclick="fixDuplicates()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm">
                    Fix Duplicates
                </button>
                <p id="fixDuplicatesMessage" class="text-sm mt-2 hidden"></p>
            </div>
        </div>

        <!-- Background Conversion Status -->
        <div id="conversionStatusPanel" class="bg-gray-800 rounded-lg p-6 mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Background Conversions</h2>
                <button onclick="clearCompletedConversions()" class="text-sm text-gray-400 hover:text-white">
                    Clear Completed
                </button>
            </div>
            <div id="conversionJobsList" class="space-y-3">
                <!-- Jobs will be inserted here -->
            </div>
        </div>

        <!-- S3 Upload Status Banner -->
        <div id="s3StatusBanner" class="hidden bg-green-900/30 border border-green-700 rounded-lg p-4 mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg class="w-6 h-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <div>
                        <span class="text-green-400 font-medium">AWS S3 Connected</span>
                        <span id="s3BucketName" class="text-gray-400 ml-2"></span>
                    </div>
                </div>
                <span class="text-gray-400 text-sm">Videos will be uploaded directly to S3</span>
            </div>
        </div>

        <!-- Direct File Upload -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Upload Video Files</h2>
                <div id="uploadDestination" class="text-sm">
                    <span class="text-gray-400">Upload to: </span>
                    <span id="uploadDestinationLabel" class="text-blue-400">Local/Supabase</span>
                </div>
            </div>
            <p class="text-gray-400 text-sm mb-4">Drag & drop video files or click to select. MP4, WebM, MOV supported. MTS/AVI/MKV will be converted.</p>
            <div class="flex flex-wrap gap-4 items-end mb-4">
                <div class="w-48">
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="uploadCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateUploadSubcategories()">
                        <option value="">Select</option>
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="uploadSubcategoryDiv" class="w-48 hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="uploadSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="w-64">
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="uploadEvent" list="uploadEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 Nationals">
                    <datalist id="uploadEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
            </div>
            <div id="dropZone"
                class="border-2 border-dashed border-gray-600 rounded-lg p-8 text-center cursor-pointer hover:border-purple-500 transition"
                ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)"
                onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" multiple accept="video/*" class="hidden" onchange="handleFileSelect(event)">
                <svg class="w-12 h-12 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
                <p class="text-gray-400">Drag & drop videos here or click to browse</p>
                <p class="text-gray-500 text-sm mt-2">MP4, WebM, MOV, MTS, AVI, MKV</p>
            </div>
            <div id="uploadProgress" class="mt-4 hidden"></div>
            <div id="uploadResults" class="mt-4 hidden"></div>
        </div>

        <!-- Export Video URLs -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Export Video URLs</h2>
            <p class="text-gray-400 text-sm mb-4">View and copy all video URLs from the library. Filter by source type.</p>
            <div class="flex flex-wrap gap-4 mb-4">
                <div>
                    <label class="block text-gray-300 mb-2">Filter by Source</label>
                    <select id="exportUrlFilter"
                        class="w-48 px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="filterExportUrls()">
                        <option value="all">All URLs</option>
                        <option value="vimeo">Vimeo Only</option>
                        <option value="youtube">YouTube Only</option>
                        <option value="dropbox">Dropbox Only</option>
                        <option value="supabase">Supabase Storage</option>
                        <option value="other">Other URLs</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Category</label>
                    <select id="exportUrlCategory"
                        class="w-48 px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="filterExportUrls()">
                        <option value="all">All Categories</option>
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button type="button" onclick="loadVideoUrls()"
                        class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold transition">
                        Load URLs
                    </button>
                    <button type="button" onclick="copyExportUrls()"
                        class="bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-lg font-semibold transition">
                        Copy All
                    </button>
                </div>
            </div>
            <div class="mb-2 flex items-center justify-between">
                <span id="exportUrlCount" class="text-gray-400 text-sm"></span>
                <label class="flex items-center gap-2 text-sm">
                    <input type="checkbox" id="exportIncludeTitles" checked class="rounded bg-gray-700 border-gray-600">
                    <span class="text-gray-400">Include titles</span>
                </label>
            </div>
            <textarea id="exportUrlsOutput" rows="8" readonly placeholder="Click 'Load URLs' to view video URLs..."
                class="w-full px-4 py-3 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono text-sm"></textarea>
        </div>

        {% if dropbox_app_key %}
        <!-- Bulk Upload from Dropbox -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Bulk Upload from Dropbox</h2>
            <p class="text-gray-400 text-sm mb-4">Select multiple videos from Dropbox, then choose category before uploading.</p>
            <button type="button" onclick="chooseMultipleFromDropbox()"
                class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg font-semibold transition">
                Select Videos from Dropbox
            </button>
        </div>
        {% endif %}

        <!-- Video List -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-6">Manage Videos</h2>
            <div class="space-y-3 max-h-[800px] overflow-y-auto">
                {% if videos %}
                {% for video in videos %}
                <div class="bg-gray-700 rounded-lg p-4" data-video-id="{{ video.id }}">
                    <div class="flex gap-4">
                        <div class="w-32 h-20 bg-gray-600 rounded flex-shrink-0 overflow-hidden">
                            {% if video.thumbnail %}
                            <img src="{{ video.thumbnail }}" alt="{{ video.title }}" class="w-full h-full object-cover">
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2">
                                <input type="text" value="{{ video.title }}"
                                    class="flex-1 font-semibold text-white bg-transparent border-b border-transparent hover:border-gray-500 focus:border-blue-500 focus:outline-none px-1 py-0.5"
                                    onchange="quickRenameVideo('{{ video.id }}', this.value)"
                                    onkeydown="if(event.key==='Enter'){this.blur();}">
                            </div>
                            <div class="flex items-center gap-2 mt-1 text-sm text-gray-400">
                                <select onchange="quickChangeCategory('{{ video.id }}', this.value, this)"
                                    class="bg-blue-600 text-white px-2 py-0.5 rounded text-xs cursor-pointer hover:bg-blue-500"
                                    data-video-id="{{ video.id }}">
                                    {% for cat_id, cat in categories.items() %}
                                    <option value="{{ cat_id }}" {% if cat_id == video.category %}selected{% endif %}>{{ cat.abbrev }}</option>
                                    {% endfor %}
                                </select>
                                <select onchange="quickChangeSubcategory('{{ video.id }}', this.value)"
                                    class="bg-gray-600 text-white px-2 py-0.5 rounded text-xs cursor-pointer hover:bg-gray-500 subcategory-select"
                                    data-video-id="{{ video.id }}" data-current="{{ video.subcategory|default('', true) }}"
                                    {% if not categories.get(video.category, {}).get('subcategories') %}style="display:none"{% endif %}>
                                    <option value="">--</option>
                                    {% if categories.get(video.category, {}).get('subcategories') %}
                                    {% for sub in categories.get(video.category, {}).get('subcategories', []) %}
                                    <option value="{{ sub.id }}" {% if sub.id == video.subcategory %}selected{% endif %}>{{ sub.name }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                                <span>{{ video.views }} views</span>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="editVideo('{{ video.id }}')"
                                    class="text-blue-400 hover:text-blue-300 text-sm">Details</button>
                                <button onclick="deleteVideo('{{ video.id }}')"
                                    class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                <a href="/video/{{ video.id }}" target="_blank"
                                    class="text-gray-400 hover:text-gray-300 text-sm">View</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-8 text-gray-500">
                    <p>No videos yet. Upload videos using the sections above.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Upload Videos</h3>
            <p id="bulkFileCount" class="text-gray-400 mb-4">0 videos selected</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="modalCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateModalSubcategories()">
                        <option value="">Select category</option>
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="modalSubcategoryDiv" class="hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="modalSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">All / None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="modalEvent" list="modalEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 Nationals">
                    <datalist id="modalEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div id="modalProgress" class="hidden"></div>
                <div id="modalMessage" class="hidden"></div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeBulkUploadModal()"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmBulkUpload()"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                        Upload Videos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Video</h3>
            <form id="editVideoForm" class="space-y-4">
                <input type="hidden" id="editVideoId">
                <div>
                    <label class="block text-gray-300 mb-2">Title *</label>
                    <input type="text" id="editTitle" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Video URL *</label>
                    <input type="url" id="editUrl" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="editCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateEditSubcategories()">
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="editSubcategoryDiv" class="hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="editSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select subcategory</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="editEvent" list="editEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 Nationals">
                    <datalist id="editEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Description</label>
                    <textarea id="editDescription" rows="3"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Duration</label>
                        <input type="text" id="editDuration"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Tags</label>
                        <input type="text" id="editTags"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const categories = {{ categories | tojson }};
        let pendingFiles = []; // Store files selected from Dropbox
        let s3Enabled = false;
        let s3Bucket = null;

        // Check S3 status on page load
        async function checkS3Status() {
            try {
                const response = await fetch('/admin/s3-status');
                const result = await response.json();
                s3Enabled = result.enabled;
                s3Bucket = result.bucket;

                if (s3Enabled) {
                    document.getElementById('s3StatusBanner').classList.remove('hidden');
                    document.getElementById('s3BucketName').textContent = `(${s3Bucket})`;
                    document.getElementById('uploadDestinationLabel').textContent = 'AWS S3';
                    document.getElementById('uploadDestinationLabel').classList.remove('text-blue-400');
                    document.getElementById('uploadDestinationLabel').classList.add('text-green-400');
                }
            } catch (err) {
                console.log('S3 status check failed:', err);
            }
        }
        checkS3Status();

        // File Upload
        function updateUploadSubcategories() {
            const catId = document.getElementById('uploadCategory').value;
            const subDiv = document.getElementById('uploadSubcategoryDiv');
            const subSelect = document.getElementById('uploadSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">Select</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        // ============================================
        // EXPORT VIDEO URLs FUNCTIONS
        // ============================================

        let allVideoUrls = [];

        async function loadVideoUrls() {
            const outputEl = document.getElementById('exportUrlsOutput');
            const countEl = document.getElementById('exportUrlCount');

            outputEl.value = 'Loading...';
            countEl.textContent = '';

            try {
                const response = await fetch('/admin/export-urls');
                const result = await response.json();

                if (result.success) {
                    allVideoUrls = result.videos;
                    filterExportUrls();
                } else {
                    outputEl.value = 'Error: ' + result.error;
                }
            } catch (err) {
                outputEl.value = 'Error: ' + err.message;
            }
        }

        function filterExportUrls() {
            const sourceFilter = document.getElementById('exportUrlFilter').value;
            const categoryFilter = document.getElementById('exportUrlCategory').value;
            const includeTitles = document.getElementById('exportIncludeTitles').checked;
            const outputEl = document.getElementById('exportUrlsOutput');
            const countEl = document.getElementById('exportUrlCount');

            if (allVideoUrls.length === 0) {
                outputEl.value = 'Click "Load URLs" to view video URLs...';
                countEl.textContent = '';
                return;
            }

            let filtered = allVideoUrls;

            // Filter by category
            if (categoryFilter !== 'all') {
                filtered = filtered.filter(v => v.category === categoryFilter);
            }

            // Filter by source type
            if (sourceFilter !== 'all') {
                filtered = filtered.filter(v => {
                    const url = (v.url || '').toLowerCase();
                    switch(sourceFilter) {
                        case 'vimeo':
                            return url.includes('vimeo.com');
                        case 'youtube':
                            return url.includes('youtube.com') || url.includes('youtu.be');
                        case 'dropbox':
                            return url.includes('dropbox.com');
                        case 'supabase':
                            return url.includes('supabase.co/storage') || url.includes('supabase.in/storage');
                        case 'other':
                            return !url.includes('vimeo.com') &&
                                   !url.includes('youtube.com') &&
                                   !url.includes('youtu.be') &&
                                   !url.includes('dropbox.com') &&
                                   !url.includes('supabase.co/storage') &&
                                   !url.includes('supabase.in/storage');
                        default:
                            return true;
                    }
                });
            }

            // Format output
            let output;
            if (includeTitles) {
                output = filtered.map(v => `${v.title}\n${v.url}`).join('\n\n');
            } else {
                output = filtered.map(v => v.url).join('\n');
            }

            outputEl.value = output || 'No matching videos found';
            countEl.textContent = `${filtered.length} video${filtered.length !== 1 ? 's' : ''} found`;
        }

        function copyExportUrls() {
            const outputEl = document.getElementById('exportUrlsOutput');
            if (!outputEl.value || outputEl.value.includes('Click "Load URLs"') || outputEl.value.includes('Loading')) {
                alert('Please load URLs first');
                return;
            }

            navigator.clipboard.writeText(outputEl.value).then(() => {
                const countEl = document.getElementById('exportUrlCount');
                const originalText = countEl.textContent;
                countEl.textContent = 'Copied to clipboard!';
                countEl.classList.add('text-green-400');
                setTimeout(() => {
                    countEl.textContent = originalText;
                    countEl.classList.remove('text-green-400');
                }, 2000);
            }).catch(err => {
                // Fallback for older browsers
                outputEl.select();
                document.execCommand('copy');
                alert('URLs copied to clipboard');
            });
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('border-purple-500', 'bg-gray-700');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-purple-500', 'bg-gray-700');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('border-purple-500', 'bg-gray-700');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('video/') ||
                f.name.toLowerCase().match(/\.(mp4|webm|mov|m4v|ogg|ogv|mts|m2ts|avi|mkv)$/));
            if (files.length > 0) {
                uploadFiles(files);
            }
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            if (files.length > 0) {
                uploadFiles(files);
            }
        }

        async function uploadFiles(files) {
            const category = document.getElementById('uploadCategory').value;
            const subcategory = document.getElementById('uploadSubcategory').value;
            const event = document.getElementById('uploadEvent').value;

            // Category is optional - will default to 'uncategorized'

            const progressDiv = document.getElementById('uploadProgress');
            const resultsDiv = document.getElementById('uploadResults');
            progressDiv.classList.remove('hidden');
            resultsDiv.classList.add('hidden');

            let uploaded = 0;
            let failed = 0;
            let backgroundJobs = 0;
            const results = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                progressDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-purple-500"></div>
                        <span>Uploading ${i + 1}/${files.length}: ${file.name}</span>
                    </div>
                `;

                const formData = new FormData();
                formData.append('file', file);
                formData.append('category', category);
                formData.append('subcategory', subcategory);
                formData.append('event', event);
                formData.append('title', file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' '));
                formData.append('background', 'true');

                // Choose upload endpoint based on S3 status
                const ext = file.name.split('.').pop().toLowerCase();
                const s3Compatible = ['mp4', 'webm', 'mov', 'm4v', 'ogg', 'ogv'].includes(ext);
                const uploadUrl = (s3Enabled && s3Compatible) ? '/admin/upload-to-s3' : '/admin/upload-video';

                try {
                    const response = await fetch(uploadUrl, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();

                    if (result.success) {
                        if (result.background) {
                            backgroundJobs++;
                            results.push({ name: file.name, success: true, background: true, jobId: result.job_id });
                            // Start polling for this job
                            startConversionPolling();
                        } else {
                            uploaded++;
                            const dest = (s3Enabled && s3Compatible) ? ' (S3)' : '';
                            results.push({ name: file.name, success: true, converted: result.converted, s3: s3Enabled && s3Compatible });
                        }
                    } else {
                        failed++;
                        results.push({ name: file.name, success: false, error: result.error });
                    }
                } catch (error) {
                    failed++;
                    results.push({ name: file.name, success: false, error: error.message });
                }
            }

            progressDiv.classList.add('hidden');
            resultsDiv.classList.remove('hidden');

            let statusMsg = '';
            if (uploaded > 0) statusMsg += `${uploaded} uploaded`;
            if (backgroundJobs > 0) statusMsg += `${statusMsg ? ', ' : ''}${backgroundJobs} converting in background`;
            if (failed > 0) statusMsg += `${statusMsg ? ', ' : ''}${failed} failed`;

            resultsDiv.innerHTML = `
                <div class="bg-gray-700 rounded-lg p-4">
                    <p class="font-semibold mb-2">${statusMsg}</p>
                    <div class="max-h-32 overflow-y-auto text-sm">
                        ${results.map(r => `
                            <div class="${r.success ? (r.background ? 'text-yellow-400' : 'text-green-400') : 'text-red-400'}">
                                ${r.success ? (r.background ? '⏳' : '✓') : '✗'} ${r.name} ${r.background ? '(converting...)' : ''} ${r.converted ? '(converted)' : ''} ${r.s3 ? '(S3)' : ''} ${r.error ? '- ' + r.error : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            // Only auto-reload if there were direct uploads and no background jobs
            if (uploaded > 0 && backgroundJobs === 0) {
                setTimeout(() => location.reload(), 2000);
            }
        }

        // Migrate to S3
        async function migrateToS3() {
            if (!s3Enabled) {
                alert('S3 is not configured. Add AWS credentials to Render environment variables.');
                return;
            }

            if (!confirm('This will download all videos and re-upload them to S3. This may take a while. Continue?')) {
                return;
            }

            const msgDiv = document.getElementById('migrateS3Message');
            const btn = document.getElementById('migrateS3Btn');
            btn.disabled = true;
            btn.textContent = 'Migrating...';
            msgDiv.textContent = 'Starting migration (this may take several minutes)...';
            msgDiv.className = 'text-sm mt-2 text-yellow-400';
            msgDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/migrate-to-s3', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    msgDiv.textContent = result.message;
                    if (result.errors && result.errors.length > 0) {
                        msgDiv.textContent += ` (${result.errors.length} errors - check console)`;
                        console.log('Migration errors:', result.errors);
                    }
                    msgDiv.className = 'text-sm mt-2 text-green-400';
                    if (result.migrated > 0) {
                        setTimeout(() => location.reload(), 2000);
                    }
                } else {
                    msgDiv.textContent = result.error || 'Migration failed';
                    msgDiv.className = 'text-sm mt-2 text-red-400';
                }
            } catch (error) {
                msgDiv.textContent = 'Error: ' + error.message;
                msgDiv.className = 'text-sm mt-2 text-red-400';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Migrate to S3';
            }
        }

        // Delete Vimeo Videos
        async function deleteVimeoVideos() {
            if (!confirm('This will permanently delete ALL Vimeo videos from the database. Continue?')) {
                return;
            }

            const msgDiv = document.getElementById('deleteVimeoMessage');
            msgDiv.textContent = 'Deleting Vimeo videos...';
            msgDiv.className = 'text-sm mt-2 text-yellow-400';
            msgDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/delete-vimeo-videos', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    msgDiv.textContent = result.message;
                    msgDiv.className = 'text-sm mt-2 text-green-400';
                    if (result.deleted > 0) {
                        setTimeout(() => location.reload(), 2000);
                    }
                } else {
                    msgDiv.textContent = result.error || 'Error deleting videos';
                    msgDiv.className = 'text-sm mt-2 text-red-400';
                }
            } catch (error) {
                msgDiv.textContent = 'Error: ' + error.message;
                msgDiv.className = 'text-sm mt-2 text-red-400';
            }
        }

        // Fix Duplicates
        async function fixDuplicates() {
            const msgDiv = document.getElementById('fixDuplicatesMessage');
            msgDiv.textContent = 'Scanning for duplicates...';
            msgDiv.className = 'text-sm mt-2 text-yellow-400';
            msgDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/fix-duplicates', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    msgDiv.textContent = result.message;
                    msgDiv.className = 'text-sm mt-2 text-green-400';
                    if (result.removed > 0) {
                        setTimeout(() => location.reload(), 2000);
                    }
                } else {
                    msgDiv.textContent = result.error || 'Error fixing duplicates';
                    msgDiv.className = 'text-sm mt-2 text-red-400';
                }
            } catch (error) {
                msgDiv.textContent = 'Error: ' + error.message;
                msgDiv.className = 'text-sm mt-2 text-red-400';
            }
        }

        // Auto-categorize videos
        async function autoCategorize() {
            const btn = document.getElementById('autoCategorizeBtn');
            const msgDiv = document.getElementById('autoCategorizeMessage');
            const scope = document.getElementById('autoCategorizeScope').value;

            let adminPin = '';

            // If processing all files, require PIN
            if (scope === 'all') {
                adminPin = prompt('Enter admin PIN to re-categorize ALL files:\n\nWarning: This will overwrite existing categories!');
                if (!adminPin) {
                    msgDiv.textContent = 'Cancelled - PIN required for all files';
                    msgDiv.className = 'text-sm mt-2 text-yellow-400';
                    msgDiv.classList.remove('hidden');
                    return;
                }
            }

            btn.disabled = true;
            btn.textContent = 'Processing...';
            msgDiv.textContent = scope === 'all' ? 'Analyzing ALL files...' : 'Analyzing uncategorized files...';
            msgDiv.className = 'text-sm mt-2 text-yellow-400';
            msgDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/auto-categorize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        only_uncategorized: scope !== 'all',
                        admin_pin: adminPin
                    })
                });
                const result = await response.json();

                if (result.success) {
                    let message = result.message;
                    if (result.details && result.details.length > 0) {
                        message += '\n\nUpdated:';
                        result.details.slice(0, 10).forEach(d => {
                            message += `\n- ${d.title}: ${d.changes.join(', ')}`;
                        });
                        if (result.details.length > 10) {
                            message += `\n... and ${result.details.length - 10} more`;
                        }
                    }
                    msgDiv.textContent = result.message;
                    msgDiv.className = 'text-sm mt-2 text-green-400';

                    if (result.updated > 0) {
                        // Show details in a modal or alert
                        let detailsText = `Updated ${result.updated} video(s):\n\n`;
                        result.details.slice(0, 20).forEach(d => {
                            detailsText += `${d.title}:\n  ${d.changes.join('\n  ')}\n\n`;
                        });
                        if (result.details.length > 20) {
                            detailsText += `... and ${result.details.length - 20} more`;
                        }
                        alert(detailsText);
                        setTimeout(() => location.reload(), 1000);
                    }
                } else {
                    msgDiv.textContent = result.error || 'Error auto-categorizing';
                    msgDiv.className = 'text-sm mt-2 text-red-400';
                }
            } catch (error) {
                msgDiv.textContent = 'Error: ' + error.message;
                msgDiv.className = 'text-sm mt-2 text-red-400';
            }

            btn.disabled = false;
            btn.textContent = 'Auto-Categorize';
        }

        // Dropbox Chooser - Single file
        function chooseFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    // Check for formats that need conversion
                    const filename = files[0].name.toLowerCase();
                    const needsConversion = ['.mts', '.m2ts', '.avi', '.mkv', '.wmv', '.flv', '.3gp'].some(ext => filename.endsWith(ext));
                    if (needsConversion) {
                        if (!confirm('This file (' + files[0].name + ') needs to be converted to MP4.\n\nIf running locally, it will be downloaded and converted automatically.\nOn production, this will fail.\n\nSupported formats: MP4, WebM, OGG, MOV\n\nContinue?')) {
                            return;
                        }
                    }
                    // Convert to streaming URL (use dl.dropboxusercontent.com)
                    let url = files[0].link
                        .replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                        .replace('?dl=0', '');
                    document.getElementById('videoUrl').value = url;

                    // Auto-fill title from filename
                    const title = document.getElementById('videoTitle');
                    if (!title.value) {
                        title.value = files[0].name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    }
                },
                linkType: 'direct',
                multiselect: false,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Dropbox Chooser - Select files first, then choose category
        function chooseFolderFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    pendingFiles = files;
                    openBulkUploadModal(files.length);
                },
                linkType: 'direct',
                multiselect: true,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Dropbox Chooser - Multiple files (same flow)
        function chooseMultipleFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    pendingFiles = files;
                    openBulkUploadModal(files.length);
                },
                linkType: 'direct',
                multiselect: true,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Modal functions
        function openBulkUploadModal(fileCount) {
            document.getElementById('bulkFileCount').textContent = `${fileCount} video${fileCount !== 1 ? 's' : ''} selected`;
            document.getElementById('modalCategory').value = '';
            document.getElementById('modalSubcategory').value = '';
            document.getElementById('modalSubcategoryDiv').classList.add('hidden');
            document.getElementById('modalProgress').classList.add('hidden');
            document.getElementById('modalMessage').classList.add('hidden');
            document.getElementById('bulkUploadModal').classList.remove('hidden');
            document.getElementById('bulkUploadModal').classList.add('flex');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.add('hidden');
            document.getElementById('bulkUploadModal').classList.remove('flex');
            pendingFiles = [];
        }

        function updateModalSubcategories() {
            const catId = document.getElementById('modalCategory').value;
            const subDiv = document.getElementById('modalSubcategoryDiv');
            const subSelect = document.getElementById('modalSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">All / None</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        async function confirmBulkUpload() {
            const category = document.getElementById('modalCategory').value;
            const subcategory = document.getElementById('modalSubcategory').value;
            const event = document.getElementById('modalEvent').value;

            // Category is optional - will default to 'uncategorized'

            const progressDiv = document.getElementById('modalProgress');
            const messageDiv = document.getElementById('modalMessage');

            progressDiv.classList.remove('hidden');
            progressDiv.innerHTML = `<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-500"></div><span>Adding 0/${pendingFiles.length} videos...</span></div>`;

            let added = 0;
            let errors = [];

            // Check for files that need conversion
            const conversionExts = ['.mts', '.m2ts', '.avi', '.mkv', '.wmv', '.flv', '.3gp'];
            const conversionFiles = pendingFiles.filter(f => {
                const name = f.name.toLowerCase();
                return conversionExts.some(ext => name.endsWith(ext));
            });
            if (conversionFiles.length > 0) {
                if (!confirm(conversionFiles.length + ' file(s) need conversion to MP4.\n\nSupported formats: MP4, WebM, OGG, MOV\nNeed conversion: MTS, AVI, MKV, WMV, FLV\n\nIf running locally, they will be converted automatically.\nOn production, these will fail.\n\nContinue?')) {
                    progressDiv.classList.add('hidden');
                    return;
                }
            }

            for (const file of pendingFiles) {
                const url = file.link.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '');
                const title = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');

                try {
                    const response = await fetch('/admin/add-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            url: url,
                            category: category,
                            subcategory: subcategory,
                            description: '',
                            tags: '',
                            duration: '',
                            event: event
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        added++;
                    } else {
                        errors.push(file.name);
                    }
                } catch (e) {
                    errors.push(file.name);
                }

                progressDiv.innerHTML = `<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-500"></div><span>Adding ${added}/${pendingFiles.length} videos...</span></div>`;
            }

            progressDiv.classList.add('hidden');

            if (errors.length > 0) {
                messageDiv.className = 'bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded';
                messageDiv.textContent = `Added ${added} videos. Failed: ${errors.length}`;
            } else {
                messageDiv.className = 'bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded';
                messageDiv.textContent = `Successfully added ${added} videos!`;
            }
            messageDiv.classList.remove('hidden');

            setTimeout(() => location.reload(), 1500);
        }

        function updateBulkSubcategories() {
            const catId = document.getElementById('bulkCategory').value;
            const subDiv = document.getElementById('bulkSubcategoryDiv');
            const subSelect = document.getElementById('bulkSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">All / None</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        function updateEditSubcategories() {
            const catId = document.getElementById('editCategory').value;
            const subDiv = document.getElementById('editSubcategoryDiv');
            const subSelect = document.getElementById('editSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">Select subcategory</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        // Delete Video
        async function deleteVideo(videoId) {
            if (!confirm('Are you sure you want to delete this video?')) return;

            try {
                const response = await fetch(`/admin/delete-video/${videoId}`, { method: 'POST' });
                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                } else {
                    location.reload();
                }
            } catch (error) {
                alert('Error deleting video: ' + error.message);
            }
        }

        // Quick rename video (inline)
        async function quickRenameVideo(videoId, newTitle) {
            if (!newTitle.trim()) return;
            try {
                const response = await fetch(`/admin/edit-video/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle.trim() })
                });
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Failed to rename');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Quick change category (inline)
        async function quickChangeCategory(videoId, newCategory, selectEl) {
            try {
                const response = await fetch(`/admin/edit-video/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: newCategory, subcategory: '' })
                });
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Failed to change category');
                } else {
                    // Update subcategory dropdown
                    const subSelect = selectEl.parentElement.querySelector('.subcategory-select');
                    const cat = categories[newCategory];
                    if (cat && cat.subcategories && cat.subcategories.length > 0) {
                        subSelect.innerHTML = '<option value="">--</option>';
                        cat.subcategories.forEach(sub => {
                            subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                        });
                        subSelect.style.display = '';
                    } else {
                        subSelect.style.display = 'none';
                        subSelect.innerHTML = '<option value="">--</option>';
                    }
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Quick change subcategory (inline)
        async function quickChangeSubcategory(videoId, newSubcategory) {
            try {
                const response = await fetch(`/admin/edit-video/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subcategory: newSubcategory })
                });
                const result = await response.json();
                if (!result.success) {
                    alert(result.error || 'Failed to change subcategory');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Edit Video - fetch data and open modal
        async function editVideo(videoId) {
            try {
                const response = await fetch(`/admin/get-video/${videoId}`);
                const video = await response.json();

                if (video.error) {
                    alert(video.error);
                    return;
                }

                // Populate form fields
                document.getElementById('editVideoId').value = video.id;
                document.getElementById('editTitle').value = video.title || '';
                document.getElementById('editUrl').value = video.url || '';
                document.getElementById('editCategory').value = video.category || '';
                document.getElementById('editDescription').value = video.description || '';
                document.getElementById('editDuration').value = video.duration || '';
                document.getElementById('editTags').value = video.tags || '';
                document.getElementById('editEvent').value = video.event || '';

                // Update subcategories and set value
                updateEditSubcategories();
                setTimeout(() => {
                    document.getElementById('editSubcategory').value = video.subcategory || '';
                }, 50);

                // Show modal
                document.getElementById('editModal').classList.remove('hidden');
                document.getElementById('editModal').classList.add('flex');
            } catch (error) {
                alert('Error loading video: ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // Edit form submission
        document.getElementById('editVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const videoId = document.getElementById('editVideoId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                category: document.getElementById('editCategory').value,
                subcategory: document.getElementById('editSubcategory').value,
                description: document.getElementById('editDescription').value,
                duration: document.getElementById('editDuration').value,
                tags: document.getElementById('editTags').value,
                event: document.getElementById('editEvent').value
            };

            try {
                const response = await fetch(`/admin/edit-video/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                } else {
                    closeEditModal();
                    location.reload();
                }
            } catch (error) {
                alert('Error updating video: ' + error.message);
            }
        });

        // ============================================
        // Background Conversion Tracking
        // ============================================
        let conversionPollingInterval = null;

        function startConversionPolling() {
            if (conversionPollingInterval) return; // Already polling
            conversionPollingInterval = setInterval(pollConversionStatus, 2000);
            pollConversionStatus(); // Immediate first poll
        }

        function stopConversionPolling() {
            if (conversionPollingInterval) {
                clearInterval(conversionPollingInterval);
                conversionPollingInterval = null;
            }
        }

        async function pollConversionStatus() {
            try {
                const response = await fetch('/conversion/all');
                const jobs = await response.json();

                const panel = document.getElementById('conversionStatusPanel');
                const list = document.getElementById('conversionJobsList');

                const jobIds = Object.keys(jobs);
                if (jobIds.length === 0) {
                    panel.classList.add('hidden');
                    stopConversionPolling();
                    return;
                }

                panel.classList.remove('hidden');

                // Check if all jobs are done
                const activeJobs = jobIds.filter(id => !['completed', 'failed'].includes(jobs[id].status));
                if (activeJobs.length === 0) {
                    stopConversionPolling();
                }

                // Render jobs
                list.innerHTML = jobIds.map(jobId => {
                    const job = jobs[jobId];
                    let statusClass = 'text-gray-400';
                    let statusIcon = '⏳';
                    let progressBar = '';

                    if (job.status === 'completed') {
                        statusClass = 'text-green-400';
                        statusIcon = '✓';
                    } else if (job.status === 'failed') {
                        statusClass = 'text-red-400';
                        statusIcon = '✗';
                    } else if (job.status === 'converting') {
                        statusClass = 'text-yellow-400';
                        statusIcon = '⚙️';
                        progressBar = `<div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                            <div class="bg-yellow-500 h-2 rounded-full transition-all" style="width: ${job.progress || 0}%"></div>
                        </div>`;
                    } else if (job.status === 'generating_thumbnail') {
                        statusClass = 'text-blue-400';
                        statusIcon = '🖼️';
                        progressBar = `<div class="w-full bg-gray-600 rounded-full h-2 mt-2">
                            <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${job.progress || 0}%"></div>
                        </div>`;
                    }

                    const statusLabels = {
                        'queued': 'Queued',
                        'converting': 'Converting...',
                        'generating_thumbnail': 'Generating thumbnail...',
                        'completed': 'Completed',
                        'failed': 'Failed'
                    };

                    return `
                        <div class="bg-gray-700 rounded-lg p-3">
                            <div class="flex justify-between items-start">
                                <div class="flex-1 min-w-0">
                                    <p class="font-medium text-white truncate">${job.title || job.filename}</p>
                                    <p class="text-sm ${statusClass}">
                                        ${statusIcon} ${statusLabels[job.status] || job.status}
                                        ${job.error ? ` - ${job.error}` : ''}
                                    </p>
                                    ${progressBar}
                                </div>
                                ${job.status === 'completed' ? `
                                    <a href="/video/${job.video_id}" target="_blank" class="text-blue-400 hover:text-blue-300 text-sm ml-3">View</a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error polling conversion status:', error);
            }
        }

        async function clearCompletedConversions() {
            try {
                await fetch('/conversion/clear-completed', { method: 'POST' });
                pollConversionStatus();
            } catch (error) {
                console.error('Error clearing completed conversions:', error);
            }
        }

        // Check for active conversions on page load
        document.addEventListener('DOMContentLoaded', function() {
            pollConversionStatus();
        });
    </script>
</body>
</html>
