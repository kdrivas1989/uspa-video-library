<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - USPA Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    {% if dropbox_app_key %}
    <script src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="{{ dropbox_app_key }}"></script>
    {% endif %}
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-purple-800 p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-white">USPA Video Library - Admin</a>
            <div class="flex items-center gap-4">
                <a href="/" class="bg-purple-700 hover:bg-purple-600 px-4 py-2 rounded-lg">View Site</a>
                <a href="/logout" class="text-purple-200 hover:text-white">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- Stats -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-4xl font-bold text-blue-400">{{ total_videos }}</p>
                <p class="text-gray-400">Total Videos</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-4xl font-bold text-green-400">{{ total_views }}</p>
                <p class="text-gray-400">Total Views</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <p class="text-gray-400 text-sm mb-3">Fix Dropbox URLs for streaming</p>
                <button onclick="fixDropboxUrls()" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-sm">
                    Fix Dropbox URLs
                </button>
                <p id="fixUrlsMessage" class="text-sm mt-2 hidden"></p>
            </div>
        </div>

        <!-- Import from Folder -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Import Videos from Folder</h2>
            <p class="text-gray-400 text-sm mb-4">Import all videos from a local folder (MTS converted to MP4) or select a Dropbox folder.</p>
            <form id="importFolderForm" class="flex flex-wrap gap-4 items-end">
                <div class="flex-1 min-w-64">
                    <label class="block text-gray-300 mb-2">Folder Path</label>
                    <div class="flex gap-2">
                        <input type="text" id="folderPath"
                            class="flex-1 px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="/path/to/video/folder"
                            oninput="detectCategoryFromPath(this.value)">
                        {% if dropbox_app_key %}
                        <button type="button" onclick="chooseFolderFromDropbox()"
                            class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm whitespace-nowrap">
                            Dropbox Folder
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="w-48">
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="importCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateImportSubcategories()">
                        <option value="">Select</option>
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="importSubcategoryDiv" class="w-48 hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="importSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select</option>
                    </select>
                </div>
                <div class="w-64">
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="importEvent" list="importEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 USPA Nationals">
                    <datalist id="importEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
                <button type="submit"
                    class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg font-semibold transition">
                    Import Videos
                </button>
            </form>
            <div id="importMessage" class="mt-4 hidden"></div>
            <div id="importProgress" class="mt-4 hidden">
                <div class="flex items-center gap-3">
                    <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-green-500"></div>
                    <span class="text-gray-300">Converting and importing videos... This may take a while.</span>
                </div>
            </div>
        </div>

        {% if dropbox_app_key %}
        <!-- Bulk Upload from Dropbox -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <h2 class="text-xl font-bold mb-4">Bulk Upload from Dropbox</h2>
            <p class="text-gray-400 text-sm mb-4">Select multiple videos from Dropbox, then choose category before uploading.</p>
            <button type="button" onclick="chooseMultipleFromDropbox()"
                class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-lg font-semibold transition">
                Select Videos from Dropbox
            </button>
        </div>
        {% endif %}

        <div class="grid lg:grid-cols-2 gap-8">
            <!-- Add Video Form -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-bold mb-6">Add New Video</h2>
                <form id="addVideoForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Title *</label>
                        <input type="text" id="videoTitle" required
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Video title">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Video URL * (YouTube, Vimeo, Dropbox, or direct MP4)</label>
                        <div class="flex gap-2">
                            <input type="url" id="videoUrl" required
                                class="flex-1 px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="https://...">
                            {% if dropbox_app_key %}
                            <button type="button" onclick="chooseFromDropbox()"
                                class="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded-lg text-sm whitespace-nowrap">
                                Dropbox
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Category *</label>
                        <select id="videoCategory" required
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            onchange="updateSubcategories()">
                            <option value="">Select category</option>
                            {% for cat_id, cat in categories.items() %}
                            <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div id="subcategoryDiv" class="hidden">
                        <label class="block text-gray-300 mb-2">Subcategory</label>
                        <select id="videoSubcategory"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Select subcategory</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Description</label>
                        <textarea id="videoDescription" rows="3"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="Video description"></textarea>
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Event</label>
                        <input type="text" id="videoEvent" list="eventList"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="e.g., 2024 USPA Nationals">
                        <datalist id="eventList">
                            {% for event in events %}
                            <option value="{{ event }}">
                            {% endfor %}
                        </datalist>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-300 mb-2">Duration</label>
                            <input type="text" id="videoDuration"
                                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="e.g., 3:45">
                        </div>
                        <div>
                            <label class="block text-gray-300 mb-2">Tags</label>
                            <input type="text" id="videoTags"
                                class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                                placeholder="tag1, tag2, tag3">
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                        Add Video
                    </button>
                </form>
                <div id="addMessage" class="mt-4 hidden"></div>
            </div>

            <!-- Video List -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-bold mb-6">Manage Videos</h2>
                <div class="space-y-3 max-h-[600px] overflow-y-auto">
                    {% if videos %}
                    {% for video in videos %}
                    <div class="bg-gray-700 rounded-lg p-4" data-video-id="{{ video.id }}">
                        <div class="flex gap-4">
                            <div class="w-32 h-20 bg-gray-600 rounded flex-shrink-0 overflow-hidden">
                                {% if video.thumbnail %}
                                <img src="{{ video.thumbnail }}" alt="{{ video.title }}" class="w-full h-full object-cover">
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-white truncate">{{ video.title }}</h3>
                                <div class="flex items-center gap-2 mt-1 text-sm text-gray-400">
                                    <span class="bg-blue-600 text-white px-2 py-0.5 rounded text-xs">{{ categories.get(video.category, {}).get('abbrev', video.category) }}</span>
                                    <span>{{ video.views }} views</span>
                                </div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="editVideo('{{ video.id }}')"
                                        class="text-blue-400 hover:text-blue-300 text-sm">Edit</button>
                                    <button onclick="deleteVideo('{{ video.id }}')"
                                        class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                                    <a href="/video/{{ video.id }}" target="_blank"
                                        class="text-gray-400 hover:text-gray-300 text-sm">View</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p>No videos yet. Add your first video!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Upload Modal -->
    <div id="bulkUploadModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">Upload Videos</h3>
            <p id="bulkFileCount" class="text-gray-400 mb-4">0 videos selected</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="modalCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateModalSubcategories()">
                        <option value="">Select category</option>
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="modalSubcategoryDiv" class="hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="modalSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">All / None</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="modalEvent" list="modalEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 USPA Nationals">
                    <datalist id="modalEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div id="modalProgress" class="hidden"></div>
                <div id="modalMessage" class="hidden"></div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeBulkUploadModal()"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmBulkUpload()"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                        Upload Videos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Edit Video</h3>
            <form id="editVideoForm" class="space-y-4">
                <input type="hidden" id="editVideoId">
                <div>
                    <label class="block text-gray-300 mb-2">Title *</label>
                    <input type="text" id="editTitle" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Video URL *</label>
                    <input type="url" id="editUrl" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Category *</label>
                    <select id="editCategory" required
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        onchange="updateEditSubcategories()">
                        {% for cat_id, cat in categories.items() %}
                        <option value="{{ cat_id }}">{{ cat.abbrev }} - {{ cat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div id="editSubcategoryDiv" class="hidden">
                    <label class="block text-gray-300 mb-2">Subcategory</label>
                    <select id="editSubcategory"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Select subcategory</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Event</label>
                    <input type="text" id="editEvent" list="editEventList"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g., 2024 USPA Nationals">
                    <datalist id="editEventList">
                        {% for event in events %}
                        <option value="{{ event }}">
                        {% endfor %}
                    </datalist>
                </div>
                <div>
                    <label class="block text-gray-300 mb-2">Description</label>
                    <textarea id="editDescription" rows="3"
                        class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Duration</label>
                        <input type="text" id="editDuration"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-gray-300 mb-2">Tags</label>
                        <input type="text" id="editTags"
                            class="w-full px-4 py-2 rounded-lg bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeEditModal()"
                        class="flex-1 bg-gray-600 hover:bg-gray-500 py-3 rounded-lg font-semibold transition">
                        Cancel
                    </button>
                    <button type="submit"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 py-3 rounded-lg font-semibold transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const categories = {{ categories | tojson }};
        let pendingFiles = []; // Store files selected from Dropbox

        // Fix Dropbox URLs
        async function fixDropboxUrls() {
            const msgDiv = document.getElementById('fixUrlsMessage');
            msgDiv.textContent = 'Fixing...';
            msgDiv.className = 'text-sm mt-2 text-yellow-400';
            msgDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/fix-dropbox-urls', { method: 'POST' });
                const result = await response.json();

                if (result.success) {
                    msgDiv.textContent = result.message;
                    msgDiv.className = 'text-sm mt-2 text-green-400';
                } else {
                    msgDiv.textContent = result.error || 'Error fixing URLs';
                    msgDiv.className = 'text-sm mt-2 text-red-400';
                }
            } catch (error) {
                msgDiv.textContent = 'Error: ' + error.message;
                msgDiv.className = 'text-sm mt-2 text-red-400';
            }
        }

        // Auto-detect category and subcategory from folder path
        function detectCategoryFromPath(path) {
            if (!path) return;

            const pathLower = path.toLowerCase();
            const categorySelect = document.getElementById('importCategory');
            let detectedCategory = '';
            let detectedSubcategory = '';

            // Category detection patterns
            const categoryPatterns = {
                'cp': ['canopy piloting', '/cp/', '_cp_', ' cp ', 'cp_', '_cp'],
                'fs': ['formation skydiving', '/fs/', '_fs_', ' fs ', 'fs_', '_fs'],
                'cf': ['canopy formation', '/cf/', '_cf_', ' cf ', 'cf_', '_cf'],
                'ae': ['artistic', 'freestyle', 'freefly', '/ae/', '_ae_', ' ae '],
                'ws': ['wingsuit', '/ws/', '_ws_', ' ws ', 'ws_', '_ws'],
                'al': ['accuracy', 'landing', '/al/', '_al_', ' al ']
            };

            // Subcategory detection patterns
            const subcategoryPatterns = {
                'cp': {
                    'freestyle': ['freestyle', 'free style'],
                    'speed': ['speed'],
                    'distance': ['distance'],
                    'zone_accuracy': ['zone', 'accuracy']
                },
                'fs': {
                    '4way_fs': ['4way', '4-way', '4 way'],
                    '4way_vfs': ['vfs', 'vertical'],
                    '2way_mfs': ['2way', '2-way', 'mfs'],
                    '8way': ['8way', '8-way', '8 way'],
                    '10way': ['10way', '10-way', '10 way'],
                    '16way': ['16way', '16-way', '16 way']
                },
                'cf': {
                    '4way': ['4way', '4-way', '4 way'],
                    '2way': ['2way', '2-way', '2 way']
                },
                'ae': {
                    'freestyle': ['freestyle', 'free style'],
                    'freefly': ['freefly', 'free fly']
                }
            };

            // Detect category
            for (const [catId, patterns] of Object.entries(categoryPatterns)) {
                for (const pattern of patterns) {
                    if (pathLower.includes(pattern)) {
                        detectedCategory = catId;
                        break;
                    }
                }
                if (detectedCategory) break;
            }

            // Set category if detected
            if (detectedCategory) {
                categorySelect.value = detectedCategory;
                updateImportSubcategories();

                // Detect subcategory
                if (subcategoryPatterns[detectedCategory]) {
                    for (const [subId, patterns] of Object.entries(subcategoryPatterns[detectedCategory])) {
                        for (const pattern of patterns) {
                            if (pathLower.includes(pattern)) {
                                detectedSubcategory = subId;
                                break;
                            }
                        }
                        if (detectedSubcategory) break;
                    }

                    // Set subcategory after a brief delay (to allow dropdown to populate)
                    if (detectedSubcategory) {
                        setTimeout(() => {
                            document.getElementById('importSubcategory').value = detectedSubcategory;
                        }, 50);
                    }
                }
            }

            // Also try to detect event name from path
            detectEventFromPath(path);
        }

        // Try to extract event name from path
        function detectEventFromPath(path) {
            const eventInput = document.getElementById('importEvent');
            if (!eventInput || eventInput.value) return; // Don't override if already set

            // Look for year patterns like "2024" or "25"
            const pathParts = path.split(/[\/\\]/);
            const eventKeywords = ['nationals', 'championship', 'world', 'uspa', 'competition', 'meet', 'open'];

            for (const part of pathParts) {
                const partLower = part.toLowerCase();
                // Check if folder name contains a year and/or event keyword
                const hasYear = /20\d{2}|\b\d{2}\b/.test(part);
                const hasKeyword = eventKeywords.some(k => partLower.includes(k));

                if (hasYear || hasKeyword) {
                    // Clean up the folder name to use as event
                    const eventName = part.replace(/[_-]/g, ' ').replace(/\s+/g, ' ').trim();
                    if (eventName.length > 5) {
                        eventInput.value = eventName;
                        return;
                    }
                }
            }
        }

        // Dropbox Chooser - Single file
        function chooseFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    // Check for formats that need conversion
                    const filename = files[0].name.toLowerCase();
                    const needsConversion = filename.endsWith('.mts') || filename.endsWith('.m2ts') || filename.endsWith('.avi') || filename.endsWith('.mkv');
                    if (needsConversion) {
                        if (!confirm('This file (' + files[0].name + ') needs to be converted to MP4.\n\nIf running locally, it will be downloaded and converted automatically.\nOn production, this will fail.\n\nContinue?')) {
                            return;
                        }
                    }
                    // Convert to streaming URL (use dl.dropboxusercontent.com)
                    let url = files[0].link
                        .replace('www.dropbox.com', 'dl.dropboxusercontent.com')
                        .replace('?dl=0', '');
                    document.getElementById('videoUrl').value = url;

                    // Auto-fill title from filename
                    const title = document.getElementById('videoTitle');
                    if (!title.value) {
                        title.value = files[0].name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');
                    }
                },
                linkType: 'direct',
                multiselect: false,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Dropbox Chooser - Select files first, then choose category
        function chooseFolderFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    pendingFiles = files;
                    openBulkUploadModal(files.length);
                },
                linkType: 'direct',
                multiselect: true,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Dropbox Chooser - Multiple files (same flow)
        function chooseMultipleFromDropbox() {
            Dropbox.choose({
                success: function(files) {
                    pendingFiles = files;
                    openBulkUploadModal(files.length);
                },
                linkType: 'direct',
                multiselect: true,
                extensions: ['video'],
                folderselect: false
            });
        }

        // Modal functions
        function openBulkUploadModal(fileCount) {
            document.getElementById('bulkFileCount').textContent = `${fileCount} video${fileCount !== 1 ? 's' : ''} selected`;
            document.getElementById('modalCategory').value = '';
            document.getElementById('modalSubcategory').value = '';
            document.getElementById('modalSubcategoryDiv').classList.add('hidden');
            document.getElementById('modalProgress').classList.add('hidden');
            document.getElementById('modalMessage').classList.add('hidden');
            document.getElementById('bulkUploadModal').classList.remove('hidden');
            document.getElementById('bulkUploadModal').classList.add('flex');
        }

        function closeBulkUploadModal() {
            document.getElementById('bulkUploadModal').classList.add('hidden');
            document.getElementById('bulkUploadModal').classList.remove('flex');
            pendingFiles = [];
        }

        function updateModalSubcategories() {
            const catId = document.getElementById('modalCategory').value;
            const subDiv = document.getElementById('modalSubcategoryDiv');
            const subSelect = document.getElementById('modalSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">All / None</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        async function confirmBulkUpload() {
            const category = document.getElementById('modalCategory').value;
            const subcategory = document.getElementById('modalSubcategory').value;
            const event = document.getElementById('modalEvent').value;

            if (!category) {
                alert('Please select a category');
                return;
            }

            const progressDiv = document.getElementById('modalProgress');
            const messageDiv = document.getElementById('modalMessage');

            progressDiv.classList.remove('hidden');
            progressDiv.innerHTML = `<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-500"></div><span>Adding 0/${pendingFiles.length} videos...</span></div>`;

            let added = 0;
            let errors = [];

            // Check for files that need conversion
            const conversionFiles = pendingFiles.filter(f => {
                const name = f.name.toLowerCase();
                return name.endsWith('.mts') || name.endsWith('.m2ts') || name.endsWith('.avi') || name.endsWith('.mkv');
            });
            if (conversionFiles.length > 0) {
                if (!confirm(conversionFiles.length + ' file(s) need conversion to MP4 (MTS/AVI/MKV).\n\nIf running locally, they will be downloaded and converted automatically.\nOn production, these will be skipped.\n\nContinue?')) {
                    progressDiv.classList.add('hidden');
                    return;
                }
            }

            for (const file of pendingFiles) {
                const url = file.link.replace('www.dropbox.com', 'dl.dropboxusercontent.com').replace('?dl=0', '');
                const title = file.name.replace(/\.[^/.]+$/, '').replace(/[_-]/g, ' ');

                try {
                    const response = await fetch('/admin/add-video', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            url: url,
                            category: category,
                            subcategory: subcategory,
                            description: '',
                            tags: '',
                            duration: '',
                            event: event
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        added++;
                    } else {
                        errors.push(file.name);
                    }
                } catch (e) {
                    errors.push(file.name);
                }

                progressDiv.innerHTML = `<div class="flex items-center gap-3"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-green-500"></div><span>Adding ${added}/${pendingFiles.length} videos...</span></div>`;
            }

            progressDiv.classList.add('hidden');

            if (errors.length > 0) {
                messageDiv.className = 'bg-yellow-900 border border-yellow-700 text-yellow-200 px-4 py-3 rounded';
                messageDiv.textContent = `Added ${added} videos. Failed: ${errors.length}`;
            } else {
                messageDiv.className = 'bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded';
                messageDiv.textContent = `Successfully added ${added} videos!`;
            }
            messageDiv.classList.remove('hidden');

            setTimeout(() => location.reload(), 1500);
        }

        function updateBulkSubcategories() {
            const catId = document.getElementById('bulkCategory').value;
            const subDiv = document.getElementById('bulkSubcategoryDiv');
            const subSelect = document.getElementById('bulkSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">All / None</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        // Update import subcategories
        function updateImportSubcategories() {
            const catId = document.getElementById('importCategory').value;
            const subDiv = document.getElementById('importSubcategoryDiv');
            const subSelect = document.getElementById('importSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">Select</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        // Import from folder
        document.getElementById('importFolderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const folderPath = document.getElementById('folderPath').value.trim();
            const category = document.getElementById('importCategory').value;
            const subcategory = document.getElementById('importSubcategory').value;
            const event = document.getElementById('importEvent').value.trim();

            if (!folderPath || !category) {
                alert('Please enter folder path and select category');
                return;
            }

            const messageDiv = document.getElementById('importMessage');
            const progressDiv = document.getElementById('importProgress');

            messageDiv.classList.add('hidden');
            progressDiv.classList.remove('hidden');

            try {
                const response = await fetch('/admin/import-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ folder_path: folderPath, category, subcategory, event, convert: true })
                });

                const result = await response.json();
                progressDiv.classList.add('hidden');

                if (result.error) {
                    messageDiv.className = 'mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded';
                    messageDiv.textContent = result.error;
                } else {
                    messageDiv.className = 'mt-4 bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded';
                    let msg = result.message;
                    if (result.errors && result.errors.length > 0) {
                        msg += '\nErrors: ' + result.errors.join(', ');
                    }
                    messageDiv.textContent = msg;
                    setTimeout(() => location.reload(), 2000);
                }
                messageDiv.classList.remove('hidden');

            } catch (error) {
                progressDiv.classList.add('hidden');
                messageDiv.className = 'mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded';
                messageDiv.textContent = 'Error importing: ' + error.message;
                messageDiv.classList.remove('hidden');
            }
        });

        // Update subcategories dropdown based on category selection
        function updateSubcategories() {
            const catId = document.getElementById('videoCategory').value;
            const subDiv = document.getElementById('subcategoryDiv');
            const subSelect = document.getElementById('videoSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">Select subcategory</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        function updateEditSubcategories() {
            const catId = document.getElementById('editCategory').value;
            const subDiv = document.getElementById('editSubcategoryDiv');
            const subSelect = document.getElementById('editSubcategory');

            const cat = categories[catId];
            if (cat && cat.subcategories && cat.subcategories.length > 0) {
                subSelect.innerHTML = '<option value="">Select subcategory</option>';
                cat.subcategories.forEach(sub => {
                    subSelect.innerHTML += `<option value="${sub.id}">${sub.name}</option>`;
                });
                subDiv.classList.remove('hidden');
            } else {
                subDiv.classList.add('hidden');
                subSelect.value = '';
            }
        }

        // Add Video
        document.getElementById('addVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const data = {
                title: document.getElementById('videoTitle').value,
                url: document.getElementById('videoUrl').value,
                category: document.getElementById('videoCategory').value,
                subcategory: document.getElementById('videoSubcategory').value,
                description: document.getElementById('videoDescription').value,
                duration: document.getElementById('videoDuration').value,
                tags: document.getElementById('videoTags').value,
                event: document.getElementById('videoEvent').value
            };

            const messageDiv = document.getElementById('addMessage');

            try {
                const response = await fetch('/admin/add-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.error) {
                    messageDiv.className = 'mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded';
                    messageDiv.textContent = result.error;
                } else {
                    messageDiv.className = 'mt-4 bg-green-900 border border-green-700 text-green-200 px-4 py-3 rounded';
                    messageDiv.textContent = result.message;
                    document.getElementById('addVideoForm').reset();
                    document.getElementById('subcategoryDiv').classList.add('hidden');
                    setTimeout(() => location.reload(), 1000);
                }
                messageDiv.classList.remove('hidden');

            } catch (error) {
                messageDiv.className = 'mt-4 bg-red-900 border border-red-700 text-red-200 px-4 py-3 rounded';
                messageDiv.textContent = 'Error adding video: ' + error.message;
                messageDiv.classList.remove('hidden');
            }
        });

        // Delete Video
        async function deleteVideo(videoId) {
            if (!confirm('Are you sure you want to delete this video?')) return;

            try {
                const response = await fetch(`/admin/delete-video/${videoId}`, { method: 'POST' });
                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                } else {
                    location.reload();
                }
            } catch (error) {
                alert('Error deleting video: ' + error.message);
            }
        }

        // Edit Video - fetch data and open modal
        async function editVideo(videoId) {
            try {
                const response = await fetch(`/admin/get-video/${videoId}`);
                const video = await response.json();

                if (video.error) {
                    alert(video.error);
                    return;
                }

                // Populate form fields
                document.getElementById('editVideoId').value = video.id;
                document.getElementById('editTitle').value = video.title || '';
                document.getElementById('editUrl').value = video.url || '';
                document.getElementById('editCategory').value = video.category || '';
                document.getElementById('editDescription').value = video.description || '';
                document.getElementById('editDuration').value = video.duration || '';
                document.getElementById('editTags').value = video.tags || '';
                document.getElementById('editEvent').value = video.event || '';

                // Update subcategories and set value
                updateEditSubcategories();
                setTimeout(() => {
                    document.getElementById('editSubcategory').value = video.subcategory || '';
                }, 50);

                // Show modal
                document.getElementById('editModal').classList.remove('hidden');
                document.getElementById('editModal').classList.add('flex');
            } catch (error) {
                alert('Error loading video: ' + error.message);
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // Edit form submission
        document.getElementById('editVideoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const videoId = document.getElementById('editVideoId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                category: document.getElementById('editCategory').value,
                subcategory: document.getElementById('editSubcategory').value,
                description: document.getElementById('editDescription').value,
                duration: document.getElementById('editDuration').value,
                tags: document.getElementById('editTags').value,
                event: document.getElementById('editEvent').value
            };

            try {
                const response = await fetch(`/admin/edit-video/${videoId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.error) {
                    alert(result.error);
                } else {
                    closeEditModal();
                    location.reload();
                }
            } catch (error) {
                alert('Error updating video: ' + error.message);
            }
        });
    </script>
</body>
</html>
