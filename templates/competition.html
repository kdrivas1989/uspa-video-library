<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ competition.name }} - Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for signatures -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Alex+Brush&family=Dancing+Script:wght@500&family=Great+Vibes&family=Pacifico&family=Satisfy&family=Tangerine:wght@700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen">
    <nav class="bg-white border-b border-gray-200 p-4 sticky top-0 z-10 shadow-sm">
        <div class="container mx-auto flex justify-between items-center">
            <a href="{% if is_public_view %}/results/{{ competition.id }}{% else %}/competition/{{ competition.id }}{% endif %}" class="text-2xl font-bold text-blue-600">{{ competition.name }}</a>
            <div class="flex items-center gap-4">
                {% if is_public_view %}
                <span class="bg-green-100 text-green-800 px-3 py-1 rounded-lg text-sm font-medium">Results View</span>
                {% else %}
                <a href="/competitions" class="text-gray-600 hover:text-gray-900">Competitions</a>
                <a href="/videographer" class="bg-yellow-500 hover:bg-gray-400 text-white px-4 py-2 rounded-lg">Videographer Upload</a>
                {% if is_admin %}
                <a href="/admin" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Admin</a>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="max-w-[1800px] mx-auto px-4 py-8">
        <!-- Unofficial Scores Banner (shown in public view when not all rounds approved) -->
        {% if is_public_view %}
        <div id="unofficialBanner" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 px-4 py-3 mb-6 rounded">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                    <span class="font-bold">*UNOFFICIAL Scores</span>
                    <span class="ml-2 text-sm">- Pending Chief Judge approval</span>
                </div>
                <button onclick="showChiefJudgeApprovalModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                    Chief Judge Approval
                </button>
            </div>
        </div>
        {% endif %}

        <!-- Header -->
        <div class="flex justify-between items-start mb-8">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-3xl font-bold">{{ competition.name }}</h1>
                    {% if is_admin and not is_public_view %}
                    <button onclick="showAddEventModal()" class="bg-gray-300 hover:bg-gray-400 px-3 py-1 rounded text-sm" title="Add another event">
                        + Add Event
                    </button>
                    {% endif %}
                </div>
                <div class="text-gray-600 flex flex-wrap gap-4 items-center">
                    {% if is_multi_event %}
                    <span class="flex flex-wrap gap-1">
                        Events:
                        {% for et in event_types %}
                        <span class="bg-blue-600 text-white text-xs px-2 py-0.5 rounded ml-1">{{ et|event_name }}</span>
                        {% endfor %}
                    </span>
                    {% else %}
                    <span>Event: {{ competition.event_type|event_name }}</span>
                    {% endif %}
                    <span class="{% if competition.status == 'active' %}text-green-400{% else %}text-gray-500{% endif %}">
                        {{ competition.status }}
                    </span>
                </div>
            </div>
            {% set is_individual_competition = (competition.event_type.startswith('cp') and competition.event_type != 'cp_team') or competition.event_type.startswith('al') or competition.event_type.startswith('sp') or competition.event_type.startswith('ws_performance') %}
            {% if is_admin and not is_public_view %}
            <div class="flex gap-2 flex-wrap">
                <button onclick="showAddTeamModal()" class="bg-green-600 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm">
                    + Add Team
                </button>
                <button onclick="showAddCompetitorModal()" class="bg-green-600 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm">
                    + Add Competitor
                </button>
                <div class="relative inline-block">
                    <button onclick="toggleImportDropdown()" class="bg-blue-600 hover:bg-gray-300 px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                        Import CSV
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="importDropdown" class="hidden absolute left-0 mt-1 w-48 bg-gray-200 rounded-lg shadow-lg z-20">
                        <button onclick="showImportModal('teams')" class="block w-full text-left px-4 py-2 hover:bg-gray-300 rounded-t-lg">
                            Import Teams
                        </button>
                        <button onclick="showImportModal('competitors')" class="block w-full text-left px-4 py-2 hover:bg-gray-300 rounded-b-lg">
                            Import Competitors
                        </button>
                    </div>
                </div>
                <button onclick="showBulkEditModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                    Bulk Edit
                </button>
                {% if not has_scores %}
                <button onclick="deleteCompetition()" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm">
                    Delete
                </button>
                {% else %}
                <span class="text-gray-500 text-sm px-2" title="Cannot delete once scoring has started">
                    (Delete disabled - scores entered)
                </span>
                {% endif %}
                <span class="text-gray-600">|</span>
                <button onclick="showTrainingPanel()" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                    <span>üéì</span> Training Videos
                </button>
                <span class="text-gray-600">|</span>
                <button onclick="showChiefJudgeModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                    Chief Judge
                </button>
                <button onclick="showChiefJudgeApprovalModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm">
                    Approve Scores
                </button>
                <button onclick="showEventDetailsModal()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm">
                    Event Details
                </button>
                {% set ns = namespace(has_draw_events=false) %}
                {% for et in event_types %}{% if et.startswith('fs_') or et.startswith('cf_') or et.startswith('ae_') or et.startswith('ws_') %}{% set ns.has_draw_events = true %}{% endif %}{% endfor %}
                {% if ns.has_draw_events or competition.event_type.startswith('fs_') or competition.event_type.startswith('cf_') or competition.event_type.startswith('ae_') or competition.event_type.startswith('ws_') %}
                <button onclick="showDrawGeneratorModal()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                    Draw Generator
                </button>
                {% endif %}
                {% if competition.event_type == 'ws_performance' or 'ws_performance' in event_types %}
                <button onclick="openWsReferencePointsModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Flight Paths
                </button>
                {% endif %}
                <button onclick="printResults()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Print PDF
                </button>
            </div>
            {% else %}
            <!-- Non-admin print button -->
            <div class="flex gap-2">
                <button onclick="printResults()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Print PDF
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Legend -->
        <div class="flex items-center gap-6 mb-4 text-sm flex-wrap">
            <span class="text-gray-600">Round Status:</span>
            <span class="flex items-center gap-2">
                <span class="w-6 h-6 rounded bg-gray-300 inline-block"></span>
                <span class="text-gray-600">No video</span>
            </span>
            <span class="flex items-center gap-2">
                <span class="w-6 h-6 rounded bg-yellow-600 inline-block text-center text-xs leading-6">üìπ</span>
                <span class="text-gray-600">Video uploaded (needs scoring)</span>
            </span>
            <span class="flex items-center gap-2">
                <span class="w-6 h-6 rounded bg-green-600 inline-block"></span>
                <span class="text-gray-600">Scored</span>
            </span>
            <span class="flex items-center gap-2">
                <span class="w-6 h-6 rounded bg-purple-600 inline-block text-center text-xs leading-6">üéì</span>
                <span class="text-gray-600">Flagged for training</span>
            </span>
        </div>

        {% if is_multi_event %}
        <!-- Event and Class Selectors (for multi-event competitions) -->
        <div class="flex gap-4 mb-4 pb-2 flex-wrap items-center">
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">Event:</label>
                <select id="eventSelector" onchange="showEvent(this.value)" class="px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% for et in event_types %}
                    <option value="{{ et }}" {% if loop.first %}selected{% endif %}>{{ et|event_name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">Class:</label>
                <select id="multiEventClassSelector" onchange="filterMultiEventClass(this.value)" class="px-4 py-2 rounded-lg bg-white border border-gray-300 text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="open" selected>Open</option>
                    <option value="advanced">Advanced</option>
                    <option value="intermediate">Intermediate</option>
                </select>
            </div>
            {% if is_admin %}
            <div class="ml-auto flex gap-2">
                {% for et in event_types %}
                {% set event_has_teams = teams_by_event.get(et, {}).values()|sum(start=[]) %}
                {% if event_types|length > 1 and not event_has_teams %}
                <button onclick="removeEvent('{{ et }}')" class="bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded text-sm" title="Remove {{ et|event_name }}">
                    Remove {{ et|event_name }}
                </button>
                {% endif %}
                {% endfor %}
                <button onclick="showRenumberModal()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 rounded text-sm">
                    Renumber
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if is_multi_event %}
        <!-- Multi-Event Competition: Teams organized by Event then Class -->
        {% for event_type, classes in teams_by_event.items() %}
        <div id="event-{{ event_type }}" class="event-section mb-8" data-event="{{ event_type }}">
            <h2 class="text-2xl font-bold mb-4 text-blue-400">{{ event_type|event_name }}</h2>
            {% for class_name, teams in classes.items() %}
            <div id="event-{{ event_type }}-class-{{ class_name }}" class="class-section mb-6" data-class="{{ class_name }}">
                <h3 class="text-lg font-bold mb-3 capitalize text-gray-300">{{ class_name }} Class</h3>
                {% if teams %}
                <div class="bg-white rounded-lg overflow-hidden">
                    <table class="w-full">
                        {% set is_individual = (event_type.startswith('cp') and event_type != 'cp_team') or event_type.startswith('al') or event_type.startswith('sp') or event_type.startswith('ws_performance') %}
                        {% set event_round_count = event_rounds.get(event_type, competition.total_rounds) %}
                        <thead class="bg-gray-200">
                            {% if event_type == 'ws_performance' %}
                            <!-- WS Performance: Two-row header with Round 1/2/3 spanning T/D/S -->
                            <tr>
                                <th rowspan="2" class="px-4 py-2 text-left">Rank</th>
                                <th rowspan="2" class="px-2 py-2 text-center">Photo</th>
                                <th rowspan="2" class="px-2 py-2 text-center"></th>
                                <th rowspan="2" class="px-2 py-2 text-left">#</th>
                                <th rowspan="2" class="px-4 py-2 text-left">Competitor</th>
                                <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-200 border-l border-r border-gray-300">Round 1</th>
                                <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-100 border-r border-gray-300">Round 2</th>
                                <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-200 border-r border-gray-300">Round 3</th>
                                <th rowspan="2" class="px-4 py-2 text-right">Total</th>
                            </tr>
                            <tr>
                                <!-- Round 1: T, D, S -->
                                <th class="px-2 py-1 text-center text-xs bg-blue-200 border-l border-gray-300" title="Time (seconds)">Time</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-200" title="Distance (meters)">Dist</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-200 border-r border-gray-300" title="Speed (km/h)">Speed</th>
                                <!-- Round 2: T, D, S -->
                                <th class="px-2 py-1 text-center text-xs bg-blue-100" title="Time (seconds)">Time</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-100" title="Distance (meters)">Dist</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-100 border-r border-gray-300" title="Speed (km/h)">Speed</th>
                                <!-- Round 3: T, D, S -->
                                <th class="px-2 py-1 text-center text-xs bg-blue-200" title="Time (seconds)">Time</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-200" title="Distance (meters)">Dist</th>
                                <th class="px-2 py-1 text-center text-xs bg-blue-200 border-r border-gray-300" title="Speed (km/h)">Speed</th>
                            </tr>
                            {% else %}
                            <tr>
                                <th class="px-4 py-3 text-left">Rank</th>
                                <th class="px-2 py-3 text-center">Photo</th>
                                <th class="px-2 py-3 text-center"></th>
                                <th class="px-2 py-3 text-left">#</th>
                                {% if is_individual %}
                                <th class="px-4 py-3 text-left">Competitor</th>
                                {% else %}
                                <th class="px-4 py-3 text-left">Team Name</th>
                                {% endif %}
                                {% if event_type == 'cp_dsz' %}
                                <!-- CP Individual: Zone Accuracy (1-3), Distance (4-6), Speed (7-9) -->
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Zone Accuracy Round 1">ZA1</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Zone Accuracy Round 2">ZA2</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Zone Accuracy Round 3">ZA3</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold" title="Zone Accuracy Total">ZA</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Distance Round 1">D1</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Distance Round 2">D2</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Distance Round 3">D3</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold" title="Distance Total">D</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Speed Round 1">S1</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Speed Round 2">S2</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-200" title="Speed Round 3">S3</th>
                                <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold" title="Speed Total">S</th>
                                {% else %}
                                {% for i in range(1, event_round_count + 1) %}
                                <th class="px-2 py-3 text-center text-sm">R{{ i }}</th>
                                {% endfor %}
                                {% endif %}
                                <th class="px-4 py-3 text-right">Total</th>
                                {% if 'sp' in event_type %}
                                <th class="px-4 py-3 text-right">Avg Speed</th>
                                {% endif %}
                            </tr>
                            {% endif %}
                        </thead>
                        <tbody>
                            {% for team in teams %}
                            <tr class="border-t border-gray-200 hover:bg-gray-750" data-team-id="{{ team.id }}" data-team-name="{{ team.team_name|e }}">
                                <td class="px-4 py-3 font-bold text-black">{{ loop.index }}</td>
                                <td class="px-2 py-3 text-center">
                                    {% if team.photo %}
                                    <img src="{{ team.photo }}" alt="{{ team.team_name }}"
                                        class="w-10 h-10 rounded-full object-cover cursor-pointer mx-auto hover:ring-2 hover:ring-blue-500"
                                        onclick="openPhotoModal('{{ team.id }}', '{{ team.photo }}', '{{ team.team_name }}', '{{ team.members|default("", true)|e }}')"
                                        title="Click to view photo">
                                    {% else %}
                                    <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mx-auto text-gray-600 text-xs cursor-pointer hover:bg-gray-400 hover:ring-2 hover:ring-blue-500"
                                        onclick="triggerPhotoUpload('{{ team.id }}', '{{ team.team_name }}')"
                                        title="Click to add photo">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                    </div>
                                    {% endif %}
                                </td>
                                {% if is_individual %}
                                <td class="px-2 py-3 text-center">
                                    {% if team.members %}<span class="country-flag" data-country="{{ team.members }}"></span>{% endif %}
                                </td>
                                <td class="px-2 py-3">{{ team.team_number }}</td>
                                <td class="px-4 py-3 font-medium">{{ team.team_name }}</td>
                                {% else %}
                                <td class="px-2 py-3 text-center"></td>
                                <td class="px-2 py-3">{{ team.team_number }}</td>
                                <td class="px-4 py-3 font-medium">{{ team.team_name }}</td>
                                {% endif %}
                                {% if event_type == 'ws_performance' %}
                                <!-- WS Performance: Display grouped by round (T, D, S for each round) -->
                                {% for round_num in [1, 2, 3] %}
                                {% set t_idx = round_num %}
                                {% set d_idx = round_num + 3 %}
                                {% set s_idx = round_num + 6 %}
                                {% set t_score = team.scores|selectattr('round_num', 'equalto', t_idx)|first %}
                                {% set d_score = team.scores|selectattr('round_num', 'equalto', d_idx)|first %}
                                {% set s_score = team.scores|selectattr('round_num', 'equalto', s_idx)|first %}
                                {% set bg_class = 'bg-blue-50' if round_num == 2 else 'bg-blue-100/50' %}
                                <!-- Time for Round {{ round_num }} -->
                                <td class="px-1 py-2 text-center {{ bg_class }} border-l border-gray-200">
                                    {% if t_score and t_score.score is not none %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ t_idx }}, {{ t_score.score }}, '{{ t_score.video_id|default("") }}', 'ws_performance', '{{ t_score.id }}', 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Time: {{ t_score.score|round(2) }}s{% if t_score.weighted_score %} | Points: {{ t_score.weighted_score|round(1) }}{% endif %}">
                                        {{ t_score.score|round(1) }}
                                    </button>
                                    {% else %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ t_idx }}, null, '', 'ws_performance', null, 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                    {% endif %}
                                </td>
                                <!-- Distance for Round {{ round_num }} -->
                                <td class="px-1 py-2 text-center {{ bg_class }}">
                                    {% if d_score and d_score.score is not none %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ d_idx }}, {{ d_score.score }}, '{{ d_score.video_id|default("") }}', 'ws_performance', '{{ d_score.id }}', 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Distance: {{ d_score.score|round(2) }}m{% if d_score.weighted_score %} | Points: {{ d_score.weighted_score|round(1) }}{% endif %}">
                                        {{ d_score.score|round(0)|int }}
                                    </button>
                                    {% else %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ d_idx }}, null, '', 'ws_performance', null, 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                    {% endif %}
                                </td>
                                <!-- Speed for Round {{ round_num }} -->
                                <td class="px-1 py-2 text-center {{ bg_class }} border-r border-gray-200">
                                    {% if s_score and s_score.score is not none %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ s_idx }}, {{ s_score.score }}, '{{ s_score.video_id|default("") }}', 'ws_performance', '{{ s_score.id }}', 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Speed: {{ s_score.score|round(2) }}km/h{% if s_score.weighted_score %} | Points: {{ s_score.weighted_score|round(1) }}{% endif %}">
                                        {{ s_score.score|round(1) }}
                                    </button>
                                    {% else %}
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ s_idx }}, null, '', 'ws_performance', null, 0)"
                                        class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                    {% endif %}
                                </td>
                                {% endfor %}
                                {% else %}
                                {% for i in range(1, event_round_count + 1) %}
                                {% set round_score = team.scores|selectattr('round_num', 'equalto', i)|first %}
                                <td class="px-2 py-3 text-center">
                                    {% if round_score and round_score.rejump %}
                                    <!-- Rejump awarded - awaiting new video -->
                                    <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, null, '', '{{ team.event|default("", true) }}', '{{ round_score.id }}', 0)"
                                        class="w-10 h-8 rounded text-sm bg-orange-600 hover:bg-orange-500 animate-pulse"
                                        title="REJUMP - Click to upload new video">
                                        RJ
                                    </button>
                                    {% elif round_score and (round_score.video_id or round_score.score is not none) %}
                                {% set is_cp_penalty = event_type == 'cp_dsz' and round_score.score_data in ['WL', 'DR', 'MR', 'DQ', 'OF', 'OC', 'CD', 'ME'] %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, {{ round_score.score if round_score.score is not none else 'null' }}, '{{ round_score.video_id }}', '{{ team.event|default("", true) }}', '{{ round_score.id }}', {{ round_score.training_flag|default(0) }})"
                                    class="relative inline-flex items-center justify-center gap-1 {% if event_type == 'cp_dsz' %}w-24 h-10{% else %}w-10 h-8{% endif %} rounded text-xs {% if is_cp_penalty %}bg-red-700 hover:bg-red-600{% elif round_score.exit_time_penalty %}ring-2 ring-red-500 {% elif round_score.training_flag %}ring-2 ring-purple-500 {% endif %}{% if round_score.score is not none and not is_cp_penalty %}bg-gray-300 hover:bg-gray-400{% elif not is_cp_penalty %}bg-yellow-600 hover:bg-gray-300{% endif %}"
                                    title="{% if is_cp_penalty %}{{ round_score.score_data }} - Penalty{% elif event_type == 'cp_dsz' and round_score.weighted_score is defined and round_score.weighted_score is not none %}Raw: {{ round_score.score }} | Weighted: {{ round_score.weighted_score|round(2) }}{% elif round_score.exit_time_penalty %}‚è±Ô∏è -20% Penalty | {% endif %}{% if round_score.training_flag %}üéì Training | {% endif %}{% if round_score.score is not none %}Score: {{ round_score.score }}{% if round_score.score_data %} ({{ round_score.score_data }}){% endif %}{% if round_score.scored_by %} by {{ round_score.scored_by }}{% endif %}{% else %}Video uploaded - Click to judge{% endif %}">
                                    {% if round_score.exit_time_penalty %}<span class="absolute -top-1 -left-1 text-xs">‚è±Ô∏è</span>{% endif %}
                                    {% if round_score.training_flag %}<span class="absolute -top-1 -right-1 text-xs">üéì</span>{% endif %}
                                    {% if is_cp_penalty %}{{ round_score.score_data }}{% elif round_score.score is not none %}{% if event_type == 'cp_dsz' and round_score.weighted_score is defined and round_score.weighted_score is not none %}<span class="text-gray-700 text-sm font-medium">{% if i <= 3 %}{{ round_score.score|int }}{% else %}{{ round_score.score|round(2) }}{% endif %}</span><span class="text-gray-900 text-sm font-bold ml-1">{{ round_score.weighted_score|round(1) }}</span>{% else %}{{ round_score.score|int }}{% endif %}{% else %}üìπ{% endif %}
                                </button>
                                {% else %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, null, '', '{{ team.event|default("", true) }}', null, 0)"
                                    class="w-10 h-8 rounded text-sm bg-gray-300 hover:bg-gray-400"
                                    title="No video - Click to upload">
                                    -
                                </button>
                                {% endif %}
                                </td>
                                {% if event_type == 'cp_dsz' and i == 3 %}
                                <!-- ZA Subtotal after round 3 -->
                                <td class="px-2 py-3 text-center bg-gray-200/30 font-bold">
                                    {% set ns = namespace(total=0) %}
                                    {% for r in range(1, 4) %}
                                        {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                        {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                            {% set ns.total = ns.total + rs.weighted_score %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                                </td>
                                {% endif %}
                                {% if event_type == 'cp_dsz' and i == 6 %}
                                <!-- D Subtotal after round 6 -->
                                <td class="px-2 py-3 text-center bg-gray-200/30 font-bold">
                                    {% set ns = namespace(total=0) %}
                                    {% for r in range(4, 7) %}
                                        {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                        {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                            {% set ns.total = ns.total + rs.weighted_score %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                                </td>
                                {% endif %}
                                {% if event_type == 'cp_dsz' and i == 9 %}
                                <!-- S Subtotal after round 9 -->
                                <td class="px-2 py-3 text-center bg-gray-200/30 font-bold">
                                    {% set ns = namespace(total=0) %}
                                    {% for r in range(7, 10) %}
                                        {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                        {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                            {% set ns.total = ns.total + rs.weighted_score %}
                                        {% endif %}
                                    {% endfor %}
                                    <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                                </td>
                                {% endif %}
                                {% endfor %}
                                {% endif %}
                                <td class="px-4 py-3 text-right font-bold text-black">{% if event_type in ['cp_dsz', 'ws_performance'] %}{{ "%.2f"|format(team.total_score) }}{% else %}{{ team.total_score|int }}{% endif %}</td>
                                {% if 'sp' in event_type %}
                                <td class="px-4 py-3 text-right text-blue-400">
                                    {% set completed_scores = team.scores|selectattr('score', 'ne', none)|list %}
                                    {% if completed_scores|length > 0 %}
                                    {{ "%.2f"|format(team.total_score / completed_scores|length) }} km/h
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-gray-500 text-center py-4 bg-white rounded-lg text-sm">
                    No teams in this class
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% endfor %}
        {% else %}
        <!-- Single-Event Competition: Teams organized by Class only -->

        <!-- Class Selector and Discipline Tabs -->
        <div class="mb-4 flex flex-wrap items-center gap-4">
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">Class:</label>
                <select id="classSelector" onchange="filterClass(this.value)" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    {% set has_teams = [] %}
                    {% for class_name, teams in teams_by_class.items() %}
                        {% if teams %}
                            {% set _ = has_teams.append(class_name) %}
                        {% endif %}
                    {% endfor %}
                    {% for class_name, teams in teams_by_class.items() %}
                        {% if teams %}
                        <option value="{{ class_name }}" {% if loop.first %}selected{% endif %}>{{ class_name|capitalize }}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>

            {% if competition.event_type == 'cp_dsz' %}
            <!-- Event Selector for CP DSZ -->
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">Event:</label>
                <select id="disciplineSelector" onchange="filterDiscipline(this.value)" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all" selected>Overall</option>
                    <option value="za">Zone Accuracy</option>
                    <option value="d">Distance</option>
                    <option value="s">Speed</option>
                </select>
            </div>
            {% elif competition.event_type == 'ws_performance' %}
            <!-- Round Selector for WS Performance -->
            <div class="flex items-center gap-2">
                <label class="text-gray-700 font-medium">Round:</label>
                <select id="wsRoundSelector" onchange="filterWsRound(this.value)" class="px-4 py-2 rounded-lg border border-gray-300 bg-white text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all" selected>All Rounds</option>
                    <option value="r1">Round 1</option>
                    <option value="r2">Round 2</option>
                    <option value="r3">Round 3</option>
                </select>
            </div>
            {% endif %}
        </div>

        {% for class_name, teams in teams_by_class.items() %}
        <div id="class-{{ class_name }}" class="class-section mb-8 hidden">
            {% if teams %}
            <div class="bg-white rounded-lg overflow-hidden">
                <table class="w-full">
                    {% set is_individual = (competition.event_type.startswith('cp') and competition.event_type != 'cp_team') or competition.event_type.startswith('al') or competition.event_type.startswith('sp') or competition.event_type.startswith('ws_performance') %}
                    {% set single_event_rounds = event_rounds.get(event_types[0], competition.total_rounds) if event_types else competition.total_rounds %}
                    <thead class="bg-gray-200">
                        {% if competition.event_type == 'ws_performance' %}
                        <!-- WS Performance: Two-row header with Round 1/2/3 spanning T/D/S -->
                        <tr>
                            <th rowspan="2" class="px-4 py-2 text-left">Rank</th>
                            <th rowspan="2" class="px-2 py-2 text-center">Photo</th>
                            <th rowspan="2" class="px-2 py-2 text-center"></th>
                            <th rowspan="2" class="px-2 py-2 text-left">#</th>
                            <th rowspan="2" class="px-4 py-2 text-left">Competitor</th>
                            <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-200 border-l border-r border-gray-300 col-r1">Round 1</th>
                            <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-100 border-r border-gray-300 col-r2">Round 2</th>
                            <th colspan="3" class="px-2 py-2 text-center text-sm bg-blue-200 border-r border-gray-300 col-r3">Round 3</th>
                            <th rowspan="2" class="px-4 py-2 text-right">Total</th>
                        </tr>
                        <tr>
                            <!-- Round 1: T, D, S -->
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 border-l border-gray-300 col-r1" title="Time (seconds)">Time</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 col-r1" title="Distance (meters)">Dist</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 border-r border-gray-300 col-r1" title="Speed (km/h)">Speed</th>
                            <!-- Round 2: T, D, S -->
                            <th class="px-2 py-1 text-center text-xs bg-blue-100 col-r2" title="Time (seconds)">Time</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-100 col-r2" title="Distance (meters)">Dist</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-100 border-r border-gray-300 col-r2" title="Speed (km/h)">Speed</th>
                            <!-- Round 3: T, D, S -->
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 col-r3" title="Time (seconds)">Time</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 col-r3" title="Distance (meters)">Dist</th>
                            <th class="px-2 py-1 text-center text-xs bg-blue-200 border-r border-gray-300 col-r3" title="Speed (km/h)">Speed</th>
                        </tr>
                        {% else %}
                        <tr>
                            <th class="px-4 py-3 text-left">Rank</th>
                            <th class="px-2 py-3 text-center">Photo</th>
                            <th class="px-2 py-3 text-center"></th>
                            <th class="px-2 py-3 text-left">#</th>
                            {% if is_individual %}
                            <th class="px-4 py-3 text-left">Competitor</th>
                            {% else %}
                            <th class="px-4 py-3 text-left">Team Name</th>
                            {% endif %}
                            {% if competition.event_type == 'cp_dsz' %}
                            <!-- CP Individual: Zone Accuracy (1-3), Distance (4-6), Speed (7-9) -->
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-za" title="Zone Accuracy Round 1">ZA1</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-za" title="Zone Accuracy Round 2">ZA2</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-za" title="Zone Accuracy Round 3">ZA3</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold col-za col-za-total" title="Zone Accuracy Total">ZA</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-d" title="Distance Round 1">D1</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-d" title="Distance Round 2">D2</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-d" title="Distance Round 3">D3</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold col-d col-d-total" title="Distance Total">D</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-s" title="Speed Round 1">S1</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-s" title="Speed Round 2">S2</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-200 col-s" title="Speed Round 3">S3</th>
                            <th class="px-2 py-3 text-center text-sm bg-gray-300 font-bold col-s col-s-total" title="Speed Total">S</th>
                            {% else %}
                            {% for i in range(1, single_event_rounds + 1) %}
                            <th class="px-2 py-3 text-center text-sm">R{{ i }}</th>
                            {% endfor %}
                            {% endif %}
                            <th class="px-4 py-3 text-right">Total</th>
                            {% if competition.event_type.startswith('sp') %}
                            <th class="px-4 py-3 text-right">Avg Speed</th>
                            {% endif %}
                        </tr>
                        {% endif %}
                    </thead>
                    <tbody>
                        {% for team in teams %}
                        <tr class="border-t border-gray-200 hover:bg-gray-750" data-team-id="{{ team.id }}" data-team-name="{{ team.team_name|e }}">
                            <td class="px-4 py-3 font-bold text-black">{{ loop.index }}</td>
                            <td class="px-2 py-3 text-center">
                                {% if team.photo %}
                                <img src="{{ team.photo }}" alt="{{ team.team_name }}"
                                    class="w-10 h-10 rounded-full object-cover cursor-pointer mx-auto hover:ring-2 hover:ring-blue-500"
                                    onclick="openPhotoModal('{{ team.id }}', '{{ team.photo }}', '{{ team.team_name }}', '{{ team.members|default("", true)|e }}')"
                                    title="Click to view photo">
                                {% else %}
                                <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mx-auto text-gray-600 text-xs cursor-pointer hover:bg-gray-400 hover:ring-2 hover:ring-blue-500"
                                    onclick="triggerPhotoUpload('{{ team.id }}', '{{ team.team_name }}')"
                                    title="Click to add photo">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                </div>
                                {% endif %}
                            </td>
                            {% if is_individual %}
                            <td class="px-2 py-3 text-center">
                                {% if team.members %}<span class="country-flag" data-country="{{ team.members }}"></span>{% endif %}
                            </td>
                            <td class="px-2 py-3">{{ team.team_number }}</td>
                            <td class="px-4 py-3 font-medium">{{ team.team_name }}</td>
                            {% else %}
                            <td class="px-2 py-3 text-center"></td>
                            <td class="px-2 py-3">{{ team.team_number }}</td>
                            <td class="px-4 py-3 font-medium">{{ team.team_name }}</td>
                            {% endif %}
                            {% if competition.event_type == 'ws_performance' %}
                            <!-- WS Performance: Display grouped by round (T, D, S for each round) -->
                            {% for round_num in [1, 2, 3] %}
                            {% set t_idx = round_num %}
                            {% set d_idx = round_num + 3 %}
                            {% set s_idx = round_num + 6 %}
                            {% set t_score = team.scores|selectattr('round_num', 'equalto', t_idx)|first %}
                            {% set d_score = team.scores|selectattr('round_num', 'equalto', d_idx)|first %}
                            {% set s_score = team.scores|selectattr('round_num', 'equalto', s_idx)|first %}
                            {% set bg_class = 'bg-blue-50' if round_num == 2 else 'bg-blue-100/50' %}
                            <!-- Time for Round {{ round_num }} -->
                            <td class="px-1 py-2 text-center {{ bg_class }} col-r{{ round_num }} border-l border-gray-200">
                                {% if t_score and t_score.score is not none %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ t_idx }}, {{ t_score.score }}, '{{ t_score.video_id|default("") }}', 'ws_performance', '{{ t_score.id }}', 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Time: {{ t_score.score|round(2) }}s{% if t_score.weighted_score %} | Points: {{ t_score.weighted_score|round(1) }}{% endif %}">
                                    <span class="font-medium">{{ t_score.score|round(1) }}</span>
                                </button>
                                {% else %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ t_idx }}, null, '', 'ws_performance', null, 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                {% endif %}
                            </td>
                            <!-- Distance for Round {{ round_num }} -->
                            <td class="px-1 py-2 text-center {{ bg_class }} col-r{{ round_num }}">
                                {% if d_score and d_score.score is not none %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ d_idx }}, {{ d_score.score }}, '{{ d_score.video_id|default("") }}', 'ws_performance', '{{ d_score.id }}', 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Distance: {{ d_score.score|round(0)|int }}m{% if d_score.weighted_score %} | Points: {{ d_score.weighted_score|round(1) }}{% endif %}">
                                    <span class="font-medium">{{ d_score.score|round(0)|int }}</span>
                                </button>
                                {% else %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ d_idx }}, null, '', 'ws_performance', null, 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                {% endif %}
                            </td>
                            <!-- Speed for Round {{ round_num }} -->
                            <td class="px-1 py-2 text-center {{ bg_class }} col-r{{ round_num }} border-r border-gray-200">
                                {% if s_score and s_score.score is not none %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ s_idx }}, {{ s_score.score }}, '{{ s_score.video_id|default("") }}', 'ws_performance', '{{ s_score.id }}', 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400" title="Speed: {{ s_score.score|round(1) }}km/h{% if s_score.weighted_score %} | Points: {{ s_score.weighted_score|round(1) }}{% endif %}">
                                    <span class="font-medium">{{ s_score.score|round(1) }}</span>
                                </button>
                                {% else %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ s_idx }}, null, '', 'ws_performance', null, 0)"
                                    class="w-14 h-8 rounded text-xs bg-gray-300 hover:bg-gray-400">-</button>
                                {% endif %}
                            </td>
                            {% endfor %}
                            {% else %}
                            {% for i in range(1, single_event_rounds + 1) %}
                            {% set round_score = team.scores|selectattr('round_num', 'equalto', i)|first %}
                            <td class="px-2 py-3 text-center {% if competition.event_type == 'cp_dsz' %}{% if i <= 3 %}col-za{% elif i <= 6 %}col-d{% else %}col-s{% endif %}{% endif %}">
                                {% if round_score and round_score.rejump %}
                                <!-- Rejump awarded - awaiting new video -->
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, null, '', '{{ team.category|default("", true) }}', '{{ round_score.id }}', 0)"
                                    class="w-10 h-8 rounded text-sm bg-orange-600 hover:bg-orange-500 animate-pulse"
                                    title="REJUMP - Click to upload new video">
                                    RJ
                                </button>
                                {% elif round_score and (round_score.video_id or round_score.score is not none) %}
                                {% set is_cp_penalty = competition.event_type == 'cp_dsz' and round_score.score_data in ['WL', 'DR', 'MR', 'DQ', 'OF', 'OC', 'CD', 'ME'] %}
                                {% set is_ws_event = competition.event_type == 'ws_performance' %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, {{ round_score.score if round_score.score is not none else 'null' }}, '{{ round_score.video_id }}', '{{ team.category|default("", true) }}', '{{ round_score.id }}', {{ round_score.training_flag|default(0) }})"
                                    class="inline-flex items-center justify-center gap-1 {% if competition.event_type in ['cp_dsz', 'ws_performance'] %}w-24 h-10{% else %}w-10 h-8{% endif %} rounded text-xs relative {% if is_cp_penalty %}bg-red-700 hover:bg-red-600{% elif round_score.exit_time_penalty %}ring-2 ring-red-500 {% elif round_score.training_flag %}ring-2 ring-purple-500 {% endif %}{% if round_score.score is not none and not is_cp_penalty %}bg-gray-300 hover:bg-gray-400{% elif not is_cp_penalty %}bg-yellow-600 hover:bg-gray-300{% endif %}"
                                    title="{% if is_cp_penalty %}{{ round_score.score_data }} - Penalty{% elif competition.event_type in ['cp_dsz', 'ws_performance'] and round_score.weighted_score is defined and round_score.weighted_score is not none %}Raw: {{ round_score.score }} | Weighted: {{ round_score.weighted_score|round(2) }}{% elif round_score.exit_time_penalty %}‚è±Ô∏è -20% Penalty | {% endif %}{% if round_score.training_flag %}üéì Training | {% endif %}{% if round_score.score is not none %}Score: {{ round_score.score }}{% if round_score.score_data %} ({{ round_score.score_data }}){% endif %}{% if round_score.scored_by %} by {{ round_score.scored_by }}{% endif %}{% else %}Video uploaded - Click to judge{% endif %}">
                                    {% if round_score.exit_time_penalty %}<span class="absolute -top-1 -left-1 text-xs">‚è±Ô∏è</span>{% endif %}
                                    {% if round_score.training_flag %}<span class="absolute -top-1 -right-1 text-xs">üéì</span>{% endif %}
                                    {% if is_cp_penalty %}{{ round_score.score_data }}{% elif round_score.score is not none %}{% if competition.event_type in ['cp_dsz', 'ws_performance'] and round_score.weighted_score is defined and round_score.weighted_score is not none %}<span class="text-gray-700 text-sm font-medium">{% if is_ws_event %}{% if i <= 3 %}{{ round_score.score|round(1) }}s{% elif i <= 6 %}{{ round_score.score|round(0)|int }}m{% else %}{{ round_score.score|round(1) }}{% endif %}{% elif i <= 3 %}{{ round_score.score|int }}{% else %}{{ round_score.score|round(2) }}{% endif %}</span><span class="text-gray-900 text-sm font-bold ml-1">{{ round_score.weighted_score|round(1) }}</span>{% else %}{{ round_score.score|int }}{% endif %}{% else %}üìπ{% endif %}
                                </button>
                                {% else %}
                                <button onclick="openRoundModal('{{ team.id }}', '{{ team.team_name }}', {{ i }}, null, '', '{{ team.category|default("", true) }}', null, 0)"
                                    class="w-10 h-8 rounded text-sm bg-gray-300 hover:bg-gray-400"
                                    title="No video - Click to upload">
                                    -
                                </button>
                                {% endif %}
                            </td>
                            {% if competition.event_type == 'cp_dsz' and i == 3 %}
                            <!-- ZA Subtotal after round 3 -->
                            <td class="px-2 py-3 text-center bg-gray-200/30 font-bold col-za col-za-total">
                                {% set ns = namespace(total=0) %}
                                {% for r in range(1, 4) %}
                                    {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                    {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                        {% set ns.total = ns.total + rs.weighted_score %}
                                    {% endif %}
                                {% endfor %}
                                <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                            </td>
                            {% endif %}
                            {% if competition.event_type == 'cp_dsz' and i == 6 %}
                            <!-- D Subtotal after round 6 -->
                            <td class="px-2 py-3 text-center bg-gray-200/30 font-bold col-d col-d-total">
                                {% set ns = namespace(total=0) %}
                                {% for r in range(4, 7) %}
                                    {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                    {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                        {% set ns.total = ns.total + rs.weighted_score %}
                                    {% endif %}
                                {% endfor %}
                                <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                            </td>
                            {% endif %}
                            {% if competition.event_type == 'cp_dsz' and i == 9 %}
                            <!-- S Subtotal after round 9 -->
                            <td class="px-2 py-3 text-center bg-gray-200/30 font-bold col-s col-s-total">
                                {% set ns = namespace(total=0) %}
                                {% for r in range(7, 10) %}
                                    {% set rs = team.scores|selectattr('round_num', 'equalto', r)|first %}
                                    {% if rs and rs.weighted_score is defined and rs.weighted_score is not none %}
                                        {% set ns.total = ns.total + rs.weighted_score %}
                                    {% endif %}
                                {% endfor %}
                                <span class="text-gray-700">{{ "%.1f"|format(ns.total) }}</span>
                            </td>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            <td class="px-4 py-3 text-right font-bold text-black">{% if competition.event_type in ['cp_dsz', 'ws_performance'] %}{{ "%.2f"|format(team.total_score) }}{% else %}{{ team.total_score|int }}{% endif %}</td>
                            {% if competition.event_type.startswith('sp') %}
                            <td class="px-4 py-3 text-right text-blue-400">
                                {% set completed_scores = team.scores|selectattr('score', 'ne', none)|list %}
                                {% if completed_scores|length > 0 %}
                                {{ "%.2f"|format(team.total_score / completed_scores|length) }} km/h
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-gray-500 text-center py-8 bg-white rounded-lg">
                No teams in this class
            </div>
            {% endif %}
        </div>
        {% endfor %}
        {% endif %}
    </div>

    <!-- Add Team/Competitor Modal -->
    <div id="addTeamModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Add {% if is_individual_competition %}Competitor{% else %}Team{% endif %}</h2>
            <form onsubmit="addTeam(event)">
                <div class="space-y-4">
                    <!-- 1. Event (first question) -->
                    {% if is_multi_event %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Event</label>
                        <select id="teamEvent" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300" required>
                            {% for et in event_types %}
                            <option value="{{ et }}">{{ et|event_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Category</label>
                        <select id="teamCategory" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">
                            <option value="">-- Select Category --</option>
                            {% for cat_id, cat in categories.items() %}
                            {% if cat.subcategories %}
                            <optgroup label="{{ cat.name }} ({{ cat.abbrev }})">
                                {% for sub in cat.subcategories %}
                                <option value="{{ cat_id }}_{{ sub.id }}">{{ sub.name }}</option>
                                {% endfor %}
                            </optgroup>
                            {% else %}
                            <option value="{{ cat_id }}">{{ cat.name }} ({{ cat.abbrev }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- 2. Class (second question) -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Class</label>
                        <select id="teamClass" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">
                            {% if is_individual_competition and (competition.event_type.startswith('al') or competition.event_type.startswith('sp')) %}
                            <option value="open" selected>Open</option>
                            {% else %}
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="open" selected>Open</option>
                            {% endif %}
                        </select>
                    </div>

                    <!-- 3. Number -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">{% if is_individual_competition %}Competitor{% else %}Team{% endif %} Number</label>
                        <input type="text" id="teamNumber" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="101">
                    </div>

                    <!-- 4. Name -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">{% if is_individual_competition %}Competitor Name{% else %}Team Name{% endif %}</label>
                        {% if is_individual_competition %}
                        <!-- Competitor Search -->
                        <div class="relative">
                            <input type="text" id="teamName" required
                                class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Search or enter name..."
                                oninput="searchCompetitors(this.value)"
                                onfocus="searchCompetitors(this.value)"
                                autocomplete="off">
                            <div id="competitorSearchResults" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                            </div>
                        </div>
                        {% else %}
                        <input type="text" id="teamName" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Skydivers United">
                        {% endif %}
                    </div>

                    <!-- 5. Members / Country -->
                    {% if not is_individual_competition %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Team Members</label>
                        <input type="text" id="teamMembers"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="John, Jane, Bob, Alice">
                    </div>
                    {% else %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Country / Affiliation</label>
                        <input type="text" id="teamMembers"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="USA">
                    </div>
                    {% endif %}

                    <!-- Event Name (only for single-event) -->
                    {% if not is_multi_event %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Event Name</label>
                        <input type="text" id="teamEventName"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="2024 Nationals">
                    </div>
                    {% endif %}

                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">{% if is_individual_competition %}Competitor{% else %}Team{% endif %} Photo</label>
                        <div class="flex items-center gap-3">
                            <div id="addTeamPhotoPreview" class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center overflow-hidden">
                                <span class="text-gray-500 text-xs">No photo</span>
                            </div>
                            <div class="flex-1">
                                <input type="file" id="addTeamPhoto" accept="image/*" class="hidden" onchange="previewAddTeamPhoto(event)">
                                <button type="button" onclick="document.getElementById('addTeamPhoto').click()"
                                    class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm w-full">
                                    Choose Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideAddTeamModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 hover:bg-gray-300">Add {% if is_individual_competition %}Competitor{% else %}Team{% endif %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Competitor Modal (for individual events) -->
    <div id="addCompetitorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Add Competitor</h2>
            <form onsubmit="addCompetitor(event)">
                <div class="space-y-4">
                    <!-- Event -->
                    {% if is_multi_event %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Event</label>
                        <select id="competitorEvent" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300" required>
                            {% for et in event_types %}
                            <option value="{{ et }}">{{ et|event_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- Class -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Class</label>
                        <select id="competitorClass" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">
                            <option value="open" selected>Open</option>
                            <option value="advanced">Advanced</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="beginner">Beginner</option>
                        </select>
                    </div>

                    <!-- Number -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Competitor Number</label>
                        <input type="text" id="competitorNumber" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="1">
                    </div>

                    <!-- Name -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Competitor Name</label>
                        <input type="text" id="competitorName" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="John Smith">
                    </div>

                    <!-- Country -->
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Country / Affiliation</label>
                        <input type="text" id="competitorCountry"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="USA">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideAddCompetitorModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 hover:bg-gray-300">Add Competitor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Edit Modal -->
    <div id="bulkEditModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto py-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 my-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Bulk Edit Competitors</h2>
                <button onclick="hideBulkEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <p class="text-gray-600 text-sm mb-3">Use the arrows to change the display order. Competitor numbers remain unchanged.</p>
            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 sticky top-0">
                        <tr>
                            <th class="px-2 py-2 text-center w-20">Order</th>
                            <th class="px-2 py-2 text-center"></th>
                            <th class="px-2 py-2 text-left">#</th>
                            <th class="px-3 py-2 text-left">Name</th>
                            <th class="px-3 py-2 text-left">Country</th>
                            <th class="px-3 py-2 text-left">Class</th>
                            <th class="px-3 py-2 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="bulkEditTableBody">
                        <!-- Populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-between">
                <button onclick="saveTeamOrder()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save Order</button>
                <button onclick="hideBulkEditModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Close</button>
            </div>
        </div>
    </div>

    <!-- Print Options Modal -->
    <div id="printOptionsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Print Options</h2>
                <button onclick="hidePrintOptionsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-medium mb-2">Select Rounds to Include</label>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="printRange" value="full" checked class="w-4 h-4">
                            <span>Full Event (All Rounds)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="printRange" value="upTo" class="w-4 h-4">
                            <span>Up to Round:</span>
                            <select id="printUpToRound" class="px-2 py-1 border border-gray-300 rounded">
                                {% if competition.event_type == 'cp_dsz' %}
                                <option value="1">ZA1</option>
                                <option value="2">ZA2</option>
                                <option value="3">ZA3</option>
                                <option value="4">D1</option>
                                <option value="5">D2</option>
                                <option value="6">D3</option>
                                <option value="7">S1</option>
                                <option value="8">S2</option>
                                <option value="9">S3</option>
                                {% else %}
                                {% for i in range(1, (competition.total_rounds or 10) + 1) %}
                                <option value="{{ i }}">Round {{ i }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="printRange" value="single" class="w-4 h-4">
                            <span>Single Round:</span>
                            <select id="printSingleRound" class="px-2 py-1 border border-gray-300 rounded">
                                {% if competition.event_type == 'cp_dsz' %}
                                <option value="1">ZA1</option>
                                <option value="2">ZA2</option>
                                <option value="3">ZA3</option>
                                <option value="4">D1</option>
                                <option value="5">D2</option>
                                <option value="6">D3</option>
                                <option value="7">S1</option>
                                <option value="8">S2</option>
                                <option value="9">S3</option>
                                {% else %}
                                {% for i in range(1, (competition.total_rounds or 10) + 1) %}
                                <option value="{{ i }}">Round {{ i }}</option>
                                {% endfor %}
                                {% endif %}
                            </select>
                        </label>
                    </div>
                </div>
            </div>
            {% if competition.chief_judge %}
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <label class="block text-gray-700 font-medium mb-2">Chief Judge Signature (Optional)</label>
                    <p class="text-gray-500 text-sm mb-2">Enter PIN to include signature, or leave blank to print without</p>
                    <input type="text" id="printSignaturePin" placeholder="PIN (optional)"
                        maxlength="6"
                        class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                {% endif %}
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button type="button" onclick="hidePrintOptionsModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                <button type="button" onclick="generatePDF()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    Generate PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Chief Judge Modal -->
    <div id="chiefJudgeModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Set Chief Judge</h2>
                <button onclick="hideChiefJudgeModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="saveChiefJudge(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Select Chief Judge</label>
                        <select id="chiefJudgeSelect"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">-- Select a Chief Judge --</option>
                        </select>
                        <p class="text-gray-400 text-xs mt-1">Only users with a Signature PIN can be selected.</p>
                    </div>
                    <div id="noSignersMessage" class="hidden bg-yellow-100 border border-yellow-400 text-yellow-800 px-4 py-3 rounded">
                        <p class="text-sm">No users with signature PINs found.</p>
                        <p class="text-xs mt-1">Go to <a href="/admin/users" class="text-blue-600 underline">User Management</a> to set up a Chief Judge with a signature PIN.</p>
                    </div>
                    <p class="text-gray-500 text-sm">
                        The Chief Judge's name will appear as an electronic signature on printed PDF results when verified with their PIN.
                    </p>
                    <div id="signaturePreviewContainer" class="hidden mt-4 p-3 bg-gray-50 rounded border">
                        <label class="block text-gray-600 text-sm mb-2">Current Signature</label>
                        <img id="signaturePreview" class="max-h-16 border border-gray-300 bg-white" alt="Signature">
                        <button type="button" onclick="openSignatureCreator()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">Edit Signature</button>
                    </div>
                    <div id="noSignatureContainer" class="hidden mt-4">
                        <button type="button" onclick="openSignatureCreator()" class="text-blue-600 hover:text-blue-800 text-sm underline">Create Signature for Selected Chief Judge</button>
                    </div>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="hideChiefJudgeModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Signature Creation Modal -->
    <div id="signatureModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Create Signature</h2>
                <button onclick="closeSignatureModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Signature Type Tabs -->
            <div class="flex border-b border-gray-300 mb-4">
                <button id="tabDraw" onclick="switchSignatureTab('draw')" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
                    Draw Signature
                </button>
                <button id="tabType" onclick="switchSignatureTab('type')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    Type Signature
                </button>
            </div>

            <!-- Draw Signature Panel -->
            <div id="drawPanel">
                <p class="text-gray-600 text-sm mb-4">Draw your signature using your mouse or touch screen.</p>
                <div class="border-2 border-gray-300 rounded bg-white mb-4">
                    <canvas id="signatureCanvas" width="450" height="150" class="w-full cursor-crosshair"></canvas>
                </div>
                <button onclick="clearSignatureCanvas()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-sm mb-4">
                    Clear Canvas
                </button>
            </div>

            <!-- Type Signature Panel -->
            <div id="typePanel" class="hidden">
                <p class="text-gray-600 text-sm mb-4">Type your name and select a signature style.</p>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Your Name</label>
                    <input type="text" id="signatureNameInput" class="w-full border rounded px-3 py-2"
                           placeholder="Enter your name" oninput="updateTypedSignaturePreview()">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Style</label>
                    <div class="grid grid-cols-1 gap-2 max-h-64 overflow-y-auto">
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Great Vibes', cursive" class="mr-3" checked onchange="updateTypedSignaturePreview()">
                            <span class="text-3xl" style="font-family: 'Great Vibes', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Alex Brush', cursive" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-3xl" style="font-family: 'Alex Brush', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Dancing Script', cursive" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-3xl" style="font-family: 'Dancing Script', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Satisfy', cursive" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-3xl" style="font-family: 'Satisfy', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Pacifico', cursive" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-3xl" style="font-family: 'Pacifico', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Tangerine', cursive" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-4xl" style="font-family: 'Tangerine', cursive;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="Georgia, serif" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-2xl italic" style="font-family: Georgia, serif;">Sample Signature</span>
                        </label>
                        <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50 signature-style-option">
                            <input type="radio" name="signatureFont" value="'Times New Roman', serif" class="mr-3" onchange="updateTypedSignaturePreview()">
                            <span class="text-2xl italic" style="font-family: 'Times New Roman', serif;">Sample Signature</span>
                        </label>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                    <div class="border-2 border-gray-300 rounded bg-white p-4 min-h-[80px] flex items-center justify-center">
                        <canvas id="typedSignatureCanvas" width="450" height="80" class="max-w-full"></canvas>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-2 pt-4 border-t">
                <button onclick="closeSignatureModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                <button onclick="saveSignature()" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">Save Signature</button>
            </div>
        </div>
    </div>

    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Event Details</h2>
                <button onclick="hideEventDetailsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form onsubmit="saveEventDetails(event)">
                <div class="space-y-4 max-h-96 overflow-y-auto">
                    {% for event_type in event_types %}
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">{{ EVENT_DISPLAY_NAMES.get(event_type, event_type) }}</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-gray-600 text-xs mb-1">Location</label>
                                <input type="text" id="eventLocation_{{ event_type }}"
                                    value="{{ (competition.event_locations|default('{}', true)|tojson|safe|replace('\\\"', '\"')|from_json).get(event_type, '') if competition.event_locations else '' }}"
                                    placeholder="e.g., Skydive Arizona"
                                    class="w-full px-3 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                            <div>
                                <label class="block text-gray-600 text-xs mb-1">Date</label>
                                <input type="date" id="eventDate_{{ event_type }}"
                                    value="{{ (competition.event_dates|default('{}', true)|tojson|safe|replace('\\\"', '\"')|from_json).get(event_type, '') if competition.event_dates else '' }}"
                                    class="w-full px-3 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="hideEventDetailsModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700 text-white">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Draw Generator Modal -->
    <div id="drawGeneratorModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
        <div class="bg-white rounded-lg p-6 w-full max-w-6xl mx-4 my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900">Draw Generator</h2>
                <button onclick="hideDrawGeneratorModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- Draw Generator Controls -->
            <div class="grid grid-cols-4 gap-4 mb-4">
                <div>
                    <label class="block text-gray-600 text-sm mb-1">Event</label>
                    <select id="drawEventType" onchange="updateDrawClassOptions()" class="w-full px-3 py-2 rounded bg-white text-gray-900 border border-gray-300">
                        {% for et in event_types %}
                        {% if et.startswith('fs_') or et.startswith('cf_') or et.startswith('ae_') or et.startswith('ws_') %}
                        <option value="{{ et }}">{{ EVENT_DISPLAY_NAMES.get(et, et) }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm mb-1">Class</label>
                    <select id="drawClass" class="w-full px-3 py-2 rounded bg-white text-gray-900 border border-gray-300">
                        <option value="open">Open</option>
                        <option value="advanced">Advanced</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="beginner">Beginner</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-600 text-sm mb-1">Rounds</label>
                    <div id="drawNumRoundsDisplay" class="w-full px-3 py-2 rounded bg-gray-100 text-gray-900 border border-gray-300 font-medium">10 Rounds</div>
                    <input type="hidden" id="drawNumRounds" value="10">
                </div>
                <div class="flex items-end gap-2">
                    <button onclick="generateCompetitionDraw()" class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold">
                        Generate
                    </button>
                    <button onclick="toggleDrawEditMode()" id="drawEditModeBtn" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded hidden">
                        Edit
                    </button>
                </div>
            </div>

            <!-- WS Acrobatic Section (Round Structure, Compulsory Sequence Draw & Tie Breaker) -->
            <div id="tieBreakerSection" class="hidden mb-4 p-4 bg-purple-50 rounded border border-purple-200">
                <!-- Round Structure -->
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">Round Structure (7 Rounds)</h4>
                    <div class="flex gap-1 mb-2">
                        <div class="w-10 h-10 rounded bg-green-500 text-white flex items-center justify-center font-bold text-sm" title="Round 1: Free">F</div>
                        <div class="w-10 h-10 rounded bg-orange-500 text-white flex items-center justify-center font-bold text-sm" title="Round 2: Compulsory">C</div>
                        <div class="w-10 h-10 rounded bg-orange-500 text-white flex items-center justify-center font-bold text-sm" title="Round 3: Compulsory">C</div>
                        <div class="w-10 h-10 rounded bg-green-500 text-white flex items-center justify-center font-bold text-sm" title="Round 4: Free">F</div>
                        <div class="w-10 h-10 rounded bg-orange-500 text-white flex items-center justify-center font-bold text-sm" title="Round 5: Compulsory">C</div>
                        <div class="w-10 h-10 rounded bg-orange-500 text-white flex items-center justify-center font-bold text-sm" title="Round 6: Compulsory">C</div>
                        <div class="w-10 h-10 rounded bg-green-500 text-white flex items-center justify-center font-bold text-sm" title="Round 7: Free">F</div>
                    </div>
                    <div class="text-xs text-gray-600 space-y-1">
                        <p><span class="inline-block w-4 h-4 bg-green-500 rounded mr-1 align-middle"></span> <strong>Free (F)</strong> - 3 rounds: Competitor's own routine</p>
                        <p><span class="inline-block w-4 h-4 bg-orange-500 rounded mr-1 align-middle"></span> <strong>Compulsory (C)</strong> - 4 rounds: 3 Compulsory Sequences per routine (from Addendum A)</p>
                    </div>
                </div>
                <!-- Compulsory Sequence Draw -->
                <div class="mb-4 pt-3 border-t border-purple-200">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-800">Compulsory Sequence Draw</h4>
                            <p class="text-sm text-gray-600">Draw 3 sequences per Compulsory round from Addendum A (without replacement)</p>
                        </div>
                        <button onclick="drawWsAcroSequences()" class="px-4 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded font-bold">
                            Draw Sequences
                        </button>
                    </div>
                    <div id="wsAcroSequenceResults" class="hidden">
                        <div class="grid grid-cols-4 gap-2 text-sm">
                            <div class="bg-orange-100 rounded p-2">
                                <div class="font-semibold text-orange-800 mb-1">Round 2 (C)</div>
                                <div id="wsAcroSeqR2" class="text-gray-700 space-y-1"></div>
                            </div>
                            <div class="bg-orange-100 rounded p-2">
                                <div class="font-semibold text-orange-800 mb-1">Round 3 (C)</div>
                                <div id="wsAcroSeqR3" class="text-gray-700 space-y-1"></div>
                            </div>
                            <div class="bg-orange-100 rounded p-2">
                                <div class="font-semibold text-orange-800 mb-1">Round 5 (C)</div>
                                <div id="wsAcroSeqR5" class="text-gray-700 space-y-1"></div>
                            </div>
                            <div class="bg-orange-100 rounded p-2">
                                <div class="font-semibold text-orange-800 mb-1">Round 6 (C)</div>
                                <div id="wsAcroSeqR6" class="text-gray-700 space-y-1"></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Sequences drawn without replacement. Pool restarts if exhausted.</p>
                    </div>
                </div>
                <!-- Tie Breaker Draw -->
                <div class="pt-3 border-t border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-gray-800">Tie Breaker Draw</h4>
                            <p class="text-sm text-gray-600">Draw to determine if tie breaker round is Compulsory or Free routine</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div id="tieBreakerResult" class="hidden px-4 py-2 rounded font-bold text-lg"></div>
                            <button onclick="drawTieBreaker()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded font-bold">
                                Draw Tie Breaker
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WS Performance Task Order Section -->
            <div id="wsTaskOrderSection" class="hidden mb-4 p-4 bg-green-50 rounded border border-green-200">
                <div class="mb-3">
                    <h4 class="font-semibold text-gray-800">Task Order Draw</h4>
                    <p class="text-sm text-gray-600">Draw which task (Time, Distance, Speed) is performed in each round</p>
                </div>
                <div class="flex items-center gap-4 mb-3">
                    <div class="flex gap-2">
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Round 1</div>
                            <div id="wsTaskRound1" class="w-24 h-10 rounded bg-gray-200 flex items-center justify-center font-bold text-gray-600">-</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Round 2</div>
                            <div id="wsTaskRound2" class="w-24 h-10 rounded bg-gray-200 flex items-center justify-center font-bold text-gray-600">-</div>
                        </div>
                        <div class="text-center">
                            <div class="text-xs text-gray-500 mb-1">Round 3</div>
                            <div id="wsTaskRound3" class="w-24 h-10 rounded bg-gray-200 flex items-center justify-center font-bold text-gray-600">-</div>
                        </div>
                    </div>
                    <button onclick="drawWsTaskOrder()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded font-bold">
                        Draw Task Order
                    </button>
                    <button onclick="saveWsTaskOrder()" id="saveWsTaskOrderBtn" class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded font-bold">
                        Save & Apply
                    </button>
                </div>
                <div id="wsTaskOrderSaved" class="hidden text-sm text-green-700 font-medium">
                    Task order saved and applied to scoring!
                </div>
            </div>

            <!-- Saved Draws Display -->
            <div id="savedDrawsSection" class="mb-4 p-3 bg-blue-50 rounded border border-blue-200">
                <h4 class="font-semibold text-gray-800 mb-2">Saved Draws</h4>
                <div id="savedDrawsList" class="flex flex-wrap gap-2">
                    <span class="text-gray-500 text-sm">No draws saved yet</span>
                </div>
            </div>

            <!-- Draw Results -->
            <div id="drawResultsArea" class="hidden">
                <div id="drawEditModeNotice" class="hidden mb-3 p-2 bg-yellow-100 border border-yellow-300 rounded text-yellow-800 text-sm">
                    <strong>Edit Mode:</strong> Click any formation to change it, or click + to add formations.
                </div>
                <div id="drawContent" class="overflow-x-auto">
                    <!-- Draw will be rendered here -->
                </div>
                <div class="flex justify-end gap-2 mt-4">
                    <button onclick="saveCurrentDraw()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded">
                        Save Draw
                    </button>
                    <button onclick="printCurrentDraw()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                        Print
                    </button>
                </div>
            </div>

            <!-- Formation Picker (for editing) -->
            <div id="drawFormationPicker" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-[60]">
                <div class="bg-white rounded-lg p-4 max-w-3xl max-h-[80vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-bold text-gray-900">Select Formation</h4>
                        <button onclick="closeDrawFormationPicker()" class="text-gray-500 hover:text-gray-700 text-xl">&times;</button>
                    </div>
                    <div id="drawFormationPickerContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Team Modal -->
    <div id="editTeamModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Edit Team</h2>
            <form onsubmit="updateTeam(event)">
                <input type="hidden" id="editTeamId">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Team Number</label>
                        <input type="text" id="editTeamNumber" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Team Name</label>
                        <input type="text" id="editTeamName" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Class</label>
                        <select id="editTeamClass" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">
                            {% if not competition.event_type.startswith('cp') %}
                            <option value="beginner">Beginner</option>
                            {% endif %}
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                            <option value="open">Open</option>
                        </select>
                    </div>
                    {% if is_multi_event %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Event</label>
                        <select id="editTeamEvent" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300" required>
                            {% for et in event_types %}
                            <option value="{{ et }}">{{ et|event_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Category</label>
                        <select id="editTeamCategory" class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">
                            <option value="">-- Select Category --</option>
                            {% for cat_id, cat in categories.items() %}
                            {% if cat.subcategories %}
                            <optgroup label="{{ cat.name }} ({{ cat.abbrev }})">
                                                                {% for sub in cat.subcategories %}
                                <option value="{{ cat_id }}_{{ sub.id }}">{{ sub.name }}</option>
                                {% endfor %}
                            </optgroup>
                            {% else %}
                            <option value="{{ cat_id }}">{{ cat.name }} ({{ cat.abbrev }})</option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Event Name</label>
                        <input type="text" id="editTeamEventName"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="2024 Nationals">
                    </div>
                    {% endif %}
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Team Members</label>
                        <input type="text" id="editTeamMembers"
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="John, Jane, Bob, Alice">
                    </div>
                    <div>
                        <label class="block text-gray-600 text-sm mb-1">Team Photo</label>
                        <div class="flex items-center gap-3">
                            <div id="editTeamPhotoPreview" class="w-16 h-16 rounded bg-gray-200 flex items-center justify-center overflow-hidden">
                                <span class="text-gray-500 text-xs">No photo</span>
                            </div>
                            <div class="flex-1">
                                <input type="file" id="editTeamPhoto" accept="image/*" class="hidden" onchange="previewTeamPhoto(event)">
                                <button type="button" onclick="document.getElementById('editTeamPhoto').click()"
                                    class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm w-full">
                                    Choose Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideEditTeamModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-gray-300">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Hidden file input for direct photo upload -->
    <input type="file" id="directPhotoUpload" accept="image/*" class="hidden" onchange="handleDirectPhotoUpload(event)">
    <input type="hidden" id="directPhotoTeamId" value="">

    <!-- Photo Viewer Modal -->
    <div id="photoModal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hidePhotoModal()">
        <div class="max-w-2xl mx-4 text-center" onclick="event.stopPropagation()">
            <img id="photoModalImage" src="" alt="" class="max-h-[70vh] rounded-lg shadow-2xl mx-auto">
            <h3 id="photoModalName" class="text-2xl font-bold mt-4"></h3>
            <p id="photoModalMembers" class="text-gray-600 mt-2"></p>
            <div class="mt-4 flex justify-center gap-3">
                {% if is_admin %}
                <button onclick="changePhotoFromModal()" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-500">Change Photo</button>
                {% endif %}
                <button onclick="hidePhotoModal()" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Close</button>
            </div>
            <input type="hidden" id="photoModalTeamId">
        </div>
    </div>

    <!-- Import CSV Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4" id="importModalTitle">Import from CSV</h2>
            <form onsubmit="importCSV(event)">
                <input type="hidden" id="importType" value="teams">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 text-sm mb-2">CSV File</label>
                        <input type="file" id="csvFile" accept=".csv" required
                            class="w-full px-4 py-2 rounded bg-white text-gray-900 border border-gray-300">

                        <!-- Teams import info -->
                        <div id="teamsImportInfo" class="mt-2 p-3 bg-gray-200 rounded text-xs">
                            <p class="text-gray-600 mb-2">Required columns:</p>
                            <code class="text-green-400">name, class, event</code>
                            <p class="text-gray-600 mt-2 mb-1">Optional columns:</p>
                            <code class="text-yellow-400">team_number, members</code>
                            <p class="text-gray-500 mt-2">Flexible headers accepted (e.g., "Team Name", "Category", "Discipline")</p>
                            <div class="mt-3 pt-2 border-t border-gray-600">
                                <a href="/example-csv/teams" download class="text-blue-400 hover:text-gray-700">
                                    Download Template CSV
                                </a>
                            </div>
                        </div>

                        <!-- Competitors import info -->
                        <div id="competitorsImportInfo" class="hidden mt-2 p-3 bg-gray-200 rounded text-xs">
                            <p class="text-gray-600 mb-2">Required columns:</p>
                            <code class="text-green-400">name, class, event</code>
                            <p class="text-gray-600 mt-2 mb-1">Optional columns:</p>
                            <code class="text-yellow-400">number, country</code>
                            <p class="text-gray-500 mt-2">Flexible headers accepted (e.g., "Athlete", "Category", "Nationality")</p>
                            <div class="mt-3 pt-2 border-t border-gray-600">
                                <a href="/example-csv/competitors" download class="text-blue-400 hover:text-gray-700">
                                    Download Template CSV
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideImportModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 hover:bg-gray-300">Import</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Renumber Modal -->
    <div id="renumberModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Renumber {% if is_individual_competition %}Competitors{% else %}Teams{% endif %}</h2>
            <p class="text-gray-600 text-sm mb-4">Set the starting number for each class. Entries will be numbered sequentially within each class.</p>
            <form onsubmit="renumberAll(event)">
                <div class="space-y-3">
                    <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded">
                        <label class="text-black font-medium">Open</label>
                        <input type="number" id="renumberOpen" value="1" min="1"
                            class="w-24 px-3 py-2 rounded bg-white border border-gray-300 text-black text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded">
                        <label class="text-black font-medium">Advanced</label>
                        <input type="number" id="renumberAdvanced" value="101" min="1"
                            class="w-24 px-3 py-2 rounded bg-white border border-gray-300 text-black text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded">
                        <label class="text-black font-medium">Intermediate</label>
                        <input type="number" id="renumberIntermediate" value="201" min="1"
                            class="w-24 px-3 py-2 rounded bg-white border border-gray-300 text-black text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex items-center justify-between bg-gray-100 px-4 py-3 rounded">
                        <label class="text-black font-medium">Beginner</label>
                        <input type="number" id="renumberBeginner" value="301" min="1"
                            class="w-24 px-3 py-2 rounded bg-white border border-gray-300 text-black text-center focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideRenumberModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400 text-black">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-yellow-600 hover:bg-yellow-700 text-white">Renumber</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Event Modal -->
    <div id="addEventModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-4">Add Events to Competition</h2>
            <form onsubmit="addEventsToCompetition(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-600 text-sm mb-2">Select Event Types</label>
                        <div class="bg-gray-200 rounded p-3 max-h-48 overflow-y-auto space-y-1">
                            {% for cat_id, cat in categories.items() %}
                            {% if cat_id != 'uncategorized' %}
                            {% if cat.subcategories %}
                            {% set has_available = [] %}
                            {% for sub in cat.subcategories %}
                            {% if (cat_id ~ '_' ~ sub.id) not in event_types %}
                            {% set _ = has_available.append(1) %}
                            {% endif %}
                            {% endfor %}
                            {% if has_available %}
                            <div class="text-gray-600 text-xs font-medium mt-2 mb-1">{{ cat.name }} ({{ cat.abbrev }})</div>
                            {% for sub in cat.subcategories %}
                            {% if (cat_id ~ '_' ~ sub.id) not in event_types %}
                            <label class="flex items-center gap-2 px-2 py-1 hover:bg-gray-300 rounded cursor-pointer">
                                <input type="checkbox" name="newEventTypes" value="{{ cat_id }}_{{ sub.id }}" class="new-event-checkbox">
                                <span class="text-sm">{{ sub.name }}</span>
                            </label>
                            {% endif %}
                            {% endfor %}
                            {% endif %}
                            {% else %}
                            {% if cat_id not in event_types %}
                            <label class="flex items-center gap-2 px-2 py-1 hover:bg-gray-300 rounded cursor-pointer">
                                <input type="checkbox" name="newEventTypes" value="{{ cat_id }}" class="new-event-checkbox">
                                <span class="text-sm">{{ cat.name }} ({{ cat.abbrev }})</span>
                            </label>
                            {% endif %}
                            {% endif %}
                            {% endif %}
                            {% endfor %}
                        </div>
                        <p class="text-gray-500 text-xs mt-1">Selected: <span id="newEventsSelectedCount">0</span> event(s)</p>
                    </div>
                    <!-- Rounds per Event (dynamically populated) -->
                    <div id="newEventRoundsSection" class="hidden">
                        <label class="block text-gray-600 text-sm mb-2">Rounds per Event</label>
                        <div id="newEventRoundsList" class="space-y-2 bg-gray-200 rounded p-3 max-h-48 overflow-y-auto">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" onclick="hideAddEventModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                    <button type="submit" class="px-4 py-2 rounded bg-green-600 hover:bg-gray-300">Add Events</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Round Score Modal (with video upload) -->
    <div id="roundModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto py-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-3xl mx-4 my-auto">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold" id="roundModalTitle">Round <span id="roundNum"></span></h2>
                <p class="text-lg font-semibold text-blue-600" id="roundTeamName"></p>
            </div>
            <form onsubmit="saveRoundScore(event)">
                <input type="hidden" id="roundTeamId">
                <input type="hidden" id="roundNumber">
                <input type="hidden" id="existingVideoId">

                <div class="space-y-4">
                    <!-- Video Player (shown when video exists) -->
                    <div id="videoPlayerSection" class="hidden">
                        <div class="aspect-video bg-black rounded-lg overflow-hidden mb-2">
                            <video id="roundVideoPlayer" controls class="w-full h-full">
                                Your browser does not support video playback.
                            </video>
                        </div>
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-green-400">üìπ Video ready for judging</span>
                            <div class="flex items-center gap-3">
                                <a href="#" id="viewVideoFullLink" target="_blank" class="text-blue-400 hover:underline">Open full player ‚Üí</a>
                                {% if is_admin %}
                                <button type="button" onclick="showRemoveVideoConfirm()" class="text-red-400 hover:text-red-300 text-sm">Remove Video</button>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Remove Video Confirmation (hidden by default) -->
                        {% if is_admin %}
                        <div id="removeVideoConfirm" class="hidden mt-3 p-3 bg-red-900/30 border border-red-700 rounded-lg">
                            <p class="text-sm text-gray-300 mb-3">Remove this video from the round? This will allow a new video to be uploaded.</p>
                            <label class="flex items-center gap-2 text-sm text-gray-600 mb-3 cursor-pointer">
                                <input type="checkbox" id="deleteVideoFile" class="w-4 h-4">
                                <span>Also delete the video file permanently</span>
                            </label>
                            <div class="flex gap-2">
                                <button type="button" onclick="removeVideoFromRound()" class="px-3 py-1.5 rounded bg-red-600 hover:bg-red-700 text-sm">
                                    Remove Video
                                </button>
                                <button type="button" onclick="hideRemoveVideoConfirm()" class="px-3 py-1.5 rounded bg-gray-300 hover:bg-gray-400 text-sm">
                                    Cancel
                                </button>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Score Entry (for judges only) -->
                    {% if is_admin %}
                    <!-- Standard Score Entry (non-CP events) -->
                    <div id="standardScoreSection" class="bg-gray-50 rounded-lg p-4">
                        <label class="block text-gray-600 text-sm mb-2">Score</label>
                        <div class="flex items-center gap-4">
                            <input type="number" id="roundScore" step="1" min="0"
                                class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-3xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="--">
                            <div class="text-gray-500 text-sm">
                                <div>Points scored</div>
                                <div class="text-xs">(minus omissions)</div>
                            </div>
                        </div>
                    </div>

                    <!-- CP Scoring Section (Canopy Piloting) -->
                    <div id="cpScoreSection" class="hidden bg-gray-50 rounded-lg p-4">
                        <!-- Zone Accuracy Section (Rounds 1-3) -->
                        <div id="cpZoneSection">
                            <!-- Water Gates (vertical, checked by default) -->
                            <div class="mb-3">
                                <label class="block text-gray-600 text-xs mb-1">Water Gates (uncheck if missed)</label>
                                <div class="flex flex-col gap-1">
                                    <label class="flex items-center gap-2 bg-gray-300 px-3 py-1.5 rounded cursor-pointer hover:bg-gray-400 text-sm">
                                        <input type="checkbox" id="cpGateEntry" class="w-4 h-4" checked onchange="calculateCpScore()">
                                        <span>Entry (3)</span>
                                    </label>
                                    <label class="flex items-center gap-2 bg-gray-300 px-3 py-1.5 rounded cursor-pointer hover:bg-gray-400 text-sm">
                                        <input type="checkbox" id="cpGate1" class="w-4 h-4" checked onchange="calculateCpScore()">
                                        <span>G1 (18)</span>
                                    </label>
                                    <label class="flex items-center gap-2 bg-gray-300 px-3 py-1.5 rounded cursor-pointer hover:bg-gray-400 text-sm">
                                        <input type="checkbox" id="cpGate2" class="w-4 h-4" checked onchange="calculateCpScore()">
                                        <span>G2 (5)</span>
                                    </label>
                                    <label class="flex items-center gap-2 bg-gray-300 px-3 py-1.5 rounded cursor-pointer hover:bg-gray-400 text-sm">
                                        <input type="checkbox" id="cpGate3" class="w-4 h-4" checked onchange="calculateCpScore()">
                                        <span>G3 (8)</span>
                                    </label>
                                    <label class="flex items-center gap-2 bg-gray-300 px-3 py-1.5 rounded cursor-pointer hover:bg-gray-400 text-sm">
                                        <input type="checkbox" id="cpGate4" class="w-4 h-4" checked onchange="calculateCpScore()">
                                        <span>G4 (16)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Landing Zone -->
                            <div class="mb-4">
                                <label class="block text-gray-600 text-sm mb-2">Landing Zone (click to select)</label>
                                <input type="hidden" id="cpLandingZone" value="">
                                <div class="flex flex-col gap-1">
                                    <button type="button" onclick="selectCpZone(3)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="3">Z1 (3 pts)</button>
                                    <button type="button" onclick="selectCpZone(11)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="11">Z2 (11 pts)</button>
                                    <button type="button" onclick="selectCpZone(19)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="19">Z3 (19 pts)</button>
                                    <button type="button" onclick="selectCpZone(27)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="27">Z4 (27 pts)</button>
                                    <button type="button" onclick="selectCpZone(34)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="34">Z5 (34 pts)</button>
                                    <button type="button" onclick="selectCpZone(41)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="41">Z6 (41 pts)</button>
                                    <button type="button" onclick="selectCpZone(46)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="46">Z7 (46 pts)</button>
                                    <button type="button" onclick="selectCpZone(48)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="48">Z8 (48 pts)</button>
                                    <button type="button" onclick="selectCpZone(50)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left font-bold" data-zone="50">Center (50 pts)</button>
                                    <button type="button" onclick="selectCpZone(25)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="25">Z9 (25 pts)</button>
                                    <button type="button" onclick="selectCpZone(5)" class="cp-zone-btn px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm text-left" data-zone="5">Z10 (5 pts)</button>
                                    <!-- Stand Up Landing -->
                                    <label class="flex items-center gap-3 bg-orange-100 px-4 py-2 rounded cursor-pointer hover:bg-orange-200 mt-2 border border-orange-300">
                                        <input type="checkbox" id="cpStandUp" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span class="text-gray-800">Stand Up Landing</span>
                                        <span class="text-orange-600 text-sm ml-auto">(-10 pts if unchecked)</span>
                                    </label>
                                    <!-- Zone Score Display and Save -->
                                    <div class="flex items-center justify-between mt-1 p-1 bg-white rounded border border-gray-200">
                                        <div>
                                            <span class="text-gray-600 text-sm">Total: </span>
                                            <span id="cpZoneTotal" class="text-2xl font-mono text-green-600 font-bold">Select zone</span>
                                            <span class="text-gray-600"> pts</span>
                                        </div>
                                        <button type="submit" class="px-6 py-2 rounded bg-green-600 hover:bg-green-700 text-white font-semibold">Save Score</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Distance Section (Rounds 4-6) -->
                        <div id="cpDistanceSection" class="hidden">
                            <h3 class="text-lg font-semibold text-green-400 mb-4">Distance Scoring</h3>

                            <!-- Gates for Distance -->
                            <div class="mb-4">
                                <label class="block text-gray-600 text-sm mb-2">Gates (uncheck if missed)</label>
                                <div class="flex flex-col gap-2">
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpDistEntry" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>Entry Gate</span>
                                    </label>
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpDistG4" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G4</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Distance Input -->
                            <div class="mb-4">
                                <label class="block text-gray-600 text-sm mb-2">Distance (meters)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="cpDistanceMeters" step="0.01" min="0" max="999.99"
                                        class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-2xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-green-500"
                                        placeholder="0.00" onchange="calculateCpScore()" oninput="calculateCpScore()">
                                    <span class="text-gray-600 text-lg">m</span>
                                </div>
                            </div>

                            <!-- Distance Score Display -->
                            <div class="bg-white rounded p-3 text-center mb-4">
                                <span class="text-gray-600 text-sm">Distance: </span>
                                <span id="cpDistanceDisplay" class="text-2xl font-mono text-green-400">0.00</span>
                                <span class="text-gray-600"> m</span>
                            </div>
                        </div>

                        <!-- CP Speed Section (Rounds 7-9) -->
                        <div id="cpSpeedSection" class="hidden">
                            <h3 class="text-lg font-semibold text-yellow-400 mb-4">Speed Scoring</h3>

                            <!-- Gates for Speed -->
                            <div class="mb-4">
                                <label class="block text-gray-600 text-sm mb-2">Gates (uncheck if missed)</label>
                                <div class="flex flex-col gap-2">
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpSpeedG1" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G1</span>
                                    </label>
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpSpeedG2" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G2</span>
                                    </label>
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpSpeedG3" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G3</span>
                                    </label>
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpSpeedG4" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G4</span>
                                    </label>
                                    <label class="flex items-center gap-3 bg-gray-300 px-4 py-2 rounded cursor-pointer hover:bg-gray-400">
                                        <input type="checkbox" id="cpSpeedG5" class="w-5 h-5" checked onchange="calculateCpScore()">
                                        <span>G5</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Time Input -->
                            <div class="mb-4">
                                <label class="block text-gray-600 text-sm mb-2">Time (seconds)</label>
                                <div class="flex items-center gap-2">
                                    <input type="number" id="cpSpeedTime" step="0.001" min="0" max="99.999"
                                        class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-2xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-yellow-500"
                                        placeholder="0.000" onchange="calculateCpScore()" oninput="calculateCpScore()">
                                    <span class="text-gray-600 text-lg">s</span>
                                </div>
                            </div>

                            <!-- Speed Score Display -->
                            <div class="bg-white rounded p-3 text-center mb-4">
                                <span class="text-gray-600 text-sm">Time: </span>
                                <span id="cpSpeedDisplay" class="text-2xl font-mono text-yellow-400">0.000</span>
                                <span class="text-gray-600"> s</span>
                            </div>
                        </div>

                        <!-- CP Penalties Section -->
                        <div class="pt-2 border-t border-gray-200 mt-2">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-gray-600 text-sm">Penalties / Special Results (optional)</label>
                                <button type="button" onclick="clearCpPenalty()" class="text-xs text-gray-500 hover:text-white px-2 py-1 rounded bg-gray-200 hover:bg-gray-300">Clear</button>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-1">
                                <label class="flex items-center gap-2 bg-gray-200/50 px-3 py-2 rounded cursor-pointer hover:bg-gray-200">
                                    <input type="radio" name="cpPenalty" value="WL" onchange="calculateCpScore()">
                                    <span class="text-sm">WL (Water Landing) 35</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-200/50 px-3 py-2 rounded cursor-pointer hover:bg-gray-200">
                                    <input type="radio" name="cpPenalty" value="OF" onchange="calculateCpScore()">
                                    <span class="text-sm">OF (Out Flying) DR</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-200/50 px-3 py-2 rounded cursor-pointer hover:bg-gray-200">
                                    <input type="radio" name="cpPenalty" value="OC" onchange="calculateCpScore()">
                                    <span class="text-sm">OC (Out Course) DR</span>
                                </label>
                                <label class="flex items-center gap-2 bg-gray-200/50 px-3 py-2 rounded cursor-pointer hover:bg-gray-200">
                                    <input type="radio" name="cpPenalty" value="CD" onchange="calculateCpScore()">
                                    <span class="text-sm">CD (Canopy Down) DR</span>
                                </label>
                                <label class="flex items-center gap-2 bg-red-900/50 px-3 py-2 rounded cursor-pointer hover:bg-red-900">
                                    <input type="radio" name="cpPenalty" value="ME" onchange="calculateCpScore()">
                                    <span class="text-sm">ME (Missed Entry) 0</span>
                                </label>
                                <label class="flex items-center gap-2 bg-red-900/50 px-3 py-2 rounded cursor-pointer hover:bg-red-900">
                                    <input type="radio" name="cpPenalty" value="DQ" onchange="calculateCpScore()">
                                    <span class="text-sm">DQ (Disqualified) 0</span>
                                </label>
                            </div>
                        </div>

                        <input type="hidden" id="cpScoreValue">
                        <input type="hidden" id="cpEventType" value="zone">
                        <input type="hidden" id="cpPenaltyValue">
                        <input type="hidden" id="cpStandUp" value="1">
                    </div>

                    <!-- CF Scoring Section (Canopy Formation events) -->
                    <div id="cfScoreSection" class="hidden bg-gray-50 rounded-lg p-4">
                        <!-- CF Event Type Selector -->
                        <div class="mb-4">
                            <label class="block text-gray-600 text-sm mb-2">CF Event Type</label>
                            <div class="grid grid-cols-2 gap-2">
                                <button type="button" onclick="setCfEventType('4way')" id="cfEvent4Way"
                                    class="px-3 py-2 rounded bg-blue-600 text-sm font-medium cf-event-btn">
                                    4-Way Sequential (-1 per omission)
                                </button>
                                <button type="button" onclick="setCfEventType('2way')" id="cfEvent2Way"
                                    class="px-3 py-2 rounded bg-gray-200 hover:bg-gray-300 text-sm font-medium cf-event-btn">
                                    2-Way Sequential (-2 per omission)
                                </button>
                            </div>
                        </div>

                        <div id="cfRulesText" class="text-sm text-gray-600 mb-4">
                            4-Way: 1 point per correct formation. Omissions = no point + 1 penalty.
                        </div>

                        <!-- Formations Completed -->
                        <div class="mb-4">
                            <label class="block text-gray-600 text-sm mb-2">Formations Completed</label>
                            <div class="flex items-center gap-4">
                                <input type="number" id="cfFormations" min="0" max="50" value="0"
                                    class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-3xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    onchange="calculateCfScore()" oninput="calculateCfScore()">
                                <div class="text-gray-500 text-sm">
                                    <div>Correct formations</div>
                                    <div class="text-xs">within working time</div>
                                </div>
                            </div>
                        </div>

                        <!-- Omissions -->
                        <div class="mb-4">
                            <label class="block text-gray-600 text-sm mb-2">Omissions</label>
                            <div class="flex items-center gap-4">
                                <input type="number" id="cfOmissions" min="0" max="20" value="0"
                                    class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-3xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-red-500"
                                    onchange="calculateCfScore()" oninput="calculateCfScore()">
                                <div class="text-gray-500 text-sm" id="cfOmissionHelp">
                                    <div>-1 point each</div>
                                    <div class="text-xs">(inter+2nd in block = 1)</div>
                                </div>
                            </div>
                        </div>

                        <!-- NV Penalty (Not Valid - score becomes 0) -->
                        <div class="mb-4">
                            <label class="flex items-center gap-3 bg-red-900/50 px-4 py-3 rounded cursor-pointer hover:bg-red-900">
                                <input type="checkbox" id="cfNvPenalty" class="w-5 h-5" onchange="calculateCfScore()">
                                <div>
                                    <span class="font-medium text-red-400">NV Penalty (Not Valid)</span>
                                    <div class="text-xs text-gray-600">Score becomes 0 for this round</div>
                                </div>
                            </label>
                        </div>

                        <!-- CF Score Calculation Display -->
                        <div class="bg-white rounded p-4 mt-4">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">Formations</div>
                                    <span id="cfFormationsDisplay" class="text-2xl font-mono text-green-400">0</span>
                                </div>
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">Omission Penalty</div>
                                    <span id="cfOmissionPenalty" class="text-2xl font-mono text-red-400">-0</span>
                                </div>
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">Final Score</div>
                                    <span id="cfFinalScore" class="text-2xl font-mono text-blue-400 font-bold">0</span>
                                </div>
                            </div>
                            <div id="cfScoreBreakdown" class="text-center text-gray-500 text-sm mt-2">
                                0 formations - 0 omission penalty = 0
                            </div>
                        </div>
                        <input type="hidden" id="cfScoreValue">
                        <input type="hidden" id="cfEventType" value="4way">
                    </div>

                    <!-- WS Performance Scoring Section -->
                    <div id="wsScoreSection" class="hidden bg-gray-50 rounded-lg p-4">
                        <h3 class="text-lg font-semibold text-purple-600 mb-4">WS Performance Scoring</h3>

                        <!-- Raw Performance Value -->
                        <div class="mb-4">
                            <label class="block text-gray-600 text-sm mb-2">Raw Performance Value</label>
                            <div class="flex items-center gap-4">
                                <input type="number" id="wsRawScore" step="0.01" min="0"
                                    class="flex-1 px-4 py-3 rounded bg-white text-gray-900 border border-gray-300 text-3xl font-mono text-center focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    placeholder="0.00" onchange="calculateWsScore()" oninput="calculateWsScore()">
                                <div class="text-gray-500 text-sm">
                                    <div id="wsScoreTypeLabel">Time (sec) / Distance (m)</div>
                                    <div class="text-xs">from FlySight data</div>
                                </div>
                            </div>
                        </div>

                        <!-- WS Score Calculation Display -->
                        <div class="bg-white rounded p-4 mt-4">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">Raw Value</div>
                                    <span id="wsRawDisplay" class="text-2xl font-mono text-purple-400">0.00</span>
                                </div>
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">DL Penalty</div>
                                    <span id="wsPenaltyDisplay" class="text-2xl font-mono text-green-400">0%</span>
                                </div>
                                <div>
                                    <div class="text-gray-600 text-xs mb-1">Final Score</div>
                                    <span id="wsFinalScore" class="text-2xl font-mono text-blue-500 font-bold">0.00</span>
                                </div>
                            </div>
                            <div id="wsScoreBreakdown" class="text-center text-gray-500 text-sm mt-2">
                                0.00 √ó 100% = 0.00
                            </div>
                        </div>
                        <input type="hidden" id="wsScoreValue">
                        <input type="hidden" id="wsDlPenaltyValue">
                    </div>
                    {% endif %}

                    <!-- Video Upload Section (for videographers - not for Speed Skydiving) -->
                    <div id="videoUploadSection" class="border-t border-gray-200 pt-4">
                        <label class="block text-gray-600 text-sm mb-2">Upload Video</label>

                        <!-- Video Already Exists Message -->
                        <div id="videoAlreadyExistsMsg" class="hidden p-3 bg-gray-200 rounded text-center text-sm text-gray-600">
                            Video already uploaded for this round.
                        </div>

                        <!-- Upload Controls (hidden when video exists) -->
                        <div id="videoUploadControls">
                            <!-- Step 1: File Selection -->
                            <div id="fileSelectControls">
                                <div class="grid grid-cols-2 gap-3">
                                    <!-- File Upload -->
                                    <div>
                                        <input type="file" id="roundVideoFile" accept="video/*" class="hidden" onchange="handleVideoSelect(event)">
                                        <button type="button" onclick="document.getElementById('roundVideoFile').click()"
                                            class="w-full px-4 py-3 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                                            <span class="block text-lg mb-1">üìÅ</span>
                                            Select File
                                        </button>
                                    </div>

                                    <!-- Camera/Device Capture -->
                                    <div>
                                        <input type="file" id="roundVideoCapture" accept="video/*" capture="environment" class="hidden" onchange="handleVideoSelect(event)">
                                        <button type="button" onclick="document.getElementById('roundVideoCapture').click()"
                                            class="w-full px-4 py-3 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                                            <span class="block text-lg mb-1">üìπ</span>
                                            From Camera
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Step 2: Set Start Point (shown after file selected) -->
                            <div id="startPointControls" class="hidden">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="selectedVideoName" class="text-sm text-gray-600"></span>
                                    <button type="button" onclick="clearSelectedVideo()" class="text-red-400 text-sm hover:underline">Change</button>
                                </div>

                                <!-- Video Preview -->
                                <div class="bg-black rounded overflow-hidden mb-3">
                                    <video id="uploadPreviewVideo" controls class="w-full" style="max-height: 200px;">
                                        Your browser does not support video playback.
                                    </video>
                                </div>

                                <!-- Start Point Controls -->
                                <div class="bg-gray-50 rounded p-3 mb-3">
                                    <p class="text-gray-600 text-xs mb-2">Scrub to the start of working time and click "Set Start Point"</p>
                                    <div class="flex items-center gap-2">
                                        <button type="button" onclick="setVideoStartPoint()"
                                            class="flex-1 px-3 py-2 rounded bg-blue-600 hover:bg-gray-300 text-sm font-medium">
                                            Set Start Point
                                        </button>
                                        <div class="text-center px-3">
                                            <div class="text-gray-500 text-xs">Start</div>
                                            <div class="font-mono text-sm" id="videoStartPointDisplay">
                                                <span class="text-yellow-400">Not set</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p id="startPointWarning" class="text-red-400 text-xs mt-2 hidden">Please set a start point before uploading</p>
                                </div>
                            </div>

                            <!-- Upload Progress -->
                            <div id="uploadProgress" class="hidden mt-3">
                                <div class="bg-gray-200 rounded-full h-2">
                                    <div id="uploadBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                                <p class="text-gray-600 text-sm mt-1" id="uploadStatus">Uploading...</p>
                            </div>
                        </div>
                    </div>

                    <!-- FlySight CSV Upload Section (for Speed Skydiving only) -->
                    <div id="flysightUploadSection" class="hidden border-t border-gray-200 pt-4">
                        <label class="block text-gray-600 text-sm mb-2">Upload FlySight CSV</label>
                        <p class="text-gray-500 text-xs mb-3">Upload the FlySight CSV file to automatically calculate speed.</p>

                        <div>
                            <input type="file" id="flysightFile" accept=".csv" class="hidden" onchange="handleFlysightSelect(event)">
                            <button type="button" onclick="document.getElementById('flysightFile').click()"
                                class="w-full px-4 py-3 rounded bg-gray-200 hover:bg-gray-300 text-sm">
                                <span class="block text-lg mb-1">üìä</span>
                                Select FlySight CSV
                            </button>
                        </div>

                        <!-- Selected CSV Display -->
                        <div id="selectedFlysightInfo" class="hidden mt-3 p-3 bg-gray-200 rounded">
                            <div class="flex items-center justify-between mb-2">
                                <span id="selectedFlysightName" class="text-sm"></span>
                                <button type="button" onclick="clearFlysightFile()" class="text-red-400 text-sm hover:underline">Remove</button>
                            </div>
                            <div id="flysightResult" class="hidden mt-2 p-3 bg-gray-50 rounded">
                                <div class="text-center">
                                    <span class="text-3xl font-mono text-green-400" id="flysightSpeed">--</span>
                                    <span class="text-gray-600 ml-1">km/h</span>
                                </div>
                                <p class="text-gray-500 text-xs text-center mt-1">Max vertical speed detected</p>
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div id="flysightProgress" class="hidden mt-3">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div id="flysightBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <p class="text-gray-600 text-sm mt-1" id="flysightStatus">Processing...</p>
                        </div>
                    </div>

                    <!-- WS Performance FlySight CSV Upload Section -->
                    <div id="wsFlysightUploadSection" class="hidden border-t border-gray-200 pt-4">
                        <!-- Ground Reference Point Section (TOP) -->
                        <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-200">
                            <div class="flex items-center justify-between mb-2">
                                <label class="text-gray-700 font-medium text-sm flex items-center gap-2">
                                    <span>üìç</span> Ground Reference Point
                                </label>
                                <button type="button" onclick="openWsReferencePointsModal()" class="text-blue-600 hover:text-blue-700 text-xs">
                                    Configure
                                </button>
                            </div>

                            <!-- Assigned Reference Point Display -->
                            <div id="wsAssignedRefPointDisplay" class="hidden">
                                <div class="flex items-center justify-between p-2 bg-green-50 rounded border border-green-200">
                                    <span id="wsAssignedRefPointText" class="text-green-700 text-sm font-medium">Point 1</span>
                                    <button type="button" onclick="showRefPointChangeDropdown()" class="text-blue-600 hover:text-blue-700 text-xs">Change</button>
                                </div>
                            </div>

                            <!-- Reference Point Selection (shown when not assigned or changing) -->
                            <div id="wsRefPointSelection">
                                <select id="wsQuickAssignSelect" class="w-full px-3 py-2 border border-gray-300 rounded bg-white text-sm">
                                    <option value="">-- Select Reference Point --</option>
                                </select>
                                <button type="button" onclick="quickAssignRefPoint()" id="wsQuickAssignBtn"
                                    class="mt-2 w-full px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium">
                                    Assign Reference Point
                                </button>
                            </div>

                            <!-- No Points Configured Message -->
                            <div id="wsNoPointsSection" class="hidden">
                                <p class="text-red-600 text-sm">No reference points configured.</p>
                                <button type="button" onclick="openWsReferencePointsModal()" class="mt-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm">
                                    Configure Flight Paths
                                </button>
                            </div>
                        </div>

                        <!-- Current Task/Round Display -->
                        <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span id="wsCurrentTaskIcon" class="text-2xl">‚è±Ô∏è</span>
                                    <div>
                                        <span id="wsCurrentTaskLabel" class="font-medium text-blue-700">Time</span>
                                        <span class="text-gray-500 mx-2">-</span>
                                        <span id="wsCurrentRoundLabel" class="font-medium text-green-700">Round 1</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- FlySight Upload Section -->
                        <div id="wsUploadContent">
                        <!-- FlySight Upload -->
                        <div class="mb-4">
                            <label class="block text-gray-600 text-sm mb-2">Upload FlySight CSV:</label>
                            <p class="text-gray-500 text-xs mb-2">Competition window: 3000m to 2000m altitude</p>
                            <input type="file" id="wsFlysightFile" accept=".csv" class="hidden" onchange="handleWsFlysightSelect(event)">
                            <button type="button" onclick="document.getElementById('wsFlysightFile').value=''; document.getElementById('wsFlysightFile').click()"
                                class="w-full px-4 py-3 rounded bg-blue-100 hover:bg-blue-200 text-sm border-2 border-dashed border-blue-400">
                                <span class="block text-lg mb-1">üìä</span>
                                Select FlySight CSV
                            </button>
                        </div>

                        <!-- Selected CSV Display -->
                        <div id="selectedWsFlysightInfo" class="hidden mt-3 p-3 bg-blue-50 rounded border border-blue-200">
                            <div class="flex items-center justify-between mb-2">
                                <span id="selectedWsFlysightName" class="text-sm font-medium text-blue-700"></span>
                                <button type="button" onclick="clearWsFlysightFile()" class="text-red-400 text-sm hover:underline">Remove</button>
                            </div>
                            <div id="wsFlysightResult" class="hidden mt-2">
                                <!-- Single Value Display (based on selected task) -->
                                <div class="text-center mb-3">
                                    <div id="wsTimeCard" class="bg-white rounded p-3 border-2 border-blue-500 inline-block min-w-32">
                                        <div class="text-xs text-gray-500">Time</div>
                                        <span class="text-3xl font-mono text-blue-600" id="wsFlysightTime">--</span>
                                        <span class="text-gray-500 text-sm">s</span>
                                    </div>
                                    <div id="wsDistanceCard" class="hidden bg-white rounded p-3 border-2 border-green-500 inline-block min-w-32">
                                        <div class="text-xs text-gray-500">Distance</div>
                                        <span class="text-3xl font-mono text-green-600" id="wsFlysightDistance">--</span>
                                        <span class="text-gray-500 text-sm">m</span>
                                    </div>
                                    <div id="wsSpeedCard" class="hidden bg-white rounded p-3 border-2 border-orange-500 inline-block min-w-32">
                                        <div class="text-xs text-gray-500">Speed</div>
                                        <span class="text-3xl font-mono text-orange-600" id="wsFlysightSpeed">--</span>
                                        <span class="text-gray-500 text-sm">km/h</span>
                                    </div>
                                </div>

                                <!-- Selected Value Highlight -->
                                <div class="bg-green-100 rounded p-3 border border-green-300 text-center">
                                    <p class="text-gray-600 text-sm">Saving <span id="wsSelectedTaskLabel" class="font-bold">Time</span> for <span id="wsSelectedRoundLabel" class="font-bold">Round 1</span>:</p>
                                    <p class="text-3xl font-mono font-bold text-green-700 mt-1" id="wsSelectedValue">--</p>
                                </div>

                                <!-- Save Button -->
                                <button type="button" onclick="saveWsFlysightScore()"
                                    class="w-full mt-3 px-4 py-3 rounded bg-green-600 hover:bg-green-700 text-white font-medium">
                                    Save Score
                                </button>

                                <!-- Flight Track Map -->
                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-gray-700 font-medium text-sm">Flight Track Visualization</label>
                                        <button type="button" onclick="toggleFlightTrackMap()" id="wsFlightTrackToggle" class="text-blue-600 hover:text-blue-700 text-xs">
                                            Show Map
                                        </button>
                                    </div>
                                    <div id="wsFlightTrackMapContainer" class="hidden">
                                        <div id="wsFlightTrackMap" style="height: 300px; border-radius: 8px; border: 2px solid #e5e7eb;"></div>
                                        <div class="flex flex-wrap gap-x-3 gap-y-1 mt-2 text-xs">
                                            <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-purple-600"></span> Flight Track</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500 border border-white"></span> Reference Point</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500 border border-white"></span> Start</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500 border border-white"></span> End</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 opacity-60"></span> Safe Lane</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 opacity-60"></span> 10%</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-500 opacity-60"></span> 20%</span>
                                            <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-600 opacity-60"></span> 50%</span>
                                        </div>
                                        <div id="wsFlightTrackInfo" class="mt-2 text-xs text-gray-600"></div>

                                        <!-- Designated Lane Violation (below map) -->
                                        <div class="mt-4 bg-orange-50 border border-orange-200 rounded p-3">
                                            <label class="block text-gray-700 font-semibold text-sm mb-2">Designated Lane (DL) Violation</label>
                                            <p class="text-xs text-gray-500 mb-3">Distance outside the 600m Designated Lane (auto-detected from flight track)</p>
                                            <div class="space-y-2">
                                                <label class="flex items-center gap-3 bg-white px-4 py-2 rounded cursor-pointer hover:bg-gray-50 border">
                                                    <input type="radio" name="wsDlViolation" value="none" checked onchange="calculateWsScore()">
                                                    <span class="text-sm text-gray-700">No violation (within DL)</span>
                                                    <span class="ml-auto text-green-600 font-medium">100%</span>
                                                </label>
                                                <label class="flex items-center gap-3 bg-white px-4 py-2 rounded cursor-pointer hover:bg-yellow-50 border border-yellow-200">
                                                    <input type="radio" name="wsDlViolation" value="under150" onchange="calculateWsScore()">
                                                    <span class="text-sm text-gray-700">&lt; 150m outside DL</span>
                                                    <span class="ml-auto text-yellow-600 font-medium">-10%</span>
                                                </label>
                                                <label class="flex items-center gap-3 bg-white px-4 py-2 rounded cursor-pointer hover:bg-orange-50 border border-orange-200">
                                                    <input type="radio" name="wsDlViolation" value="150to300" onchange="calculateWsScore()">
                                                    <span class="text-sm text-gray-700">150-300m outside DL</span>
                                                    <span class="ml-auto text-orange-600 font-medium">-20%</span>
                                                </label>
                                                <label class="flex items-center gap-3 bg-white px-4 py-2 rounded cursor-pointer hover:bg-red-50 border border-red-300">
                                                    <input type="radio" name="wsDlViolation" value="over300" onchange="calculateWsScore()">
                                                    <span class="text-sm text-gray-700">&gt; 300m outside DL</span>
                                                    <span class="ml-auto text-red-600 font-medium">-50%</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Upload Progress -->
                        <div id="wsFlysightProgress" class="hidden mt-3">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div id="wsFlysightBar" class="bg-blue-600 h-2 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <p class="text-gray-600 text-sm mt-1" id="wsFlysightStatus">Processing...</p>
                        </div>

                        <!-- Ground Reference Points Info -->
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="flex items-center justify-between">
                                <span class="text-gray-600 text-sm">Ground Reference Points:</span>
                                <button type="button" onclick="openWsReferencePointsModal()" class="text-blue-600 hover:text-blue-700 text-sm">
                                    Configure
                                </button>
                            </div>
                            <div id="wsRefPointsStatus" class="text-xs text-gray-500 mt-1">
                                Not configured - using default competition window
                            </div>
                        </div>
                        </div> <!-- End wsUploadContent -->
                    </div>
                </div>

                <div class="flex justify-between items-center mt-3 pt-2 border-t border-gray-200">
                    <div class="flex items-center gap-3">
                        {% if is_admin %}
                        <button type="button" onclick="awardRejump()" id="rejumpBtn" class="px-3 py-2 rounded bg-orange-600 hover:bg-orange-700 text-sm">
                            Award Rejump
                        </button>
                        <label class="flex items-center gap-2 px-3 py-2 rounded bg-purple-900/50 hover:bg-purple-900 cursor-pointer text-sm" id="trainingFlagLabel">
                            <input type="checkbox" id="trainingFlagCheckbox" onchange="toggleTrainingFlag()" class="rounded">
                            <span>üéì Flag for Training</span>
                        </label>
                        <label class="hidden items-center gap-2 px-3 py-2 rounded bg-red-900/50 hover:bg-red-900 cursor-pointer text-sm" id="cfPenaltyLabel">
                            <input type="checkbox" id="cfPenaltyCheckbox" class="rounded">
                            <span>‚è±Ô∏è Working Time Penalty (-20%)</span>
                        </label>
                        {% endif %}
                        <span id="modalStatusText" class="text-sm text-gray-500"></span>
                    </div>
                    <div class="flex gap-3">
                        {% if is_admin %}
                        <button type="button" onclick="deleteScore()" id="deleteScoreBtn" class="hidden px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white">Delete Score</button>
                        {% endif %}
                        <button type="button" onclick="hideRoundModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">Cancel</button>
                        <button type="button" onclick="uploadVideoOnly()" id="uploadOnlyBtn" class="hidden px-4 py-2 rounded bg-blue-600 hover:bg-gray-300">Upload Video Only</button>
                        {% if is_admin %}
                        <button type="submit" id="saveRoundBtn" class="px-4 py-2 rounded bg-green-600 hover:bg-gray-300">Save Score</button>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Training Videos Panel -->
    <div id="trainingPanel" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto py-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl mx-4 my-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span>üéì</span> Training Videos
                </h2>
                <button onclick="hideTrainingPanel()" class="text-gray-600 hover:text-white text-2xl">&times;</button>
            </div>

            <p class="text-gray-600 text-sm mb-4">Videos flagged for training material. Use the checkbox in the round modal to flag/unflag videos.</p>

            <!-- Export Buttons -->
            <div class="flex gap-3 mb-4">
                <a href="/competition/{{ competition.id }}/training-report" class="bg-blue-600 hover:bg-gray-300 px-4 py-2 rounded text-sm flex items-center gap-2">
                    <span>üìÑ</span> Download CSV Report
                </a>
                <a href="/competition/{{ competition.id }}/training-download" class="bg-green-600 hover:bg-gray-300 px-4 py-2 rounded text-sm flex items-center gap-2">
                    <span>üì¶</span> Download Videos (ZIP)
                </a>
                <button onclick="loadTrainingVideos()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded text-sm">
                    Refresh
                </button>
            </div>

            <!-- Training Videos List -->
            <div id="trainingVideosList" class="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                <p class="text-gray-500 text-center">Loading...</p>
            </div>

            <div class="mt-4 text-gray-600 text-sm">
                <span id="trainingCount">0</span> videos flagged for training
            </div>
        </div>
    </div>

    <!-- WS Performance Ground Reference Points Modal -->
    <div id="wsRefPointsModal" class="hidden fixed inset-0 bg-black/50 items-center justify-center z-50 overflow-y-auto py-2">
        <div class="bg-white rounded-lg p-6 w-full max-w-6xl mx-4 my-auto">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold">WS Performance - Flight Paths & Reference Points</h2>
                <button onclick="closeWsRefPointsModal()" class="text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
            </div>

            <div class="flex gap-4 mb-3">
                <div class="flex-1 bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                    <div class="font-semibold text-blue-800 mb-1">Competition Window Specifications:</div>
                    <ul class="text-blue-700 space-y-1">
                        <li><strong>Vertical Window:</strong> 1000m (2500m / 8202ft to 1500m / 4921ft geometric altitude)</li>
                        <li><strong>Designated Lane:</strong> 600m wide corridor centered on the Designated Flight Path</li>
                        <li><strong>Flight Path:</strong> Straight ground track from competition window start to designated ground reference point</li>
                    </ul>
                </div>
                <div class="w-72 bg-green-50 border border-green-200 rounded p-3">
                    <label class="block font-semibold text-green-800 mb-2">Field Elevation</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="wsFieldElevation" placeholder="0" step="1" min="0" max="5000"
                            class="w-24 px-3 py-2 border border-green-300 rounded text-sm text-center font-mono"
                            onchange="updateFieldElevation()">
                        <span class="text-green-700 text-sm">meters MSL</span>
                        <button onclick="lookupElevation()" id="wsElevationLookupBtn"
                            class="px-2 py-1 bg-green-600 hover:bg-green-700 text-white rounded text-xs whitespace-nowrap">
                            Auto
                        </button>
                    </div>
                    <p id="wsElevationStatus" class="text-green-600 text-xs mt-2">Set a reference point to auto-lookup elevation</p>
                    <div id="wsAglInfo" class="mt-2 text-xs text-green-700 hidden">
                        <div>Window start: <span id="wsWindowStartAgl" class="font-mono">--</span> AGL</div>
                        <div>Window end: <span id="wsWindowEndAgl" class="font-mono">--</span> AGL</div>
                    </div>
                </div>
            </div>
            <p class="text-gray-600 text-sm mb-3">
                Set up to 4 ground reference points. Each competitor must be assigned a specific reference point for their Designated Flight Path.
            </p>

            <!-- Location Search -->
            <div class="flex gap-4 mb-3">
                <div class="flex-1">
                    <div class="flex gap-2">
                        <input type="text" id="wsRefSearchInput" placeholder="Search location (e.g., Perris, CA or Dubai, UAE)"
                            class="flex-1 px-3 py-2 border rounded text-sm" onkeypress="if(event.key === 'Enter') searchWsRefLocation()">
                        <button onclick="searchWsRefLocation()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm whitespace-nowrap">
                            Search
                        </button>
                    </div>
                    <p id="wsRefSearchStatus" class="text-gray-500 text-xs mt-1"></p>
                </div>
                <!-- Manual coordinate entry - inline -->
                <div class="flex gap-2 items-start">
                    <input type="text" id="wsRefLatInput" placeholder="Latitude"
                        class="w-28 px-2 py-2 border rounded text-sm">
                    <input type="text" id="wsRefLngInput" placeholder="Longitude"
                        class="w-28 px-2 py-2 border rounded text-sm">
                    <input type="hidden" id="wsRefPointType" value="reference">
                    <button onclick="addWsRefPointManual()"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm whitespace-nowrap">
                        Add
                    </button>
                </div>
            </div>

            <!-- Map and Reference Points side by side -->
            <div class="flex gap-4">
                <!-- Map -->
                <div class="flex-1">
                    <div id="wsRefMap" style="height: 450px; border-radius: 8px; border: 2px solid #e5e7eb;"></div>
                    <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Reference Points</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-0.5 bg-black"></span> Flight Path</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-green-500 opacity-60"></span> Safe Lane</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-yellow-500 opacity-60"></span> 10% Penalty</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-orange-500 opacity-60"></span> 20% Penalty</span>
                        <span class="flex items-center gap-1"><span class="w-3 h-3 bg-red-600 opacity-60"></span> 50% Penalty</span>
                    </div>
                </div>

                <!-- Reference Points Panel -->
                <div class="w-80 flex flex-col">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-medium text-gray-700">Ground Reference Points</h3>
                        <span id="wsRefPointsConfigStatus" class="text-sm font-medium text-yellow-600">0/4</span>
                    </div>

                    <!-- 4 Reference Point Cards -->
                    <div class="grid grid-cols-1 gap-2 flex-1 overflow-y-auto" style="max-height: 280px;">
                        <div id="wsRefPoint1Card" class="bg-gray-100 rounded p-3 border-2 border-dashed border-gray-300">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-700">Point 1</span>
                                <button onclick="removeWsRefMarker(0)" class="text-red-500 hover:text-red-700 text-xs hidden" id="wsRefPoint1Remove">Remove</button>
                            </div>
                            <div id="wsRefPoint1Coords" class="text-sm text-gray-500 mt-1">Click map to set</div>
                        </div>
                        <div id="wsRefPoint2Card" class="bg-gray-100 rounded p-3 border-2 border-dashed border-gray-300">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-700">Point 2</span>
                                <button onclick="removeWsRefMarker(1)" class="text-red-500 hover:text-red-700 text-xs hidden" id="wsRefPoint2Remove">Remove</button>
                            </div>
                            <div id="wsRefPoint2Coords" class="text-sm text-gray-500 mt-1">Click map to set</div>
                        </div>
                        <div id="wsRefPoint3Card" class="bg-gray-100 rounded p-3 border-2 border-dashed border-gray-300">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-700">Point 3</span>
                                <button onclick="removeWsRefMarker(2)" class="text-red-500 hover:text-red-700 text-xs hidden" id="wsRefPoint3Remove">Remove</button>
                            </div>
                            <div id="wsRefPoint3Coords" class="text-sm text-gray-500 mt-1">Click map to set</div>
                        </div>
                        <div id="wsRefPoint4Card" class="bg-gray-100 rounded p-3 border-2 border-dashed border-gray-300">
                            <div class="flex items-center justify-between">
                                <span class="font-medium text-gray-700">Point 4</span>
                                <button onclick="removeWsRefMarker(3)" class="text-red-500 hover:text-red-700 text-xs hidden" id="wsRefPoint4Remove">Remove</button>
                            </div>
                            <div id="wsRefPoint4Coords" class="text-sm text-gray-500 mt-1">Click map to set</div>
                        </div>
                    </div>

                    <!-- Competitor Assignment Section -->
                    <div class="mt-3 pt-3 border-t border-gray-200">
                        <h4 class="font-medium text-gray-700 mb-2">Assign Reference Points to Competitors</h4>
                        <div id="wsCompetitorAssignments" class="text-sm text-gray-500 max-h-32 overflow-y-auto">
                            Save reference points first to assign to competitors
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 mt-4 pt-4 border-t border-gray-200">
                <button onclick="closeWsRefPointsModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">
                    Cancel
                </button>
                <button onclick="saveWsReferencePoints()" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">
                    Save Configuration
                </button>
            </div>
        </div>
    </div>

    <!-- Chief Judge Score Approval Modal -->
    <div id="chiefJudgeApprovalModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg mx-4">
            <h3 class="text-xl font-bold mb-4">Chief Judge Score Approval</h3>

            <div class="mb-4">
                <p class="text-gray-600 mb-3">Enter your PIN to approve scores for each round. Once approved, scores become official.</p>

                <label class="block text-sm font-medium text-gray-700 mb-1">Chief Judge PIN</label>
                <input type="password" id="approvalPinInput" class="w-full border rounded px-3 py-2" placeholder="Enter PIN">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Event</label>
                <select id="approvalEventSelect" class="w-full border rounded px-3 py-2" onchange="updateApprovalRounds()">
                </select>
            </div>

            <div id="approvalRoundsContainer" class="mb-4 max-h-64 overflow-y-auto">
                <!-- Rounds will be populated dynamically -->
            </div>

            <div class="flex justify-between gap-3">
                <button onclick="approveAllRounds()" class="px-4 py-2 rounded bg-green-600 hover:bg-green-700 text-white">
                    Approve All Rounds
                </button>
                <button onclick="closeChiefJudgeApprovalModal()" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Leaflet CSS and JS for WS Reference Points Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const compId = '{{ competition.id }}';
        const isMultiEvent = {{ 'true' if is_multi_event else 'false' }};
        const isPublicView = {{ 'true' if is_public_view else 'false' }};
        const scoreApprovals = {{ score_approvals|default({})|tojson|safe }};
        const eventTypes = {{ event_types|tojson|safe }};
        const EVENT_DISPLAY_NAMES = {{ EVENT_DISPLAY_NAMES|tojson|safe }};
        let selectedVideoFile = null;
        let currentClass = 'all';
        let currentEvent = eventTypes.length > 0 ? eventTypes[0] : '';

        // Audio feedback for score saves
        function playDingSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 880; // A5 note
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not available:', e);
            }
        }

        // Country code to flag emoji conversion
        const COUNTRY_TO_ISO = {
            'USA': 'US', 'US': 'US', 'UNITED STATES': 'US', 'AMERICA': 'US',
            'GBR': 'GB', 'GB': 'GB', 'UK': 'GB', 'UNITED KINGDOM': 'GB', 'ENGLAND': 'GB', 'BRITAIN': 'GB',
            'ESP': 'ES', 'ES': 'ES', 'SPAIN': 'ES',
            'GER': 'DE', 'DE': 'DE', 'GERMANY': 'DE', 'DEUTSCHLAND': 'DE',
            'FRA': 'FR', 'FR': 'FR', 'FRANCE': 'FR',
            'ITA': 'IT', 'IT': 'IT', 'ITALY': 'IT', 'ITALIA': 'IT',
            'JPN': 'JP', 'JP': 'JP', 'JAPAN': 'JP',
            'CHN': 'CN', 'CN': 'CN', 'CHINA': 'CN',
            'AUS': 'AU', 'AU': 'AU', 'AUSTRALIA': 'AU',
            'CAN': 'CA', 'CA': 'CA', 'CANADA': 'CA',
            'BRA': 'BR', 'BR': 'BR', 'BRAZIL': 'BR', 'BRASIL': 'BR',
            'MEX': 'MX', 'MX': 'MX', 'MEXICO': 'MX',
            'NED': 'NL', 'NL': 'NL', 'NETHERLANDS': 'NL', 'HOLLAND': 'NL',
            'BEL': 'BE', 'BE': 'BE', 'BELGIUM': 'BE',
            'SWE': 'SE', 'SE': 'SE', 'SWEDEN': 'SE',
            'NOR': 'NO', 'NO': 'NO', 'NORWAY': 'NO',
            'DEN': 'DK', 'DK': 'DK', 'DENMARK': 'DK',
            'FIN': 'FI', 'FI': 'FI', 'FINLAND': 'FI',
            'POL': 'PL', 'PL': 'PL', 'POLAND': 'PL', 'POLSKA': 'PL',
            'RUS': 'RU', 'RU': 'RU', 'RUSSIA': 'RU',
            'UKR': 'UA', 'UA': 'UA', 'UKRAINE': 'UA',
            'AUT': 'AT', 'AT': 'AT', 'AUSTRIA': 'AT',
            'SUI': 'CH', 'CH': 'CH', 'SWITZERLAND': 'CH', 'SWISS': 'CH',
            'NZL': 'NZ', 'NZ': 'NZ', 'NEW ZEALAND': 'NZ',
            'RSA': 'ZA', 'ZA': 'ZA', 'SOUTH AFRICA': 'ZA',
            'ARG': 'AR', 'AR': 'AR', 'ARGENTINA': 'AR',
            'COL': 'CO', 'CO': 'CO', 'COLOMBIA': 'CO',
            'CZE': 'CZ', 'CZ': 'CZ', 'CZECH': 'CZ', 'CZECH REPUBLIC': 'CZ', 'CZECHIA': 'CZ',
            'POR': 'PT', 'PT': 'PT', 'PORTUGAL': 'PT',
            'IRL': 'IE', 'IE': 'IE', 'IRELAND': 'IE',
            'IND': 'IN', 'IN': 'IN', 'INDIA': 'IN',
            'KOR': 'KR', 'KR': 'KR', 'KOREA': 'KR', 'SOUTH KOREA': 'KR',
            'SGP': 'SG', 'SG': 'SG', 'SINGAPORE': 'SG',
            'HUN': 'HU', 'HU': 'HU', 'HUNGARY': 'HU',
            'GRE': 'GR', 'GR': 'GR', 'GREECE': 'GR',
            'ISR': 'IL', 'IL': 'IL', 'ISRAEL': 'IL',
            'UAE': 'AE', 'AE': 'AE', 'EMIRATES': 'AE', 'DUBAI': 'AE',
            'THA': 'TH', 'TH': 'TH', 'THAILAND': 'TH',
            'PHL': 'PH', 'PH': 'PH', 'PHILIPPINES': 'PH',
            'MYS': 'MY', 'MY': 'MY', 'MALAYSIA': 'MY',
            'IDN': 'ID', 'ID': 'ID', 'INDONESIA': 'ID',
            'VNM': 'VN', 'VN': 'VN', 'VIETNAM': 'VN',
            'TWN': 'TW', 'TW': 'TW', 'TAIWAN': 'TW',
            'HKG': 'HK', 'HK': 'HK', 'HONG KONG': 'HK',
            'CHL': 'CL', 'CL': 'CL', 'CHILE': 'CL',
            'PER': 'PE', 'PE': 'PE', 'PERU': 'PE',
            'VEN': 'VE', 'VE': 'VE', 'VENEZUELA': 'VE',
            'ECU': 'EC', 'EC': 'EC', 'ECUADOR': 'EC',
            'CRI': 'CR', 'CR': 'CR', 'COSTA RICA': 'CR',
            'PAN': 'PA', 'PA': 'PA', 'PANAMA': 'PA',
            'DOM': 'DO', 'DO': 'DO', 'DOMINICAN REPUBLIC': 'DO',
            'JAM': 'JM', 'JM': 'JM', 'JAMAICA': 'JM',
            'TTO': 'TT', 'TT': 'TT', 'TRINIDAD': 'TT', 'TRINIDAD AND TOBAGO': 'TT'
        };

        function countryToFlag(country) {
            if (!country) return '';
            const code = COUNTRY_TO_ISO[country.toUpperCase().trim()];
            if (!code) {
                // Try to use first 2 chars as ISO code
                const tryCode = country.toUpperCase().trim().slice(0, 2);
                if (tryCode.length === 2 && /^[A-Z]{2}$/.test(tryCode)) {
                    return String.fromCodePoint(...[...tryCode].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
                }
                return '';
            }
            return String.fromCodePoint(...[...code].map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
        }

        function countryWithFlag(country) {
            if (!country) return '';
            const flag = countryToFlag(country);
            return flag ? `${flag} ${country}` : country;
        }

        // CP Scoring - ordered team list for auto-navigation
        let cpTeamList = [];
        let currentCpTeamIndex = -1;

        function buildCpTeamList() {
            // Build ordered list of teams from the table for CP auto-navigation
            cpTeamList = [];
            const rows = document.querySelectorAll('table tbody tr[data-team-id]');
            rows.forEach(row => {
                const teamId = row.dataset.teamId;
                const teamName = row.dataset.teamName;
                if (teamId && teamName) {
                    cpTeamList.push({ id: teamId, name: teamName });
                }
            });
            // Also check for teams in event sections (multi-event)
            if (cpTeamList.length === 0) {
                document.querySelectorAll('[data-team-id]').forEach(el => {
                    const teamId = el.dataset.teamId;
                    const teamName = el.dataset.teamName;
                    if (teamId && teamName && !cpTeamList.find(t => t.id === teamId)) {
                        cpTeamList.push({ id: teamId, name: teamName });
                    }
                });
            }
        }

        function getNextCpTeam(currentTeamId, currentRound) {
            // Find index of current team
            const currentIndex = cpTeamList.findIndex(t => t.id === currentTeamId);
            if (currentIndex === -1 || currentIndex >= cpTeamList.length - 1) {
                return null; // No next team
            }
            return { ...cpTeamList[currentIndex + 1], round: currentRound };
        }

        function openNextCpCompetitor(currentTeamId, currentRound) {
            const next = getNextCpTeam(currentTeamId, currentRound);
            if (next) {
                // Open scoring modal for next competitor
                openRoundModal(next.id, next.name, currentRound, null, '', currentTeamCategory, null, 0);
                return true;
            }
            return false;
        }

        // Helper function to preserve current event/class when reloading
        function preserveEventAndReload() {
            // Store current state in sessionStorage
            sessionStorage.setItem('competition_currentEvent', currentEvent);
            sessionStorage.setItem('competition_currentClass', currentClass);
            const classSelector = document.getElementById('multiEventClassSelector');
            if (classSelector) {
                sessionStorage.setItem('competition_multiEventClass', classSelector.value);
            }
            location.reload();
        }

        // Restore event/class state on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Convert country codes to flags
            document.querySelectorAll('.country-flag').forEach(el => {
                const country = el.dataset.country;
                if (country) {
                    const flag = countryToFlag(country);
                    el.textContent = flag ? `${flag} ${country}` : country;
                }
            });

            // Build CP team list for auto-navigation
            buildCpTeamList();

            const savedEvent = sessionStorage.getItem('competition_currentEvent');
            const savedClass = sessionStorage.getItem('competition_currentClass');
            const savedMultiClass = sessionStorage.getItem('competition_multiEventClass');

            // Clear stored values after use
            sessionStorage.removeItem('competition_currentEvent');
            sessionStorage.removeItem('competition_currentClass');
            sessionStorage.removeItem('competition_multiEventClass');

            // Check URL hash for event navigation
            const hash = window.location.hash.slice(1); // Remove the # symbol
            if (hash && eventTypes.includes(hash)) {
                setTimeout(() => {
                    showEvent(hash, false); // Don't update hash since it's already there
                    // Scroll to the event section
                    const eventSection = document.getElementById('event-' + hash);
                    if (eventSection) {
                        eventSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100);
            }
            // Restore state if saved (from reload)
            else if (savedEvent && eventTypes.includes(savedEvent)) {
                setTimeout(() => {
                    showEvent(savedEvent);
                    if (savedMultiClass) {
                        filterMultiEventClass(savedMultiClass);
                    } else if (savedClass) {
                        showClass(savedClass);
                    }
                }, 100);
            }
        });

        // Handle browser back/forward navigation with hash changes
        window.addEventListener('hashchange', function() {
            const hash = window.location.hash.slice(1);
            if (hash && eventTypes.includes(hash)) {
                showEvent(hash, false);
            }
        });

        function showEvent(eventType, updateHash = true) {
            currentEvent = eventType;
            // Update dropdown selection
            const eventSelector = document.getElementById('eventSelector');
            if (eventSelector) {
                eventSelector.value = eventType;
            }

            // Update URL hash
            if (updateHash && eventType) {
                history.replaceState(null, null, '#' + eventType);
            }

            // Show/hide event sections
            document.querySelectorAll('.event-section').forEach(section => {
                if (section.dataset.event === eventType) {
                    section.classList.remove('hidden');
                } else {
                    section.classList.add('hidden');
                }
            });

            // Reapply class filter for multi-event
            if (isMultiEvent) {
                const classSelector = document.getElementById('multiEventClassSelector');
                if (classSelector) {
                    filterMultiEventClass(classSelector.value || 'open');
                }
            } else {
                showClass(currentClass);
            }
        }

        function filterMultiEventClass(className) {
            // Update dropdown
            const selector = document.getElementById('multiEventClassSelector');
            if (selector) {
                selector.value = className;
            }

            // Show/hide class sections within visible events
            document.querySelectorAll('.event-section').forEach(eventSection => {
                if (eventSection.classList.contains('hidden')) return;

                eventSection.querySelectorAll('.class-section').forEach(section => {
                    const sectionClass = section.dataset.class;
                    if (sectionClass === className) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
            });
        }

        function showClass(className) {
            currentClass = className;

            // Show/hide class sections
            document.querySelectorAll('.class-section').forEach(section => {
                const sectionClass = section.dataset.class || section.id.replace('class-', '');

                if (className === 'all') {
                    // Show all classes in currently visible events
                    if (isMultiEvent) {
                        const parentEvent = section.closest('.event-section');
                        if (parentEvent && !parentEvent.classList.contains('hidden')) {
                            section.classList.remove('hidden');
                        }
                    } else {
                        section.classList.remove('hidden');
                    }
                } else {
                    if (sectionClass === className) {
                        // Show only if parent event is visible (for multi-event)
                        if (isMultiEvent) {
                            const parentEvent = section.closest('.event-section');
                            if (parentEvent && !parentEvent.classList.contains('hidden')) {
                                section.classList.remove('hidden');
                            }
                        } else {
                            section.classList.remove('hidden');
                        }
                    } else {
                        section.classList.add('hidden');
                    }
                }
            });
        }

        function showAddTeamModal() {
            document.getElementById('addTeamModal').classList.remove('hidden');

            // Auto-generate next available number
            const nextNumber = getNextTeamNumber();
            document.getElementById('teamNumber').value = nextNumber;

            // Clear other fields
            document.getElementById('teamName').value = '';
            document.getElementById('teamMembers').value = '';
            const eventNameField = document.getElementById('teamEventName');
            if (eventNameField) eventNameField.value = '';
        }

        function getNextTeamNumber() {
            // Get all existing team numbers from the page
            const existingNumbers = [];

            // Look for team numbers in the table rows
            document.querySelectorAll('table tbody tr td:nth-child(3)').forEach(td => {
                const num = parseInt(td.textContent.trim());
                if (!isNaN(num)) {
                    existingNumbers.push(num);
                }
            });

            if (existingNumbers.length === 0) {
                return '1';
            }

            // Find the highest number and add 1
            const maxNumber = Math.max(...existingNumbers);
            return String(maxNumber + 1);
        }

        function hideAddTeamModal() {
            document.getElementById('addTeamModal').classList.add('hidden');
            // Reset photo state
            selectedAddTeamPhotoFile = null;
            document.getElementById('addTeamPhoto').value = '';
            document.getElementById('addTeamPhotoPreview').innerHTML = '<span class="text-gray-500 text-xs">No photo</span>';
            // Hide search results
            const resultsEl = document.getElementById('competitorSearchResults');
            if (resultsEl) resultsEl.classList.add('hidden');
        }

        // Competitor search functionality
        let allCompetitors = [];
        let competitorSearchTimeout = null;

        async function loadCompetitorsForSearch() {
            try {
                const response = await fetch('/admin/competition/{{ competition.id }}/teams');
                const data = await response.json();
                if (data.success) {
                    allCompetitors = data.teams || [];
                }
            } catch (err) {
                console.error('Error loading competitors:', err);
            }
        }

        function searchCompetitors(query) {
            const resultsEl = document.getElementById('competitorSearchResults');
            if (!resultsEl) return;

            // Load competitors on first search
            if (allCompetitors.length === 0) {
                loadCompetitorsForSearch().then(() => searchCompetitors(query));
                return;
            }

            // Clear previous timeout
            if (competitorSearchTimeout) clearTimeout(competitorSearchTimeout);

            // Debounce search - start immediately on first character
            competitorSearchTimeout = setTimeout(() => {
                if (!query) {
                    resultsEl.classList.add('hidden');
                    return;
                }

                const searchLower = query.toLowerCase().trim();
                if (searchLower.length === 0) {
                    // Show all competitors if field is focused but empty
                    resultsEl.innerHTML = allCompetitors.slice(0, 10).map(c => {
                        const safeName = (c.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const safeMembers = (c.members || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                        const flag = countryToFlag(c.members);
                        return `
                        <div class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0"
                             onclick="selectCompetitor('${safeName}', '${c.team_number || ''}', '${safeMembers}')">
                            <div class="font-medium text-gray-800">${c.name || 'Unknown'}</div>
                            <div class="text-xs text-gray-500">${flag ? flag + ' ' : ''}#${c.team_number || '?'}${c.members ? ' ' + c.members : ''}</div>
                        </div>`;
                    }).join('');
                    if (allCompetitors.length > 0) {
                        resultsEl.classList.remove('hidden');
                    }
                    return;
                }

                const matches = allCompetitors.filter(c =>
                    (c.name && c.name.toLowerCase().includes(searchLower)) ||
                    (c.team_number && c.team_number.toString().includes(searchLower))
                ).slice(0, 10);

                if (matches.length === 0) {
                    resultsEl.innerHTML = '<div class="p-3 text-gray-500 text-sm">No matching competitors found</div>';
                    resultsEl.classList.remove('hidden');
                    return;
                }

                resultsEl.innerHTML = matches.map(c => {
                    const safeName = (c.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const safeMembers = (c.members || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const flag = countryToFlag(c.members);
                    return `
                    <div class="p-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-0"
                         onclick="selectCompetitor('${safeName}', '${c.team_number || ''}', '${safeMembers}')">
                        <div class="font-medium text-gray-800">${c.name || 'Unknown'}</div>
                        <div class="text-xs text-gray-500">${flag ? flag + ' ' : ''}#${c.team_number || '?'}${c.members ? ' ' + c.members : ''}</div>
                    </div>`;
                }).join('');
                resultsEl.classList.remove('hidden');
            }, 150);
        }

        function selectCompetitor(name, number, country) {
            document.getElementById('teamName').value = name;
            if (number) document.getElementById('teamNumber').value = number;
            if (country) document.getElementById('teamMembers').value = country;
            document.getElementById('competitorSearchResults').classList.add('hidden');
        }

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            const resultsEl = document.getElementById('competitorSearchResults');
            const nameInput = document.getElementById('teamName');
            if (resultsEl && nameInput && !nameInput.contains(e.target) && !resultsEl.contains(e.target)) {
                resultsEl.classList.add('hidden');
            }
        });

        let bulkEditTeams = [];

        function showBulkEditModal() {
            // Fetch competitors and filter by current event
            fetch('/admin/competition/{{ competition.id }}/teams')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Filter by current event (for multi-event competitions)
                        let filteredTeams = data.teams;
                        if (currentEvent && currentEvent !== 'all') {
                            filteredTeams = data.teams.filter(team => team.event === currentEvent);
                        }
                        // Sort by display_order, then by team_number
                        bulkEditTeams = filteredTeams.sort((a, b) => {
                            const orderA = a.display_order || 0;
                            const orderB = b.display_order || 0;
                            if (orderA !== orderB) return orderA - orderB;
                            return (a.team_number || '').localeCompare(b.team_number || '');
                        });
                        renderBulkEditTable();

                        // Update modal title to show current event
                        const modalTitle = document.querySelector('#bulkEditModal h2');
                        if (modalTitle && currentEvent) {
                            const eventName = EVENT_DISPLAY_NAMES[currentEvent] || currentEvent;
                            modalTitle.textContent = `Bulk Edit - ${eventName}`;
                        }
                    }
                })
                .catch(err => console.error('Error loading teams:', err));

            document.getElementById('bulkEditModal').classList.remove('hidden');
        }

        function renderBulkEditTable() {
            const tbody = document.getElementById('bulkEditTableBody');
            tbody.innerHTML = '';
            bulkEditTeams.forEach((team, index) => {
                const hasScores = team.has_scores || false;
                const row = document.createElement('tr');
                row.className = 'border-t border-gray-200';
                row.dataset.teamId = team.id;
                row.innerHTML = `
                    <td class="px-2 py-2 text-center">
                        <div class="flex justify-center items-center gap-1">
                            <input type="number" min="1" value="${index + 1}"
                                onchange="moveTeamToPosition(${index}, this.value)"
                                class="w-12 px-1 py-1 text-center border border-gray-300 rounded text-sm">
                            <div class="flex flex-col">
                                <button onclick="moveTeamUp(${index})" class="px-1 py-0.5 rounded bg-gray-200 hover:bg-gray-300 text-xs ${index === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                                <button onclick="moveTeamDown(${index})" class="px-1 py-0.5 rounded bg-gray-200 hover:bg-gray-300 text-xs ${index === bulkEditTeams.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${index === bulkEditTeams.length - 1 ? 'disabled' : ''}>‚ñº</button>
                            </div>
                        </div>
                    </td>
                    <td class="px-2 py-2 text-center">${team.members ? countryToFlag(team.members) : ''}</td>
                    <td class="px-2 py-2">${team.team_number || ''}</td>
                    <td class="px-3 py-2 font-medium">${team.team_name || ''}</td>
                    <td class="px-3 py-2">${team.members || ''}</td>
                    <td class="px-3 py-2">${team.class || ''}</td>
                    <td class="px-3 py-2 text-center">
                        <button onclick="openEditTeamModal('${team.id}', '${team.team_number || ''}', '${team.team_name || ''}', '${team.class || ''}', '${(team.members || '').replace(/'/g, "\\'")}', '${team.category || ''}', '${team.event || ''}', '${team.photo || ''}')" class="text-blue-600 hover:text-blue-800 text-sm mr-2">Edit</button>
                        ${!hasScores ? `<button onclick="deleteTeam('${team.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function moveTeamToPosition(currentIndex, newPosition) {
            const targetIndex = parseInt(newPosition) - 1;
            if (isNaN(targetIndex) || targetIndex < 0 || targetIndex >= bulkEditTeams.length || targetIndex === currentIndex) {
                renderBulkEditTable(); // Re-render to reset invalid input
                return;
            }

            // Remove team from current position
            const [team] = bulkEditTeams.splice(currentIndex, 1);
            // Insert at new position
            bulkEditTeams.splice(targetIndex, 0, team);
            renderBulkEditTable();
        }

        function moveTeamUp(index) {
            if (index <= 0) return;
            const temp = bulkEditTeams[index];
            bulkEditTeams[index] = bulkEditTeams[index - 1];
            bulkEditTeams[index - 1] = temp;
            renderBulkEditTable();
        }

        function moveTeamDown(index) {
            if (index >= bulkEditTeams.length - 1) return;
            const temp = bulkEditTeams[index];
            bulkEditTeams[index] = bulkEditTeams[index + 1];
            bulkEditTeams[index + 1] = temp;
            renderBulkEditTable();
        }

        async function saveTeamOrder() {
            const orders = bulkEditTeams.map((team, index) => ({
                team_id: team.id,
                display_order: index + 1
            }));

            try {
                const response = await fetch('/admin/competition/{{ competition.id }}/update-team-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orders })
                });
                const result = await response.json();
                if (result.success) {
                    alert('Order saved successfully');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save order'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error saving order');
            }
        }

        function hideBulkEditModal() {
            document.getElementById('bulkEditModal').classList.add('hidden');
        }

        // Signature canvas variables
        let signatureCanvas = null;
        let signatureCtx = null;
        let typedSignatureCanvas = null;
        let typedSignatureCtx = null;
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let currentSignerUsername = '';
        let currentSignerName = '';
        let currentSignatureTab = 'draw';

        async function showChiefJudgeModal() {
            document.getElementById('chiefJudgeModal').classList.remove('hidden');

            // Fetch available signers
            try {
                const response = await fetch('/api/signers');
                const result = await response.json();
                const select = document.getElementById('chiefJudgeSelect');
                const noSignersMsg = document.getElementById('noSignersMessage');

                // Clear existing options except the first
                select.innerHTML = '<option value="">-- Select a Chief Judge --</option>';

                if (result.success && result.signers.length > 0) {
                    noSignersMsg.classList.add('hidden');
                    result.signers.forEach(signer => {
                        const option = document.createElement('option');
                        option.value = signer.username;
                        option.dataset.hasSignature = signer.has_signature ? 'true' : 'false';
                        option.textContent = `${signer.name} (${signer.role === 'admin' ? 'Admin' : 'Chief Judge'})${signer.has_signature ? ' ‚úì' : ''}`;
                        if (signer.username === '{{ competition.chief_judge or "" }}') {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });

                    // Add change handler to show/hide signature preview
                    select.onchange = loadSelectedSignature;

                    // Load signature for currently selected
                    loadSelectedSignature();
                } else {
                    noSignersMsg.classList.remove('hidden');
                    document.getElementById('signaturePreviewContainer').classList.add('hidden');
                    document.getElementById('noSignatureContainer').classList.add('hidden');
                }
            } catch (err) {
                console.error('Error loading signers:', err);
            }
        }

        async function loadSelectedSignature() {
            const select = document.getElementById('chiefJudgeSelect');
            const username = select.value;
            const previewContainer = document.getElementById('signaturePreviewContainer');
            const noSigContainer = document.getElementById('noSignatureContainer');

            if (!username) {
                previewContainer.classList.add('hidden');
                noSigContainer.classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/signature/${username}`);
                const result = await response.json();

                if (result.success && result.has_signature) {
                    document.getElementById('signaturePreview').src = result.signature_data;
                    previewContainer.classList.remove('hidden');
                    noSigContainer.classList.add('hidden');
                } else {
                    previewContainer.classList.add('hidden');
                    noSigContainer.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Error loading signature:', err);
                previewContainer.classList.add('hidden');
                noSigContainer.classList.add('hidden');
            }
        }

        function openSignatureCreator() {
            const select = document.getElementById('chiefJudgeSelect');
            currentSignerUsername = select.value;

            if (!currentSignerUsername) {
                alert('Please select a Chief Judge first');
                return;
            }

            // Get the signer's display name from the selected option
            const selectedOption = select.options[select.selectedIndex];
            currentSignerName = selectedOption.textContent.split(' (')[0];  // Extract name before role

            document.getElementById('signatureModal').classList.remove('hidden');

            // Reset to draw tab
            switchSignatureTab('draw');
            initSignatureCanvas();

            // Pre-fill name input for typed signature
            document.getElementById('signatureNameInput').value = currentSignerName;
            initTypedSignatureCanvas();
            updateTypedSignaturePreview();
        }

        function closeSignatureModal() {
            document.getElementById('signatureModal').classList.add('hidden');
        }

        function switchSignatureTab(tab) {
            currentSignatureTab = tab;

            const tabDraw = document.getElementById('tabDraw');
            const tabType = document.getElementById('tabType');
            const drawPanel = document.getElementById('drawPanel');
            const typePanel = document.getElementById('typePanel');

            if (tab === 'draw') {
                tabDraw.classList.add('border-blue-600', 'text-blue-600');
                tabDraw.classList.remove('border-transparent', 'text-gray-500');
                tabType.classList.remove('border-blue-600', 'text-blue-600');
                tabType.classList.add('border-transparent', 'text-gray-500');
                drawPanel.classList.remove('hidden');
                typePanel.classList.add('hidden');
            } else {
                tabType.classList.add('border-blue-600', 'text-blue-600');
                tabType.classList.remove('border-transparent', 'text-gray-500');
                tabDraw.classList.remove('border-blue-600', 'text-blue-600');
                tabDraw.classList.add('border-transparent', 'text-gray-500');
                typePanel.classList.remove('hidden');
                drawPanel.classList.add('hidden');
                updateTypedSignaturePreview();
            }
        }

        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');

            // Clear canvas
            clearSignatureCanvas();

            // Set drawing style
            signatureCtx.strokeStyle = '#1a365d';  // Dark blue
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Remove old listeners to prevent duplicates
            signatureCanvas.removeEventListener('mousedown', startDrawing);
            signatureCanvas.removeEventListener('mousemove', draw);
            signatureCanvas.removeEventListener('mouseup', stopDrawing);
            signatureCanvas.removeEventListener('mouseout', stopDrawing);
            signatureCanvas.removeEventListener('touchstart', handleTouchStart);
            signatureCanvas.removeEventListener('touchmove', handleTouchMove);
            signatureCanvas.removeEventListener('touchend', stopDrawing);

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseout', stopDrawing);

            // Touch events
            signatureCanvas.addEventListener('touchstart', handleTouchStart);
            signatureCanvas.addEventListener('touchmove', handleTouchMove);
            signatureCanvas.addEventListener('touchend', stopDrawing);
        }

        function initTypedSignatureCanvas() {
            typedSignatureCanvas = document.getElementById('typedSignatureCanvas');
            typedSignatureCtx = typedSignatureCanvas.getContext('2d');
        }

        function updateTypedSignaturePreview() {
            if (!typedSignatureCtx) {
                initTypedSignatureCanvas();
            }

            const name = document.getElementById('signatureNameInput').value || 'Your Name';
            const fontRadio = document.querySelector('input[name="signatureFont"]:checked');
            const fontFamily = fontRadio ? fontRadio.value : "'Great Vibes', cursive";

            // Check if it's a serif font (needs italic)
            const isSerif = fontFamily.includes('Georgia') || fontFamily.includes('Times') || fontFamily.includes('Palatino');

            // Check if it's Tangerine (needs larger font)
            const isTangerine = fontFamily.includes('Tangerine');

            // Clear canvas
            typedSignatureCtx.fillStyle = '#ffffff';
            typedSignatureCtx.fillRect(0, 0, typedSignatureCanvas.width, typedSignatureCanvas.height);

            // Draw text
            typedSignatureCtx.fillStyle = '#1a365d';  // Dark blue
            typedSignatureCtx.textAlign = 'center';
            typedSignatureCtx.textBaseline = 'middle';

            // Calculate font size to fit (Tangerine needs larger base size)
            let fontSize = isTangerine ? 64 : 48;
            typedSignatureCtx.font = `${isSerif ? 'italic ' : ''}${fontSize}px ${fontFamily}`;

            // Reduce font size if text is too wide
            while (typedSignatureCtx.measureText(name).width > typedSignatureCanvas.width - 40 && fontSize > 20) {
                fontSize -= 2;
                typedSignatureCtx.font = `${isSerif ? 'italic ' : ''}${fontSize}px ${fontFamily}`;
            }

            typedSignatureCtx.fillText(name, typedSignatureCanvas.width / 2, typedSignatureCanvas.height / 2);

            // Update the sample text in radio options to show the user's name
            document.querySelectorAll('.signature-style-option span').forEach(span => {
                span.textContent = name || 'Sample Signature';
            });
        }

        function getCanvasCoords(e) {
            const rect = signatureCanvas.getBoundingClientRect();
            const scaleX = signatureCanvas.width / rect.width;
            const scaleY = signatureCanvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const coords = getCanvasCoords(e);
            lastX = coords.x;
            lastY = coords.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCanvasCoords(e);
            signatureCtx.beginPath();
            signatureCtx.moveTo(lastX, lastY);
            signatureCtx.lineTo(coords.x, coords.y);
            signatureCtx.stroke();

            lastX = coords.x;
            lastY = coords.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            signatureCanvas.dispatchEvent(mouseEvent);
        }

        function clearSignatureCanvas() {
            if (signatureCtx) {
                signatureCtx.fillStyle = '#ffffff';
                signatureCtx.fillRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            }
        }

        async function saveSignature() {
            if (!currentSignerUsername) {
                alert('No user selected');
                return;
            }

            let signatureData;

            if (currentSignatureTab === 'draw') {
                // Check if canvas has any drawing (not just white)
                const canvas = signatureCanvas;
                const ctx = signatureCtx;
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let hasDrawing = false;

                for (let i = 0; i < pixels.length; i += 4) {
                    // Check if pixel is not white (255, 255, 255)
                    if (pixels[i] < 250 || pixels[i + 1] < 250 || pixels[i + 2] < 250) {
                        hasDrawing = true;
                        break;
                    }
                }

                if (!hasDrawing) {
                    alert('Please draw your signature before saving');
                    return;
                }

                signatureData = signatureCanvas.toDataURL('image/png');
            } else {
                // Typed signature
                const name = document.getElementById('signatureNameInput').value.trim();
                if (!name) {
                    alert('Please enter your name');
                    return;
                }

                // Make sure preview is up to date
                updateTypedSignaturePreview();
                signatureData = typedSignatureCanvas.toDataURL('image/png');
            }

            try {
                const response = await fetch(`/api/signature/${currentSignerUsername}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ signature_data: signatureData })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Signature saved successfully!');
                    closeSignatureModal();
                    loadSelectedSignature();  // Refresh preview
                } else {
                    alert('Error: ' + (result.error || 'Failed to save signature'));
                }
            } catch (err) {
                console.error('Error saving signature:', err);
                alert('Error saving signature');
            }
        }

        function hideChiefJudgeModal() {
            document.getElementById('chiefJudgeModal').classList.add('hidden');
        }

        // Chief Judge Score Approval Functions
        function showChiefJudgeApprovalModal() {
            document.getElementById('chiefJudgeApprovalModal').classList.remove('hidden');
            document.getElementById('approvalPinInput').value = '';

            // Populate event select
            const eventSelect = document.getElementById('approvalEventSelect');
            eventSelect.innerHTML = '';

            if (isMultiEvent && eventTypes.length > 1) {
                eventTypes.forEach(et => {
                    const option = document.createElement('option');
                    option.value = et;
                    option.textContent = EVENT_DISPLAY_NAMES[et] || et;
                    eventSelect.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.value = 'default';
                option.textContent = EVENT_DISPLAY_NAMES[eventTypes[0]] || eventTypes[0] || 'Default';
                eventSelect.appendChild(option);
            }

            updateApprovalRounds();
        }

        function closeChiefJudgeApprovalModal() {
            document.getElementById('chiefJudgeApprovalModal').classList.add('hidden');
        }

        function updateApprovalRounds() {
            const eventType = document.getElementById('approvalEventSelect').value;
            const container = document.getElementById('approvalRoundsContainer');
            const eventRounds = {{ event_rounds|tojson|safe }};
            const numRounds = eventRounds[eventType] || eventRounds[eventTypes[0]] || 10;

            let html = '<div class="space-y-2">';
            for (let i = 1; i <= numRounds; i++) {
                const approvalKey = eventType || 'default';
                const roundApproval = scoreApprovals[approvalKey] && scoreApprovals[approvalKey][i.toString()];
                const isApproved = !!roundApproval;
                const approvedAt = roundApproval ? new Date(roundApproval.approved_at).toLocaleString() : '';

                html += `
                    <div class="flex items-center justify-between p-2 border rounded ${isApproved ? 'bg-green-50 border-green-300' : 'bg-gray-50'}">
                        <div class="flex items-center gap-2">
                            <span class="font-medium">Round ${i}</span>
                            ${isApproved ? `<span class="text-xs text-green-700">Approved: ${approvedAt}</span>` : '<span class="text-xs text-gray-500">Pending approval</span>'}
                        </div>
                        ${isApproved ?
                            '<span class="text-green-600 text-sm font-medium">‚úì Official</span>' :
                            `<button onclick="approveRound('${eventType}', ${i})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">Approve</button>`
                        }
                    </div>
                `;
            }
            html += '</div>';
            container.innerHTML = html;

            // Update the unofficial banner based on all approvals
            updateUnofficialBanner();
        }

        async function approveRound(eventType, roundNum) {
            const pin = document.getElementById('approvalPinInput').value;
            if (!pin) {
                alert('Please enter the Chief Judge PIN');
                return;
            }

            try {
                const response = await fetch(`/api/competition/${compId}/approve-scores`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pin: pin,
                        round_num: roundNum,
                        event_type: eventType || 'default'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    // Update local scoreApprovals
                    const key = eventType || 'default';
                    if (!scoreApprovals[key]) scoreApprovals[key] = {};
                    scoreApprovals[key][roundNum.toString()] = {
                        approved_at: result.approved_at,
                        approved_by: 'Chief Judge'
                    };
                    updateApprovalRounds();
                    alert(`Round ${roundNum} scores approved and now OFFICIAL`);
                } else {
                    alert('Error: ' + (result.error || 'Failed to approve'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error approving scores');
            }
        }

        async function approveAllRounds() {
            const pin = document.getElementById('approvalPinInput').value;
            if (!pin) {
                alert('Please enter the Chief Judge PIN');
                return;
            }

            const eventType = document.getElementById('approvalEventSelect').value;
            const eventRounds = {{ event_rounds|tojson|safe }};
            const numRounds = eventRounds[eventType] || eventRounds[eventTypes[0]] || 10;

            let approved = 0;
            let errors = [];

            for (let roundNum = 1; roundNum <= numRounds; roundNum++) {
                const key = eventType || 'default';
                // Skip already approved rounds
                if (scoreApprovals[key] && scoreApprovals[key][roundNum.toString()]) {
                    continue;
                }

                try {
                    const response = await fetch(`/api/competition/${compId}/approve-scores`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            pin: pin,
                            round_num: roundNum,
                            event_type: eventType || 'default'
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        if (!scoreApprovals[key]) scoreApprovals[key] = {};
                        scoreApprovals[key][roundNum.toString()] = {
                            approved_at: result.approved_at,
                            approved_by: 'Chief Judge'
                        };
                        approved++;
                    } else {
                        errors.push(`Round ${roundNum}: ${result.error}`);
                    }
                } catch (err) {
                    errors.push(`Round ${roundNum}: Network error`);
                }
            }

            updateApprovalRounds();

            if (errors.length > 0) {
                alert(`Approved ${approved} rounds.\n\nErrors:\n${errors.join('\n')}`);
            } else if (approved > 0) {
                alert(`All ${approved} rounds approved! Scores are now OFFICIAL.`);
            } else {
                alert('All rounds were already approved.');
            }
        }

        function updateUnofficialBanner() {
            const banner = document.getElementById('unofficialBanner');
            if (!banner) return;

            const eventRounds = {{ event_rounds|tojson|safe }};
            let allApproved = true;

            // Check if all rounds in all events are approved
            const eventsToCheck = isMultiEvent ? eventTypes : ['default'];
            for (const et of eventsToCheck) {
                const numRounds = eventRounds[et] || eventRounds[eventTypes[0]] || 10;
                const key = et === eventTypes[0] && !isMultiEvent ? 'default' : et;
                for (let i = 1; i <= numRounds; i++) {
                    if (!scoreApprovals[key] || !scoreApprovals[key][i.toString()]) {
                        allApproved = false;
                        break;
                    }
                }
                if (!allApproved) break;
            }

            if (allApproved) {
                banner.classList.add('hidden');
            } else {
                banner.classList.remove('hidden');
            }
        }

        // Check banner status on page load
        if (isPublicView) {
            document.addEventListener('DOMContentLoaded', updateUnofficialBanner);
        }

        async function saveChiefJudge(e) {
            e.preventDefault();
            const chiefJudge = document.getElementById('chiefJudgeSelect').value;

            try {
                const response = await fetch('/admin/competition/' + compId + '/set-chief-judge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chief_judge: chiefJudge })
                });

                const result = await response.json();
                if (result.success) {
                    hideChiefJudgeModal();
                    alert('Chief Judge saved: ' + (result.display_name || '(none)'));
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error saving Chief Judge');
            }
        }

        function showEventDetailsModal() {
            document.getElementById('eventDetailsModal').classList.remove('hidden');
        }

        function hideEventDetailsModal() {
            document.getElementById('eventDetailsModal').classList.add('hidden');
        }

        async function saveEventDetails(e) {
            e.preventDefault();
            const eventTypes = {{ event_types|tojson|safe }};
            const eventLocations = {};
            const eventDates = {};

            eventTypes.forEach(et => {
                const locationInput = document.getElementById('eventLocation_' + et);
                const dateInput = document.getElementById('eventDate_' + et);
                if (locationInput && locationInput.value.trim()) {
                    eventLocations[et] = locationInput.value.trim();
                }
                if (dateInput && dateInput.value) {
                    eventDates[et] = dateInput.value;
                }
            });

            try {
                const response = await fetch('/admin/competition/' + compId + '/set-event-details', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_locations: eventLocations, event_dates: eventDates })
                });

                const result = await response.json();
                if (result.success) {
                    hideEventDetailsModal();
                    alert('Event details saved');
                    location.reload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error saving event details');
            }
        }

        // =====================
        // DRAW GENERATOR
        // =====================

        // 4-Way FS Randoms and Blocks (USPA)
        const fs4wayRandoms = {
            'A': 'Unipod', 'B': 'Stairstep', 'C': 'Murphy', 'D': 'Yuan',
            'E': 'Meeker', 'F': 'Open Accord', 'G': 'Cataccord', 'H': 'Bow',
            'J': 'Donut', 'K': 'Hook', 'L': 'Adder', 'M': 'Star',
            'N': 'Crank', 'O': 'Satellite', 'P': 'Sidebody', 'Q': 'Phalanx'
        };

        const fs4wayBlocks = {
            1: 'Bipole-Opal', 2: 'Sidebody-Opal', 3: 'Caterpillar-Opal', 4: 'Monopod',
            5: 'Sidebuddies', 6: 'Stardian', 7: 'Zig-Zag', 8: 'Marquis',
            9: 'Lepton', 10: 'Dancer', 11: 'Bunyip', 12: 'Photon',
            13: 'Ritz', 14: 'Piver', 15: 'Compressed', 16: 'Packer',
            17: 'Meson', 18: 'Tango', 19: 'Icepick', 20: 'Zircon',
            21: 'Firefly', 22: 'Turbo'
        };

        // Draw generation rules by event/class
        const drawRules = {
            'fs_4way_fs': {
                open: { randoms: Object.keys(fs4wayRandoms), blocks: Object.keys(fs4wayBlocks).map(Number).filter(b => ![2,4,8,12,19].includes(b)), pointsPerRound: [5, 6] },
                advanced: { randoms: Object.keys(fs4wayRandoms), blocks: [1, 6, 7, 9, 14, 15, 21], pointsPerRound: [4, 5] },
                intermediate: { randoms: Object.keys(fs4wayRandoms), blocks: [7, 9, 14], pointsPerRound: [3, 4] },
                beginner: { randoms: Object.keys(fs4wayRandoms).filter(r => r !== 'G'), blocks: [], pointsPerRound: [3, 3] }
            },
            'fs_8way': {
                open: { randoms: Object.keys(fs4wayRandoms), blocks: Object.keys(fs4wayBlocks).map(Number), pointsPerRound: [5, 6] },
                advanced: { randoms: Object.keys(fs4wayRandoms), blocks: Object.keys(fs4wayBlocks).map(Number), pointsPerRound: [5, 6] },
                intermediate: { randoms: Object.keys(fs4wayRandoms), blocks: [1,3,4,5,6,7,8,10,13,14,16,17,18,19,21], pointsPerRound: [4, 5] }
            }
        };

        let currentDrawData = null;
        let drawEditMode = false;
        let savedDraws = {};

        function showDrawGeneratorModal() {
            document.getElementById('drawGeneratorModal').classList.remove('hidden');
            loadSavedDraws();
            updateDrawClassOptions();
        }

        function hideDrawGeneratorModal() {
            document.getElementById('drawGeneratorModal').classList.add('hidden');
        }

        async function loadSavedDraws() {
            try {
                const response = await fetch('/competition/' + compId + '/draws');
                const result = await response.json();
                if (result.success) {
                    savedDraws = result.draws || {};
                    renderSavedDrawsList();
                }
            } catch (err) {
                console.error('Error loading draws:', err);
            }
        }

        function renderSavedDrawsList() {
            const container = document.getElementById('savedDrawsList');
            const entries = [];

            for (const eventType in savedDraws) {
                for (const className in savedDraws[eventType]) {
                    entries.push({ eventType, className, draw: savedDraws[eventType][className] });
                }
            }

            if (entries.length === 0) {
                container.innerHTML = '<span class="text-gray-500 text-sm">No draws saved yet</span>';
                return;
            }

            container.innerHTML = entries.map(e => `
                <div class="flex items-center gap-2 bg-white px-3 py-1 rounded border">
                    <span class="text-sm font-medium text-gray-800">${e.eventType} - ${e.className}</span>
                    <button onclick="viewSavedDraw('${e.eventType}', '${e.className}')" class="text-blue-600 hover:text-blue-800 text-sm">View</button>
                    <button onclick="deleteSavedDraw('${e.eventType}', '${e.className}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                </div>
            `).join('');
        }

        function viewSavedDraw(eventType, className) {
            if (savedDraws[eventType] && savedDraws[eventType][className]) {
                document.getElementById('drawEventType').value = eventType;
                document.getElementById('drawClass').value = className;
                currentDrawData = savedDraws[eventType][className];
                drawEditMode = false;
                renderDrawResults();
            }
        }

        async function deleteSavedDraw(eventType, className) {
            if (!confirm(`Delete draw for ${eventType} - ${className}?`)) return;

            try {
                const response = await fetch('/admin/competition/' + compId + '/delete-draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_type: eventType, class_name: className })
                });
                const result = await response.json();
                if (result.success) {
                    loadSavedDraws();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error deleting draw');
            }
        }

        function updateDrawClassOptions() {
            const eventType = document.getElementById('drawEventType').value;
            // Update available rounds based on event type
            const defaultRounds = {
                // Formation Skydiving
                'fs_4way_fs': 10, 'fs_4way_vfs': 10, 'fs_2way_mfs': 10, 'fs_8way': 10,
                'fs_16way': 6, 'fs_10way': 6,
                // Canopy Formation
                'cf_4way_rot': 8, 'cf_4way_seq': 8, 'cf_2way_open': 8, 'cf_2way_proam': 8, 'cf_2way': 8,
                // Artistic Events
                'ae_freestyle': 7, 'ae_freefly': 7,
                // Wingsuit
                'ws_acrobatic': 7, 'ws_performance': 3
            };
            const rounds = defaultRounds[eventType] || 10;

            // Update the rounds display and hidden input
            document.getElementById('drawNumRounds').value = rounds;
            document.getElementById('drawNumRoundsDisplay').textContent = rounds + ' Rounds';

            // Show/hide tie breaker section for WS Acrobatic only
            const tieBreakerSection = document.getElementById('tieBreakerSection');
            const needsTieBreaker = eventType === 'ws_acrobatic';
            tieBreakerSection.classList.toggle('hidden', !needsTieBreaker);

            // Show/hide WS Performance task order section
            const wsTaskOrderSection = document.getElementById('wsTaskOrderSection');
            wsTaskOrderSection.classList.toggle('hidden', eventType !== 'ws_performance');

            // Reset tie breaker result when switching events
            document.getElementById('tieBreakerResult').classList.add('hidden');

            // Load saved task order for WS Performance
            if (eventType === 'ws_performance') {
                loadSavedWsTaskOrder();
            }
        }

        let currentWsTaskOrder = null;

        function drawWsTaskOrder() {
            // Shuffle tasks: Time, Distance, Speed
            const tasks = ['Time', 'Distance', 'Speed'];
            for (let i = tasks.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [tasks[i], tasks[j]] = [tasks[j], tasks[i]];
            }
            currentWsTaskOrder = tasks;

            // Display results with colors
            const colors = {
                'Time': 'bg-blue-500 text-white',
                'Distance': 'bg-green-500 text-white',
                'Speed': 'bg-orange-500 text-white'
            };

            for (let i = 0; i < 3; i++) {
                const el = document.getElementById('wsTaskRound' + (i + 1));
                el.textContent = tasks[i];
                el.className = 'w-24 h-10 rounded flex items-center justify-center font-bold ' + colors[tasks[i]];
            }

            // Show save button
            document.getElementById('saveWsTaskOrderBtn').classList.remove('hidden');
            document.getElementById('wsTaskOrderSaved').classList.add('hidden');
        }

        async function loadSavedWsTaskOrder() {
            try {
                const response = await fetch('/competition/' + compId + '/ws-task-order');
                const result = await response.json();
                if (result.success && result.task_order && result.task_order.length === 3) {
                    currentWsTaskOrder = result.task_order;
                    const colors = {
                        'Time': 'bg-blue-500 text-white',
                        'Distance': 'bg-green-500 text-white',
                        'Speed': 'bg-orange-500 text-white'
                    };
                    for (let i = 0; i < 3; i++) {
                        const el = document.getElementById('wsTaskRound' + (i + 1));
                        el.textContent = result.task_order[i];
                        el.className = 'w-24 h-10 rounded flex items-center justify-center font-bold ' + colors[result.task_order[i]];
                    }
                    document.getElementById('wsTaskOrderSaved').classList.remove('hidden');
                    document.getElementById('wsTaskOrderSaved').textContent = 'Current task order loaded';
                    document.getElementById('saveWsTaskOrderBtn').classList.add('hidden');
                }
            } catch (err) {
                console.error('Error loading WS task order:', err);
            }
        }

        async function saveWsTaskOrder() {
            if (!currentWsTaskOrder) {
                alert('Please draw a task order first');
                return;
            }

            try {
                const response = await fetch('/competition/' + compId + '/ws-task-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_order: currentWsTaskOrder })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('wsTaskOrderSaved').textContent = 'Task order saved and applied to scoring!';
                    document.getElementById('wsTaskOrderSaved').classList.remove('hidden');
                    document.getElementById('saveWsTaskOrderBtn').classList.add('hidden');
                    // Reload page to apply new task order to scoring display
                    setTimeout(() => location.reload(), 1500);
                } else {
                    alert('Error: ' + (result.error || 'Failed to save task order'));
                }
            } catch (err) {
                console.error('Error saving WS task order:', err);
                alert('Error saving task order');
            }
        }

        function drawTieBreaker() {
            const result = Math.random() < 0.5 ? 'Compulsory' : 'Free';
            const resultDiv = document.getElementById('tieBreakerResult');
            resultDiv.textContent = result;
            resultDiv.className = result === 'Compulsory'
                ? 'px-4 py-2 rounded font-bold text-lg bg-orange-100 text-orange-800 border border-orange-300'
                : 'px-4 py-2 rounded font-bold text-lg bg-green-100 text-green-800 border border-green-300';
            resultDiv.classList.remove('hidden');
        }

        // WS Acrobatic Compulsory Sequences from Addendum A (USPA SCM Chapter 14)
        const wsAcroSequencePool = [
            'A: Up and Over',
            'B: Rock and Roll',
            'C: Revolutions',
            'D: Roll Over',
            'E: Duck and Roll',
            'F: D√©j√† vu',
            'G: Yin Yang',
            'H: Back to Back',
            'I: Pancakes',
            'J: Reversed Pancakes',
            'K: Hand to Foot',
            'L: Reversed Hand to Foot',
            'M: Hand to Opposed Foot',
            'N: Corkscrew',
            'O: Scary Roll'
        ];

        function drawWsAcroSequences() {
            // 4 Compulsory rounds (2, 3, 5, 6), each needs 3 sequences
            const compulsoryRounds = [2, 3, 5, 6];
            const sequencesPerRound = 3;
            const totalNeeded = compulsoryRounds.length * sequencesPerRound; // 12 sequences

            // Create a working copy of the pool
            let availableSequences = [...wsAcroSequencePool];
            const drawnSequences = {};

            for (const round of compulsoryRounds) {
                drawnSequences[round] = [];
                for (let i = 0; i < sequencesPerRound; i++) {
                    // If pool is exhausted, restart
                    if (availableSequences.length === 0) {
                        availableSequences = [...wsAcroSequencePool];
                    }
                    // Draw random sequence
                    const randomIndex = Math.floor(Math.random() * availableSequences.length);
                    const sequence = availableSequences.splice(randomIndex, 1)[0];
                    drawnSequences[round].push(sequence);
                }
            }

            // Display results
            for (const round of compulsoryRounds) {
                const container = document.getElementById(`wsAcroSeqR${round}`);
                if (container) {
                    container.innerHTML = drawnSequences[round].map((seq, idx) =>
                        `<div class="bg-white px-2 py-1 rounded text-xs">${idx + 1}. ${seq}</div>`
                    ).join('');
                }
            }

            document.getElementById('wsAcroSequenceResults').classList.remove('hidden');
        }

        function generateCompetitionDraw() {
            const eventType = document.getElementById('drawEventType').value;
            const className = document.getElementById('drawClass').value;
            const numRounds = parseInt(document.getElementById('drawNumRounds').value);

            // Get rules for this event/class
            const eventRules = drawRules[eventType];
            const classRules = eventRules ? (eventRules[className] || eventRules.open) : null;

            if (!classRules) {
                alert('Draw generation not available for this event type yet');
                return;
            }

            const rounds = [];
            for (let i = 0; i < numRounds; i++) {
                rounds.push(generateRound(classRules));
            }

            currentDrawData = rounds;
            drawEditMode = false;
            renderDrawResults();
        }

        function generateRound(rules) {
            const [minPts, maxPts] = rules.pointsPerRound;
            const isOpenClass = (maxPts === 6 && minPts === 5);
            const isAdvancedClass = (maxPts === 5 && minPts === 4);
            const isIntermediateClass = (maxPts === 4 && minPts === 3);

            const formations = [];
            let currentPoints = 0;

            const availableRandoms = [...rules.randoms];
            const availableBlocks = [...rules.blocks];

            while (currentPoints < maxPts) {
                // Point stopping rules
                if (isOpenClass && currentPoints === 5) break;
                if (isAdvancedClass && currentPoints === 4) break;
                if (isIntermediateClass && currentPoints === 3) break;

                // Check if we should stop at minimum
                if (isOpenClass && currentPoints >= minPts) {
                    if (currentPoints === 4 && availableBlocks.length > 0 && Math.random() < 0.5) {
                        const idx = Math.floor(Math.random() * availableBlocks.length);
                        const block = availableBlocks.splice(idx, 1)[0];
                        formations.push({ type: 'block', value: block, points: 2, name: fs4wayBlocks[block] });
                        currentPoints += 2;
                    }
                    break;
                }
                if (isAdvancedClass && currentPoints >= minPts) {
                    if (currentPoints === 3 && availableBlocks.length > 0 && Math.random() < 0.5) {
                        const idx = Math.floor(Math.random() * availableBlocks.length);
                        const block = availableBlocks.splice(idx, 1)[0];
                        formations.push({ type: 'block', value: block, points: 2, name: fs4wayBlocks[block] });
                        currentPoints += 2;
                    }
                    break;
                }
                if (isIntermediateClass && currentPoints >= minPts) {
                    if (currentPoints === 2 && availableBlocks.length > 0 && Math.random() < 0.5) {
                        const idx = Math.floor(Math.random() * availableBlocks.length);
                        const block = availableBlocks.splice(idx, 1)[0];
                        formations.push({ type: 'block', value: block, points: 2, name: fs4wayBlocks[block] });
                        currentPoints += 2;
                    }
                    break;
                }

                const canAddRandom = availableRandoms.length > 0 && (currentPoints + 1 <= maxPts);
                const canAddBlock = availableBlocks.length > 0 && (currentPoints + 2 <= maxPts);

                if (!canAddRandom && !canAddBlock) break;

                let addBlock = canAddBlock && (!canAddRandom || Math.random() < 0.4);

                if (addBlock) {
                    const idx = Math.floor(Math.random() * availableBlocks.length);
                    const block = availableBlocks.splice(idx, 1)[0];
                    formations.push({ type: 'block', value: block, points: 2, name: fs4wayBlocks[block] });
                    currentPoints += 2;
                } else if (canAddRandom) {
                    const idx = Math.floor(Math.random() * availableRandoms.length);
                    const random = availableRandoms.splice(idx, 1)[0];
                    formations.push({ type: 'random', value: random, points: 1, name: fs4wayRandoms[random] });
                    currentPoints += 1;
                }
            }

            // Rotate Star to end if drawn first
            if (formations.length > 0 && formations[0].value === 'M') {
                const star = formations.shift();
                formations.push(star);
            }

            return { formations, maxPoints: currentPoints };
        }

        function renderDrawResults() {
            const resultsArea = document.getElementById('drawResultsArea');
            const content = document.getElementById('drawContent');
            const editBtn = document.getElementById('drawEditModeBtn');
            const editNotice = document.getElementById('drawEditModeNotice');

            if (!currentDrawData || currentDrawData.length === 0) {
                resultsArea.classList.add('hidden');
                return;
            }

            resultsArea.classList.remove('hidden');
            editBtn.classList.remove('hidden');

            if (drawEditMode) {
                editBtn.textContent = 'Done';
                editBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                editBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                editNotice.classList.remove('hidden');
            } else {
                editBtn.textContent = 'Edit';
                editBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                editBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                editNotice.classList.add('hidden');
            }

            const maxFormations = Math.max(...currentDrawData.map(r => r.formations.length));

            let html = `<table class="w-full border-collapse text-sm">
                <thead>
                    <tr class="border-b-2 border-gray-300">`;

            currentDrawData.forEach((_, idx) => {
                html += `<th class="text-center px-1 py-2 font-bold text-gray-800">Round ${idx + 1}</th>`;
            });
            html += `</tr></thead><tbody>`;

            for (let formIdx = 0; formIdx < maxFormations; formIdx++) {
                html += `<tr class="border-b border-gray-200">`;
                currentDrawData.forEach((round, roundIdx) => {
                    if (formIdx < round.formations.length) {
                        const f = round.formations[formIdx];
                        const imgSrc = `/static/formations/FS-${f.value}.png`;
                        const isBlock = f.type === 'block';
                        const editClass = drawEditMode ? 'ring-2 ring-yellow-500 cursor-pointer' : '';
                        const clickHandler = drawEditMode ? `showDrawFormationPicker(${roundIdx}, ${formIdx})` : '';
                        html += `
                            <td class="text-center p-1">
                                <div class="inline-block ${editClass}" ${clickHandler ? `onclick="${clickHandler}"` : ''}>
                                    <img src="${imgSrc}" alt="${f.value}" class="w-12 ${isBlock ? 'h-16' : 'h-12'} object-contain bg-white rounded border mx-auto"
                                         onerror="this.style.display='none'; this.nextElementSibling.classList.remove('hidden')">
                                    <span class="hidden font-bold text-gray-800">${f.value}</span>
                                    <div class="text-xs text-gray-600">${f.value}</div>
                                </div>
                            </td>`;
                    } else {
                        html += `<td></td>`;
                    }
                });
                html += `</tr>`;
            }

            // Add formation row (edit mode)
            if (drawEditMode) {
                html += `<tr class="border-b border-gray-200">`;
                currentDrawData.forEach((_, roundIdx) => {
                    html += `<td class="text-center p-2">
                        <button onclick="showDrawFormationPicker(${roundIdx}, null)" class="w-8 h-8 rounded-full bg-green-600 hover:bg-green-700 text-white font-bold">+</button>
                    </td>`;
                });
                html += `</tr>`;
            }

            // Points row
            html += `<tr class="bg-gray-100 border-t-2 border-gray-300">`;
            currentDrawData.forEach(round => {
                html += `<td class="text-center py-2 font-bold text-gray-800">${round.maxPoints} pts</td>`;
            });
            html += `</tr></tbody></table>`;

            content.innerHTML = html;
        }

        function toggleDrawEditMode() {
            drawEditMode = !drawEditMode;
            renderDrawResults();
        }

        function showDrawFormationPicker(roundIdx, formIdx) {
            const picker = document.getElementById('drawFormationPicker');
            const content = document.getElementById('drawFormationPickerContent');

            const eventType = document.getElementById('drawEventType').value;
            const className = document.getElementById('drawClass').value;
            const eventRules = drawRules[eventType];
            const rules = eventRules ? (eventRules[className] || eventRules.open) : { randoms: Object.keys(fs4wayRandoms), blocks: Object.keys(fs4wayBlocks).map(Number) };

            let html = '<div class="grid grid-cols-2 gap-4">';

            // Randoms
            html += '<div><h5 class="font-semibold text-gray-800 mb-2">Randoms (1 pt)</h5><div class="flex flex-wrap gap-1">';
            rules.randoms.forEach(r => {
                html += `<div class="cursor-pointer hover:ring-2 hover:ring-blue-500 rounded p-1 bg-gray-100" onclick="selectDrawFormation(${roundIdx}, ${formIdx}, 'random', '${r}')">
                    <img src="/static/formations/FS-${r}.png" alt="${r}" class="w-10 h-10 object-contain bg-white rounded">
                    <div class="text-center text-xs">${r}</div>
                </div>`;
            });
            html += '</div></div>';

            // Blocks
            if (rules.blocks.length > 0) {
                html += '<div><h5 class="font-semibold text-gray-800 mb-2">Blocks (2 pts)</h5><div class="flex flex-wrap gap-1">';
                rules.blocks.forEach(b => {
                    html += `<div class="cursor-pointer hover:ring-2 hover:ring-purple-500 rounded p-1 bg-gray-100" onclick="selectDrawFormation(${roundIdx}, ${formIdx}, 'block', ${b})">
                        <img src="/static/formations/FS-${b}.png" alt="${b}" class="w-10 h-12 object-contain bg-white rounded">
                        <div class="text-center text-xs">${b}</div>
                    </div>`;
                });
                html += '</div></div>';
            }

            html += '</div>';

            // Remove button
            if (formIdx !== null && currentDrawData[roundIdx].formations[formIdx]) {
                html += `<div class="mt-4 pt-4 border-t">
                    <button onclick="removeDrawFormation(${roundIdx}, ${formIdx})" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded">Remove</button>
                </div>`;
            }

            content.innerHTML = html;
            picker.classList.remove('hidden');
        }

        function closeDrawFormationPicker() {
            document.getElementById('drawFormationPicker').classList.add('hidden');
        }

        function selectDrawFormation(roundIdx, formIdx, type, value) {
            const formation = {
                type: type,
                value: value,
                points: type === 'block' ? 2 : 1,
                name: type === 'block' ? fs4wayBlocks[value] : fs4wayRandoms[value]
            };

            if (formIdx === null || formIdx >= currentDrawData[roundIdx].formations.length) {
                currentDrawData[roundIdx].formations.push(formation);
            } else {
                currentDrawData[roundIdx].formations[formIdx] = formation;
            }

            currentDrawData[roundIdx].maxPoints = currentDrawData[roundIdx].formations.reduce((sum, f) => sum + f.points, 0);
            closeDrawFormationPicker();
            renderDrawResults();
        }

        function removeDrawFormation(roundIdx, formIdx) {
            currentDrawData[roundIdx].formations.splice(formIdx, 1);
            currentDrawData[roundIdx].maxPoints = currentDrawData[roundIdx].formations.reduce((sum, f) => sum + f.points, 0);
            closeDrawFormationPicker();
            renderDrawResults();
        }

        async function saveCurrentDraw() {
            if (!currentDrawData) {
                alert('No draw to save');
                return;
            }

            const eventType = document.getElementById('drawEventType').value;
            const className = document.getElementById('drawClass').value;

            try {
                const response = await fetch('/admin/competition/' + compId + '/save-draw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_type: eventType,
                        class_name: className,
                        draw: currentDrawData
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Draw saved successfully');
                    loadSavedDraws();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error saving draw');
            }
        }

        function printCurrentDraw() {
            // Open draw in print window
            const content = document.getElementById('drawContent').innerHTML;
            const eventType = document.getElementById('drawEventType').value;
            const className = document.getElementById('drawClass').value;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Draw - ${eventType} ${className}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
                        img { max-width: 50px; max-height: 60px; }
                    </style>
                </head>
                <body>
                    <h1>{{ competition.name }} - ${eventType} ${className}</h1>
                    ${content}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function filterClass(className) {
            // Hide all class sections
            document.querySelectorAll('.class-section').forEach(section => {
                section.classList.add('hidden');
            });
            // Show selected class section
            const selectedSection = document.getElementById('class-' + className);
            if (selectedSection) {
                selectedSection.classList.remove('hidden');
            }
        }

        function filterDiscipline(discipline) {
            // Update dropdown selection
            const selector = document.getElementById('disciplineSelector');
            if (selector) {
                selector.value = discipline;
            }

            // Show/hide columns based on discipline
            // Includes: za (Zone Accuracy), t (Time), d (Distance), s (Speed)
            const allCols = ['col-za', 'col-t', 'col-d', 'col-s'];

            if (discipline === 'all') {
                // Show all columns
                allCols.forEach(cls => {
                    document.querySelectorAll('.' + cls).forEach(el => {
                        el.style.display = '';
                    });
                });
            } else {
                // Hide all, then show selected
                allCols.forEach(cls => {
                    document.querySelectorAll('.' + cls).forEach(el => {
                        el.style.display = 'none';
                    });
                });
                // Show selected discipline
                const showClass = 'col-' + discipline;
                document.querySelectorAll('.' + showClass).forEach(el => {
                    el.style.display = '';
                });
            }
        }

        function filterWsRound(round) {
            // Update dropdown selection
            const selector = document.getElementById('wsRoundSelector');
            if (selector) {
                selector.value = round;
            }

            // Show/hide columns based on round
            const allRounds = ['col-r1', 'col-r2', 'col-r3'];

            if (round === 'all') {
                // Show all rounds
                allRounds.forEach(cls => {
                    document.querySelectorAll('.' + cls).forEach(el => {
                        el.style.display = '';
                    });
                });
            } else {
                // Hide all, then show selected round
                allRounds.forEach(cls => {
                    document.querySelectorAll('.' + cls).forEach(el => {
                        el.style.display = 'none';
                    });
                });
                const showClass = 'col-' + round;
                document.querySelectorAll('.' + showClass).forEach(el => {
                    el.style.display = '';
                });
            }
        }

        function printResults() {
            document.getElementById('printOptionsModal').classList.remove('hidden');
        }

        function hidePrintOptionsModal() {
            document.getElementById('printOptionsModal').classList.add('hidden');
        }

        function generatePDF() {
            const printRange = document.querySelector('input[name="printRange"]:checked').value;
            let url = '/competition/' + compId + '/print-pdf?';

            if (printRange === 'full') {
                url += 'range=full';
            } else if (printRange === 'upTo') {
                const upToRound = document.getElementById('printUpToRound').value;
                url += 'range=upTo&round=' + upToRound;
            } else if (printRange === 'single') {
                const singleRound = document.getElementById('printSingleRound').value;
                url += 'range=single&round=' + singleRound;
            }

            // Add PIN if provided
            const pinInput = document.getElementById('printSignaturePin');
            if (pinInput && pinInput.value.trim()) {
                url += '&pin=' + encodeURIComponent(pinInput.value.trim());
            }

            hidePrintOptionsModal();
            window.open(url, '_blank');
        }

        function showAddCompetitorModal() {
            document.getElementById('addCompetitorModal').classList.remove('hidden');
            // Auto-generate next available number
            const nextNumber = getNextTeamNumber();
            document.getElementById('competitorNumber').value = nextNumber;
            document.getElementById('competitorName').value = '';
            document.getElementById('competitorCountry').value = '';
        }

        function hideAddCompetitorModal() {
            document.getElementById('addCompetitorModal').classList.add('hidden');
        }

        async function addCompetitor(e) {
            e.preventDefault();

            const isMultiEvent = {{ 'true' if is_multi_event else 'false' }};
            const eventType = isMultiEvent
                ? document.getElementById('competitorEvent').value
                : '{{ competition.event_type }}';

            const data = {
                team_number: document.getElementById('competitorNumber').value,
                team_name: document.getElementById('competitorName').value,
                class: document.getElementById('competitorClass').value,
                members: document.getElementById('competitorCountry').value,
                event: eventType
            };

            try {
                const response = await fetch('/admin/competition/' + compId + '/add-team', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    alert('Competitor added successfully');
                    location.reload();
                } else {
                    alert(result.error || 'Failed to add competitor');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function showRenumberModal() {
            document.getElementById('renumberModal').classList.remove('hidden');
        }

        function hideRenumberModal() {
            document.getElementById('renumberModal').classList.add('hidden');
        }

        async function renumberAll(e) {
            e.preventDefault();

            const classStartNumbers = {
                open: parseInt(document.getElementById('renumberOpen').value) || 1,
                advanced: parseInt(document.getElementById('renumberAdvanced').value) || 101,
                intermediate: parseInt(document.getElementById('renumberIntermediate').value) || 201,
                beginner: parseInt(document.getElementById('renumberBeginner').value) || 301
            };

            try {
                const response = await fetch('/admin/competition/{{ competition.id }}/renumber', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_start_numbers: classStartNumbers })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.error || 'Failed to renumber');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function toggleImportDropdown() {
            const dropdown = document.getElementById('importDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('importDropdown');
            const button = e.target.closest('button');
            if (!button || !button.onclick || !button.onclick.toString().includes('toggleImportDropdown')) {
                if (!e.target.closest('#importDropdown')) {
                    dropdown.classList.add('hidden');
                }
            }
        });

        function showImportModal(importType) {
            document.getElementById('importDropdown').classList.add('hidden');
            document.getElementById('importModal').classList.remove('hidden');
            document.getElementById('importType').value = importType;
            document.getElementById('csvFile').value = '';

            if (importType === 'teams') {
                document.getElementById('importModalTitle').textContent = 'Import Teams from CSV';
                document.getElementById('teamsImportInfo').classList.remove('hidden');
                document.getElementById('competitorsImportInfo').classList.add('hidden');
            } else {
                document.getElementById('importModalTitle').textContent = 'Import Competitors from CSV';
                document.getElementById('teamsImportInfo').classList.add('hidden');
                document.getElementById('competitorsImportInfo').classList.remove('hidden');
            }
        }

        function showPhotoModal(photoUrl, teamName, members) {
            const modal = document.getElementById('photoModal');
            const img = document.getElementById('photoModalImage');
            const name = document.getElementById('photoModalName');
            const membersEl = document.getElementById('photoModalMembers');

            if (photoUrl) {
                img.src = photoUrl;
                img.classList.remove('hidden');
            } else {
                img.src = '';
                img.classList.add('hidden');
            }
            name.textContent = teamName;
            membersEl.textContent = members || 'No members listed';
            modal.classList.remove('hidden');
        }

        function hidePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        let selectedTeamPhotoFile = null;
        let selectedAddTeamPhotoFile = null;

        function previewTeamPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                selectedTeamPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('editTeamPhotoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function previewAddTeamPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                selectedAddTeamPhotoFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('addTeamPhotoPreview');
                    preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function triggerPhotoUpload(teamId, teamName) {
            document.getElementById('directPhotoTeamId').value = teamId;
            document.getElementById('directPhotoUpload').click();
        }

        function openPhotoModal(teamId, photoUrl, teamName, members) {
            document.getElementById('photoModalImage').src = photoUrl;
            document.getElementById('photoModalName').textContent = teamName;
            document.getElementById('photoModalMembers').textContent = members || '';
            document.getElementById('photoModalTeamId').value = teamId;
            document.getElementById('photoModal').classList.remove('hidden');
        }

        function hidePhotoModal() {
            document.getElementById('photoModal').classList.add('hidden');
        }

        function changePhotoFromModal() {
            const teamId = document.getElementById('photoModalTeamId').value;
            hidePhotoModal();
            triggerPhotoUpload(teamId, '');
        }

        async function handleDirectPhotoUpload(event) {
            const file = event.target.files[0];
            const teamId = document.getElementById('directPhotoTeamId').value;

            if (!file || !teamId) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/admin/team/' + teamId + '/upload-photo', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert('Photo upload failed: ' + (result.error || 'Unknown error'));
                }
            } catch (err) {
                alert('Photo upload error: ' + err.message);
            }

            // Reset file input
            event.target.value = '';
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function openEditTeamModal(teamId, teamNumber, teamName, teamClass, members, category, event, photo) {
            document.getElementById('editTeamId').value = teamId;
            document.getElementById('editTeamNumber').value = teamNumber;
            document.getElementById('editTeamName').value = teamName;
            document.getElementById('editTeamClass').value = (teamClass || '').toLowerCase();
            document.getElementById('editTeamMembers').value = members;

            // Handle event field based on multi-event vs single-event
            if (isMultiEvent) {
                const eventEl = document.getElementById('editTeamEvent');
                if (eventEl) eventEl.value = event || eventTypes[0] || '';
            } else {
                const categoryEl = document.getElementById('editTeamCategory');
                const eventNameEl = document.getElementById('editTeamEventName');
                if (categoryEl) categoryEl.value = category || '';
                if (eventNameEl) eventNameEl.value = event || '';
            }

            // Reset photo
            selectedTeamPhotoFile = null;
            document.getElementById('editTeamPhoto').value = '';
            const preview = document.getElementById('editTeamPhotoPreview');
            if (photo) {
                preview.innerHTML = `<img src="${photo}" class="w-full h-full object-cover">`;
            } else {
                preview.innerHTML = '<span class="text-gray-500 text-xs">No photo</span>';
            }

            document.getElementById('editTeamModal').classList.remove('hidden');
        }

        function hideEditTeamModal() {
            document.getElementById('editTeamModal').classList.add('hidden');
            selectedTeamPhotoFile = null;
        }

        async function updateTeam(e) {
            e.preventDefault();

            const teamId = document.getElementById('editTeamId').value;

            // Upload photo first if selected
            if (selectedTeamPhotoFile) {
                const formData = new FormData();
                formData.append('file', selectedTeamPhotoFile);

                try {
                    const photoResponse = await fetch('/admin/team/' + teamId + '/upload-photo', {
                        method: 'POST',
                        body: formData
                    });
                    const photoResult = await photoResponse.json();
                    if (!photoResult.success) {
                        alert('Photo upload failed: ' + (photoResult.error || 'Unknown error'));
                    }
                } catch (err) {
                    alert('Photo upload error: ' + err.message);
                }
            }

            const data = {
                team_number: document.getElementById('editTeamNumber').value,
                team_name: document.getElementById('editTeamName').value,
                class: document.getElementById('editTeamClass').value.toLowerCase(),
                members: document.getElementById('editTeamMembers').value
            };

            // Handle event field based on multi-event vs single-event
            if (isMultiEvent) {
                const eventEl = document.getElementById('editTeamEvent');
                data.event = eventEl ? eventEl.value : '';
                data.category = data.event;  // Use event as category for multi-event
            } else {
                const categoryEl = document.getElementById('editTeamCategory');
                const eventNameEl = document.getElementById('editTeamEventName');
                data.category = categoryEl ? categoryEl.value : '';
                data.event = eventNameEl ? eventNameEl.value : '';
            }

            try {
                const response = await fetch('/admin/team/' + teamId + '/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'Failed to update team');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        let currentTeamCategory = '';
        let selectedFlysightFile = null;
        let currentCpEvent = 'zone';
        let videoStartPoint = null;
        const competitionEventType = '{{ competition.event_type }}';
        const isCpCompetition = competitionEventType.startsWith('cp');

        // CP Scoring Functions (Zone Accuracy, Distance, and Speed)
        function selectCpZone(value) {
            document.getElementById('cpLandingZone').value = value;
            // Update button styles
            document.querySelectorAll('.cp-zone-btn').forEach(btn => {
                const btnZone = parseInt(btn.dataset.zone);
                if (btnZone === value) {
                    btn.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                    btn.classList.add('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                } else {
                    btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400');
                    btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
                }
            });
            calculateCpScore();
        }

        function setCpEvent(eventType) {
            currentCpEvent = eventType;
            document.getElementById('cpEventType').value = eventType;

            // Show/hide appropriate section
            const zoneSection = document.getElementById('cpZoneSection');
            const distanceSection = document.getElementById('cpDistanceSection');
            const speedSection = document.getElementById('cpSpeedSection');

            zoneSection.classList.add('hidden');
            distanceSection.classList.add('hidden');
            speedSection.classList.add('hidden');

            if (eventType === 'zone') {
                zoneSection.classList.remove('hidden');
            } else if (eventType === 'distance') {
                distanceSection.classList.remove('hidden');
            } else if (eventType === 'speed') {
                speedSection.classList.remove('hidden');
            }

            calculateCpScore();
        }

        function resetCpScoringForm() {
            // Reset all CP scoring checkboxes to checked
            ['cpGateEntry', 'cpGate1', 'cpGate2', 'cpGate3', 'cpGate4'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = true;
            });
            ['cpDistEntry', 'cpDistG4'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = true;
            });
            ['cpSpeedG1', 'cpSpeedG2', 'cpSpeedG3', 'cpSpeedG4', 'cpSpeedG5'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.checked = true;
            });

            // Reset input fields
            // Reset stand up checkbox
            const standUp = document.getElementById('cpStandUp');
            if (standUp) standUp.checked = true;

            const landingZone = document.getElementById('cpLandingZone');
            if (landingZone) landingZone.value = '3';
            // Reset zone button styles
            document.querySelectorAll('.cp-zone-btn').forEach(btn => {
                const btnZone = parseInt(btn.dataset.zone);
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400', 'bg-green-600', 'ring-green-400');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
            });
            const distanceMeters = document.getElementById('cpDistanceMeters');
            if (distanceMeters) distanceMeters.value = '';
            const speedTime = document.getElementById('cpSpeedTime');
            if (speedTime) speedTime.value = '';

            // Clear penalties
            document.querySelectorAll('input[name="cpPenalty"]').forEach(radio => {
                radio.checked = false;
            });
            const cpPenaltyValue = document.getElementById('cpPenaltyValue');
            if (cpPenaltyValue) cpPenaltyValue.value = '';

            // Reset score value
            const cpScoreValue = document.getElementById('cpScoreValue');
            if (cpScoreValue) cpScoreValue.value = '';

            // Reset upload progress
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadBar').style.width = '0%';
            document.getElementById('uploadStatus').textContent = '';

            // Recalculate score
            calculateCpScore();
        }

        function calculateCpScore() {
            // Check for penalties
            const penaltyRadio = document.querySelector('input[name="cpPenalty"]:checked');
            const penalty = penaltyRadio ? penaltyRadio.value : '';
            document.getElementById('cpPenaltyValue').value = penalty;

            if (penalty) {
                // Penalty scores: WL=35, OF/OC/CD=3 (Default Result), ME/DQ=0
                let penaltyScore = 0;
                let penaltyLabel = penalty;
                if (penalty === 'WL') {
                    penaltyScore = 35;
                    penaltyLabel = 'WL (35)';
                } else if (['OF', 'OC', 'CD'].includes(penalty)) {
                    penaltyScore = 3;
                    penaltyLabel = penalty + ' (DR=3)';
                } else {
                    penaltyScore = 0;
                    penaltyLabel = penalty + ' (0)';
                }
                if (currentCpEvent === 'zone') {
                    document.getElementById('cpZoneTotal').textContent = penaltyLabel;
                } else if (currentCpEvent === 'distance') {
                    document.getElementById('cpDistanceDisplay').textContent = penaltyLabel;
                } else if (currentCpEvent === 'speed') {
                    document.getElementById('cpSpeedDisplay').textContent = penaltyLabel;
                }
                document.getElementById('cpScoreValue').value = penaltyScore;
                return;
            }

            if (currentCpEvent === 'zone') {
                // Check entry gate first - if not checked, automatic zero
                const entryGateChecked = document.getElementById('cpGateEntry').checked;

                if (!entryGateChecked) {
                    // Entry gate missed = automatic zero
                    document.getElementById('cpZoneTotal').textContent = '0 (entry missed)';
                    document.getElementById('cpScoreValue').value = 0;
                    return;
                }

                // Calculate water gate points (entry=3, g1=18, g2=5, g3=8, g4=16)
                let gatePoints = 3; // Entry gate is checked, so start with 3
                if (document.getElementById('cpGate1').checked) gatePoints += 18;
                if (document.getElementById('cpGate2').checked) gatePoints += 5;
                if (document.getElementById('cpGate3').checked) gatePoints += 8;
                if (document.getElementById('cpGate4').checked) gatePoints += 16;

                // Landing zone points
                const zoneValue = document.getElementById('cpLandingZone').value;

                // Check if zone is selected
                if (zoneValue === '') {
                    document.getElementById('cpZoneTotal').textContent = 'Select zone';
                    document.getElementById('cpScoreValue').value = '';
                    return;
                }

                const zonePoints = parseInt(zoneValue) || 0;

                // Stand up penalty (-10 if not checked)
                const standUp = document.getElementById('cpStandUp').checked;
                const standUpPenalty = standUp ? 0 : 10;

                const rawScore = gatePoints + zonePoints;
                const finalScore = Math.max(0, rawScore - standUpPenalty);

                // Update zone total display
                if (!standUp) {
                    document.getElementById('cpZoneTotal').textContent = `${finalScore} (${rawScore} - 10 stand up)`;
                } else {
                    document.getElementById('cpZoneTotal').textContent = finalScore;
                }
                document.getElementById('cpScoreValue').value = finalScore;
            } else if (currentCpEvent === 'distance') {
                // Distance scoring - just record the distance if gates are passed
                const entryGate = document.getElementById('cpDistEntry').checked;
                const g4Gate = document.getElementById('cpDistG4').checked;
                const distance = parseFloat(document.getElementById('cpDistanceMeters').value) || 0;

                // Display the distance
                document.getElementById('cpDistanceDisplay').textContent = distance.toFixed(2);

                // Score is the distance (gates must be passed for valid score)
                if (entryGate && g4Gate && distance > 0) {
                    document.getElementById('cpScoreValue').value = distance;
                } else if (!entryGate || !g4Gate) {
                    document.getElementById('cpScoreValue').value = 0;
                    document.getElementById('cpDistanceDisplay').textContent = '0.00 (gate missed)';
                } else {
                    document.getElementById('cpScoreValue').value = distance;
                }
            } else if (currentCpEvent === 'speed') {
                // Speed scoring - record the time if all gates are passed
                const g1 = document.getElementById('cpSpeedG1').checked;
                const g2 = document.getElementById('cpSpeedG2').checked;
                const g3 = document.getElementById('cpSpeedG3').checked;
                const g4 = document.getElementById('cpSpeedG4').checked;
                const g5 = document.getElementById('cpSpeedG5').checked;
                const allGatesPassed = g1 && g2 && g3 && g4 && g5;
                const time = parseFloat(document.getElementById('cpSpeedTime').value) || 0;

                // Display the time
                document.getElementById('cpSpeedDisplay').textContent = time.toFixed(3);

                // Score is the time (all gates must be passed for valid score)
                if (allGatesPassed && time > 0) {
                    document.getElementById('cpScoreValue').value = time;
                } else if (!allGatesPassed) {
                    document.getElementById('cpScoreValue').value = 0;
                    document.getElementById('cpSpeedDisplay').textContent = '0.000 (gate missed)';
                } else {
                    document.getElementById('cpScoreValue').value = time;
                }
            }
        }

        function resetCpScoring() {
            // Reset Zone - all gates checked by default (positive scoring)
            document.getElementById('cpGateEntry').checked = true;
            document.getElementById('cpGate1').checked = true;
            document.getElementById('cpGate2').checked = true;
            document.getElementById('cpGate3').checked = true;
            document.getElementById('cpGate4').checked = true;
            document.getElementById('cpStandUp').checked = true;
            document.getElementById('cpLandingZone').value = '';
            // Reset zone button styles
            document.querySelectorAll('.cp-zone-btn').forEach(btn => {
                const btnZone = parseInt(btn.dataset.zone);
                btn.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'text-white', 'ring-2', 'ring-blue-400', 'bg-green-600', 'ring-green-400');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-800');
            });
            document.getElementById('cpZoneTotal').textContent = 'Select zone';

            // Reset Distance - gates checked by default
            document.getElementById('cpDistEntry').checked = true;
            document.getElementById('cpDistG4').checked = true;
            document.getElementById('cpDistanceMeters').value = '';
            document.getElementById('cpDistanceDisplay').textContent = '0.00';

            // Reset Speed - all gates checked by default
            document.getElementById('cpSpeedG1').checked = true;
            document.getElementById('cpSpeedG2').checked = true;
            document.getElementById('cpSpeedG3').checked = true;
            document.getElementById('cpSpeedG4').checked = true;
            document.getElementById('cpSpeedG5').checked = true;
            document.getElementById('cpSpeedTime').value = '';
            document.getElementById('cpSpeedDisplay').textContent = '0.000';

            document.getElementById('cpScoreValue').value = '';
            document.getElementById('cpEventType').value = 'zone';
            // Reset penalties - uncheck all
            document.querySelectorAll('input[name="cpPenalty"]').forEach(r => r.checked = false);
            document.getElementById('cpPenaltyValue').value = '';
        }

        function clearCpPenalty() {
            // Uncheck all penalty radio buttons and recalculate score
            document.querySelectorAll('input[name="cpPenalty"]').forEach(r => r.checked = false);
            document.getElementById('cpPenaltyValue').value = '';
            calculateCpScore();
        }

        // CF (Canopy Formation) Scoring Functions
        let currentCfEventType = '4way';  // Default to 4-way (1 point penalty)

        function setCfEventType(eventType) {
            currentCfEventType = eventType;

            // Update button styles
            document.querySelectorAll('.cf-event-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });

            if (eventType === '4way') {
                document.getElementById('cfEvent4Way').classList.remove('bg-gray-200', 'hover:bg-gray-300');
                document.getElementById('cfEvent4Way').classList.add('bg-blue-600');
                document.getElementById('cfRulesText').textContent = '4-Way: 1 point per correct formation. Omissions = no point + 1 penalty.';
                document.getElementById('cfOmissionHelp').innerHTML = '<div>-1 point each</div><div class="text-xs">(inter+2nd in block = 1)</div>';
            } else {
                document.getElementById('cfEvent2Way').classList.remove('bg-gray-200', 'hover:bg-gray-300');
                document.getElementById('cfEvent2Way').classList.add('bg-blue-600');
                document.getElementById('cfRulesText').textContent = '2-Way: 1 point per correct formation. Omissions = no point + 2 penalty.';
                document.getElementById('cfOmissionHelp').innerHTML = '<div>-2 points each</div><div class="text-xs">per omission</div>';
            }

            document.getElementById('cfEventType').value = eventType;
            calculateCfScore();
        }

        function calculateCfScore() {
            const formations = parseInt(document.getElementById('cfFormations').value) || 0;
            const omissions = parseInt(document.getElementById('cfOmissions').value) || 0;
            const nvPenalty = document.getElementById('cfNvPenalty').checked;

            // Check for NV penalty first - score becomes 0
            if (nvPenalty) {
                document.getElementById('cfFormationsDisplay').textContent = formations;
                document.getElementById('cfOmissionPenalty').textContent = 'NV';
                document.getElementById('cfFinalScore').textContent = '0';
                document.getElementById('cfScoreBreakdown').textContent = 'NV Penalty Applied - Score = 0';
                document.getElementById('cfScoreValue').value = 0;
                return;
            }

            // Score = formations completed - omission penalties
            // 4-Way: Each omission = -1 penalty
            // 2-Way: Each omission = -2 penalty
            const penaltyPerOmission = currentCfEventType === '2way' ? 2 : 1;
            const totalPenalty = omissions * penaltyPerOmission;
            const finalScore = Math.max(0, formations - totalPenalty);

            // Update displays
            document.getElementById('cfFormationsDisplay').textContent = formations;
            document.getElementById('cfOmissionPenalty').textContent = totalPenalty > 0 ? '-' + totalPenalty : '-0';
            document.getElementById('cfFinalScore').textContent = finalScore;
            document.getElementById('cfScoreBreakdown').textContent =
                formations + ' formations - ' + totalPenalty + ' penalty (' + omissions + ' omission' + (omissions !== 1 ? 's' : '') + ' √ó ' + penaltyPerOmission + ') = ' + finalScore;
            document.getElementById('cfScoreValue').value = finalScore;
        }

        function resetCfScoring() {
            currentCfEventType = '4way';
            setCfEventType('4way');
            document.getElementById('cfFormations').value = '0';
            document.getElementById('cfOmissions').value = '0';
            document.getElementById('cfNvPenalty').checked = false;
            document.getElementById('cfFormationsDisplay').textContent = '0';
            document.getElementById('cfOmissionPenalty').textContent = '-0';
            document.getElementById('cfFinalScore').textContent = '0';
            document.getElementById('cfScoreBreakdown').textContent = '0 formations - 0 omission penalty = 0';
        }

        // =====================
        // WS PERFORMANCE SCORING
        // =====================

        function calculateWsScore() {
            const wsRawScoreEl = document.getElementById('wsRawScore');
            if (!wsRawScoreEl) return; // Elements don't exist

            const rawScore = parseFloat(wsRawScoreEl.value) || 0;
            const dlViolation = document.querySelector('input[name="wsDlViolation"]:checked')?.value || 'none';

            // Determine penalty percentage based on DL violation
            let penaltyPercent = 0;
            let penaltyDisplay = '0%';
            let multiplier = 1.0;

            switch (dlViolation) {
                case 'none':
                    penaltyPercent = 0;
                    penaltyDisplay = '0%';
                    multiplier = 1.0;
                    break;
                case 'under150':
                    penaltyPercent = 10;
                    penaltyDisplay = '-10%';
                    multiplier = 0.9;
                    break;
                case '150to300':
                    penaltyPercent = 20;
                    penaltyDisplay = '-20%';
                    multiplier = 0.8;
                    break;
                case 'over300':
                    penaltyPercent = 50;
                    penaltyDisplay = '-50%';
                    multiplier = 0.5;
                    break;
            }

            const finalScore = rawScore * multiplier;

            // Update displays (with null checks)
            const wsRawDisplay = document.getElementById('wsRawDisplay');
            const wsPenaltyDisplay = document.getElementById('wsPenaltyDisplay');
            const wsFinalScore = document.getElementById('wsFinalScore');
            const wsScoreBreakdown = document.getElementById('wsScoreBreakdown');
            const wsScoreValue = document.getElementById('wsScoreValue');
            const wsDlPenaltyValue = document.getElementById('wsDlPenaltyValue');

            if (wsRawDisplay) wsRawDisplay.textContent = rawScore.toFixed(2);
            if (wsPenaltyDisplay) {
                wsPenaltyDisplay.textContent = penaltyDisplay;
                wsPenaltyDisplay.className = `text-2xl font-mono ${penaltyPercent === 0 ? 'text-green-400' : penaltyPercent < 50 ? 'text-yellow-500' : 'text-red-500'}`;
            }
            if (wsFinalScore) wsFinalScore.textContent = finalScore.toFixed(2);
            if (wsScoreBreakdown) wsScoreBreakdown.textContent = `${rawScore.toFixed(2)} √ó ${(multiplier * 100).toFixed(0)}% = ${finalScore.toFixed(2)}`;

            // Store values for submission
            if (wsScoreValue) wsScoreValue.value = finalScore;
            if (wsDlPenaltyValue) wsDlPenaltyValue.value = dlViolation;
        }

        function resetWsScoring() {
            const wsRawScore = document.getElementById('wsRawScore');
            const wsRawDisplay = document.getElementById('wsRawDisplay');
            const wsPenaltyDisplay = document.getElementById('wsPenaltyDisplay');
            const wsFinalScore = document.getElementById('wsFinalScore');
            const wsScoreBreakdown = document.getElementById('wsScoreBreakdown');
            const wsScoreValue = document.getElementById('wsScoreValue');
            const wsDlPenaltyValue = document.getElementById('wsDlPenaltyValue');

            if (wsRawScore) wsRawScore.value = '';
            document.querySelectorAll('input[name="wsDlViolation"]').forEach(r => r.checked = r.value === 'none');
            if (wsRawDisplay) wsRawDisplay.textContent = '0.00';
            if (wsPenaltyDisplay) {
                wsPenaltyDisplay.textContent = '0%';
                wsPenaltyDisplay.className = 'text-2xl font-mono text-green-400';
            }
            if (wsFinalScore) wsFinalScore.textContent = '0.00';
            if (wsScoreBreakdown) wsScoreBreakdown.textContent = '0.00 √ó 100% = 0.00';
            if (wsScoreValue) wsScoreValue.value = '';
            if (wsDlPenaltyValue) wsDlPenaltyValue.value = 'none';
        }

        function openRoundModal(teamId, teamName, roundNum, score, videoId, category, scoreId, trainingFlag) {
            // Show modal first
            const modal = document.getElementById('roundModal');
            if (modal) modal.classList.remove('hidden');

            const roundTeamIdEl = document.getElementById('roundTeamId');
            const roundNumberEl = document.getElementById('roundNumber');
            const roundNumEl = document.getElementById('roundNum');
            const roundModalTitleEl = document.getElementById('roundModalTitle');
            const roundTeamNameEl = document.getElementById('roundTeamName');
            const existingVideoIdEl = document.getElementById('existingVideoId');

            if (roundTeamIdEl) roundTeamIdEl.value = teamId;
            if (roundNumberEl) roundNumberEl.value = roundNum;
            if (roundNumEl) roundNumEl.textContent = roundNum;
            if (roundModalTitleEl) roundModalTitleEl.textContent = 'Round ' + roundNum;
            if (roundTeamNameEl) roundTeamNameEl.textContent = teamName;
            if (existingVideoIdEl) existingVideoIdEl.value = videoId || '';
            currentTeamCategory = category || '';

            // Set training flag state
            currentScoreId = scoreId || null;
            const trainingCheckbox = document.getElementById('trainingFlagCheckbox');
            if (trainingCheckbox) {
                trainingCheckbox.checked = trainingFlag == 1;
                // Hide training flag label if no score record exists yet
                const trainingLabel = document.getElementById('trainingFlagLabel');
                if (trainingLabel) {
                    trainingLabel.style.display = scoreId ? 'flex' : 'none';
                }
            }

            // Show/hide delete button based on whether score exists
            const deleteScoreBtn = document.getElementById('deleteScoreBtn');
            if (deleteScoreBtn) {
                deleteScoreBtn.style.display = (scoreId && score !== null && score !== undefined) ? 'block' : 'none';
            }

            // Show CF working time penalty checkbox for CF events
            const cfPenaltyLabel = document.getElementById('cfPenaltyLabel');
            const cfPenaltyCheckbox = document.getElementById('cfPenaltyCheckbox');
            const isCfEvent = category === 'cf' || category.startsWith('cf_') ||
                              competitionEventType === 'cf' || competitionEventType.startsWith('cf_');
            if (cfPenaltyLabel) {
                cfPenaltyLabel.style.display = isCfEvent ? 'flex' : 'none';
                if (cfPenaltyCheckbox) {
                    cfPenaltyCheckbox.checked = false;  // Reset on modal open
                }
            }

            // Reset state
            selectedVideoFile = null;
            selectedFlysightFile = null;
            videoStartPoint = null;
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('roundVideoFile').value = '';
            document.getElementById('roundVideoCapture').value = '';
            // Reset start point controls
            document.getElementById('fileSelectControls').classList.remove('hidden');
            document.getElementById('startPointControls').classList.add('hidden');
            document.getElementById('videoStartPointDisplay').innerHTML = '<span class="text-yellow-400">Not set</span>';
            document.getElementById('startPointWarning').classList.add('hidden');

            // Reset FlySight state
            document.getElementById('flysightFile').value = '';
            document.getElementById('selectedFlysightInfo').classList.add('hidden');
            document.getElementById('flysightResult').classList.add('hidden');
            document.getElementById('flysightProgress').classList.add('hidden');

            // Get scoring sections
            const standardScoreSection = document.getElementById('standardScoreSection');
            const cpScoreSection = document.getElementById('cpScoreSection');
            const cfScoreSection = document.getElementById('cfScoreSection');
            const videoUploadSection = document.getElementById('videoUploadSection');
            const flysightUploadSection = document.getElementById('flysightUploadSection');
            const videoPlayerSection = document.getElementById('videoPlayerSection');
            const videoPlayer = document.getElementById('roundVideoPlayer');
            const uploadOnlyBtn = document.getElementById('uploadOnlyBtn');
            const scoreInput = document.getElementById('roundScore');

            // Determine event type - prioritize the category passed from the button click
            // The category parameter always takes precedence over competition-level event type
            const isWsPerformance = category === 'ws_performance';
            const isSpeedSkydiving = category === 'sp' || category.startsWith('sp_');
            const isCp = category === 'cp' || category.startsWith('cp_');
            const isCf = category === 'cf' || category.startsWith('cf_');

            // Fallback to competition type only if category is empty
            const fallbackIsSpeedSkydiving = !category && (competitionEventType === 'sp' || competitionEventType.startsWith('sp_'));
            const fallbackIsCp = !category && isCpCompetition;
            const fallbackIsCf = !category && (competitionEventType === 'cf' || competitionEventType.startsWith('cf_'));
            const fallbackIsWsPerformance = !category && competitionEventType === 'ws_performance';

            // Get WS FlySight section
            const wsFlysightUploadSection = document.getElementById('wsFlysightUploadSection');

            // Get WS Score section
            const wsScoreSection = document.getElementById('wsScoreSection');

            if ((isCp || fallbackIsCp) && standardScoreSection && cpScoreSection) {
                // Canopy Piloting - show CP-specific scoring (no video upload)
                standardScoreSection.classList.add('hidden');
                cpScoreSection.classList.remove('hidden');
                if (cfScoreSection) cfScoreSection.classList.add('hidden');
                if (wsScoreSection) wsScoreSection.classList.add('hidden');
                videoUploadSection.classList.add('hidden');
                flysightUploadSection.classList.add('hidden');
                if (videoPlayerSection) videoPlayerSection.classList.add('hidden');
                if (wsFlysightUploadSection) wsFlysightUploadSection.classList.add('hidden');

                // Reset CP scoring fields (all gates checked by default)
                resetCpScoring();

                // Auto-select CP event based on round number
                // Rounds 1-3: Zone Accuracy, Rounds 4-6: Distance, Rounds 7-9: Speed
                const modalTitle = document.getElementById('roundModalTitle');
                const modalStatus = document.getElementById('modalStatusText');
                if (roundNum >= 1 && roundNum <= 3) {
                    setCpEvent('zone');
                    if (modalTitle) modalTitle.textContent = 'Zone Accuracy Round ' + roundNum;
                    if (modalStatus) modalStatus.textContent = 'Uncheck missed gates';
                } else if (roundNum >= 4 && roundNum <= 6) {
                    setCpEvent('distance');
                    if (modalTitle) modalTitle.textContent = 'Distance Round ' + (roundNum - 3);
                    if (modalStatus) modalStatus.textContent = 'Enter distance in meters';
                } else if (roundNum >= 7 && roundNum <= 9) {
                    setCpEvent('speed');
                    if (modalTitle) modalTitle.textContent = 'Speed Round ' + (roundNum - 6);
                    if (modalStatus) modalStatus.textContent = 'Enter time in seconds';
                } else {
                    setCpEvent('zone');
                    if (modalTitle) modalTitle.textContent = 'Round ' + roundNum;
                    if (modalStatus) modalStatus.textContent = 'Score CP - uncheck missed gates';
                }

                if (modalStatus) modalStatus.classList.remove('text-green-400', 'text-yellow-400');
            } else if ((isCf || fallbackIsCf) && standardScoreSection && cfScoreSection) {
                // Canopy Formation - show CF-specific scoring
                standardScoreSection.classList.add('hidden');
                if (cpScoreSection) cpScoreSection.classList.add('hidden');
                if (wsScoreSection) wsScoreSection.classList.add('hidden');
                cfScoreSection.classList.remove('hidden');
                videoUploadSection.classList.remove('hidden');
                flysightUploadSection.classList.add('hidden');
                if (wsFlysightUploadSection) wsFlysightUploadSection.classList.add('hidden');

                // Reset CF scoring fields
                resetCfScoring();

                document.getElementById('modalStatusText').textContent = 'Enter formations completed and omissions';
                document.getElementById('modalStatusText').classList.remove('text-green-400', 'text-yellow-400');
            } else if (isSpeedSkydiving || fallbackIsSpeedSkydiving) {
                // Speed Skydiving - FlySight CSV upload only (no manual entry)
                if (standardScoreSection) standardScoreSection.classList.add('hidden');
                if (cpScoreSection) cpScoreSection.classList.add('hidden');
                if (cfScoreSection) cfScoreSection.classList.add('hidden');
                if (wsScoreSection) wsScoreSection.classList.add('hidden');
                videoUploadSection.classList.add('hidden');
                flysightUploadSection.classList.remove('hidden');
                videoPlayerSection.classList.add('hidden');
                document.getElementById('modalStatusText').textContent = 'Upload FlySight CSV to record speed';
                document.getElementById('modalStatusText').classList.remove('text-green-400', 'text-yellow-400');
                if (wsFlysightUploadSection) wsFlysightUploadSection.classList.add('hidden');
            } else if (isWsPerformance || fallbackIsWsPerformance) {
                // WS Performance - FlySight CSV upload + DL violation scoring
                if (standardScoreSection) standardScoreSection.classList.add('hidden');
                if (cpScoreSection) cpScoreSection.classList.add('hidden');
                if (cfScoreSection) cfScoreSection.classList.add('hidden');
                videoUploadSection.classList.add('hidden');
                flysightUploadSection.classList.add('hidden');
                videoPlayerSection.classList.add('hidden');
                if (wsFlysightUploadSection) wsFlysightUploadSection.classList.remove('hidden');

                // Show WS scoring section for DL violations
                const wsScoreSection = document.getElementById('wsScoreSection');
                if (wsScoreSection) {
                    wsScoreSection.classList.remove('hidden');
                    resetWsScoring();
                }

                // Clear previous WS FlySight state
                clearWsFlysightFile();

                // Check if competitor has assigned reference point
                checkWsRefPointAssignment(teamId);

                // Determine task type and display round based on internal round number
                let taskType = 'time';
                let displayRound = roundNum;
                if (roundNum >= 1 && roundNum <= 3) {
                    taskType = 'time';
                    displayRound = roundNum;
                } else if (roundNum >= 4 && roundNum <= 6) {
                    taskType = 'distance';
                    displayRound = roundNum - 3;
                } else if (roundNum >= 7 && roundNum <= 9) {
                    taskType = 'speed';
                    displayRound = roundNum - 6;
                }

                // Auto-select the task and round buttons
                selectWsTask(taskType);
                selectWsRound(displayRound);

                const taskLabels = { time: 'Time', distance: 'Distance', speed: 'Speed' };
                document.getElementById('roundModalTitle').textContent = `WS Performance - ${taskLabels[taskType]} Round ${displayRound}`;
                document.getElementById('modalStatusText').textContent = 'Select task and round, then upload FlySight CSV';
                document.getElementById('modalStatusText').classList.remove('text-green-400', 'text-yellow-400');
            } else {
                // Other categories - show standard scoring
                if (wsFlysightUploadSection) wsFlysightUploadSection.classList.add('hidden');
                if (standardScoreSection) standardScoreSection.classList.remove('hidden');
                if (cpScoreSection) cpScoreSection.classList.add('hidden');
                if (cfScoreSection) cfScoreSection.classList.add('hidden');
                if (wsScoreSection) wsScoreSection.classList.add('hidden');
                videoUploadSection.classList.remove('hidden');
                flysightUploadSection.classList.add('hidden');
                if (scoreInput) {
                    scoreInput.step = '1';
                    scoreInput.placeholder = '--';
                    scoreInput.parentElement.querySelector('.text-gray-500 div').textContent = 'Points scored';
                    scoreInput.parentElement.querySelector('.text-gray-500 .text-xs').textContent = '(minus omissions)';
                }
            }

            // Handle video player visibility and upload controls
            const videoUploadControls = document.getElementById('videoUploadControls');
            const videoAlreadyExistsMsg = document.getElementById('videoAlreadyExistsMsg');

            if (!isSpeedSkydiving && !fallbackIsSpeedSkydiving && !isWsPerformance && !fallbackIsWsPerformance) {
                if (videoId) {
                    // Show video player with the uploaded video
                    videoPlayerSection.classList.remove('hidden');
                    fetch('/videographer/get-video-info/' + videoId)
                        .then(r => r.json())
                        .then(data => {
                            if (data.url) {
                                videoPlayer.src = data.url;
                                // Store start time as data attribute for keyboard shortcut
                                videoPlayer.dataset.startTime = data.start_time || 0;
                                // Apply start time when video loads
                                if (data.start_time && data.start_time > 0) {
                                    videoPlayer.addEventListener('loadedmetadata', function onLoaded() {
                                        videoPlayer.currentTime = data.start_time;
                                        videoPlayer.removeEventListener('loadedmetadata', onLoaded);
                                    });
                                    // Also try setting it directly in case metadata already loaded
                                    if (videoPlayer.readyState >= 1) {
                                        videoPlayer.currentTime = data.start_time;
                                    }
                                }
                            }
                        })
                        .catch(err => console.error('Error loading video:', err));
                    document.getElementById('viewVideoFullLink').href = '/video/' + videoId;

                    // Hide upload controls since video already exists
                    if (videoUploadControls) videoUploadControls.classList.add('hidden');
                    if (videoAlreadyExistsMsg) videoAlreadyExistsMsg.classList.remove('hidden');

                    if (score !== null && score !== undefined) {
                        document.getElementById('modalStatusText').textContent = '‚úì Video uploaded and scored';
                        document.getElementById('modalStatusText').classList.add('text-green-400');
                    } else {
                        document.getElementById('modalStatusText').textContent = '‚è≥ Video uploaded - awaiting score';
                        document.getElementById('modalStatusText').classList.remove('text-green-400');
                        document.getElementById('modalStatusText').classList.add('text-yellow-400');
                    }
                    uploadOnlyBtn.classList.add('hidden');
                } else {
                    videoPlayerSection.classList.add('hidden');
                    videoPlayer.src = '';

                    // Show upload controls since no video exists
                    if (videoUploadControls) videoUploadControls.classList.remove('hidden');
                    if (videoAlreadyExistsMsg) videoAlreadyExistsMsg.classList.add('hidden');

                    if (!isCp) {
                        document.getElementById('modalStatusText').textContent = 'No video uploaded yet';
                        document.getElementById('modalStatusText').classList.remove('text-green-400', 'text-yellow-400');
                    }
                    uploadOnlyBtn.classList.add('hidden');
                }
            }

            // Set score value for non-CP events
            if (!isCp && scoreInput) {
                scoreInput.value = (score !== null && score !== undefined) ? score : '';
            }

            document.getElementById('roundModal').classList.remove('hidden');
        }

        function handleFlysightSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFlysightFile = file;
                document.getElementById('selectedFlysightName').textContent = file.name;
                document.getElementById('selectedFlysightInfo').classList.remove('hidden');

                // Parse CSV to extract speed
                parseFlysightCSV(file);
            }
        }

        function clearFlysightFile() {
            selectedFlysightFile = null;
            document.getElementById('flysightFile').value = '';
            document.getElementById('selectedFlysightInfo').classList.add('hidden');
            document.getElementById('flysightResult').classList.add('hidden');
            const scoreInput = document.getElementById('roundScore');
            if (scoreInput) scoreInput.value = '';
        }

        function parseFlysightCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');

                // Find the header line and velD column (vertical velocity)
                let velDIndex = -1;
                let maxSpeed = 0;

                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;

                    const cols = line.split(',');

                    // Look for header with velD (vertical velocity in m/s)
                    if (velDIndex === -1) {
                        for (let j = 0; j < cols.length; j++) {
                            if (cols[j].trim().toLowerCase() === 'veld') {
                                velDIndex = j;
                                break;
                            }
                        }
                        continue;
                    }

                    // Parse velocity data
                    if (velDIndex >= 0 && cols.length > velDIndex) {
                        const vel = parseFloat(cols[velDIndex]);
                        if (!isNaN(vel) && vel > maxSpeed) {
                            maxSpeed = vel;
                        }
                    }
                }

                // Convert m/s to km/h
                const speedKmh = (maxSpeed * 3.6).toFixed(2);

                document.getElementById('flysightSpeed').textContent = speedKmh;
                document.getElementById('flysightResult').classList.remove('hidden');

                // Auto-fill the score
                const scoreInput = document.getElementById('roundScore');
                if (scoreInput) {
                    scoreInput.value = speedKmh;
                }
            };
            reader.readAsText(file);
        }

        // WS Performance FlySight handling
        let selectedWsFlysightFile = null;
        let wsFlysightParsedData = null;
        let wsFlysightTrackPoints = []; // Store GPS track points from FlySight
        let wsFlightTrackMap = null;
        let wsFlightTrackLayers = [];
        let selectedWsTask = 'time';  // 'time', 'distance', 'speed'
        let selectedWsRound = 1;      // 1, 2, 3

        function toggleFlightTrackMap() {
            const container = document.getElementById('wsFlightTrackMapContainer');
            const toggleBtn = document.getElementById('wsFlightTrackToggle');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Map';
                initFlightTrackMap();
            } else {
                container.classList.add('hidden');
                toggleBtn.textContent = 'Show Map';
            }
        }

        function initFlightTrackMap() {
            if (wsFlightTrackMap) {
                wsFlightTrackMap.invalidateSize();
                return;
            }

            // Initialize the map
            wsFlightTrackMap = L.map('wsFlightTrackMap').setView([38.5, -98.0], 4);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(wsFlightTrackMap);

            // Draw the flight track if we have data
            if (wsFlysightTrackPoints.length > 0) {
                drawFlightTrackOnMap();
            }
        }

        async function drawFlightTrackOnMap() {
            if (!wsFlightTrackMap) return;

            // Clear existing layers
            wsFlightTrackLayers.forEach(layer => wsFlightTrackMap.removeLayer(layer));
            wsFlightTrackLayers = [];

            // Load reference points configuration
            const competitionId = '{{ competition.id }}';
            let refPoints = [];
            let competitorRefPoint = null;
            const teamId = document.getElementById('roundTeamId')?.value;

            try {
                const response = await fetch(`/ws-performance/reference-points/${competitionId}`);
                const result = await response.json();
                if (result.success) {
                    refPoints = result.points || [];
                    // Get assigned reference point for this competitor
                    if (teamId && result.competitor_assignments && result.competitor_assignments[teamId] !== undefined) {
                        const refIdx = result.competitor_assignments[teamId];
                        if (refPoints[refIdx]) {
                            competitorRefPoint = refPoints[refIdx];
                        }
                    }
                    // Default to first reference point if not assigned
                    if (!competitorRefPoint && refPoints.length > 0) {
                        competitorRefPoint = refPoints[0];
                    }
                }
            } catch (err) {
                console.error('Error loading reference points:', err);
            }

            // Draw designated lane using FlySight track start point and reference point
            let trackStart = null;
            if (wsFlysightTrackPoints.length > 0 && competitorRefPoint) {
                trackStart = wsFlysightTrackPoints[0];
                drawDesignatedLaneOnTrackMap(trackStart, competitorRefPoint);
            }

            // Draw the flight track
            if (wsFlysightTrackPoints.length > 0) {
                const trackCoords = wsFlysightTrackPoints.map(p => [p.lat, p.lon]);

                // Draw the flight track line
                const trackLine = L.polyline(trackCoords, {
                    color: '#9333ea', // purple
                    weight: 3,
                    opacity: 0.9
                }).addTo(wsFlightTrackMap);
                wsFlightTrackLayers.push(trackLine);

                // Add start and end markers
                if (trackCoords.length > 0) {
                    const startMarker = L.circleMarker(trackCoords[0], {
                        radius: 8,
                        fillColor: '#22c55e',
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(wsFlightTrackMap);
                    startMarker.bindPopup('<b>Window Start</b><br>3000m altitude');
                    wsFlightTrackLayers.push(startMarker);

                    const endMarker = L.circleMarker(trackCoords[trackCoords.length - 1], {
                        radius: 8,
                        fillColor: '#ef4444',
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 1
                    }).addTo(wsFlightTrackMap);
                    endMarker.bindPopup('<b>Window End</b><br>2000m altitude');
                    wsFlightTrackLayers.push(endMarker);
                }

                // Fit map to show all layers
                const allLayers = wsFlightTrackLayers.filter(l => l.getBounds || l.getLatLng);
                if (allLayers.length > 0) {
                    const group = new L.featureGroup(allLayers);
                    wsFlightTrackMap.fitBounds(group.getBounds().pad(0.1));
                }

                // Update info
                const infoEl = document.getElementById('wsFlightTrackInfo');
                if (infoEl) {
                    infoEl.innerHTML = `Track: ${wsFlysightTrackPoints.length} points | ` +
                        `Start: ${trackCoords[0][0].toFixed(4)}, ${trackCoords[0][1].toFixed(4)} | ` +
                        `End: ${trackCoords[trackCoords.length-1][0].toFixed(4)}, ${trackCoords[trackCoords.length-1][1].toFixed(4)}`;
                }

                // Auto-detect DL violations if we have reference point
                if (trackStart && competitorRefPoint) {
                    const detection = detectDLViolation(
                        wsFlysightTrackPoints,
                        trackStart.lat, trackStart.lon,
                        competitorRefPoint.lat, competitorRefPoint.lng
                    );

                    if (detection) {
                        // Update info with violation detection
                        if (infoEl) {
                            const violationText = detection.violation === 'none'
                                ? '<span class="text-green-600">No DL violation detected</span>'
                                : `<span class="text-red-600">Max ${detection.maxDistance}m from center (${detection.outsideDistance}m outside safe zone)</span>`;
                            infoEl.innerHTML += ` | ${violationText}`;
                        }

                        // Show detection and ask for confirmation
                        setTimeout(() => showDLViolationDetection(detection), 500);
                    }
                }
            }
        }

        function drawDesignatedLaneOnTrackMap(trackStart, refPoint) {
            if (!wsFlightTrackMap) return;

            const vwLat = trackStart.lat;
            const vwLng = trackStart.lon || trackStart.lng;
            const refLat = refPoint.lat;
            const refLng = refPoint.lng;

            // Draw penalty zones from outermost to innermost
            // Red zone: 50% penalty (600-900m from center)
            const redWidth = 900;
            const redP1Left = offsetPoint(vwLat, vwLng, refLat, refLng, redWidth, 'left');
            const redP1Right = offsetPoint(vwLat, vwLng, refLat, refLng, redWidth, 'right');
            const redP2Left = offsetPoint(refLat, refLng, vwLat, vwLng, redWidth, 'right');
            const redP2Right = offsetPoint(refLat, refLng, vwLat, vwLng, redWidth, 'left');
            const redZone = L.polygon([redP1Left, redP1Right, redP2Right, redP2Left], {
                color: '#dc2626', weight: 1, opacity: 0.3, fillColor: '#dc2626', fillOpacity: 0.2
            }).addTo(wsFlightTrackMap);
            wsFlightTrackLayers.push(redZone);

            // Orange zone: 20% penalty (450-600m from center)
            const orangeWidth = 600;
            const orangeP1Left = offsetPoint(vwLat, vwLng, refLat, refLng, orangeWidth, 'left');
            const orangeP1Right = offsetPoint(vwLat, vwLng, refLat, refLng, orangeWidth, 'right');
            const orangeP2Left = offsetPoint(refLat, refLng, vwLat, vwLng, orangeWidth, 'right');
            const orangeP2Right = offsetPoint(refLat, refLng, vwLat, vwLng, orangeWidth, 'left');
            const orangeZone = L.polygon([orangeP1Left, orangeP1Right, orangeP2Right, orangeP2Left], {
                color: '#f97316', weight: 1, opacity: 0.3, fillColor: '#f97316', fillOpacity: 0.25
            }).addTo(wsFlightTrackMap);
            wsFlightTrackLayers.push(orangeZone);

            // Yellow zone: 10% penalty (300-450m from center)
            const yellowWidth = 450;
            const yellowP1Left = offsetPoint(vwLat, vwLng, refLat, refLng, yellowWidth, 'left');
            const yellowP1Right = offsetPoint(vwLat, vwLng, refLat, refLng, yellowWidth, 'right');
            const yellowP2Left = offsetPoint(refLat, refLng, vwLat, vwLng, yellowWidth, 'right');
            const yellowP2Right = offsetPoint(refLat, refLng, vwLat, vwLng, yellowWidth, 'left');
            const yellowZone = L.polygon([yellowP1Left, yellowP1Right, yellowP2Right, yellowP2Left], {
                color: '#eab308', weight: 1, opacity: 0.3, fillColor: '#eab308', fillOpacity: 0.3
            }).addTo(wsFlightTrackMap);
            wsFlightTrackLayers.push(yellowZone);

            // Green zone: Safe lane (300m from center = 600m total)
            const greenWidth = 300;
            const greenP1Left = offsetPoint(vwLat, vwLng, refLat, refLng, greenWidth, 'left');
            const greenP1Right = offsetPoint(vwLat, vwLng, refLat, refLng, greenWidth, 'right');
            const greenP2Left = offsetPoint(refLat, refLng, vwLat, vwLng, greenWidth, 'right');
            const greenP2Right = offsetPoint(refLat, refLng, vwLat, vwLng, greenWidth, 'left');
            const greenZone = L.polygon([greenP1Left, greenP1Right, greenP2Right, greenP2Left], {
                color: '#16a34a', weight: 2, opacity: 0.8, fillColor: '#22c55e', fillOpacity: 0.35
            }).addTo(wsFlightTrackMap);
            wsFlightTrackLayers.push(greenZone);

            // Center line
            const centerLine = L.polyline([[vwLat, vwLng], [refLat, refLng]], {
                color: '#000', weight: 2, opacity: 0.7, dashArray: '5, 5'
            }).addTo(wsFlightTrackMap);
            wsFlightTrackLayers.push(centerLine);

            // Validation window marker
            const vwMarker = L.circleMarker([vwLat, vwLng], {
                radius: 6, fillColor: '#f97316', color: '#fff', weight: 2, fillOpacity: 1
            }).addTo(wsFlightTrackMap);
            vwMarker.bindPopup('<b>Validation Window</b>');
            wsFlightTrackLayers.push(vwMarker);

            // Reference point marker (blue dot)
            const refMarker = L.circleMarker([refLat, refLng], {
                radius: 10, fillColor: '#3b82f6', color: '#fff', weight: 3, fillOpacity: 1
            }).addTo(wsFlightTrackMap);
            refMarker.bindPopup('<b>Ground Reference Point</b><br>Designated Lane Target');
            wsFlightTrackLayers.push(refMarker);
        }

        function selectWsTask(task) {
            selectedWsTask = task;

            // Update current task display
            const taskIcons = { time: '‚è±Ô∏è', distance: 'üìè', speed: 'üí®' };
            const taskLabels = { time: 'Time', distance: 'Distance', speed: 'Speed' };

            const iconEl = document.getElementById('wsCurrentTaskIcon');
            const labelEl = document.getElementById('wsCurrentTaskLabel');
            if (iconEl) iconEl.textContent = taskIcons[task] || '‚è±Ô∏è';
            if (labelEl) labelEl.textContent = taskLabels[task] || 'Time';

            // Show only the relevant card for the selected task
            const wsTimeCard = document.getElementById('wsTimeCard');
            const wsDistanceCard = document.getElementById('wsDistanceCard');
            const wsSpeedCard = document.getElementById('wsSpeedCard');

            // Hide all cards first
            if (wsTimeCard) wsTimeCard.classList.add('hidden');
            if (wsDistanceCard) wsDistanceCard.classList.add('hidden');
            if (wsSpeedCard) wsSpeedCard.classList.add('hidden');

            // Show only the selected task's card
            if (task === 'time' && wsTimeCard) {
                wsTimeCard.classList.remove('hidden');
            } else if (task === 'distance' && wsDistanceCard) {
                wsDistanceCard.classList.remove('hidden');
            } else if (task === 'speed' && wsSpeedCard) {
                wsSpeedCard.classList.remove('hidden');
            }

            // Update raw score if FlySight data exists
            if (wsFlysightParsedData) {
                const wsRawScoreEl = document.getElementById('wsRawScore');
                if (wsRawScoreEl) {
                    wsRawScoreEl.value = wsFlysightParsedData[task];
                    calculateWsScore();
                }
            }

            updateWsSelectedDisplay();
        }

        function selectWsRound(round) {
            selectedWsRound = round;

            // Update current round display
            const labelEl = document.getElementById('wsCurrentRoundLabel');
            if (labelEl) labelEl.textContent = 'Round ' + round;

            updateWsSelectedDisplay();
        }

        function updateWsSelectedDisplay() {
            const taskLabels = { time: 'Time', distance: 'Distance', speed: 'Speed' };
            const taskUnits = { time: 's', distance: 'm', speed: 'km/h' };

            const taskLabelEl = document.getElementById('wsSelectedTaskLabel');
            const roundLabelEl = document.getElementById('wsSelectedRoundLabel');
            const valueEl = document.getElementById('wsSelectedValue');

            if (taskLabelEl) taskLabelEl.textContent = taskLabels[selectedWsTask];
            if (roundLabelEl) roundLabelEl.textContent = 'Round ' + selectedWsRound;

            if (wsFlysightParsedData && valueEl) {
                const value = wsFlysightParsedData[selectedWsTask];
                valueEl.textContent = value + ' ' + taskUnits[selectedWsTask];
            }
        }

        function handleWsFlysightSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedWsFlysightFile = file;
                document.getElementById('selectedWsFlysightName').textContent = file.name;
                document.getElementById('selectedWsFlysightInfo').classList.remove('hidden');

                // Show progress
                document.getElementById('wsFlysightProgress').classList.remove('hidden');
                document.getElementById('wsFlysightStatus').textContent = 'Parsing FlySight data...';

                // Parse CSV on server to get Time, Distance, Speed
                parseWsFlysightCSV(file);
            }
        }

        async function checkWsRefPointAssignment(teamId) {
            const uploadContent = document.getElementById('wsUploadContent');
            const statusEl = document.getElementById('modalStatusText');
            const assignedDisplay = document.getElementById('wsAssignedRefPointDisplay');
            const assignedText = document.getElementById('wsAssignedRefPointText');
            const selectionSection = document.getElementById('wsRefPointSelection');
            const noPointsSection = document.getElementById('wsNoPointsSection');
            const quickAssignSelect = document.getElementById('wsQuickAssignSelect');

            if (!teamId) {
                // No team selected
                if (selectionSection) selectionSection.classList.add('hidden');
                if (assignedDisplay) assignedDisplay.classList.add('hidden');
                if (noPointsSection) noPointsSection.classList.remove('hidden');
                // Keep upload content visible
                if (uploadContent) uploadContent.classList.remove('hidden');
                return;
            }

            try {
                const competitionId = '{{ competition.id }}';
                const response = await fetch(`/ws-performance/reference-points/${competitionId}`);
                const result = await response.json();

                if (result.success) {
                    const assignments = result.competitor_assignments || {};
                    const refPoints = result.points || [];

                    // Check if this competitor has an assigned reference point
                    const hasAssignment = assignments[teamId] !== undefined && assignments[teamId] !== null;
                    const hasRefPoints = refPoints.length > 0;

                    // Store ref points for later use
                    window.wsAvailableRefPoints = refPoints;
                    window.wsCurrentAssignments = assignments;

                    // Always show upload content
                    if (uploadContent) uploadContent.classList.remove('hidden');

                    if (!hasRefPoints) {
                        // No reference points configured at all
                        if (assignedDisplay) assignedDisplay.classList.add('hidden');
                        if (selectionSection) selectionSection.classList.add('hidden');
                        if (noPointsSection) noPointsSection.classList.remove('hidden');
                        if (statusEl) {
                            statusEl.textContent = 'Configure reference points first';
                            statusEl.classList.add('text-red-500');
                        }
                    } else if (!hasAssignment) {
                        // Reference points exist but competitor not assigned - show selection
                        if (assignedDisplay) assignedDisplay.classList.add('hidden');
                        if (selectionSection) selectionSection.classList.remove('hidden');
                        if (noPointsSection) noPointsSection.classList.add('hidden');
                        if (statusEl) {
                            statusEl.textContent = 'Select reference point above';
                            statusEl.classList.remove('text-red-500');
                        }

                        // Populate dropdown with available reference points
                        populateRefPointDropdown(refPoints);
                    } else {
                        // Competitor has assigned reference point - show assignment
                        const refPointIdx = assignments[teamId];
                        const refPoint = refPoints[refPointIdx];

                        if (assignedDisplay) assignedDisplay.classList.remove('hidden');
                        if (selectionSection) selectionSection.classList.add('hidden');
                        if (noPointsSection) noPointsSection.classList.add('hidden');

                        if (assignedText && refPoint) {
                            assignedText.textContent = `Point ${refPointIdx + 1} (${refPoint.lat.toFixed(4)}, ${refPoint.lng.toFixed(4)})`;
                        }

                        if (statusEl) {
                            statusEl.textContent = 'Upload FlySight CSV';
                            statusEl.classList.remove('text-red-500');
                        }

                        // Pre-populate dropdown in case user wants to change
                        populateRefPointDropdown(refPoints, refPointIdx);
                    }
                } else {
                    // Error fetching - still show upload
                    if (assignedDisplay) assignedDisplay.classList.add('hidden');
                    if (selectionSection) selectionSection.classList.add('hidden');
                    if (noPointsSection) noPointsSection.classList.remove('hidden');
                }
            } catch (err) {
                console.error('Error checking reference point assignment:', err);
                // On error, show upload content anyway
                if (uploadContent) uploadContent.classList.remove('hidden');
            }
        }

        function populateRefPointDropdown(refPoints, selectedIdx = null) {
            const quickAssignSelect = document.getElementById('wsQuickAssignSelect');
            if (!quickAssignSelect) return;

            quickAssignSelect.innerHTML = '<option value="">-- Select Reference Point --</option>';
            refPoints.forEach((point, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `Point ${idx + 1} (${point.lat.toFixed(4)}, ${point.lng.toFixed(4)})`;
                if (selectedIdx !== null && idx === selectedIdx) {
                    option.selected = true;
                }
                quickAssignSelect.appendChild(option);
            });
        }

        function showRefPointChangeDropdown() {
            const assignedDisplay = document.getElementById('wsAssignedRefPointDisplay');
            const selectionSection = document.getElementById('wsRefPointSelection');

            if (assignedDisplay) assignedDisplay.classList.add('hidden');
            if (selectionSection) selectionSection.classList.remove('hidden');
        }

        async function quickAssignRefPoint() {
            const select = document.getElementById('wsQuickAssignSelect');
            const btn = document.getElementById('wsQuickAssignBtn');
            const teamId = document.getElementById('roundTeamId')?.value;

            if (!select || !teamId) {
                alert('Error: Could not determine competitor');
                return;
            }

            const refPointIndex = select.value;
            if (refPointIndex === '') {
                alert('Please select a reference point');
                return;
            }

            // Disable button while saving
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Saving...';
            }

            try {
                const competitionId = '{{ competition.id }}';
                const response = await fetch(`/ws-performance/assign-ref-point/${competitionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        team_id: teamId,
                        ref_point_index: parseInt(refPointIndex)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Re-check assignment - should now pass
                    await checkWsRefPointAssignment(teamId);
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Failed to save assignment: ' + err.message);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Assign and Continue';
                }
            }
        }

        function clearWsFlysightFile() {
            selectedWsFlysightFile = null;
            wsFlysightParsedData = null;
            wsFlysightTrackPoints = [];
            document.getElementById('wsFlysightFile').value = '';
            document.getElementById('selectedWsFlysightInfo').classList.add('hidden');
            document.getElementById('wsFlysightResult').classList.add('hidden');
            document.getElementById('wsFlysightProgress').classList.add('hidden');

            // Hide and reset flight track map
            const mapContainer = document.getElementById('wsFlightTrackMapContainer');
            const toggleBtn = document.getElementById('wsFlightTrackToggle');
            if (mapContainer) mapContainer.classList.add('hidden');
            if (toggleBtn) toggleBtn.textContent = 'Show Map';

            // Clear map layers
            if (wsFlightTrackMap) {
                wsFlightTrackLayers.forEach(layer => wsFlightTrackMap.removeLayer(layer));
                wsFlightTrackLayers = [];
            }
        }

        async function parseWsFlysightCSV(file) {
            // Parse locally for preview (simplified - server does full calculation)
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const lines = text.split('\n');

                let headerIdx = 0;
                for (let i = 0; i < lines.length; i++) {
                    if (!lines[i].startsWith('$') && lines[i].trim()) {
                        headerIdx = i;
                        break;
                    }
                }

                const headers = lines[headerIdx].split(',').map(h => h.trim());

                const hMSLIdx = headers.indexOf('hMSL');
                const velNIdx = headers.indexOf('velN');
                const velEIdx = headers.indexOf('velE');
                const timeIdx = headers.indexOf('time');
                const latIdx = headers.indexOf('lat');
                const lonIdx = headers.indexOf('lon');

                if (hMSLIdx === -1) {
                    document.getElementById('wsFlysightStatus').textContent = 'Error: hMSL column not found in CSV';
                    return;
                }

                // Find competition window (3000m to 2000m)
                let windowPoints = [];
                let inWindow = false;

                for (let i = headerIdx + 1; i < lines.length; i++) {
                    const cols = lines[i].split(',');
                    if (cols.length <= hMSLIdx) continue;

                    const alt = parseFloat(cols[hMSLIdx]);
                    if (isNaN(alt)) continue;

                    if (!inWindow && alt <= 3000 && alt >= 2000) {
                        inWindow = true;
                    }

                    // Only include points within the competition window (3000m to 2000m)
                    if (inWindow && alt >= 2000 && alt <= 3000) {
                        windowPoints.push({
                            time: timeIdx >= 0 ? cols[timeIdx] : '',
                            lat: latIdx >= 0 ? parseFloat(cols[latIdx]) : 0,
                            lon: lonIdx >= 0 ? parseFloat(cols[lonIdx]) : 0,
                            alt: alt,
                            velN: velNIdx >= 0 ? parseFloat(cols[velNIdx]) : 0,
                            velE: velEIdx >= 0 ? parseFloat(cols[velEIdx]) : 0
                        });
                    }

                    // Stop when below validation window (2000m)
                    if (inWindow && alt < 2000) {
                        break;
                    }
                }

                if (windowPoints.length < 2) {
                    document.getElementById('wsFlysightStatus').textContent = 'Error: Could not find competition window (3000m-2000m)';
                    return;
                }

                // Calculate metrics (simplified - server does more precise calculation)
                const timeSeconds = windowPoints.length / 5.0; // Assume 5Hz

                let totalDist = 0;
                let totalSpeed = 0;
                for (let i = 1; i < windowPoints.length; i++) {
                    const p1 = windowPoints[i-1];
                    const p2 = windowPoints[i];

                    // Haversine distance
                    const R = 6371000;
                    const dLat = (p2.lat - p1.lat) * Math.PI / 180;
                    const dLon = (p2.lon - p1.lon) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                              Math.cos(p1.lat * Math.PI / 180) * Math.cos(p2.lat * Math.PI / 180) *
                              Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    totalDist += R * c;

                    const horizSpeed = Math.sqrt(p2.velN * p2.velN + p2.velE * p2.velE);
                    totalSpeed += horizSpeed;
                }

                const avgSpeedKmh = (totalSpeed / windowPoints.length) * 3.6;

                // Get validation window start point (first point in competition window)
                const validationPoint = windowPoints[0];

                wsFlysightParsedData = {
                    time: timeSeconds.toFixed(2),
                    distance: totalDist.toFixed(0),
                    speed: avgSpeedKmh.toFixed(2),
                    validationLat: validationPoint.lat,
                    validationLon: validationPoint.lon,
                    validationAlt: validationPoint.alt
                };

                // Store track points for map visualization (only points within validation window)
                wsFlysightTrackPoints = windowPoints.filter(p => p.lat && p.lon && p.alt >= 2000 && p.alt <= 3000);

                // Update display
                document.getElementById('wsFlysightTime').textContent = wsFlysightParsedData.time;
                document.getElementById('wsFlysightDistance').textContent = wsFlysightParsedData.distance;
                document.getElementById('wsFlysightSpeed').textContent = wsFlysightParsedData.speed;
                document.getElementById('wsFlysightResult').classList.remove('hidden');
                document.getElementById('wsFlysightProgress').classList.add('hidden');

                // Set raw score based on selected task and calculate final score
                const wsRawScoreEl = document.getElementById('wsRawScore');
                if (wsRawScoreEl) {
                    wsRawScoreEl.value = wsFlysightParsedData[selectedWsTask];
                    calculateWsScore();
                }

                // Automatically show flight track map after parsing
                if (wsFlysightTrackPoints.length > 0) {
                    const container = document.getElementById('wsFlightTrackMapContainer');
                    const toggleBtn = document.getElementById('wsFlightTrackToggle');
                    if (container) {
                        container.classList.remove('hidden');
                        if (toggleBtn) toggleBtn.textContent = 'Hide Map';
                        // Small delay to ensure container is visible before initializing map
                        setTimeout(() => {
                            initFlightTrackMap();
                            drawFlightTrackOnMap();
                        }, 100);
                    }
                }

                // Update selected value display
                updateWsSelectedDisplay();
            };
            reader.readAsText(file);
        }

        async function uploadWsFlysight(roundBase) {
            if (!selectedWsFlysightFile) {
                alert('Please select a FlySight CSV file first');
                return;
            }

            const teamId = document.getElementById('roundTeamId').value;
            if (!teamId) {
                alert('No team selected');
                return;
            }

            const formData = new FormData();
            formData.append('file', selectedWsFlysightFile);
            formData.append('round_base', roundBase);

            document.getElementById('wsFlysightProgress').classList.remove('hidden');
            document.getElementById('wsFlysightStatus').textContent = 'Uploading and processing...';

            try {
                const response = await fetch(`/ws-performance/bulk-upload-flysight/${teamId}`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('wsFlysightStatus').textContent = result.message;
                    alert(`Round ${roundBase} scores saved!\nTime: ${result.scores.time}s\nDistance: ${result.scores.distance}m\nSpeed: ${result.scores.speed} km/h`);
                    hideRoundModal();
                    preserveEventAndReload();
                } else {
                    document.getElementById('wsFlysightStatus').textContent = 'Error: ' + result.error;
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                document.getElementById('wsFlysightStatus').textContent = 'Upload failed';
                alert('Upload failed: ' + err.message);
            }
        }

        async function saveWsFlysightScore() {
            if (!wsFlysightParsedData) {
                alert('Please upload a FlySight CSV file first');
                return;
            }

            const teamId = document.getElementById('roundTeamId').value;
            if (!teamId) {
                alert('No team selected');
                return;
            }

            // Map task and round to internal round number
            // Time: rounds 1-3, Distance: rounds 4-6, Speed: rounds 7-9
            let internalRound;
            if (selectedWsTask === 'time') {
                internalRound = selectedWsRound;
            } else if (selectedWsTask === 'distance') {
                internalRound = selectedWsRound + 3;
            } else if (selectedWsTask === 'speed') {
                internalRound = selectedWsRound + 6;
            }

            // Get final score with DL penalty applied
            const wsScoreValueEl = document.getElementById('wsScoreValue');
            const rawScore = parseFloat(wsFlysightParsedData[selectedWsTask]);
            const finalScore = wsScoreValueEl ? parseFloat(wsScoreValueEl.value) || rawScore : rawScore;
            const dlViolation = document.querySelector('input[name="wsDlViolation"]:checked')?.value || 'none';

            const taskLabels = { time: 'Time', distance: 'Distance', speed: 'Speed' };
            const taskUnits = { time: 's', distance: 'm', speed: 'km/h' };

            document.getElementById('wsFlysightProgress').classList.remove('hidden');
            document.getElementById('wsFlysightStatus').textContent = 'Saving score...';

            try {
                const response = await fetch(`/ws-performance/save-score/${teamId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        round_num: internalRound,
                        score: finalScore,
                        task: selectedWsTask,
                        raw_score: rawScore,
                        dl_violation: dlViolation
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('wsFlysightStatus').textContent = 'Score saved!';
                    const penaltyText = dlViolation !== 'none' ? ` (with ${dlViolation} DL penalty)` : '';
                    alert(`${taskLabels[selectedWsTask]} Round ${selectedWsRound} saved: ${finalScore.toFixed(2)} ${taskUnits[selectedWsTask]}${penaltyText}`);
                    hideRoundModal();
                    preserveEventAndReload();
                } else {
                    document.getElementById('wsFlysightStatus').textContent = 'Error: ' + result.error;
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                document.getElementById('wsFlysightStatus').textContent = 'Save failed';
                alert('Save failed: ' + err.message);
            }
        }

        // Ground Reference Points for WS Performance
        let wsReferencePoints = [];
        let wsRefMap = null;
        let wsRefMarkers = [];
        let wsFlightPaths = [];
        let wsFlightLanes = [];
        let wsCompetitorRefPoints = {}; // competitor_id -> ref_point_index

        function openWsReferencePointsModal() {
            document.getElementById('wsRefPointsModal').classList.remove('hidden');
            document.getElementById('wsRefPointsModal').classList.add('flex');

            // Initialize map if not already done
            if (!wsRefMap) {
                initWsRefMap();
            }

            // Load existing reference points
            loadWsReferencePoints();
        }

        function closeWsRefPointsModal() {
            document.getElementById('wsRefPointsModal').classList.add('hidden');
            document.getElementById('wsRefPointsModal').classList.remove('flex');
        }

        function initWsRefMap() {
            // Initialize Leaflet map centered on a default location
            wsRefMap = L.map('wsRefMap').setView([38.5, -98.0], 4);  // Center of USA

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(wsRefMap);

            // Add click handler to place reference point markers
            wsRefMap.on('click', function(e) {
                if (wsRefMarkers.length < 4) {
                    addWsRefMarker(e.latlng.lat, e.latlng.lng);
                } else {
                    alert('Maximum 4 reference points. Remove one to add a new point.');
                }
            });
        }

        let wsFieldElevation = 0;

        function updateFieldElevation() {
            const elevInput = document.getElementById('wsFieldElevation');
            const aglInfo = document.getElementById('wsAglInfo');
            const windowStartAgl = document.getElementById('wsWindowStartAgl');
            const windowEndAgl = document.getElementById('wsWindowEndAgl');

            if (elevInput && elevInput.value) {
                wsFieldElevation = parseFloat(elevInput.value) || 0;

                // Competition window is 2500m to 1500m MSL
                // Calculate AGL (Above Ground Level)
                const startAgl = 2500 - wsFieldElevation;
                const endAgl = 1500 - wsFieldElevation;

                if (aglInfo && windowStartAgl && windowEndAgl) {
                    windowStartAgl.textContent = `${startAgl.toFixed(0)}m / ${(startAgl * 3.28084).toFixed(0)}ft`;
                    windowEndAgl.textContent = `${endAgl.toFixed(0)}m / ${(endAgl * 3.28084).toFixed(0)}ft`;
                    aglInfo.classList.remove('hidden');
                }

                // Save field elevation with reference points
                saveWsReferencePoints();
            } else {
                wsFieldElevation = 0;
                if (aglInfo) aglInfo.classList.add('hidden');
            }
        }

        async function lookupElevation() {
            const statusEl = document.getElementById('wsElevationStatus');
            const elevInput = document.getElementById('wsFieldElevation');
            const lookupBtn = document.getElementById('wsElevationLookupBtn');

            // Get coordinates from first reference point
            let lat, lon;
            if (wsRefMarkers.length > 0) {
                const latlng = wsRefMarkers[0].getLatLng();
                lat = latlng.lat;
                lon = latlng.lng;
            } else {
                if (statusEl) statusEl.textContent = 'Set a reference point first to lookup elevation';
                return;
            }

            // Update UI to show loading
            if (lookupBtn) {
                lookupBtn.disabled = true;
                lookupBtn.textContent = '...';
            }
            if (statusEl) statusEl.textContent = 'Looking up elevation...';

            try {
                // Use USGS Elevation Point Query Service
                const response = await fetch(`https://epqs.nationalmap.gov/v1/json?x=${lon}&y=${lat}&units=Meters&wkid=4326`);
                const data = await response.json();

                if (data && data.value !== undefined && data.value !== -1000000) {
                    const elevation = Math.round(data.value);
                    if (elevInput) {
                        elevInput.value = elevation;
                        updateFieldElevation();
                    }
                    if (statusEl) {
                        statusEl.innerHTML = `<span class="text-green-700">Elevation: ${elevation}m / ${Math.round(elevation * 3.28084)}ft (from USGS)</span>`;
                    }
                } else {
                    if (statusEl) statusEl.textContent = 'Could not determine elevation for this location';
                }
            } catch (err) {
                console.error('Elevation lookup error:', err);
                if (statusEl) statusEl.textContent = 'Elevation lookup failed. Enter manually.';
            } finally {
                if (lookupBtn) {
                    lookupBtn.disabled = false;
                    lookupBtn.textContent = 'Auto';
                }
            }
        }

        // Calculate offset point perpendicular to a line (for creating lane polygon)
        function offsetPoint(lat1, lng1, lat2, lng2, distanceMeters, side) {
            // Calculate bearing from point 1 to point 2
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const lat1Rad = lat1 * Math.PI / 180;
            const lat2Rad = lat2 * Math.PI / 180;
            const y = Math.sin(dLng) * Math.cos(lat2Rad);
            const x = Math.cos(lat1Rad) * Math.sin(lat2Rad) - Math.sin(lat1Rad) * Math.cos(lat2Rad) * Math.cos(dLng);
            let bearing = Math.atan2(y, x);

            // Perpendicular bearing (90 degrees offset)
            const perpBearing = side === 'left' ? bearing - Math.PI / 2 : bearing + Math.PI / 2;

            // Earth's radius in meters
            const R = 6371000;

            // Calculate new point at distance
            const d = distanceMeters / R;
            const lat1R = lat1 * Math.PI / 180;
            const lng1R = lng1 * Math.PI / 180;

            const newLat = Math.asin(Math.sin(lat1R) * Math.cos(d) + Math.cos(lat1R) * Math.sin(d) * Math.cos(perpBearing));
            const newLng = lng1R + Math.atan2(Math.sin(perpBearing) * Math.sin(d) * Math.cos(lat1R), Math.cos(d) - Math.sin(lat1R) * Math.sin(newLat));

            return [newLat * 180 / Math.PI, newLng * 180 / Math.PI];
        }

        // Calculate perpendicular distance from a point to a line defined by two points
        function distanceFromPointToLine(pointLat, pointLon, line1Lat, line1Lon, line2Lat, line2Lon) {
            const R = 6371000; // Earth's radius in meters

            // Convert to radians
            const toRad = deg => deg * Math.PI / 180;
            const pLat = toRad(pointLat);
            const pLon = toRad(pointLon);
            const l1Lat = toRad(line1Lat);
            const l1Lon = toRad(line1Lon);
            const l2Lat = toRad(line2Lat);
            const l2Lon = toRad(line2Lon);

            // Calculate bearing from line point 1 to line point 2
            const dLon12 = l2Lon - l1Lon;
            const y12 = Math.sin(dLon12) * Math.cos(l2Lat);
            const x12 = Math.cos(l1Lat) * Math.sin(l2Lat) - Math.sin(l1Lat) * Math.cos(l2Lat) * Math.cos(dLon12);
            const bearing12 = Math.atan2(y12, x12);

            // Calculate bearing from line point 1 to our point
            const dLon1P = pLon - l1Lon;
            const y1P = Math.sin(dLon1P) * Math.cos(pLat);
            const x1P = Math.cos(l1Lat) * Math.sin(pLat) - Math.sin(l1Lat) * Math.cos(pLat) * Math.cos(dLon1P);
            const bearing1P = Math.atan2(y1P, x1P);

            // Calculate angular distance from line point 1 to our point
            const dLat = pLat - l1Lat;
            const dLon = pLon - l1Lon;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(l1Lat) * Math.cos(pLat) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const angularDist = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            // Cross-track distance (perpendicular distance)
            const crossTrack = Math.asin(Math.sin(angularDist) * Math.sin(bearing1P - bearing12));

            return Math.abs(crossTrack * R);
        }

        // Analyze flight track and detect DL violations
        function detectDLViolation(trackPoints, trackStartLat, trackStartLon, refPointLat, refPointLon) {
            if (!trackPoints || trackPoints.length === 0) return null;

            let maxDistance = 0;
            let maxDistancePoint = null;

            // Check each track point's distance from the designated lane center line
            for (const point of trackPoints) {
                const distance = distanceFromPointToLine(
                    point.lat, point.lon,
                    trackStartLat, trackStartLon,
                    refPointLat, refPointLon
                );

                if (distance > maxDistance) {
                    maxDistance = distance;
                    maxDistancePoint = point;
                }
            }

            // Determine violation level based on max distance from center line
            // Safe lane is 300m from center (600m total width)
            // Penalties are based on distance OUTSIDE the safe lane
            let violation = 'none';
            let penaltyPercent = 0;
            let outsideDistance = Math.max(0, maxDistance - 300);

            if (outsideDistance <= 0) {
                violation = 'none';
                penaltyPercent = 0;
            } else if (outsideDistance <= 150) {
                violation = 'under150';
                penaltyPercent = 10;
            } else if (outsideDistance <= 300) {
                violation = '150to300';
                penaltyPercent = 20;
            } else {
                violation = 'over300';
                penaltyPercent = 50;
            }

            return {
                violation: violation,
                penaltyPercent: penaltyPercent,
                maxDistance: Math.round(maxDistance),
                outsideDistance: Math.round(outsideDistance),
                maxDistancePoint: maxDistancePoint
            };
        }

        // Show DL violation detection result and ask for confirmation
        function showDLViolationDetection(detection) {
            if (!detection) return;

            const violationLabels = {
                'none': 'No Violation (within designated lane)',
                'under150': 'Minor Violation (<150m outside DL) - 10% penalty',
                '150to300': 'Moderate Violation (150-300m outside DL) - 20% penalty',
                'over300': 'Major Violation (>300m outside DL) - 50% penalty'
            };

            // Auto-select the detected violation
            const radioBtn = document.querySelector(`input[name="wsDlViolation"][value="${detection.violation}"]`);
            if (radioBtn) {
                radioBtn.checked = true;
                calculateWsScore();
            }

            // Show confirmation if there's a penalty
            if (detection.violation !== 'none') {
                const confirmed = confirm(
                    `DL Violation Auto-Detected:\n\n` +
                    `${violationLabels[detection.violation]}\n\n` +
                    `Max distance from lane center: ${detection.maxDistance}m\n` +
                    `Distance outside safe zone: ${detection.outsideDistance}m\n\n` +
                    `Click OK to confirm this penalty, or Cancel to select manually.`
                );

                if (!confirmed) {
                    // Reset to no violation if not confirmed
                    const noneBtn = document.querySelector('input[name="wsDlViolation"][value="none"]');
                    if (noneBtn) {
                        noneBtn.checked = true;
                        calculateWsScore();
                    }
                }
            }
        }

        function drawFlightPaths() {
            // Clear existing paths and lanes
            wsFlightPaths.forEach(p => wsRefMap.removeLayer(p));
            wsFlightLanes.forEach(l => wsRefMap.removeLayer(l));
            wsFlightPaths = [];
            wsFlightLanes = [];

            // Note: Flight lanes are now only drawn in the scoring modal
            // when we have FlySight track data to determine the origin point.
            // This page just shows the reference points.
        }

        async function searchWsRefLocation() {
            const searchInput = document.getElementById('wsRefSearchInput');
            const statusEl = document.getElementById('wsRefSearchStatus');
            const query = searchInput.value.trim();

            if (!query) {
                statusEl.textContent = 'Please enter a location to search';
                statusEl.className = 'text-red-500 text-xs mt-1';
                return;
            }

            statusEl.textContent = 'Searching...';
            statusEl.className = 'text-gray-500 text-xs mt-1';

            try {
                // Use OpenStreetMap Nominatim geocoding service
                const encodedQuery = encodeURIComponent(query);
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodedQuery}&limit=5`, {
                    headers: {
                        'User-Agent': 'VideoLibrary/1.0'
                    }
                });

                const results = await response.json();

                if (results && results.length > 0) {
                    const result = results[0];
                    const lat = parseFloat(result.lat);
                    const lng = parseFloat(result.lon);

                    // Pan and zoom to the location
                    wsRefMap.setView([lat, lng], 14);

                    statusEl.textContent = `Found: ${result.display_name}`;
                    statusEl.className = 'text-green-600 text-xs mt-1';

                    // Clear the search input
                    searchInput.value = '';
                } else {
                    statusEl.textContent = 'Location not found. Try a different search term.';
                    statusEl.className = 'text-red-500 text-xs mt-1';
                }
            } catch (err) {
                console.error('Geocoding error:', err);
                statusEl.textContent = 'Search failed. Please try again.';
                statusEl.className = 'text-red-500 text-xs mt-1';
            }
        }

        function addWsRefMarker(lat, lng, label = null) {
            const pointNum = wsRefMarkers.length + 1;
            const pointLabel = label || 'Point ' + pointNum;

            // Custom blue icon for reference points
            const refIcon = L.divIcon({
                className: 'ref-marker',
                html: `<div style="background-color: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${pointNum}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });

            const marker = L.marker([lat, lng], {
                draggable: true,
                icon: refIcon
            }).addTo(wsRefMap);

            // Store the point number on the marker for reference
            marker.pointNum = pointNum;

            updateMarkerPopup(marker, pointNum, lat, lng);

            marker.on('dragend', function(e) {
                const latlng = e.target.getLatLng();
                updateMarkerPopup(e.target, e.target.pointNum, latlng.lat, latlng.lng);
                updateWsRefPointsList();
                drawFlightPaths();
            });

            wsRefMarkers.push(marker);
            updateWsRefPointsList();
            drawFlightPaths();

            // Auto-lookup elevation when first reference point is added
            if (wsRefMarkers.length === 1 && !wsFieldElevation) {
                lookupElevation();
            }
        }

        function updateMarkerPopup(marker, pointNum, lat, lng) {
            marker.bindPopup(`<div class="text-center"><b>Point ${pointNum}</b><br><span class="font-mono text-xs">${lat.toFixed(6)}, ${lng.toFixed(6)}</span></div>`);
        }

        function removeWsRefMarker(index) {
            if (wsRefMarkers[index]) {
                wsRefMap.removeLayer(wsRefMarkers[index]);
                wsRefMarkers.splice(index, 1);

                // Update point numbers for remaining markers and recreate icons
                wsRefMarkers.forEach((marker, idx) => {
                    marker.pointNum = idx + 1;
                    const latlng = marker.getLatLng();
                    updateMarkerPopup(marker, idx + 1, latlng.lat, latlng.lng);
                    // Update icon with new number
                    const newIcon = L.divIcon({
                        className: 'ref-marker',
                        html: `<div style="background-color: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;">${idx + 1}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    marker.setIcon(newIcon);
                });

                updateWsRefPointsList();
                drawFlightPaths();
            }
        }

        function updateWsRefPointsList() {
            // Update all 4 point cards
            for (let i = 1; i <= 4; i++) {
                const card = document.getElementById(`wsRefPoint${i}Card`);
                const coordsEl = document.getElementById(`wsRefPoint${i}Coords`);
                const removeBtn = document.getElementById(`wsRefPoint${i}Remove`);

                if (wsRefMarkers[i - 1]) {
                    const latlng = wsRefMarkers[i - 1].getLatLng();
                    card.className = 'bg-green-50 rounded p-3 border-2 border-green-400';
                    coordsEl.innerHTML = `<span class="font-mono text-green-700">${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}</span>`;
                    removeBtn.classList.remove('hidden');
                } else {
                    card.className = 'bg-gray-100 rounded p-3 border-2 border-dashed border-gray-300';
                    coordsEl.innerHTML = '<span class="text-gray-400">Click map to set</span>';
                    removeBtn.classList.add('hidden');
                }
            }

            // Update status
            const status = document.getElementById('wsRefPointsConfigStatus');
            if (wsRefMarkers.length === 4) {
                status.textContent = '4/4 ‚úì';
                status.className = 'text-sm font-medium text-green-600';
            } else {
                status.textContent = `${wsRefMarkers.length}/4`;
                status.className = 'text-sm font-medium text-yellow-600';
            }
        }

        async function saveWsReferencePoints() {
            if (wsRefMarkers.length === 0) {
                alert('Please configure at least one reference point');
                return;
            }

            const competitionId = '{{ competition.id }}';
            const points = wsRefMarkers.map((marker, idx) => {
                const latlng = marker.getLatLng();
                return {
                    index: idx,
                    lat: latlng.lat,
                    lng: latlng.lng
                };
            });

            try {
                const response = await fetch(`/ws-performance/reference-points/${competitionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        points: points,
                        competitor_assignments: wsCompetitorRefPoints,
                        field_elevation: wsFieldElevation
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('Flight path configuration saved successfully');
                    const statusEl = document.getElementById('wsRefPointsStatus');
                    if (statusEl) statusEl.textContent = `${points.length}/4`;
                    closeWsRefPointsModal();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Save failed: ' + err.message);
            }
        }

        async function loadWsReferencePoints() {
            const competitionId = '{{ competition.id }}';

            try {
                const response = await fetch(`/ws-performance/reference-points/${competitionId}`);
                const result = await response.json();

                if (result.success) {
                    // Clear existing markers
                    wsRefMarkers.forEach(m => wsRefMap.removeLayer(m));
                    wsRefMarkers = [];

                    // Load competitor assignments
                    wsCompetitorRefPoints = result.competitor_assignments || {};

                    // Load field elevation
                    if (result.field_elevation !== undefined && result.field_elevation !== null) {
                        wsFieldElevation = result.field_elevation;
                        const elevInput = document.getElementById('wsFieldElevation');
                        if (elevInput) {
                            elevInput.value = wsFieldElevation;
                            updateFieldElevation();
                        }
                    }

                    // Add markers for loaded points
                    if (result.points && result.points.length > 0) {
                        result.points.forEach((point, idx) => {
                            addWsRefMarker(point.lat, point.lng, 'Point ' + (idx + 1));
                        });
                    }

                    // Fit map to show all markers
                    if (wsRefMarkers.length > 0) {
                        const group = new L.featureGroup(wsRefMarkers);
                        wsRefMap.fitBounds(group.getBounds().pad(0.1));
                    }

                    // Update status
                    const statusEl = document.getElementById('wsRefPointsStatus');
                    if (statusEl) {
                        statusEl.textContent = `${wsRefMarkers.length}/4`;
                    }

                    // Render competitor assignments
                    renderCompetitorAssignments();
                }
            } catch (err) {
                console.error('Error loading reference points:', err);
            }
        }

        function renderCompetitorAssignments() {
            const container = document.getElementById('wsCompetitorAssignments');
            if (!container) return;

            // Get WS Performance competitors from the page
            const wsTeams = [];
            document.querySelectorAll('[data-event="ws_performance"] tr[data-team-id]').forEach(row => {
                const teamId = row.dataset.teamId;
                const teamName = row.querySelector('td:nth-child(4)')?.textContent?.trim() || 'Unknown';
                const teamNum = row.querySelector('td:nth-child(3)')?.textContent?.trim() || '';
                wsTeams.push({ id: teamId, name: teamName, num: teamNum });
            });

            if (wsTeams.length === 0) {
                container.innerHTML = '<span class="text-gray-400">No WS Performance competitors found</span>';
                return;
            }

            if (wsRefMarkers.length === 0) {
                container.innerHTML = '<span class="text-gray-400">Add reference points first</span>';
                return;
            }

            let html = '<div class="space-y-2">';
            wsTeams.forEach(team => {
                const currentAssignment = wsCompetitorRefPoints[team.id] || '';
                html += `
                    <div class="flex items-center justify-between gap-2 bg-gray-50 p-2 rounded">
                        <span class="text-sm text-gray-700 truncate flex-1">${team.num ? '#' + team.num + ' ' : ''}${team.name}</span>
                        <select onchange="assignCompetitorRefPoint('${team.id}', this.value)"
                                class="px-2 py-1 border rounded text-sm">
                            <option value="">Not assigned</option>
                            ${wsRefMarkers.map((_, idx) => `
                                <option value="${idx}" ${currentAssignment === idx ? 'selected' : ''}>Point ${idx + 1}</option>
                            `).join('')}
                        </select>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function assignCompetitorRefPoint(competitorId, refPointIndex) {
            if (refPointIndex === '' || refPointIndex === null) {
                delete wsCompetitorRefPoints[competitorId];
            } else {
                wsCompetitorRefPoints[competitorId] = parseInt(refPointIndex);
            }
        }

        function addWsRefPointManual() {
            const lat = parseFloat(document.getElementById('wsRefLatInput').value);
            const lng = parseFloat(document.getElementById('wsRefLngInput').value);

            if (isNaN(lat) || isNaN(lng)) {
                alert('Please enter valid latitude and longitude values');
                return;
            }

            if (lat < -90 || lat > 90) {
                alert('Latitude must be between -90 and 90');
                return;
            }

            if (lng < -180 || lng > 180) {
                alert('Longitude must be between -180 and 180');
                return;
            }

            if (wsRefMarkers.length >= 4) {
                alert('Maximum 4 reference points. Remove one to add a new point.');
                return;
            }
            addWsRefMarker(lat, lng);

            wsRefMap.setView([lat, lng], 15);

            // Clear inputs
            document.getElementById('wsRefLatInput').value = '';
            document.getElementById('wsRefLngInput').value = '';
        }

        async function deleteScore() {
            if (!currentScoreId) {
                alert('No score to delete');
                return;
            }

            const teamId = document.getElementById('roundTeamId').value;
            const roundNum = document.getElementById('roundNumber').value;

            if (!confirm(`Are you sure you want to delete the score for Round ${roundNum}?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/delete-score/${teamId}/${currentScoreId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert('Score deleted successfully');
                    hideRoundModal();
                    preserveEventAndReload();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete score'));
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        }

        function hideRoundModal() {
            document.getElementById('roundModal').classList.add('hidden');
            // Stop video playback
            document.getElementById('roundVideoPlayer').pause();
            document.getElementById('roundVideoPlayer').src = '';

            // Clean up upload preview video
            const previewVideo = document.getElementById('uploadPreviewVideo');
            if (previewVideo && previewVideo.src) {
                previewVideo.pause();
                URL.revokeObjectURL(previewVideo.src);
                previewVideo.src = '';
            }

            // Reset start point state
            videoStartPoint = null;
            selectedVideoFile = null;

            // Hide remove video confirmation
            const removeConfirm = document.getElementById('removeVideoConfirm');
            if (removeConfirm) {
                removeConfirm.classList.add('hidden');
                document.getElementById('deleteVideoFile').checked = false;
            }
        }

        async function awardRejump() {
            const teamId = document.getElementById('roundTeamId').value;
            const roundNum = document.getElementById('roundNumber').value;
            const teamName = document.getElementById('roundTeamName').textContent;

            if (!confirm(`Award REJUMP for ${teamName} - Round ${roundNum}?\n\nThis will clear the current score and video, allowing a new video to be uploaded.`)) {
                return;
            }

            try {
                const response = await fetch(`/admin/team/${teamId}/rejump`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ round_num: parseInt(roundNum) })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    hideRoundModal();
                    preserveEventAndReload();
                } else {
                    alert(result.error || 'Failed to award rejump');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Training flag functions
        let currentScoreId = null;

        function showTrainingPanel() {
            document.getElementById('trainingPanel').classList.remove('hidden');
            loadTrainingVideos();
        }

        function hideTrainingPanel() {
            document.getElementById('trainingPanel').classList.add('hidden');
        }

        async function loadTrainingVideos() {
            const listEl = document.getElementById('trainingVideosList');
            listEl.innerHTML = '<p class="text-gray-500 text-center">Loading...</p>';

            try {
                const response = await fetch('/competition/' + compId + '/training-videos');
                const result = await response.json();

                if (result.videos && result.videos.length > 0) {
                    listEl.innerHTML = result.videos.map(v => `
                        <div class="flex items-center justify-between py-2 border-b border-gray-200 last:border-0">
                            <div>
                                <span class="font-medium">${v.team_name}</span>
                                <span class="text-gray-600 text-sm ml-2">Round ${v.round_num}</span>
                                ${v.score !== null ? `<span class="text-green-400 text-sm ml-2">Score: ${v.score}</span>` : ''}
                            </div>
                            <div class="text-gray-600 text-sm">
                                ${v.video_file || v.video_id || 'No video'}
                            </div>
                        </div>
                    `).join('');
                } else {
                    listEl.innerHTML = '<p class="text-gray-500 text-center">No videos flagged for training yet.<br>Use the checkbox in the round modal to flag videos.</p>';
                }

                document.getElementById('trainingCount').textContent = result.count || 0;
            } catch (err) {
                listEl.innerHTML = '<p class="text-red-400 text-center">Error loading training videos</p>';
            }
        }

        async function toggleTrainingFlag() {
            if (!currentScoreId) {
                alert('No score record found. Please save a score first.');
                document.getElementById('trainingFlagCheckbox').checked = false;
                return;
            }

            const checkbox = document.getElementById('trainingFlagCheckbox');
            const flagValue = checkbox.checked ? 1 : 0;

            try {
                const response = await fetch('/admin/score/' + currentScoreId + '/training-flag', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ training_flag: flagValue })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('modalStatusText').textContent = flagValue ? 'üéì Flagged for training' : 'Training flag removed';
                    setTimeout(() => {
                        document.getElementById('modalStatusText').textContent = '';
                    }, 2000);
                } else {
                    alert(result.error || 'Failed to update training flag');
                    checkbox.checked = !checkbox.checked;
                }
            } catch (err) {
                alert('Error: ' + err.message);
                checkbox.checked = !checkbox.checked;
            }
        }

        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedVideoFile = file;
                videoStartPoint = null;
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('selectedVideoName').textContent = file.name + ' (' + sizeMB + ' MB)';

                // Show start point section, hide file select
                document.getElementById('fileSelectControls').classList.add('hidden');
                document.getElementById('startPointControls').classList.remove('hidden');

                // Load video preview
                const previewVideo = document.getElementById('uploadPreviewVideo');
                const videoUrl = URL.createObjectURL(file);
                previewVideo.src = videoUrl;

                // Reset start point display
                document.getElementById('videoStartPointDisplay').innerHTML = '<span class="text-yellow-400">Not set</span>';
                document.getElementById('startPointWarning').classList.add('hidden');

                // Hide upload only button until start point is set
                document.getElementById('uploadOnlyBtn').classList.add('hidden');
            }
        }

        function setVideoStartPoint() {
            const previewVideo = document.getElementById('uploadPreviewVideo');
            videoStartPoint = parseFloat(previewVideo.currentTime.toFixed(2));

            // Update display
            document.getElementById('videoStartPointDisplay').innerHTML = '<span class="text-green-400">' + videoStartPoint.toFixed(2) + 's</span>';
            document.getElementById('startPointWarning').classList.add('hidden');

            // Show upload only button
            document.getElementById('uploadOnlyBtn').classList.remove('hidden');
        }

        function clearSelectedVideo() {
            selectedVideoFile = null;
            videoStartPoint = null;

            // Reset UI
            document.getElementById('fileSelectControls').classList.remove('hidden');
            document.getElementById('startPointControls').classList.add('hidden');
            document.getElementById('uploadOnlyBtn').classList.add('hidden');
            document.getElementById('roundVideoFile').value = '';
            document.getElementById('roundVideoCapture').value = '';

            // Clean up video preview
            const previewVideo = document.getElementById('uploadPreviewVideo');
            if (previewVideo && previewVideo.src) {
                URL.revokeObjectURL(previewVideo.src);
                previewVideo.src = '';
            }
        }

        async function uploadVideoOnly() {
            if (!selectedVideoFile) {
                alert('Please select a video first');
                return;
            }

            // Require start point
            if (videoStartPoint === null) {
                document.getElementById('startPointWarning').classList.remove('hidden');
                return;
            }

            const teamId = document.getElementById('roundTeamId').value;
            const roundNum = document.getElementById('roundNumber').value;
            const teamName = document.getElementById('roundTeamName').textContent;

            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadOnlyBtn').disabled = true;
            const saveRoundBtn = document.getElementById('saveRoundBtn');
            if (saveRoundBtn) saveRoundBtn.disabled = true;
            document.getElementById('uploadBar').style.width = '20%';
            document.getElementById('uploadStatus').textContent = 'Uploading video...';

            const formData = new FormData();
            formData.append('file', selectedVideoFile);
            formData.append('category', '{{ competition.event_type }}');
            formData.append('event', '{{ competition.name }}');
            formData.append('title', teamName + ' - Round ' + roundNum);

            try {
                document.getElementById('uploadBar').style.width = '50%';

                const uploadResponse = await fetch('/videographer/upload-video', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();

                if (uploadResult.success) {
                    document.getElementById('uploadBar').style.width = '60%';
                    document.getElementById('uploadStatus').textContent = 'Setting start point...';

                    // Save start point
                    const startTimeResponse = await fetch('/api/video/' + uploadResult.id + '/set-start-time', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ start_time: videoStartPoint })
                    });
                    const startTimeResult = await startTimeResponse.json();
                    if (!startTimeResult.success) {
                        console.error('Failed to save start time:', startTimeResult.error);
                    }

                    document.getElementById('uploadBar').style.width = '80%';
                    document.getElementById('uploadStatus').textContent = 'Linking to team...';

                    // Save score record with video but no score
                    const response = await fetch('/videographer/team/' + teamId + '/score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            round_num: parseInt(roundNum),
                            score: null,  // No score yet
                            video_id: uploadResult.id
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('uploadBar').style.width = '100%';
                        document.getElementById('uploadStatus').textContent = 'Video uploaded! Start: ' + videoStartPoint.toFixed(2) + 's';
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert(result.error || 'Failed to save');
                    }
                } else {
                    alert('Video upload failed: ' + uploadResult.error);
                }
            } catch (err) {
                alert('Upload error: ' + err.message);
            }

            document.getElementById('uploadOnlyBtn').disabled = false;
            document.getElementById('saveRoundBtn').disabled = false;
        }

        async function addTeam(e) {
            e.preventDefault();

            const data = {
                team_number: document.getElementById('teamNumber').value,
                team_name: document.getElementById('teamName').value,
                class: document.getElementById('teamClass').value,
                members: document.getElementById('teamMembers').value
            };

            // Handle event field based on multi-event vs single-event
            if (isMultiEvent) {
                data.event = document.getElementById('teamEvent').value;
                data.category = data.event;  // Use event as category for multi-event
            } else {
                const categoryEl = document.getElementById('teamCategory');
                const eventNameEl = document.getElementById('teamEventName');
                data.category = categoryEl ? categoryEl.value : '';
                data.event = eventNameEl ? eventNameEl.value : '';
            }

            try {
                const response = await fetch('/admin/competition/' + compId + '/add-team', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    // Upload photo if selected
                    if (selectedAddTeamPhotoFile && result.id) {
                        const formData = new FormData();
                        formData.append('file', selectedAddTeamPhotoFile);

                        try {
                            await fetch('/admin/team/' + result.id + '/upload-photo', {
                                method: 'POST',
                                body: formData
                            });
                        } catch (photoErr) {
                            console.error('Photo upload failed:', photoErr);
                        }
                    }
                    location.reload();
                } else {
                    alert(result.error || 'Failed to add team');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function importCSV(e) {
            e.preventDefault();

            const importType = document.getElementById('importType').value;
            const formData = new FormData();
            formData.append('file', document.getElementById('csvFile').files[0]);
            formData.append('import_type', importType);

            try {
                const response = await fetch('/admin/competition/' + compId + '/import-teams', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.error || 'Failed to import');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function saveRoundScore(e) {
            e.preventDefault();

            const teamId = document.getElementById('roundTeamId').value;
            const roundNum = document.getElementById('roundNumber').value;
            const existingVideoId = document.getElementById('existingVideoId').value;

            let score;
            let scoreData = '';

            // Check if this is a CP competition
            const cpScoreSection = document.getElementById('cpScoreSection');
            const isCpScoring = cpScoreSection && !cpScoreSection.classList.contains('hidden');

            // Check if this is a CF competition
            const cfScoreSection = document.getElementById('cfScoreSection');
            const isCfScoring = cfScoreSection && !cfScoreSection.classList.contains('hidden');

            console.log('isCpScoring:', isCpScoring, 'isCfScoring:', isCfScoring);

            if (isCpScoring) {
                // Get CP score (Zone Accuracy or Distance)
                const cpScoreValue = document.getElementById('cpScoreValue').value;
                const cpPenalty = document.getElementById('cpPenaltyValue').value;
                const cpEventType = currentCpEvent || 'zone';
                console.log('CP Scoring - Event:', cpEventType, 'Score Value:', cpScoreValue, 'Penalty:', cpPenalty);

                // Validate zone is selected for zone accuracy
                if (cpEventType === 'zone' && !cpPenalty && document.getElementById('cpLandingZone').value === '') {
                    alert('Please select a landing zone');
                    return;
                }

                // Validate distance is entered for distance scoring
                if (cpEventType === 'distance' && !cpPenalty) {
                    const distanceValue = document.getElementById('cpDistanceMeters').value;
                    console.log('Distance validation - value:', distanceValue, 'cpScoreValue:', cpScoreValue);
                    if (distanceValue === '' || distanceValue === null) {
                        alert('Please enter the distance in meters');
                        return;
                    }
                }

                // Validate time is entered for speed scoring
                if (cpEventType === 'speed' && !cpPenalty) {
                    const timeValue = document.getElementById('cpSpeedTime').value;
                    if (timeValue === '' || timeValue === null) {
                        alert('Please enter the time in seconds');
                        return;
                    }
                }

                // Check for penalty first
                if (cpPenalty) {
                    // Penalty takes precedence - store penalty code in score_data
                    // WL=35, OF/OC/CD=3 (DR), ME/DQ=0
                    if (cpPenalty === 'WL') {
                        score = 35;
                    } else if (['OF', 'OC', 'CD'].includes(cpPenalty)) {
                        score = 3;  // Default Result
                    } else {
                        score = 0;  // ME, DQ
                    }
                    scoreData = cpPenalty;
                } else {
                    score = parseFloat(cpScoreValue) || 0;

                    if (cpEventType === 'zone') {
                        // Build score_data JSON for CP Zone Accuracy
                        scoreData = JSON.stringify({
                            event: 'zone',
                            gates: {
                                entry: document.getElementById('cpGateEntry').checked,
                                g1: document.getElementById('cpGate1').checked,
                                g2: document.getElementById('cpGate2').checked,
                                g3: document.getElementById('cpGate3').checked,
                                g4: document.getElementById('cpGate4').checked
                            },
                            landingZone: parseInt(document.getElementById('cpLandingZone').value),
                            total: score
                        });
                    } else if (cpEventType === 'distance') {
                        // Build score_data JSON for CP Distance
                        scoreData = JSON.stringify({
                            event: 'distance',
                            gates: {
                                entry: document.getElementById('cpDistEntry').checked,
                                g4: document.getElementById('cpDistG4').checked
                            },
                            distance: parseFloat(document.getElementById('cpDistanceMeters').value) || 0,
                            total: score
                        });
                    } else if (cpEventType === 'speed') {
                        // Build score_data JSON for CP Speed
                        scoreData = JSON.stringify({
                            event: 'speed',
                            gates: {
                                g1: document.getElementById('cpSpeedG1').checked,
                                g2: document.getElementById('cpSpeedG2').checked,
                                g3: document.getElementById('cpSpeedG3').checked,
                                g4: document.getElementById('cpSpeedG4').checked,
                                g5: document.getElementById('cpSpeedG5').checked
                            },
                            time: parseFloat(document.getElementById('cpSpeedTime').value) || 0,
                            total: score
                        });
                    }
                }
            } else if (isCfScoring) {
                // Get CF-specific score
                const formations = parseInt(document.getElementById('cfFormations').value) || 0;
                const omissions = parseInt(document.getElementById('cfOmissions').value) || 0;
                const nvPenalty = document.getElementById('cfNvPenalty').checked;
                const cfScoreValue = document.getElementById('cfScoreValue').value;
                const cfEventType = document.getElementById('cfEventType').value || '4way';
                const penaltyPerOmission = cfEventType === '2way' ? 2 : 1;
                const totalPenalty = omissions * penaltyPerOmission;

                score = parseInt(cfScoreValue) || 0;

                // Build score_data JSON for CF
                scoreData = JSON.stringify({
                    event: cfEventType === '2way' ? 'cf_2way_sequential' : 'cf_4way_sequential',
                    formations: formations,
                    omissions: omissions,
                    penalty_per_omission: penaltyPerOmission,
                    total_penalty: totalPenalty,
                    nv_penalty: nvPenalty,
                    final_score: score
                });
            } else {
                // Standard scoring
                const scoreInput = document.getElementById('roundScore').value;

                // Validate score is entered
                if (scoreInput === '' || scoreInput === null) {
                    alert('Please enter a score');
                    return;
                }

                score = parseFloat(scoreInput);
            }

            let videoId = existingVideoId;  // Keep existing video if any

            // Show progress for CP/CF scoring (no video upload)
            if (isCpScoring || isCfScoring) {
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('uploadBar').style.width = '50%';
                document.getElementById('uploadStatus').textContent = 'Saving score...';
            }

            // Upload new video if selected
            if (selectedVideoFile) {
                document.getElementById('uploadProgress').classList.remove('hidden');
                document.getElementById('saveRoundBtn').disabled = true;
                document.getElementById('uploadOnlyBtn').disabled = true;
                document.getElementById('uploadBar').style.width = '30%';
                document.getElementById('uploadStatus').textContent = 'Uploading video...';

                const formData = new FormData();
                formData.append('file', selectedVideoFile);
                formData.append('category', '{{ competition.event_type }}');
                formData.append('event', '{{ competition.name }}');
                formData.append('title', document.getElementById('roundTeamName').textContent + ' - Round ' + roundNum);

                try {
                    document.getElementById('uploadBar').style.width = '60%';

                    const uploadResponse = await fetch('/videographer/upload-video', {
                        method: 'POST',
                        body: formData
                    });

                    const uploadResult = await uploadResponse.json();
                    if (uploadResult.success) {
                        videoId = uploadResult.id;
                        document.getElementById('uploadStatus').textContent = 'Video uploaded!';
                        document.getElementById('uploadBar').style.width = '80%';
                    } else {
                        alert('Video upload failed: ' + uploadResult.error);
                        document.getElementById('saveRoundBtn').disabled = false;
                        document.getElementById('uploadOnlyBtn').disabled = false;
                        return;
                    }
                } catch (err) {
                    alert('Video upload error: ' + err.message);
                    document.getElementById('saveRoundBtn').disabled = false;
                    document.getElementById('uploadOnlyBtn').disabled = false;
                    return;
                }
            }

            // Save score
            try {
                document.getElementById('uploadStatus').textContent = 'Saving score...';
                document.getElementById('uploadBar').style.width = '90%';

                // Check for CF working time penalty
                const cfPenaltyCheckbox = document.getElementById('cfPenaltyCheckbox');
                const exitTimePenalty = cfPenaltyCheckbox && cfPenaltyCheckbox.checked ? 1 : 0;

                console.log('Saving score:', { teamId, roundNum, score, scoreData, videoId });
                const response = await fetch('/admin/team/' + teamId + '/score', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        round_num: parseInt(roundNum),
                        score: score,
                        score_data: scoreData,
                        video_id: videoId,
                        exit_time_penalty: exitTimePenalty
                    })
                });

                const result = await response.json();
                console.log('Save result:', result);
                if (result.success) {
                    document.getElementById('uploadBar').style.width = '100%';
                    // Update currentScoreId so delete works for newly saved scores
                    if (result.score_id) {
                        currentScoreId = result.score_id;
                        // Show delete button now that we have a score
                        const deleteScoreBtn = document.getElementById('deleteScoreBtn');
                        if (deleteScoreBtn) deleteScoreBtn.style.display = 'block';
                    }

                    if (result.penalty_applied) {
                        document.getElementById('uploadStatus').textContent =
                            `Score saved! (Raw: ${result.raw_score}, Penalty: -${result.penalty_amount}, Final: ${result.final_score})`;
                    } else {
                        document.getElementById('uploadStatus').textContent = 'Score saved!';
                    }

                    // For CP scoring, play ding sound and auto-navigate to next competitor
                    if (isCpScoring) {
                        playDingSound(); // Audio feedback for judge
                        // Rebuild team list in case it wasn't built
                        if (cpTeamList.length === 0) {
                            buildCpTeamList();
                        }
                        console.log('CP Team List:', cpTeamList);
                        console.log('Current Team ID:', teamId);
                        const nextTeam = getNextCpTeam(teamId, parseInt(roundNum));
                        console.log('Next Team:', nextTeam);
                        if (nextTeam) {
                            document.getElementById('uploadStatus').textContent += ' Loading next competitor...';
                            setTimeout(() => {
                                // Reset the modal for next competitor
                                resetCpScoringForm();
                                openRoundModal(nextTeam.id, nextTeam.name, nextTeam.round, null, '', currentTeamCategory, null, 0);
                            }, 800);
                        } else {
                            // No more competitors, reload page
                            document.getElementById('uploadStatus').textContent += ' (Last competitor)';
                            setTimeout(() => {
                                hideRoundModal();
                                preserveEventAndReload();
                            }, 1000);
                        }
                    } else {
                        // Close modal and reload page after saving (preserve current event)
                        setTimeout(() => {
                            hideRoundModal();
                            preserveEventAndReload();
                        }, 500);
                    }
                } else {
                    alert(result.error || 'Failed to save score');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }

            document.getElementById('saveRoundBtn').disabled = false;
            document.getElementById('uploadOnlyBtn').disabled = false;
        }

        function showRemoveVideoConfirm() {
            document.getElementById('removeVideoConfirm').classList.remove('hidden');
        }

        function hideRemoveVideoConfirm() {
            document.getElementById('removeVideoConfirm').classList.add('hidden');
            document.getElementById('deleteVideoFile').checked = false;
        }

        async function removeVideoFromRound() {
            const teamId = document.getElementById('roundTeamId').value;
            const roundNum = document.getElementById('roundNumber').value;
            const deleteFile = document.getElementById('deleteVideoFile').checked;

            try {
                const response = await fetch('/admin/team/' + teamId + '/round/' + roundNum + '/remove-video', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delete_file: deleteFile })
                });

                const result = await response.json();
                if (result.success) {
                    alert('Video removed from round' + (result.deleted_file ? ' and file deleted' : ''));
                    location.reload();
                } else {
                    alert(result.error || 'Failed to remove video');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteTeam(teamId) {
            if (!confirm('Delete this team and all scores?')) return;

            try {
                const response = await fetch('/admin/team/' + teamId + '/delete', {
                    method: 'POST'
                });

                const result = await response.json();
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'Failed to delete team');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function deleteCompetition() {
            if (!confirm('Delete this competition and ALL teams/scores? This cannot be undone.')) return;
            if (!confirm('Are you SURE? All data will be permanently deleted.')) return;

            try {
                const response = await fetch('/admin/competition/{{ competition.id }}/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const text = await response.text();
                    console.error('Delete failed:', response.status, text);
                    alert('Failed to delete competition: ' + response.status);
                    return;
                }

                const result = await response.json();
                if (result.success) {
                    window.location.href = '/competitions';
                } else {
                    alert(result.error || 'Failed to delete competition');
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Error: ' + err.message);
            }
        }

        async function removeEvent(eventType) {
            if (!confirm(`Remove event "${eventType.toUpperCase()}" from this competition?\n\nThis will also remove all teams and scores for this event.`)) {
                return;
            }

            try {
                const response = await fetch('/admin/competition/{{ competition.id }}/remove-event', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ event_type: eventType })
                });

                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert(result.error || 'Failed to remove event');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // Default rounds for new events
        const newEventDefaultRounds = {
            'fs_4way_fs': 10, 'fs_4way_vfs': 10, 'fs_2way_mfs': 10, 'fs_8way': 10,
            'fs_16way': 6, 'fs_10way': 6,
            'cf_4way_rot': 8, 'cf_4way_seq': 8, 'cf_2way_open': 8, 'cf_2way_proam': 8,
            'ae_freestyle': 7, 'ae_freefly': 7,
            'cp_dsz': 9, 'cp_team': 9, 'cp_freestyle': 3,
            'ws_performance': 3, 'ws_acrobatic': 7,
            'sp_individual': 8, 'sp_mixed_team': 3,
            'al_individual': 8, 'al_team': 8,
            'default': 10
        };

        const newEventNames = {
            'fs_4way_fs': '4-Way FS', 'fs_4way_vfs': '4-Way VFS', 'fs_2way_mfs': '2-Way MFS',
            'fs_8way': '8-Way FS', 'fs_16way': '16-Way FS', 'fs_10way': '10-Way FS',
            'cf_4way_rot': '4-Way Rotation', 'cf_4way_seq': '4-Way Sequential',
            'cf_2way_open': '2-Way Sequential Open', 'cf_2way_proam': '2-Way Sequential Pro/Am',
            'al_individual': 'AL Individual', 'al_team': 'AL Team',
            'cp_dsz': 'CP Individual', 'cp_team': 'CP Team', 'cp_freestyle': 'CP Freestyle',
            'ae_freestyle': 'AE Freestyle', 'ae_freefly': 'AE Freefly',
            'ws_acrobatic': 'WS Acrobatic', 'ws_performance': 'WS Performance',
            'sp_individual': 'SP Individual', 'sp_mixed_team': 'SP Mixed Team'
        };

        function showAddEventModal() {
            document.getElementById('addEventModal').classList.remove('hidden');
            // Reset all checkboxes
            document.querySelectorAll('.new-event-checkbox').forEach(cb => {
                cb.checked = false;
            });
            updateNewEventSelection();
        }

        function hideAddEventModal() {
            document.getElementById('addEventModal').classList.add('hidden');
        }

        function updateNewEventSelection() {
            const selectedEvents = [];
            document.querySelectorAll('.new-event-checkbox:checked').forEach(cb => {
                selectedEvents.push(cb.value);
            });

            document.getElementById('newEventsSelectedCount').textContent = selectedEvents.length;

            const roundsSection = document.getElementById('newEventRoundsSection');
            const roundsList = document.getElementById('newEventRoundsList');

            if (selectedEvents.length === 0) {
                roundsSection.classList.add('hidden');
                roundsList.innerHTML = '';
                return;
            }

            roundsSection.classList.remove('hidden');
            roundsList.innerHTML = selectedEvents.map(eventId => {
                const defaultRoundCount = newEventDefaultRounds[eventId] || newEventDefaultRounds['default'];
                const displayName = newEventNames[eventId] || eventId.replace(/_/g, ' ').toUpperCase();
                return `
                    <div class="flex items-center justify-between gap-3 py-1">
                        <span class="text-sm text-gray-300">${displayName}</span>
                        <input type="number" data-event="${eventId}" value="${defaultRoundCount}" min="1" max="20"
                            class="w-20 px-2 py-1 rounded bg-gray-300 text-white text-center text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                `;
            }).join('');
        }

        // Attach event listeners to checkboxes
        document.querySelectorAll('.new-event-checkbox').forEach(cb => {
            cb.addEventListener('change', updateNewEventSelection);
        });

        async function addEventsToCompetition(e) {
            e.preventDefault();

            // Get selected events with their rounds
            const eventRounds = {};
            document.querySelectorAll('#newEventRoundsList input[data-event]').forEach(input => {
                eventRounds[input.dataset.event] = parseInt(input.value) || 10;
            });

            const selectedEvents = Object.keys(eventRounds);

            if (selectedEvents.length === 0) {
                alert('Please select at least one event type');
                return;
            }

            try {
                // Add each event
                for (const eventType of selectedEvents) {
                    const response = await fetch('/admin/competition/{{ competition.id }}/add-event', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            event_type: eventType,
                            rounds: eventRounds[eventType]
                        })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        alert(result.error || `Failed to add event ${eventType}`);
                        return;
                    }
                }

                alert(`Successfully added ${selectedEvents.length} event(s)`);
                location.reload();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ========================================
        // Keyboard shortcuts for video judging
        // ========================================
        const frameTime = 1/30;  // Assume 30fps for frame stepping
        let currentPlaybackRate = 1;

        function setPlaybackSpeed(speed) {
            const videoPlayer = document.getElementById('roundVideoPlayer');
            if (videoPlayer) {
                videoPlayer.playbackRate = speed;
                currentPlaybackRate = speed;
            }
        }

        // Keyboard controls for round modal video
        window.addEventListener('keydown', (e) => {
            // Only handle if round modal is open
            const roundModal = document.getElementById('roundModal');
            if (roundModal.classList.contains('hidden')) return;

            // Ignore if typing in an input, select, or textarea
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;

            const videoPlayer = document.getElementById('roundVideoPlayer');
            if (!videoPlayer || !videoPlayer.src) return;

            let handled = false;

            switch(e.code) {
                case 'Space':
                    if (videoPlayer.paused) {
                        videoPlayer.play();
                    } else {
                        videoPlayer.pause();
                    }
                    handled = true;
                    break;
                case 'ArrowLeft':
                    videoPlayer.pause();
                    videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - frameTime);
                    handled = true;
                    break;
                case 'ArrowRight':
                    videoPlayer.pause();
                    videoPlayer.currentTime = Math.min(videoPlayer.duration || 9999, videoPlayer.currentTime + frameTime);
                    handled = true;
                    break;
                case 'ArrowUp':
                    // Jump back 5 seconds
                    videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 5);
                    handled = true;
                    break;
                case 'ArrowDown':
                    // Jump forward 5 seconds
                    videoPlayer.currentTime = Math.min(videoPlayer.duration || 9999, videoPlayer.currentTime + 5);
                    handled = true;
                    break;
                case 'Digit1':
                    setPlaybackSpeed(0.25);
                    handled = true;
                    break;
                case 'Digit2':
                    setPlaybackSpeed(0.5);
                    handled = true;
                    break;
                case 'Digit3':
                    setPlaybackSpeed(0.75);
                    handled = true;
                    break;
                case 'Digit4':
                    setPlaybackSpeed(1);
                    handled = true;
                    break;
                case 'Digit5':
                    setPlaybackSpeed(1.5);
                    handled = true;
                    break;
                case 'Digit6':
                    setPlaybackSpeed(2);
                    handled = true;
                    break;
                case 'KeyG':
                    // Go to start time
                    const startTime = videoPlayer.dataset.startTime;
                    if (startTime) {
                        videoPlayer.currentTime = parseFloat(startTime);
                    }
                    handled = true;
                    break;
                case 'Escape':
                    hideRoundModal();
                    handled = true;
                    break;
            }

            if (handled) {
                e.preventDefault();
                e.stopPropagation();
            }
        }, true);

        // Prevent video from capturing keyboard events
        document.getElementById('roundVideoPlayer').addEventListener('focus', function() {
            this.blur();
        });

        // Click outside inputs to enable keyboard shortcuts
        document.getElementById('roundModal').addEventListener('click', (e) => {
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'SELECT' && e.target.tagName !== 'TEXTAREA') {
                if (document.activeElement && ['INPUT', 'SELECT', 'TEXTAREA'].includes(document.activeElement.tagName)) {
                    document.activeElement.blur();
                }
            }
        });

        // Initialize: show first event and class on page load
        document.addEventListener('DOMContentLoaded', function() {
            // For multi-event, show first event
            if (isMultiEvent && eventTypes.length > 0) {
                showEvent(eventTypes[0]);
            }

            const classSelector = document.getElementById('classSelector');
            if (classSelector && classSelector.value) {
                filterClass(classSelector.value);
            }

            // Start checking for background conversions
            checkBackgroundConversions();
        });

        // ============================================
        // Floating Conversion Status Indicator
        // ============================================
        let conversionCheckInterval = null;

        async function checkBackgroundConversions() {
            try {
                const response = await fetch('/conversion/all');
                const jobs = await response.json();

                const jobIds = Object.keys(jobs);
                const activeJobs = jobIds.filter(id => !['completed', 'failed'].includes(jobs[id].status));

                updateFloatingIndicator(jobs, activeJobs.length);

                if (activeJobs.length > 0 && !conversionCheckInterval) {
                    conversionCheckInterval = setInterval(checkBackgroundConversions, 3000);
                } else if (activeJobs.length === 0 && conversionCheckInterval) {
                    clearInterval(conversionCheckInterval);
                    conversionCheckInterval = null;
                }
            } catch (error) {
                console.error('Error checking conversions:', error);
            }
        }

        function updateFloatingIndicator(jobs, activeCount) {
            let indicator = document.getElementById('floatingConversionIndicator');

            const jobIds = Object.keys(jobs);
            if (jobIds.length === 0) {
                if (indicator) indicator.remove();
                return;
            }

            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'floatingConversionIndicator';
                indicator.className = 'fixed bottom-4 right-4 bg-gray-800 text-white rounded-lg shadow-lg p-4 max-w-sm z-50';
                document.body.appendChild(indicator);
            }

            const jobsHtml = jobIds.slice(0, 3).map(jobId => {
                const job = jobs[jobId];
                let statusIcon = '‚è≥';
                let statusClass = 'text-gray-400';

                if (job.status === 'completed') {
                    statusIcon = '‚úì';
                    statusClass = 'text-green-400';
                } else if (job.status === 'failed') {
                    statusIcon = '‚úó';
                    statusClass = 'text-red-400';
                } else if (job.status === 'converting' || job.status === 'generating_thumbnail') {
                    statusIcon = '‚öôÔ∏è';
                    statusClass = 'text-yellow-400';
                }

                return `<div class="text-sm ${statusClass} truncate">${statusIcon} ${job.title || job.filename}</div>`;
            }).join('');

            const moreCount = jobIds.length > 3 ? `<div class="text-xs text-gray-400">+${jobIds.length - 3} more</div>` : '';

            indicator.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="font-medium">${activeCount > 0 ? 'Converting...' : 'Conversions'}</span>
                    <button onclick="clearAndHideConversions()" class="text-gray-400 hover:text-white text-xs">
                        ${activeCount === 0 ? 'Clear' : 'Hide'}
                    </button>
                </div>
                ${jobsHtml}
                ${moreCount}
                ${activeCount > 0 ? `<div class="mt-2 w-full bg-gray-600 rounded-full h-1">
                    <div class="bg-yellow-500 h-1 rounded-full animate-pulse" style="width: 60%"></div>
                </div>` : ''}
            `;
        }

        async function clearAndHideConversions() {
            try {
                await fetch('/conversion/clear-completed', { method: 'POST' });
                const indicator = document.getElementById('floatingConversionIndicator');
                if (indicator) indicator.remove();
                checkBackgroundConversions();
            } catch (error) {
                console.error('Error clearing conversions:', error);
            }
        }
    </script>
</body>
</html>
