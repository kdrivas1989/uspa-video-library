<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videographer Upload - Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 p-4 sticky top-0 z-10">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-400">Video Library</a>
            <div class="flex items-center gap-4">
                <a href="/competitions" class="text-gray-400 hover:text-white">Competitions</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8 max-w-2xl">
        <h1 class="text-3xl font-bold mb-2">Videographer Upload</h1>
        <p class="text-gray-400 mb-8">Upload competition videos or FlysSight data for judging</p>

        <!-- Step 1: Select Event -->
        <div class="bg-gray-800 rounded-lg p-6 mb-4">
            <div class="flex items-center gap-3 mb-4">
                <span class="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold">1</span>
                <h2 class="text-xl font-bold">Select Event</h2>
            </div>
            <select id="eventSelect" onchange="loadTeams()"
                class="w-full px-4 py-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Select Competition --</option>
                {% for comp in competitions %}
                <option value="{{ comp.id }}" data-rounds="{{ comp.total_rounds }}" data-type="{{ comp.event_type }}" data-types="{{ comp.event_types|default('', true) }}">
                    {{ comp.name }}{% if comp.event_types %} (Multi-Event){% else %} ({{ comp.event_type|upper }}){% endif %}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Step 2: Select Team -->
        <div id="teamSection" class="bg-gray-800 rounded-lg p-6 mb-4 opacity-50 pointer-events-none">
            <div class="flex items-center gap-3 mb-4">
                <span class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold" id="step2Circle">2</span>
                <h2 class="text-xl font-bold">Select Team</h2>
            </div>
            <select id="teamSelect" onchange="loadRounds()"
                class="w-full px-4 py-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Select Team --</option>
            </select>
            <p id="teamCount" class="text-gray-500 text-sm mt-2"></p>
        </div>

        <!-- Step 3: Select Round -->
        <div id="roundSection" class="bg-gray-800 rounded-lg p-6 mb-4 opacity-50 pointer-events-none">
            <div class="flex items-center gap-3 mb-4">
                <span class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold" id="step3Circle">3</span>
                <h2 class="text-xl font-bold">Select Round</h2>
            </div>
            <select id="roundSelect" onchange="enableUpload()"
                class="w-full px-4 py-3 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">-- Select Round --</option>
            </select>
            <p id="roundStatus" class="text-gray-500 text-sm mt-2"></p>
            <p class="text-gray-500 text-xs mt-2 italic">If you don't see your round, a video has already been uploaded. Please contact an administrator.</p>
        </div>

        <!-- Step 4: Upload Video/FlysSight -->
        <div id="uploadSection" class="bg-gray-800 rounded-lg p-6 mb-4 opacity-50 pointer-events-none">
            <div class="flex items-center gap-3 mb-4">
                <span class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center font-bold" id="step4Circle">4</span>
                <h2 class="text-xl font-bold" id="step4Title">Upload Video</h2>
            </div>

            <!-- Upload Controls -->
            <div id="uploadControls">
                <!-- Step 4a: Select File (Video) -->
                <div id="fileSelectSection">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <!-- File Upload -->
                        <div>
                            <input type="file" id="videoFile" accept="video/*" class="hidden" onchange="handleVideoSelect(event)">
                            <button type="button" onclick="document.getElementById('videoFile').click()"
                                class="w-full px-4 py-6 rounded bg-gray-700 hover:bg-gray-600 text-center">
                                <span class="block text-3xl mb-2">üìÅ</span>
                                <span class="block text-sm">Select File</span>
                            </button>
                        </div>

                        <!-- Camera/Device Capture -->
                        <div>
                            <input type="file" id="videoCapture" accept="video/*" capture="environment" class="hidden" onchange="handleVideoSelect(event)">
                            <button type="button" onclick="document.getElementById('videoCapture').click()"
                                class="w-full px-4 py-6 rounded bg-gray-700 hover:bg-gray-600 text-center">
                                <span class="block text-3xl mb-2">üìπ</span>
                                <span class="block text-sm">From Camera</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 4a: Select FlysSight File (for Speed Skydiving) -->
                <div id="flysightSelectSection" class="hidden">
                    <div class="bg-blue-900/30 border border-blue-700 rounded-lg p-4 mb-4">
                        <p class="text-blue-300 text-sm">Speed Skydiving uses FlysSight GPS data instead of video.</p>
                    </div>
                    <input type="file" id="flysightFile" accept=".csv,.CSV" class="hidden" onchange="handleFlysightSelect(event)">
                    <button type="button" onclick="document.getElementById('flysightFile').click()"
                        class="w-full px-4 py-6 rounded bg-gray-700 hover:bg-gray-600 text-center">
                        <span class="block text-3xl mb-2">üìä</span>
                        <span class="block text-sm">Select FlysSight CSV</span>
                    </button>
                </div>

                <!-- Step 4b: Set Start Point (shown after video file selected) -->
                <div id="startPointSection" class="hidden">
                    <div class="mb-3 flex items-center justify-between">
                        <span id="selectedVideoName" class="text-sm text-gray-400"></span>
                        <button type="button" onclick="clearSelectedVideo()" class="text-red-400 text-sm hover:underline">Change File</button>
                    </div>

                    <!-- Video Preview -->
                    <div class="bg-black rounded-lg overflow-hidden mb-4">
                        <video id="previewVideo" controls class="w-full" style="max-height: 300px;">
                            Your browser does not support video playback.
                        </video>
                    </div>

                    <!-- Start Point Controls -->
                    <div class="bg-gray-700 rounded-lg p-4 mb-4">
                        <p class="text-gray-300 text-sm mb-3">Scrub to the start of the working time and click "Set Start Point"</p>
                        <div class="flex items-center gap-3">
                            <button type="button" onclick="setStartPoint()"
                                class="flex-1 px-4 py-3 rounded bg-blue-600 hover:bg-blue-700 font-medium">
                                Set Start Point
                            </button>
                            <div id="startPointDisplay" class="text-center px-4">
                                <div class="text-gray-500 text-xs">Start Point</div>
                                <div class="text-yellow-400 font-mono text-lg" id="startPointTime">Not set</div>
                            </div>
                        </div>
                        <p id="startPointWarning" class="text-red-400 text-xs mt-2 hidden">Please set a start point before uploading</p>
                    </div>

                    <!-- Upload Progress -->
                    <div id="uploadProgress" class="hidden mb-4">
                        <div class="bg-gray-700 rounded-full h-3 mb-2">
                            <div id="uploadBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p class="text-gray-400 text-sm text-center" id="uploadStatus">Uploading...</p>
                    </div>

                    <!-- Upload Button -->
                    <button id="uploadBtn" onclick="uploadVideo()" disabled
                        class="w-full px-4 py-4 rounded bg-green-600 hover:bg-green-700 disabled:bg-gray-600 disabled:cursor-not-allowed font-bold text-lg">
                        Upload Video
                    </button>
                </div>

                <!-- Step 4b: FlysSight file selected (for Speed Skydiving) -->
                <div id="flysightReadySection" class="hidden">
                    <div class="mb-3 flex items-center justify-between">
                        <span id="selectedFlysightName" class="text-sm text-gray-400"></span>
                        <button type="button" onclick="clearSelectedFlysight()" class="text-red-400 text-sm hover:underline">Change File</button>
                    </div>

                    <div class="bg-green-900/30 border border-green-700 rounded-lg p-4 mb-4">
                        <p class="text-green-300 text-sm">FlysSight file ready for upload</p>
                    </div>

                    <!-- Upload Progress -->
                    <div id="flysightUploadProgress" class="hidden mb-4">
                        <div class="bg-gray-700 rounded-full h-3 mb-2">
                            <div id="flysightUploadBar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                        </div>
                        <p class="text-gray-400 text-sm text-center" id="flysightUploadStatus">Uploading...</p>
                    </div>

                    <!-- Upload Button -->
                    <button id="flysightUploadBtn" onclick="uploadFlysight()"
                        class="w-full px-4 py-4 rounded bg-green-600 hover:bg-green-700 font-bold text-lg">
                        Upload FlysSight Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="successMessage" class="hidden bg-green-900/50 border border-green-700 rounded-lg p-6 text-center">
            <span class="text-5xl block mb-4">‚úì</span>
            <h3 class="text-xl font-bold text-green-400 mb-2">Upload Complete!</h3>
            <p class="text-gray-300 mb-4" id="successText">Video uploaded successfully.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="resetForm()" class="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600">
                    Upload Another
                </button>
                <a href="/competitions" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">
                    View Competitions
                </a>
            </div>
        </div>
    </div>

    <script>
        let selectedVideoFile = null;
        let selectedFlysightFile = null;
        let currentCompetition = null;
        let currentTeams = [];
        let currentTeam = null;
        let totalRounds = 10;
        let videoStartPoint = null;
        let isFlysightEvent = false;

        // Categories with file types (from server)
        const FLYSIGHT_EVENTS = ['sp'];  // Speed Skydiving uses FlysSight

        function loadTeams() {
            const eventSelect = document.getElementById('eventSelect');
            const compId = eventSelect.value;

            if (!compId) {
                disableSection('teamSection', 'step2Circle');
                disableSection('roundSection', 'step3Circle');
                disableSection('uploadSection', 'step4Circle');
                return;
            }

            // Get total rounds and event types from data attribute
            const option = eventSelect.options[eventSelect.selectedIndex];
            totalRounds = parseInt(option.dataset.rounds) || 10;
            const eventTypes = option.dataset.types;
            const isMultiEvent = eventTypes && eventTypes.length > 5;  // JSON array will be longer than empty/single
            currentCompetition = {
                id: compId,
                event_type: option.dataset.type,
                is_multi_event: isMultiEvent
            };

            // Enable team section
            enableSection('teamSection', 'step2Circle');

            // Fetch teams for this competition
            fetch('/api/competition/' + compId + '/teams')
                .then(r => r.json())
                .then(teams => {
                    currentTeams = teams;
                    const teamSelect = document.getElementById('teamSelect');
                    teamSelect.innerHTML = '<option value="">-- Select Team --</option>';

                    // Sort teams - by event then by number for multi-event
                    if (isMultiEvent) {
                        teams.sort((a, b) => {
                            const eventCompare = (a.event || '').localeCompare(b.event || '');
                            if (eventCompare !== 0) return eventCompare;
                            return (a.team_number || '').localeCompare(b.team_number || '');
                        });
                    }

                    teams.forEach(team => {
                        const opt = document.createElement('option');
                        opt.value = team.id;
                        // Show event type for multi-event competitions
                        if (isMultiEvent && team.event) {
                            opt.textContent = '[' + team.event.toUpperCase() + '] #' + team.team_number + ' - ' + team.team_name + ' (' + team.class + ')';
                        } else {
                            opt.textContent = '#' + team.team_number + ' - ' + team.team_name + ' (' + team.class + ')';
                        }
                        teamSelect.appendChild(opt);
                    });

                    document.getElementById('teamCount').textContent = teams.length + ' teams';
                })
                .catch(err => {
                    console.error('Error loading teams:', err);
                    document.getElementById('teamCount').textContent = 'Error loading teams';
                });

            // Disable subsequent sections
            disableSection('roundSection', 'step3Circle');
            disableSection('uploadSection', 'step4Circle');
        }

        function loadRounds() {
            const teamSelect = document.getElementById('teamSelect');
            const teamId = teamSelect.value;

            if (!teamId) {
                disableSection('roundSection', 'step3Circle');
                disableSection('uploadSection', 'step4Circle');
                return;
            }

            // Find selected team data
            currentTeam = currentTeams.find(t => t.id === teamId);

            // Enable round section
            enableSection('roundSection', 'step3Circle');

            const roundSelect = document.getElementById('roundSelect');
            roundSelect.innerHTML = '<option value="">-- Select Round --</option>';

            let availableRounds = 0;
            for (let i = 1; i <= totalRounds; i++) {
                // Check if this round has a video
                const roundScore = currentTeam.scores ? currentTeam.scores.find(s => s.round_num === i) : null;
                const hasVideo = roundScore && roundScore.video_id;

                // Skip rounds that already have videos
                if (hasVideo) {
                    continue;
                }

                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = 'Round ' + i;
                roundSelect.appendChild(opt);
                availableRounds++;
            }

            // Update status based on available rounds
            const roundStatus = document.getElementById('roundStatus');
            if (availableRounds === 0) {
                roundStatus.textContent = 'All rounds have videos uploaded';
                roundStatus.classList.add('text-green-400');
            } else {
                roundStatus.textContent = availableRounds + ' round(s) need video';
                roundStatus.classList.remove('text-green-400');
            }

            // Disable upload section
            disableSection('uploadSection', 'step4Circle');
        }

        function enableUpload() {
            const roundSelect = document.getElementById('roundSelect');
            const roundNum = roundSelect.value;

            if (!roundNum) {
                disableSection('uploadSection', 'step4Circle');
                return;
            }

            // Check if this is a FlysSight event based on team's event type
            const teamEvent = currentTeam ? (currentTeam.event || currentCompetition.event_type) : currentCompetition.event_type;
            isFlysightEvent = FLYSIGHT_EVENTS.includes(teamEvent);

            // Update UI based on file type
            if (isFlysightEvent) {
                document.getElementById('step4Title').textContent = 'Upload FlysSight Data';
                document.getElementById('fileSelectSection').classList.add('hidden');
                document.getElementById('startPointSection').classList.add('hidden');
                document.getElementById('flysightSelectSection').classList.remove('hidden');
                document.getElementById('flysightReadySection').classList.add('hidden');
                clearSelectedFlysight();
            } else {
                document.getElementById('step4Title').textContent = 'Upload Video';
                document.getElementById('fileSelectSection').classList.remove('hidden');
                document.getElementById('startPointSection').classList.add('hidden');
                document.getElementById('flysightSelectSection').classList.add('hidden');
                document.getElementById('flysightReadySection').classList.add('hidden');
                clearSelectedVideo();
            }

            // Enable upload section - all rounds in dropdown are available (no video yet)
            enableSection('uploadSection', 'step4Circle');
        }

        function enableSection(sectionId, circleId) {
            const section = document.getElementById(sectionId);
            const circle = document.getElementById(circleId);
            section.classList.remove('opacity-50', 'pointer-events-none');
            circle.classList.remove('bg-gray-600');
            circle.classList.add('bg-blue-600');
        }

        function disableSection(sectionId, circleId) {
            const section = document.getElementById(sectionId);
            const circle = document.getElementById(circleId);
            section.classList.add('opacity-50', 'pointer-events-none');
            circle.classList.remove('bg-blue-600');
            circle.classList.add('bg-gray-600');
        }

        function parseFilename(filename) {
            // Parse filename like "3_23_4201_1.mp4" or "3 23 4201 1.mp4"
            // Returns { teamNumber: "4201", round: "1" } or null
            const nameWithoutExt = filename.replace(/\.[^/.]+$/, ''); // Remove extension
            const parts = nameWithoutExt.split(/[_\s-]+/); // Split by underscore, space, or dash

            if (parts.length >= 4) {
                // Format: X_X_TEAM_ROUND (team is 3rd part, round is 4th)
                return {
                    teamNumber: parts[2],
                    round: parts[3]
                };
            }
            return null;
        }

        function autoSelectFromFilename(filename) {
            const parsed = parseFilename(filename);
            if (!parsed || !currentTeams || currentTeams.length === 0) {
                return false;
            }

            // Find team with matching team_number
            const matchingTeam = currentTeams.find(t => t.team_number === parsed.teamNumber);
            if (matchingTeam) {
                // Select the team
                const teamSelect = document.getElementById('teamSelect');
                teamSelect.value = matchingTeam.id;
                loadRounds();

                // Wait for rounds to load, then select the round
                setTimeout(() => {
                    const roundSelect = document.getElementById('roundSelect');
                    // Find the option with matching round number
                    for (let i = 0; i < roundSelect.options.length; i++) {
                        if (roundSelect.options[i].value === parsed.round) {
                            roundSelect.value = parsed.round;
                            enableUpload();
                            break;
                        }
                    }
                }, 300);

                return true;
            }
            return false;
        }

        function handleVideoSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedVideoFile = file;
                videoStartPoint = null;
                const sizeMB = (file.size / 1024 / 1024).toFixed(2);
                document.getElementById('selectedVideoName').textContent = file.name + ' (' + sizeMB + ' MB)';

                // Try to auto-select team and round from filename
                if (currentTeams && currentTeams.length > 0) {
                    const autoSelected = autoSelectFromFilename(file.name);
                    if (autoSelected) {
                        console.log('Auto-selected team and round from filename:', file.name);
                    }
                }

                // Show start point section, hide file select
                document.getElementById('fileSelectSection').classList.add('hidden');
                document.getElementById('startPointSection').classList.remove('hidden');

                // Load video preview
                const previewVideo = document.getElementById('previewVideo');
                const videoUrl = URL.createObjectURL(file);
                previewVideo.src = videoUrl;

                // Reset start point display
                document.getElementById('startPointTime').textContent = 'Not set';
                document.getElementById('startPointTime').classList.remove('text-green-400');
                document.getElementById('startPointTime').classList.add('text-yellow-400');
                document.getElementById('startPointWarning').classList.add('hidden');
                document.getElementById('uploadBtn').disabled = true;
            }
        }

        function setStartPoint() {
            const previewVideo = document.getElementById('previewVideo');
            videoStartPoint = parseFloat(previewVideo.currentTime.toFixed(2));

            // Update display
            document.getElementById('startPointTime').textContent = videoStartPoint.toFixed(2) + 's';
            document.getElementById('startPointTime').classList.remove('text-yellow-400');
            document.getElementById('startPointTime').classList.add('text-green-400');
            document.getElementById('startPointWarning').classList.add('hidden');

            // Enable upload button
            document.getElementById('uploadBtn').disabled = false;
        }

        function clearSelectedVideo() {
            selectedVideoFile = null;
            videoStartPoint = null;

            // Reset UI
            document.getElementById('fileSelectSection').classList.remove('hidden');
            document.getElementById('startPointSection').classList.add('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('videoFile').value = '';
            document.getElementById('videoCapture').value = '';

            // Clean up video preview
            const previewVideo = document.getElementById('previewVideo');
            if (previewVideo.src) {
                URL.revokeObjectURL(previewVideo.src);
                previewVideo.src = '';
            }
        }

        function handleFlysightSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFlysightFile = file;
                const sizeKB = (file.size / 1024).toFixed(2);
                document.getElementById('selectedFlysightName').textContent = file.name + ' (' + sizeKB + ' KB)';

                // Show ready section, hide file select
                document.getElementById('flysightSelectSection').classList.add('hidden');
                document.getElementById('flysightReadySection').classList.remove('hidden');
            }
        }

        function clearSelectedFlysight() {
            selectedFlysightFile = null;

            // Reset UI
            document.getElementById('flysightSelectSection').classList.remove('hidden');
            document.getElementById('flysightReadySection').classList.add('hidden');
            document.getElementById('flysightFile').value = '';
        }

        async function uploadFlysight() {
            if (!selectedFlysightFile) {
                alert('Please select a FlysSight file first');
                return;
            }

            const teamId = document.getElementById('teamSelect').value;
            const roundNum = document.getElementById('roundSelect').value;
            const eventSelect = document.getElementById('eventSelect');
            const eventName = eventSelect.options[eventSelect.selectedIndex].textContent;
            const teamName = currentTeam ? currentTeam.team_name : 'Team';

            // Show progress
            document.getElementById('flysightUploadProgress').classList.remove('hidden');
            document.getElementById('flysightUploadBtn').disabled = true;
            document.getElementById('flysightUploadBar').style.width = '10%';
            document.getElementById('flysightUploadStatus').textContent = 'Preparing upload...';

            const formData = new FormData();
            formData.append('file', selectedFlysightFile);
            formData.append('category', 'sp');
            formData.append('event', eventName);
            formData.append('title', teamName + ' - Round ' + roundNum);
            formData.append('file_type', 'flysight');

            try {
                document.getElementById('flysightUploadBar').style.width = '30%';
                document.getElementById('flysightUploadStatus').textContent = 'Uploading FlysSight data...';

                const uploadResponse = await fetch('/videographer/upload-flysight', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();

                if (uploadResult.success) {
                    document.getElementById('flysightUploadBar').style.width = '70%';
                    document.getElementById('flysightUploadStatus').textContent = 'Linking to team...';

                    // Save score record with flysight data
                    const response = await fetch('/videographer/team/' + teamId + '/score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            round_num: parseInt(roundNum),
                            score: null,
                            video_id: uploadResult.id  // Store flysight ID in video_id field
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('flysightUploadBar').style.width = '100%';
                        document.getElementById('flysightUploadStatus').textContent = 'Complete!';

                        // Show success message
                        document.getElementById('successText').textContent =
                            'FlysSight data uploaded for ' + teamName + ' - Round ' + roundNum + '. Ready for judging.';
                        document.getElementById('successMessage').classList.remove('hidden');

                        // Hide upload section
                        document.getElementById('uploadSection').classList.add('hidden');
                    } else {
                        alert('Failed to link FlysSight data: ' + (result.error || 'Unknown error'));
                        document.getElementById('flysightUploadBtn').disabled = false;
                    }
                } else {
                    alert('FlysSight upload failed: ' + (uploadResult.error || 'Unknown error'));
                    document.getElementById('flysightUploadBtn').disabled = false;
                }
            } catch (err) {
                alert('Upload error: ' + err.message);
                document.getElementById('flysightUploadBtn').disabled = false;
            }
        }

        async function uploadVideo() {
            if (!selectedVideoFile) {
                alert('Please select a video first');
                return;
            }

            // Require start point to be set
            if (videoStartPoint === null) {
                document.getElementById('startPointWarning').classList.remove('hidden');
                return;
            }

            const teamId = document.getElementById('teamSelect').value;
            const roundNum = document.getElementById('roundSelect').value;
            const eventSelect = document.getElementById('eventSelect');
            const eventName = eventSelect.options[eventSelect.selectedIndex].textContent;
            const teamName = currentTeam ? currentTeam.team_name : 'Team';

            // Show progress
            document.getElementById('uploadProgress').classList.remove('hidden');
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBar').style.width = '10%';
            document.getElementById('uploadStatus').textContent = 'Preparing upload...';

            const formData = new FormData();
            formData.append('file', selectedVideoFile);
            formData.append('category', currentCompetition.event_type);
            formData.append('event', eventName);
            formData.append('title', teamName + ' - Round ' + roundNum);

            try {
                document.getElementById('uploadBar').style.width = '30%';
                document.getElementById('uploadStatus').textContent = 'Uploading video...';

                const uploadResponse = await fetch('/videographer/upload-video', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();

                if (uploadResult.success) {
                    document.getElementById('uploadBar').style.width = '50%';
                    document.getElementById('uploadStatus').textContent = 'Setting start point...';

                    // Save start point
                    const startTimeResponse = await fetch('/api/video/' + uploadResult.id + '/set-start-time', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ start_time: videoStartPoint })
                    });
                    const startTimeResult = await startTimeResponse.json();
                    if (!startTimeResult.success) {
                        console.error('Failed to save start time:', startTimeResult.error);
                        alert('Warning: Video uploaded but start point may not have saved. Error: ' + (startTimeResult.error || 'Unknown'));
                    }

                    document.getElementById('uploadBar').style.width = '70%';
                    document.getElementById('uploadStatus').textContent = 'Linking to team...';

                    // Save score record with video but no score
                    const response = await fetch('/videographer/team/' + teamId + '/score', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            round_num: parseInt(roundNum),
                            score: null,
                            video_id: uploadResult.id
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('uploadBar').style.width = '100%';
                        document.getElementById('uploadStatus').textContent = 'Complete!';

                        // Show success message
                        document.getElementById('successText').textContent =
                            'Video uploaded for ' + teamName + ' - Round ' + roundNum + ' (start: ' + videoStartPoint.toFixed(2) + 's). Ready for judging.';
                        document.getElementById('successMessage').classList.remove('hidden');

                        // Hide upload section
                        document.getElementById('uploadSection').classList.add('hidden');
                    } else {
                        alert('Failed to link video: ' + (result.error || 'Unknown error'));
                        document.getElementById('uploadBtn').disabled = false;
                    }
                } else {
                    alert('Video upload failed: ' + (uploadResult.error || 'Unknown error'));
                    document.getElementById('uploadBtn').disabled = false;
                }
            } catch (err) {
                alert('Upload error: ' + err.message);
                document.getElementById('uploadBtn').disabled = false;
            }
        }

        function resetForm() {
            // Reset all selections
            document.getElementById('eventSelect').value = '';
            document.getElementById('teamSelect').innerHTML = '<option value="">-- Select Team --</option>';
            document.getElementById('roundSelect').innerHTML = '<option value="">-- Select Round --</option>';

            // Reset file selection
            clearSelectedVideo();

            // Reset start point section
            document.getElementById('fileSelectSection').classList.remove('hidden');
            document.getElementById('startPointSection').classList.add('hidden');
            document.getElementById('startPointTime').textContent = 'Not set';
            document.getElementById('startPointWarning').classList.add('hidden');

            // Reset progress
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('uploadBar').style.width = '0%';

            // Hide success message
            document.getElementById('successMessage').classList.add('hidden');

            // Show and disable sections
            document.getElementById('uploadSection').classList.remove('hidden');
            disableSection('teamSection', 'step2Circle');
            disableSection('roundSection', 'step3Circle');
            disableSection('uploadSection', 'step4Circle');

            // Reset state
            selectedVideoFile = null;
            videoStartPoint = null;
            currentCompetition = null;
            currentTeams = [];
            currentTeam = null;
        }

        // ============================================
        // Floating Conversion Status Indicator
        // ============================================
        let conversionCheckInterval = null;

        async function checkBackgroundConversions() {
            try {
                const response = await fetch('/conversion/all');
                const jobs = await response.json();

                const jobIds = Object.keys(jobs);
                const activeJobs = jobIds.filter(id => !['completed', 'failed'].includes(jobs[id].status));

                updateFloatingIndicator(jobs, activeJobs.length);

                if (activeJobs.length > 0 && !conversionCheckInterval) {
                    conversionCheckInterval = setInterval(checkBackgroundConversions, 3000);
                } else if (activeJobs.length === 0 && conversionCheckInterval) {
                    clearInterval(conversionCheckInterval);
                    conversionCheckInterval = null;
                }
            } catch (error) {
                console.error('Error checking conversions:', error);
            }
        }

        function updateFloatingIndicator(jobs, activeCount) {
            let indicator = document.getElementById('floatingConversionIndicator');

            const jobIds = Object.keys(jobs);
            if (jobIds.length === 0) {
                if (indicator) indicator.remove();
                return;
            }

            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'floatingConversionIndicator';
                indicator.className = 'fixed bottom-4 right-4 bg-gray-800 text-white rounded-lg shadow-lg p-4 max-w-sm z-50';
                document.body.appendChild(indicator);
            }

            const jobsHtml = jobIds.slice(0, 3).map(jobId => {
                const job = jobs[jobId];
                let statusIcon = '‚è≥';
                let statusClass = 'text-gray-400';

                if (job.status === 'completed') {
                    statusIcon = '‚úì';
                    statusClass = 'text-green-400';
                } else if (job.status === 'failed') {
                    statusIcon = '‚úó';
                    statusClass = 'text-red-400';
                } else if (job.status === 'converting' || job.status === 'generating_thumbnail') {
                    statusIcon = '‚öôÔ∏è';
                    statusClass = 'text-yellow-400';
                }

                return `<div class="text-sm ${statusClass} truncate">${statusIcon} ${job.title || job.filename}</div>`;
            }).join('');

            const moreCount = jobIds.length > 3 ? `<div class="text-xs text-gray-400">+${jobIds.length - 3} more</div>` : '';

            indicator.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <span class="font-medium">${activeCount > 0 ? 'Converting...' : 'Conversions'}</span>
                    <button onclick="clearAndHideConversions()" class="text-gray-400 hover:text-white text-xs">
                        ${activeCount === 0 ? 'Clear' : 'Hide'}
                    </button>
                </div>
                ${jobsHtml}
                ${moreCount}
                ${activeCount > 0 ? `<div class="mt-2 w-full bg-gray-600 rounded-full h-1">
                    <div class="bg-yellow-500 h-1 rounded-full animate-pulse" style="width: 60%"></div>
                </div>` : ''}
            `;
        }

        async function clearAndHideConversions() {
            try {
                await fetch('/conversion/clear-completed', { method: 'POST' });
                const indicator = document.getElementById('floatingConversionIndicator');
                if (indicator) indicator.remove();
                checkBackgroundConversions();
            } catch (error) {
                console.error('Error clearing conversions:', error);
            }
        }

        // Check for conversions on page load
        document.addEventListener('DOMContentLoaded', checkBackgroundConversions);
    </script>
</body>
</html>
