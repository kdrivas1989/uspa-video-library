<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sync Viewing - {{ video.title }} - Video Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-400">Video Library</a>
            <div class="flex items-center gap-4">
                <span class="text-gray-400">Room: <span class="text-white font-mono">{{ room_id }}</span></span>
                <a href="/my-assignments" class="text-gray-400 hover:text-white">Back to Assignments</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-6">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Video Player -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg overflow-hidden">
                    <div class="aspect-video bg-black relative">
                        <video id="syncVideo" class="w-full h-full"
                            {% if video.url %}src="{{ video.url }}"{% endif %}
                            preload="auto">
                        </video>
                        <!-- Overlay when waiting -->
                        <div id="waitingOverlay" class="absolute inset-0 bg-black/80 flex items-center justify-center">
                            <div class="text-center">
                                <div id="overlayIcon" class="text-6xl mb-4">
                                    {% if is_event_judge %}
                                    ▶️
                                    {% else %}
                                    ⏳
                                    {% endif %}
                                </div>
                                <p id="overlayText" class="text-xl">
                                    {% if is_event_judge %}
                                    Press Play to start synchronized viewing
                                    {% else %}
                                    Waiting for Event Judge to start...
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        <!-- Press X overlay -->
                        <div id="pressXOverlay" class="absolute inset-0 bg-blue-900/90 flex items-center justify-center hidden">
                            <div class="text-center">
                                <div class="text-8xl mb-4 animate-pulse">X</div>
                                <p class="text-2xl">Press X to start video!</p>
                                <p class="text-gray-300 mt-2">All judges must press within 0.5 seconds</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-4">
                        <h1 class="text-xl font-bold">{{ video.title }}</h1>
                        <p class="text-gray-400 mt-1">{{ categories.get(video.category, {}).get('name', 'Unknown Category') }}</p>
                    </div>
                </div>

                <!-- Event Judge Controls -->
                {% if is_event_judge %}
                <div class="bg-gray-800 rounded-lg p-4 mt-4">
                    <h3 class="font-bold mb-3">Event Judge Controls</h3>
                    <div class="flex gap-4">
                        <button id="playBtn" onclick="startSyncPlayback()"
                            class="bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg font-bold text-lg flex items-center gap-2">
                            <span>▶</span> Start Synchronized Playback
                        </button>
                        <button onclick="resetRoom()"
                            class="bg-gray-600 hover:bg-gray-700 px-4 py-3 rounded-lg">
                            Reset
                        </button>
                    </div>
                    <p class="text-gray-400 text-sm mt-2">All judges must press X within 0.5 seconds of each other to start.</p>
                </div>
                {% endif %}

                <!-- Status Messages -->
                <div id="statusMessages" class="mt-4 space-y-2"></div>
            </div>

            <!-- Judges Panel -->
            <div class="lg:col-span-1">
                <div class="bg-gray-800 rounded-lg p-4 sticky top-20">
                    <h3 class="font-bold mb-4">Judges in Room</h3>

                    <!-- Room State -->
                    <div class="mb-4 p-3 rounded-lg" id="roomStateBox">
                        <span id="roomStateText" class="font-medium">Waiting...</span>
                    </div>

                    <!-- Event Judge -->
                    <div class="mb-4">
                        <p class="text-gray-400 text-sm mb-2">Event Judge</p>
                        <div class="flex items-center gap-2 bg-gray-700 rounded p-3">
                            <span class="w-3 h-3 rounded-full bg-green-500"></span>
                            <span>{{ room.event_judge }}</span>
                            {% if is_event_judge %}
                            <span class="text-xs text-blue-400 ml-auto">(You)</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Judges List -->
                    <div>
                        <p class="text-gray-400 text-sm mb-2">Judges (<span id="judgeCount">0</span>)</p>
                        <div id="judgesList" class="space-y-2">
                            <p class="text-gray-500 text-sm">No judges connected yet</p>
                        </div>
                    </div>

                    <!-- Share Room -->
                    <div class="mt-6 pt-4 border-t border-gray-700">
                        <p class="text-gray-400 text-sm mb-2">Share Room Link</p>
                        <div class="flex gap-2">
                            <input type="text" readonly value="{{ request.url }}"
                                class="flex-1 bg-gray-700 text-white px-3 py-2 rounded text-sm" id="roomLink">
                            <button onclick="copyRoomLink()" class="bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded text-sm">
                                Copy
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const roomId = '{{ room_id }}';
        const username = '{{ username }}';
        const isEventJudge = {{ 'true' if is_event_judge else 'false' }};

        // Connect to the same origin (works for both localhost and production)
        const socketUrl = window.location.origin;
        const socket = io(socketUrl, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000
        });
        const video = document.getElementById('syncVideo');
        const waitingOverlay = document.getElementById('waitingOverlay');
        const pressXOverlay = document.getElementById('pressXOverlay');
        const overlayText = document.getElementById('overlayText');
        const overlayIcon = document.getElementById('overlayIcon');
        const statusMessages = document.getElementById('statusMessages');

        let canPressX = false;

        // Connect to room
        socket.on('connect', () => {
            socket.emit('join_sync_room', {
                room_id: roomId,
                username: username,
                is_event_judge: isEventJudge
            });
            addStatus('Connected to sync room', 'success');
        });

        socket.on('disconnect', () => {
            addStatus('Disconnected from server', 'error');
        });

        // Room updates
        socket.on('room_update', (data) => {
            updateJudgesList(data.judges);
            updateRoomState(data.state);
            if (data.waiting_for) {
                addStatus(`Waiting for: ${data.waiting_for.join(', ')}`, 'info');
            }
        });

        // Prepare to start (judges need to press X)
        socket.on('prepare_to_start', (data) => {
            waitingOverlay.classList.add('hidden');
            pressXOverlay.classList.remove('hidden');
            canPressX = true;
            addStatus('Press X to start video!', 'warning');
        });

        // Sync successful - play video
        socket.on('sync_play', (data) => {
            pressXOverlay.classList.add('hidden');
            waitingOverlay.classList.add('hidden');
            canPressX = false;
            video.currentTime = 0;
            video.play();
            addStatus(data.message, 'success');
            updateRoomState('playing');
        });

        // Sync failed - reset
        socket.on('sync_failed', (data) => {
            pressXOverlay.classList.add('hidden');
            waitingOverlay.classList.remove('hidden');
            canPressX = false;
            video.pause();
            video.currentTime = 0;
            addStatus(data.message, 'error');
            updateRoomState('waiting');

            if (isEventJudge) {
                overlayText.textContent = 'Sync failed. Press Play to try again.';
            } else {
                overlayText.textContent = 'Sync failed. Waiting for Event Judge...';
            }
        });

        socket.on('error', (data) => {
            addStatus(data.message, 'error');
        });

        // Keyboard handler for X key
        document.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'x' && canPressX && !isEventJudge) {
                canPressX = false;
                const pressTime = Date.now() / 1000;
                socket.emit('judge_start_video', {
                    room_id: roomId,
                    username: username,
                    press_time: pressTime
                });
                pressXOverlay.querySelector('div').innerHTML = `
                    <div class="text-6xl mb-4">✓</div>
                    <p class="text-xl">Waiting for other judges...</p>
                `;
                addStatus('You pressed X! Waiting for others...', 'info');
            }
        });

        // Event judge starts sync playback
        function startSyncPlayback() {
            if (!isEventJudge) return;

            const judgeCount = document.querySelectorAll('#judgesList .judge-item').length;
            if (judgeCount === 0) {
                addStatus('No judges in room yet!', 'warning');
                return;
            }

            socket.emit('event_judge_play', {
                room_id: roomId,
                username: username
            });
            addStatus('Initiated sync playback - judges must press X', 'info');
        }

        function resetRoom() {
            video.pause();
            video.currentTime = 0;
            waitingOverlay.classList.remove('hidden');
            pressXOverlay.classList.add('hidden');
            canPressX = false;
            if (isEventJudge) {
                overlayText.textContent = 'Press Play to start synchronized viewing';
            }
        }

        // Video ended
        video.addEventListener('ended', () => {
            socket.emit('video_ended', { room_id: roomId });
            waitingOverlay.classList.remove('hidden');
            if (isEventJudge) {
                overlayText.textContent = 'Video ended. Press Play to watch again.';
            } else {
                overlayText.textContent = 'Video ended. Waiting for Event Judge...';
            }
        });

        function updateJudgesList(judges) {
            const list = document.getElementById('judgesList');
            const count = Object.keys(judges).length;
            document.getElementById('judgeCount').textContent = count;

            if (count === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm">No judges connected yet</p>';
                return;
            }

            list.innerHTML = Object.entries(judges).map(([name, data]) => `
                <div class="judge-item flex items-center gap-2 bg-gray-700 rounded p-3">
                    <span class="w-3 h-3 rounded-full ${data.ready ? 'bg-green-500' : 'bg-gray-500'}"></span>
                    <span>${name}</span>
                    ${name === username ? '<span class="text-xs text-blue-400 ml-auto">(You)</span>' : ''}
                    ${data.ready ? '<span class="text-xs text-green-400 ml-auto">Ready</span>' : ''}
                </div>
            `).join('');
        }

        function updateRoomState(state) {
            const box = document.getElementById('roomStateBox');
            const text = document.getElementById('roomStateText');

            box.className = 'mb-4 p-3 rounded-lg ';
            switch(state) {
                case 'waiting':
                    box.className += 'bg-gray-700';
                    text.textContent = 'Waiting to start...';
                    break;
                case 'syncing':
                    box.className += 'bg-yellow-600/30';
                    text.textContent = 'Syncing - Press X!';
                    break;
                case 'playing':
                    box.className += 'bg-green-600/30';
                    text.textContent = 'Playing synchronized';
                    break;
            }
        }

        function addStatus(message, type) {
            const div = document.createElement('div');
            div.className = 'p-3 rounded-lg text-sm ';
            switch(type) {
                case 'success': div.className += 'bg-green-600/30 text-green-300'; break;
                case 'error': div.className += 'bg-red-600/30 text-red-300'; break;
                case 'warning': div.className += 'bg-yellow-600/30 text-yellow-300'; break;
                default: div.className += 'bg-blue-600/30 text-blue-300';
            }
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            statusMessages.insertBefore(div, statusMessages.firstChild);

            // Keep only last 5 messages
            while (statusMessages.children.length > 5) {
                statusMessages.removeChild(statusMessages.lastChild);
            }
        }

        function copyRoomLink() {
            const input = document.getElementById('roomLink');
            input.select();
            document.execCommand('copy');
            addStatus('Room link copied!', 'success');
        }

        // Leave room on page unload
        window.addEventListener('beforeunload', () => {
            socket.emit('leave_sync_room', {
                room_id: roomId,
                username: username
            });
        });
    </script>
</body>
</html>
