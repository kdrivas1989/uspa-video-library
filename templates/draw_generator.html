<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Draw Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <nav class="bg-gray-800 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <a href="/" class="text-2xl font-bold text-blue-400">Draw Generator</a>
            <div class="flex items-center gap-4">
                <a href="/" class="text-gray-400 hover:text-white">Back to Videos</a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold mb-6 print:hidden">Draw Generator</h1>
        <p class="text-gray-400 mb-8">Generate competition draws based on USPA rules (SCM Chapter 9)</p>

        <!-- Generator Controls -->
        <div class="bg-gray-800 rounded-lg p-6 mb-8">
            <!-- Competition Info -->
            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Competition Name</label>
                    <input type="text" id="competitionName" value="" class="w-full px-3 py-2 rounded bg-gray-700 text-white" placeholder="Competition Name (optional)">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Start Date</label>
                    <input type="date" id="startDate" class="w-full px-3 py-2 rounded bg-gray-700 text-white">
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">End Date</label>
                    <input type="date" id="endDate" class="w-full px-3 py-2 rounded bg-gray-700 text-white">
                </div>
            </div>

            <!-- Event Selection -->
            <div class="grid md:grid-cols-4 gap-4 mb-6">
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Event</label>
                    <select id="eventType" onchange="updateClassOptions()" class="w-full px-3 py-2 rounded bg-gray-700 text-white">
                        <optgroup label="Formation Skydiving">
                            <option value="4way-fs" selected>4-Way FS</option>
                            <option value="8way">8-Way FS</option>
                            <option value="4way-vfs">4-Way VFS</option>
                            <option value="2way-mfs">2-Way MFS</option>
                            <option value="16way">16-Way FS</option>
                            <option value="10way">10-Way Speed</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Class</label>
                    <select id="eventClass" class="w-full px-3 py-2 rounded bg-gray-700 text-white">
                        <option value="open">Open</option>
                        <option value="advanced">Advanced</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="beginner">Beginner</option>
                    </select>
                </div>
                <div>
                    <label class="block text-gray-400 text-sm mb-2">Number of Rounds</label>
                    <div id="numRoundsDisplay" class="w-full px-3 py-2 rounded bg-gray-600 text-white font-medium">10 Rounds</div>
                    <input type="hidden" id="numRounds" value="10">
                </div>
                <div class="flex items-end">
                    <button onclick="generateDraw()" class="w-full px-6 py-2 bg-green-600 hover:bg-green-700 rounded font-bold">
                        Generate Draw
                    </button>
                </div>
            </div>

            <!-- Event Info -->
            <div id="eventInfo" class="text-sm text-gray-400 p-3 bg-gray-700 rounded">
                <strong>4-Way FS Open:</strong> 5-6 formations per round | All blocks (1-22) | All randoms (A-Q) | Working time: 35s
            </div>
        </div>

        <!-- Draw Results -->
        <div id="drawResults" class="hidden">
            <div class="flex justify-between items-center mb-4 print:hidden">
                <h2 class="text-2xl font-bold">Draw Sheet</h2>
                <div class="flex gap-2">
                    <button onclick="copyDraw()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded">Copy All</button>
                    <button onclick="printCompact()" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded">Print Compact (1 page)</button>
                    <button onclick="printFull()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">Print Full</button>
                </div>
            </div>

            <div id="drawContent" class="space-y-4">
                <!-- Rounds will be inserted here -->
            </div>
        </div>

        <!-- Dive Pool Reference -->
        <div class="mt-12">
            <h2 class="text-2xl font-bold mb-4">Dive Pool Reference</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold text-blue-400 mb-3">Random Formations (1 point each)</h3>
                    <div class="flex flex-wrap gap-2" id="randomsReference">
                        <!-- Generated by JS -->
                    </div>
                </div>
                <div class="bg-gray-800 rounded-lg p-4">
                    <h3 class="font-bold text-purple-400 mb-3">Block Sequences (2 points each)</h3>
                    <div class="flex flex-wrap gap-2" id="blocksReference">
                        <!-- Generated by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // USPA Dive Pool Rules per Event/Class (from SCM Chapter 9)
        // drawPoints = target points per round (randoms=1pt, blocks=2pts)
        const divePoolRules = {
            '4way-fs': {
                open: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 35, name: '4-Way FS Open' },
                advanced: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 35, name: '4-Way FS Advanced' },
                intermediate: { blocks: [1,2,4,6,7,8,9,11,13,14,15,18,19,20,21,22], randoms: 'all', drawPoints: [4, 5], workingTime: 35, name: '4-Way FS Intermediate' },
                beginner: { blocks: [2,4,6,7,8,9,19,21], randoms: 'all', drawPoints: [3, 4], workingTime: 35, name: '4-Way FS Beginner' }
            },
            '8way': {
                open: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 50, name: '8-Way FS Open' },
                advanced: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 50, name: '8-Way FS Advanced' },
                intermediate: { blocks: [1,3,4,5,6,7,8,10,13,14,16,17,18,19,21], randoms: 'all', drawPoints: [4, 5], workingTime: 50, name: '8-Way FS Intermediate' }
            },
            '4way-vfs': {
                open: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 35, name: '4-Way VFS Open' },
                advanced: { blocks: [1,2,3,4,7,8,9,11,12,13,14,16,17,18,20,21,22], randoms: ['A','B','C','E','J','K','L','Q'], drawPoints: [4, 5], workingTime: 35, name: '4-Way VFS Advanced' },
                intermediate: { blocks: [1,2,3,7,8,12,13,14,21,22], randoms: ['A','B','E','J','L'], drawPoints: [3, 4], workingTime: 35, name: '4-Way VFS Intermediate' }
            },
            '2way-mfs': {
                open: { blocks: 'all', randoms: 'all', drawPoints: [5, 6], workingTime: 35, name: '2-Way MFS Open' },
                advanced: { blocks: 'allExcept', blocksExclude: [4,12,13,16], randoms: 'allExcept', randomsExclude: ['A','F','P'], drawPoints: [4, 5], workingTime: 35, name: '2-Way MFS Advanced' },
                intermediate: { blocks: [5,6,7,8,10,17,20,22], randoms: ['D','G','H','J','K','L','M','Q'], drawPoints: [3, 4], workingTime: 35, name: '2-Way MFS Intermediate' }
            },
            '16way': {
                open: { blocks: 'all', randoms: 'all', drawPoints: [3, 4], workingTime: 50, name: '16-Way FS' }
            },
            '10way': {
                open: { blocks: [], randoms: [1,2,3,4,5,6,7,9,10,11,12], drawPoints: [1], workingTime: 35, name: '10-Way Speed', isSpeed: true, excludeRound6: 8 }
            }
        };

        // All randoms and blocks
        const allRandoms = ['A','B','C','D','E','F','G','H','J','K','L','M','N','O','P','Q'];
        const allBlocks = Array.from({length: 22}, (_, i) => i + 1);

        // Get available formations for current event/class
        function getAvailablePool() {
            const eventType = document.getElementById('eventType').value;
            const eventClass = document.getElementById('eventClass').value;

            const rules = divePoolRules[eventType];
            const classRules = rules[eventClass] || rules.open;

            let randoms = [];
            let blocks = [];

            // Get randoms
            if (classRules.randoms === 'all') {
                randoms = [...allRandoms];
            } else if (classRules.randoms === 'allExcept') {
                randoms = allRandoms.filter(r => !classRules.randomsExclude.includes(r));
            } else if (Array.isArray(classRules.randoms)) {
                randoms = [...classRules.randoms];
            }

            // Get blocks
            if (classRules.blocks === 'all') {
                blocks = [...allBlocks];
            } else if (classRules.blocks === 'allExcept') {
                blocks = allBlocks.filter(b => !classRules.blocksExclude.includes(b));
            } else if (Array.isArray(classRules.blocks)) {
                blocks = [...classRules.blocks];
            }

            return { randoms, blocks, classRules };
        }

        // Default rounds per event type based on USPA competition rules
        const defaultRoundsPerEvent = {
            // Formation Skydiving
            '4way-fs': 10,
            '4way-vfs': 10,
            '2way-mfs': 10,
            '8way': 10,
            '16way': 6,
            '10way': 6,
            // Canopy Formation
            'cf_4way_rot': 8,
            'cf_4way_seq': 8,
            'cf_2way_open': 8,
            'cf_2way_proam': 8,
            // Artistic Events
            'ae_freestyle': 7,
            'ae_freefly': 7,
            // Wingsuit
            'ws_acrobatic': 7,
            'ws_performance': 3,
            // Default
            'default': 10
        };

        // Update class options and rounds based on event
        function updateClassOptions() {
            const eventType = document.getElementById('eventType').value;
            const classSelect = document.getElementById('eventClass');
            const rules = divePoolRules[eventType];

            // Clear and rebuild options
            classSelect.innerHTML = '';

            const classes = ['open', 'advanced', 'intermediate', 'beginner'];
            classes.forEach(cls => {
                if (rules[cls]) {
                    const option = document.createElement('option');
                    option.value = cls;
                    option.textContent = cls.charAt(0).toUpperCase() + cls.slice(1);
                    classSelect.appendChild(option);
                }
            });

            // Update rounds based on event type
            const rounds = defaultRoundsPerEvent[eventType] || defaultRoundsPerEvent['default'];
            document.getElementById('numRounds').value = rounds;
            document.getElementById('numRoundsDisplay').textContent = rounds + ' Rounds';

            updateEventInfo();
            updatePoolReference();
        }

        // Update event info display
        function updateEventInfo() {
            const { classRules } = getAvailablePool();
            const infoEl = document.getElementById('eventInfo');

            const drawPts = classRules.drawPoints;
            infoEl.innerHTML = `<strong>${classRules.name}:</strong> ${drawPts[0]}${drawPts.length > 1 ? '-' + drawPts[1] : ''} points per round (randoms=1pt, blocks=2pts) | Working time: ${classRules.workingTime}s`;
        }

        // Update pool reference display
        function updatePoolReference() {
            const { randoms, blocks } = getAvailablePool();

            const randomsEl = document.getElementById('randomsReference');
            randomsEl.innerHTML = randoms.map(r =>
                `<span class="px-2 py-1 bg-blue-600 rounded text-sm font-mono">${r}</span>`
            ).join('');

            const blocksEl = document.getElementById('blocksReference');
            blocksEl.innerHTML = blocks.map(b =>
                `<span class="px-2 py-1 bg-purple-600 rounded text-sm font-mono">${b}</span>`
            ).join('');
        }

        // Generate a single round based on target POINTS (not formation count)
        function generateRound(pool, usedInRound = new Set()) {
            const { randoms, blocks, classRules } = pool;
            const drawPoints = classRules.drawPoints;

            // Determine target points (random between min and max)
            const targetPoints = drawPoints.length > 1
                ? drawPoints[0] + Math.floor(Math.random() * (drawPoints[1] - drawPoints[0] + 1))
                : drawPoints[0];

            const round = [];
            let currentPoints = 0;
            const availableRandoms = [...randoms];
            const availableBlocks = [...blocks];

            // Build the round until we reach target points
            while (currentPoints < targetPoints) {
                const canAddRandom = availableRandoms.length > 0 && (currentPoints + 1 <= targetPoints);
                const canAddBlock = availableBlocks.length > 0 && (currentPoints + 2 <= targetPoints);

                if (!canAddRandom && !canAddBlock) break;

                // Prefer blocks slightly to get variety, but ensure we can hit exact point target
                const pointsRemaining = targetPoints - currentPoints;
                let addBlock = false;

                if (canAddBlock && canAddRandom) {
                    // If we need exactly 1 more point, must use random
                    if (pointsRemaining === 1) {
                        addBlock = false;
                    } else {
                        // Otherwise, randomly choose (slight preference for blocks)
                        addBlock = Math.random() < 0.4;
                    }
                } else {
                    addBlock = canAddBlock;
                }

                if (addBlock) {
                    const idx = Math.floor(Math.random() * availableBlocks.length);
                    const block = availableBlocks.splice(idx, 1)[0];
                    round.push({ type: 'block', value: block, points: 2 });
                    currentPoints += 2;
                } else if (canAddRandom) {
                    const idx = Math.floor(Math.random() * availableRandoms.length);
                    const random = availableRandoms.splice(idx, 1)[0];
                    round.push({ type: 'random', value: random, points: 1 });
                    currentPoints += 1;
                }
            }

            return { formations: round, maxPoints: currentPoints };
        }

        // Generate full draw
        function generateDraw() {
            const numRounds = parseInt(document.getElementById('numRounds').value);
            const pool = getAvailablePool();

            const rounds = [];
            const masterPool = new Set(); // Track used formations across rounds

            for (let i = 0; i < numRounds; i++) {
                // If pool is exhausted, reset it
                if (masterPool.size >= pool.randoms.length + pool.blocks.length) {
                    masterPool.clear();
                }

                const round = generateRound(pool, new Set()); // Each round allows repeats from other rounds
                rounds.push(round);
            }

            displayDraw(rounds);
        }

        function formatDateRange(startStr, endStr) {
            if (!startStr && !endStr) return '';
            if (!startStr) startStr = endStr;
            if (!endStr) endStr = startStr;

            const start = new Date(startStr + 'T00:00:00');
            const end = new Date(endStr + 'T00:00:00');
            const options = { month: 'long', day: 'numeric', year: 'numeric' };

            if (startStr === endStr) {
                return start.toLocaleDateString('en-US', options);
            }

            const startMonth = start.toLocaleDateString('en-US', { month: 'long' });
            const endMonth = end.toLocaleDateString('en-US', { month: 'long' });
            const startDay = start.getDate();
            const endDay = end.getDate();
            const year = end.getFullYear();

            if (startMonth === endMonth) {
                return `${startMonth} ${startDay} - ${endDay}, ${year}`;
            }
            return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
        }

        // Display generated draw - columnar layout like reference PDF
        function displayDraw(rounds) {
            const resultsEl = document.getElementById('drawResults');
            const contentEl = document.getElementById('drawContent');

            resultsEl.classList.remove('hidden');

            const eventType = document.getElementById('eventType').value;
            const eventClass = document.getElementById('eventClass').value;
            const rules = divePoolRules[eventType][eventClass] || divePoolRules[eventType].open;

            // Get competition info from inputs
            const competitionName = document.getElementById('competitionName').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const dateRange = formatDateRange(startDate, endDate);

            // Build title
            const title = competitionName ? `${competitionName} - ${rules.name}` : rules.name;
            const subtitle = dateRange ? `${dateRange} | Working Time: ${rules.workingTime}s` : `Working Time: ${rules.workingTime}s`;

            // Find max formations in any round for row count
            const maxFormations = Math.max(...rounds.map(r => r.formations.length));

            // Print header
            let html = `
                <div id="printHeader" class="mb-4">
                    <div class="flex justify-between items-center border-b-2 border-gray-600 pb-2 print:border-black">
                        <div>
                            <h1 class="text-xl font-bold print:text-black">${title}</h1>
                            <p class="text-sm text-gray-400 print:text-gray-600">${subtitle}</p>
                        </div>
                        <div class="text-right text-sm text-gray-400 print:text-gray-600">
                            <div>${new Date().toLocaleDateString()}</div>
                            <div>${rounds.length} Rounds</div>
                        </div>
                    </div>
                </div>
            `;

            // Columnar layout - rounds as columns
            html += `<div class="draw-columns overflow-x-auto">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="border-b-2 border-gray-600 print:border-black">`;

            // Round headers
            rounds.forEach((_, idx) => {
                html += `<th class="text-center px-1 py-2 text-sm font-bold print:text-black">Round ${idx + 1}</th>`;
            });
            html += `</tr></thead><tbody>`;

            // Formation rows
            for (let formIdx = 0; formIdx < maxFormations; formIdx++) {
                html += `<tr class="border-b border-gray-700 print:border-gray-300">`;

                rounds.forEach((round) => {
                    if (formIdx < round.formations.length) {
                        const f = round.formations[formIdx];
                        const imgPath = `/static/formations/FS-${f.value}.png`;
                        html += `
                            <td class="text-center p-1 align-top">
                                <div class="formation-cell inline-block">
                                    <div class="formation-pic w-16 h-20 mx-auto rounded overflow-hidden border border-gray-600 print:border-gray-400 cursor-pointer"
                                         style="background-color: white"
                                         onclick="openModal('${imgPath}', '${f.value}')">
                                        <span class="compact-code hidden font-bold text-black text-lg">${f.value}</span>
                                        <img src="${imgPath}" alt="${f.value}" class="full-image w-full h-full object-contain"
                                             onerror="this.onerror=null; this.style.display='none'; this.parentElement.querySelector('.compact-code').classList.remove('hidden')"/>
                                    </div>
                                </div>
                            </td>`;
                    } else {
                        html += `<td></td>`;
                    }
                });

                html += `</tr>`;
            }

            // Max points row
            html += `<tr class="border-t-2 border-gray-600 print:border-black bg-gray-800 print:bg-gray-100">`;
            rounds.forEach((round) => {
                html += `<td class="text-center py-2 text-sm font-bold print:text-black">${round.maxPoints} pts</td>`;
            });
            html += `</tr>`;

            html += `</tbody></table></div>`;

            // Detailed view (hidden on print) - text version
            html += `<div class="detailed-view mt-6 print:hidden">
                <h3 class="text-lg font-bold mb-3">Text Format</h3>`;
            rounds.forEach((round, idx) => {
                const drawString = round.formations.map(f => f.value).join(' ');
                html += `
                    <div class="bg-gray-800 rounded-lg p-3 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="font-bold">Round ${idx + 1}:</span>
                            <span class="text-gray-400 text-sm">${round.maxPoints} pts</span>
                        </div>
                        <div class="font-mono text-lg mt-1">${drawString}</div>
                    </div>
                `;
            });
            html += `</div>`;

            contentEl.innerHTML = html;
        }

        // Copy draw to clipboard
        function copyDraw() {
            const contentEl = document.getElementById('drawContent');
            const rounds = contentEl.querySelectorAll('.bg-gray-800');

            let text = `Draw - ${document.getElementById('eventType').value.toUpperCase()} ${document.getElementById('eventClass').value.toUpperCase()}\n`;
            text += '='.repeat(40) + '\n\n';

            rounds.forEach((round, idx) => {
                const drawStr = round.querySelector('.font-mono.bg-gray-700').textContent.trim();
                const maxPts = round.querySelector('.text-gray-400.text-sm').textContent.trim();
                text += `Round ${idx + 1}: ${drawStr} (${maxPts})\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                alert('Draw copied to clipboard!');
            });
        }

        // Print compact (1 page)
        function printCompact() {
            document.body.classList.add('print-compact');
            document.body.classList.remove('print-full');
            window.print();
        }

        // Print full
        function printFull() {
            document.body.classList.remove('print-compact');
            document.body.classList.add('print-full');
            window.print();
        }

        // Initialize
        updateClassOptions();
    </script>

    <style>
        @media print {
            @page {
                size: letter landscape;
                margin: 0.3in;
            }
            body {
                background: white !important;
                color: black !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            nav, button, #eventInfo, .mt-12, .detailed-view, .bg-gray-800.rounded-lg.p-6 {
                display: none !important;
            }
            #printHeader { display: block !important; }
            #drawResults { display: block !important; }
            .container { max-width: 100% !important; padding: 0 !important; }
            .draw-columns {
                overflow: visible !important;
            }
            .draw-columns table {
                width: 100% !important;
                table-layout: fixed !important;
            }
            .formation-pic {
                border: 1px solid #333 !important;
                background: white !important;
            }
        }

        /* Compact print mode - 1 page, no images, landscape */
        @media print {
            body.print-compact .formation-pic {
                width: 40px !important;
                height: 28px !important;
            }
            body.print-compact .formation-pic .full-image,
            body.print-compact .formation-pic img {
                display: none !important;
            }
            body.print-compact .formation-pic .compact-code {
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                height: 100% !important;
                font-size: 10pt !important;
            }
            body.print-compact td {
                padding: 2px !important;
            }
            body.print-compact th {
                font-size: 9pt !important;
                padding: 4px 2px !important;
            }
        }

        /* Full print mode - with images */
        @media print {
            body.print-full .formation-pic {
                width: 65px !important;
                height: 80px !important;
            }
            body.print-full .formation-pic .compact-code {
                display: none !important;
            }
            body.print-full .formation-pic .full-image,
            body.print-full .formation-pic img {
                display: block !important;
                width: 100% !important;
                height: 100% !important;
                object-fit: contain !important;
            }
            body.print-full td {
                padding: 3px !important;
            }
            body.print-full th {
                font-size: 10pt !important;
                padding: 4px 2px !important;
            }
        }

        /* Screen styles */
        .draw-columns table th,
        .draw-columns table td {
            vertical-align: top;
        }
        .formation-pic {
            transition: transform 0.2s;
        }
        .formation-pic:hover {
            transform: scale(1.05);
        }
    </style>
    <!-- Image Modal -->
    <div id="imageModal" class="fixed inset-0 bg-black/80 hidden z-50 overflow-y-auto" onclick="closeModal()">
        <div class="min-h-full flex items-center justify-center p-8">
            <div class="relative" onclick="event.stopPropagation()">
                <button onclick="closeModal()" class="absolute -top-8 -right-8 text-white text-3xl font-bold hover:text-gray-300">&times;</button>
                <img id="modalImage" src="" alt="" class="bg-white rounded-lg shadow-2xl">
                <div id="modalCaption" class="text-center text-white mt-4 text-xl font-bold"></div>
            </div>
        </div>
    </div>

    <script>
        function openModal(imgSrc, caption) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const modalCaption = document.getElementById('modalCaption');

            modalImg.src = imgSrc;
            modalCaption.textContent = caption;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
